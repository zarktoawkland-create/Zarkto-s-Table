<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>密大图书馆 - Zarkto's Table</title>
    <!-- 引入衬线字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Noto Serif SC"', 'SimSun', 'Songti SC', 'serif'],
                        sans: ['"Noto Serif SC"', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            950: '#020617',
                            900: '#0a0f1e',
                            850: '#141b2d',
                            800: '#1e293b',
                            700: '#334155',
                        },
                        mystic: {
                            gold: '#d4af37',
                            green: '#2d6a4f',
                            teal: '#115e59',
                            red: '#8a1c1c',
                            purple: '#581c87',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                    }
                }
            }
        }
    </script>
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
            background-color: #020617;
            color: #cbd5e1;
            font-family: 'Noto Serif SC', serif;
        }
        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 50;
            opacity: 0.4;
        }
        [v-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
    </style>
</head>
<body class="selection:bg-purple-900 selection:text-purple-100">
    <div id="app" v-cloak class="h-full flex flex-col relative bg-dark-950 text-slate-300 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
        
        <!-- Header -->
        <div class="h-16 border-b border-dark-800 bg-dark-900/80 backdrop-blur flex items-center justify-between px-6 z-10 shrink-0 safe-pt">
            <div class="flex items-center gap-4">
                <a href="../index (ver2.0).html" class="flex items-center text-slate-400 hover:text-mystic-gold transition-colors">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    <span class="font-bold text-sm tracking-widest uppercase">返回大厅</span>
                </a>
            </div>
            <div class="font-bold text-xl text-purple-400 font-serif flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
                密斯卡托尼克大学图书馆
            </div>
            <div class="w-24 flex justify-end">
                <div v-if="user.name" class="flex items-center gap-2 text-xs text-slate-500">
                    <img v-if="user.avatar" :src="user.avatar" class="w-6 h-6 rounded-full border border-dark-600">
                    <div v-else class="w-6 h-6 rounded-full bg-dark-800 flex items-center justify-center font-bold">{{ user.name.charAt(0) }}</div>
                    <span class="max-w-[100px] truncate">{{ user.name }}</span>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="fixed top-20 left-1/2 transform -translate-x-1/2 z-[1000] flex flex-col gap-2 pointer-events-none items-center w-full max-w-sm px-4">
            <transition-group name="list" tag="div" class="flex flex-col items-center w-full">
                <div v-for="toast in toasts" :key="toast.id"
                     class="pointer-events-auto flex items-center px-4 py-3 rounded-xl shadow-2xl border bg-dark-900/95 backdrop-blur-md text-sm font-medium w-full"
                     :class="{
                        'border-mystic-green/50 text-mystic-green': toast.type === 'success',
                        'border-red-500/50 text-red-400': toast.type === 'error',
                        'border-blue-500/50 text-blue-400': toast.type === 'info',
                        'border-mystic-gold/50 text-mystic-gold': toast.type === 'warning'
                     }">
                    <span class="flex-1">{{ toast.message }}</span>
                </div>
            </transition-group>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 animate-fade-in custom-scrollbar">
            <div class="max-w-6xl mx-auto">
                <!-- Section Navigation -->
                <div class="flex justify-center mb-8">
                    <div class="flex bg-dark-900/50 p-1.5 rounded-2xl border border-dark-800 backdrop-blur-sm relative">
                        <!-- Sliding Background -->
                        <div class="absolute top-1.5 bottom-1.5 rounded-xl transition-all duration-300 ease-out bg-dark-800 border"
                             :class="libraryState.currentSection === 'reading' ? 'left-1.5 w-[calc(50%-6px)] border-purple-500/30 shadow-[0_0_15px_rgba(168,85,247,0.15)]' : 'left-[50%] w-[calc(50%-6px)] border-red-500/30 shadow-[0_0_15px_rgba(220,38,38,0.15)]'">
                        </div>

                        <button @click="libraryState.currentSection = 'reading'; fetchLibraryModules()"
                                class="relative z-10 px-8 py-2.5 rounded-xl font-bold transition-colors flex items-center gap-2"
                                :class="libraryState.currentSection === 'reading' ? 'text-purple-400' : 'text-slate-500 hover:text-slate-300'">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                            阅览室
                        </button>
                        <button @click="libraryState.currentSection = 'restricted'; fetchLibraryModules()"
                                class="relative z-10 px-8 py-2.5 rounded-xl font-bold transition-colors flex items-center gap-2"
                                :class="libraryState.currentSection === 'restricted' ? 'text-red-400' : 'text-slate-500 hover:text-slate-300'">
                            禁书区
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 animate-fade-in" :key="libraryState.currentSection">
                    <div class="text-slate-500 text-sm font-serif italic hidden md:block">
                        <template v-if="libraryState.currentSection === 'reading'">“知识是危险的，但无知更加致命。”</template>
                        <template v-else>“有些秘密注定不该被揭开...”</template>
                    </div>
                    
                    <div class="flex gap-3 w-full md:w-auto">
                        <div class="relative flex-1 md:w-72">
                            <input v-model="libraryState.searchQuery" @keyup.enter="fetchLibraryModules"
                                   :placeholder="libraryState.currentSection === 'reading' ? '搜索公开典籍...' : '搜索禁忌知识...'"
                                   class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-2.5 text-sm text-slate-300 outline-none transition-colors"
                                   :class="libraryState.currentSection === 'reading' ? 'focus:border-purple-500' : 'focus:border-red-500'">
                            <button @click="fetchLibraryModules" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 transition-colors"
                                    :class="libraryState.currentSection === 'reading' ? 'hover:text-purple-400' : 'hover:text-red-400'">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </button>
                        </div>
                        
                        <button v-if="libraryState.currentSection === 'reading'" @click="libraryState.showUpload = true" class="px-5 py-2.5 bg-purple-600 text-white shadow-[0_0_15px_rgba(147,51,234,0.3)] rounded-lg hover:bg-purple-500 font-bold text-sm flex items-center gap-2 whitespace-nowrap transition-all hover:scale-105 active:scale-95">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            贡献藏书
                        </button>
                        
                        <button v-else @click="libraryState.showAlchemyTable = true" class="px-5 py-2.5 bg-red-900/30 text-red-400 border border-red-500/50 shadow-[0_0_15px_rgba(220,38,38,0.2)] rounded-lg hover:bg-red-900/50 font-bold text-sm flex items-center gap-2 whitespace-nowrap transition-all hover:scale-105 active:scale-95">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                            扎克托的炼金写字台
                        </button>
                    </div>
                </div>
                <!-- Module List -->
                <div v-if="libraryState.loading" class="text-center py-20 text-purple-400 animate-pulse">
                    正在从书架上取书...
                </div>
                <div v-else-if="libraryState.modules.length === 0" class="text-center py-20 border border-dashed border-dark-700 rounded bg-dark-900/30">
                    <div class="text-slate-500 font-serif italic mb-4">
                        {{ libraryState.currentSection === 'restricted' ? '禁书区尚未有任何记录...' : '图书馆空空如也，也许你该贡献第一本藏书？' }}
                    </div>
                </div>
                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="mod in libraryState.modules" :key="mod.id"
                         :class="['group relative bg-dark-900 border rounded-lg overflow-hidden transition-all duration-300 flex flex-col transform hover:-translate-y-1',
                                  libraryState.currentSection === 'restricted' ? 'border-red-900/30 hover:border-red-500/50 hover:shadow-[0_0_20px_rgba(220,38,38,0.15)]' : 'border-dark-700 hover:border-purple-500/50 hover:shadow-[0_0_20px_rgba(168,85,247,0.15)]']">
                        
                        <div v-if="libraryState.currentSection === 'restricted'" class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-600 to-orange-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div v-else class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-600 to-blue-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        
                        <div class="p-5 flex-1 relative">
                            <!-- Background Pattern -->
                            <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity pointer-events-none">
                                <svg v-if="libraryState.currentSection === 'restricted'" class="w-24 h-24 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/></svg>
                                <svg v-else class="w-24 h-24 text-purple-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/></svg>
                            </div>

                            <div class="flex justify-between items-start mb-2 relative z-10">
                                <div class="flex-1 mr-2">
                                    <div class="flex items-center gap-2 mb-1">
                                        <template v-if="libraryState.currentSection === 'restricted'">
                                            <span v-if="mod.type === 'ai_adapt_private'" class="text-[10px] px-1.5 py-0.5 rounded bg-red-900/30 text-red-400 border border-red-500/30 font-bold uppercase tracking-wider flex items-center gap-1">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                                私有
                                            </span>
                                            <span v-else class="text-[10px] px-1.5 py-0.5 rounded bg-teal-900/30 text-teal-400 border border-teal-500/30 font-bold uppercase tracking-wider flex items-center gap-1">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                                公开
                                            </span>
                                        </template>
                                        <template v-else>
                                            <span v-if="mod.type === 'reprint'" class="text-[10px] px-1.5 py-0.5 rounded bg-blue-900/30 text-blue-400 border border-blue-500/30 font-bold uppercase tracking-wider">搬运</span>
                                            <span v-else class="text-[10px] px-1.5 py-0.5 rounded bg-purple-900/30 text-purple-400 border border-purple-500/30 font-bold uppercase tracking-wider">原创</span>
                                        </template>
                                        <span class="text-[10px] text-slate-600">{{ new Date(mod.created_at).toLocaleDateString() }}</span>
                                    </div>
                                    <h3 class="text-lg font-bold text-slate-200 font-serif line-clamp-1 group-hover:text-purple-400 transition-colors" :title="mod.title">{{ mod.title }}</h3>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 mb-3 text-xs text-slate-500">
                                <div class="font-mono flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    {{ mod.author_name || '佚名' }}
                                </div>
                                <div v-if="mod.min_players || mod.max_players" class="flex items-center gap-1 px-1.5 py-0.5 rounded bg-dark-800 border border-dark-700">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    <span>{{ mod.min_players || '?' }} - {{ mod.max_players || '?' }} 人</span>
                                </div>
                            </div>
                            <p class="text-sm text-slate-400 line-clamp-3 mb-4 h-[4.5em] leading-relaxed relative z-10">{{ mod.description || '暂无简介...' }}</p>
                            <div class="flex gap-4 text-xs text-slate-600 border-t border-dark-800 pt-3 justify-between">
                                <div class="flex gap-4">
                                    <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg> {{ Math.ceil(mod.content.length / 1000) }}k 字</span>
                                    <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> {{ mod.downloads || 0 }}</span>
                                </div>
                                <div class="flex gap-3">
                                    <button v-if="mod.author_id === user.uuid" @click="deleteModule(mod)" class="text-slate-500 hover:text-red-400 transition-colors" title="撤回/删除">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                    <button @click="exportModuleToWord(mod)" class="text-slate-500 hover:text-blue-400 transition-colors" title="导出 Word">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-dark-800 bg-dark-950/30 flex gap-2">
                            <button @click="useLibraryModule(mod, 'single')" class="flex-1 py-2 bg-dark-800 hover:bg-mystic-gold hover:text-dark-900 text-mystic-gold border border-mystic-gold/30 rounded text-xs font-bold transition-colors">
                                单人跑团
                            </button>
                            <button @click="useLibraryModule(mod, 'multi')" class="flex-1 py-2 bg-dark-800 hover:bg-mystic-green hover:text-dark-900 text-mystic-green border border-mystic-green/30 rounded text-xs font-bold transition-colors">
                                多人联机
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Modal (Refined) -->
        <div v-if="libraryState.showUpload" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm safe-pt safe-pb">
            <div class="bg-dark-900 border border-purple-500/30 rounded-xl shadow-2xl max-w-4xl w-full flex flex-col h-[85vh] md:h-[90vh] animate-fade-in ring-1 ring-white/5">
                <!-- Header -->
                <div class="px-6 py-5 border-b border-white/5 flex justify-between items-center flex-shrink-0 bg-white/5">
                    <h3 class="text-xl font-bold text-slate-100 font-serif flex items-center gap-3">
                        <div class="p-2 bg-purple-500/10 rounded-lg text-purple-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        </div>
                        贡献新藏书
                    </h3>
                    <button @click="libraryState.showUpload = false" class="text-slate-500 hover:text-white transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                    <!-- Left Column: Metadata -->
                    <div class="md:w-80 border-b md:border-b-0 md:border-r border-white/5 bg-black/20 overflow-y-auto custom-scrollbar p-6 space-y-6 flex-shrink-0">
                        <!-- Title -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">模组标题 <span class="text-red-500">*</span></label>
                            <input v-model="libraryState.uploadForm.title" placeholder="请输入模组标题" class="w-full bg-dark-950 border border-white/10 rounded-lg px-4 py-3 text-slate-200 focus:border-purple-500 outline-none transition-colors shadow-sm focus:ring-1 focus:ring-purple-500/50">
                        </div>

                        <!-- Type -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">来源类型</label>
                            <div class="grid grid-cols-2 gap-2 p-1 bg-dark-950 rounded-lg border border-white/10">
                                <button @click="libraryState.uploadForm.type = 'original'"
                                    :class="['py-2 text-xs rounded-md font-bold transition-all flex items-center justify-center gap-1.5', libraryState.uploadForm.type === 'original' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300 hover:bg-white/5']">
                                    <span>原创</span>
                                </button>
                                <button @click="libraryState.uploadForm.type = 'reprint'"
                                    :class="['py-2 text-xs rounded-md font-bold transition-all flex items-center justify-center gap-1.5', libraryState.uploadForm.type === 'reprint' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300 hover:bg-white/5']">
                                    <span>搬运</span>
                                </button>
                            </div>
                        </div>

                        <!-- Player Count -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">建议人数</label>
                            <div class="flex items-center gap-2">
                                <input type="number" v-model="libraryState.uploadForm.min_players" placeholder="最小" min="1" class="w-full bg-dark-950 border border-white/10 rounded-lg px-3 py-2 text-slate-200 focus:border-purple-500 outline-none transition-colors text-center">
                                <span class="text-slate-500">-</span>
                                <input type="number" v-model="libraryState.uploadForm.max_players" placeholder="最大" min="1" class="w-full bg-dark-950 border border-white/10 rounded-lg px-3 py-2 text-slate-200 focus:border-purple-500 outline-none transition-colors text-center">
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">简介</label>
                                <button v-if="!libraryState.isSummarizing" @click="generateModuleSummary(libraryState.uploadForm.content)" class="text-purple-400 hover:text-purple-300 text-[10px] flex items-center gap-1 px-2 py-0.5 rounded-full hover:bg-purple-500/10 transition-colors" :disabled="!libraryState.uploadForm.content">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    AI 摘要
                                </button>
                                <span v-else class="text-purple-400 text-[10px] flex items-center gap-1 animate-pulse">
                                    <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    生成中...
                                </span>
                            </div>
                            <textarea v-model="libraryState.uploadForm.description" rows="6" placeholder="简要描述模组背景、核心谜团..." class="w-full bg-dark-950 border border-white/10 rounded-lg px-4 py-3 text-slate-300 focus:border-purple-500 outline-none resize-none transition-colors text-sm leading-relaxed scrollbar-thin scrollbar-thumb-slate-700"></textarea>
                        </div>
                    </div>

                    <!-- Right Column: Content Editor -->
                    <div class="flex-1 flex flex-col min-w-0 bg-dark-900/50">
                        <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                模组正文 <span class="text-red-500">*</span>
                                <span v-if="libraryState.uploadForm.content" class="text-emerald-500 font-normal normal-case ml-2 text-[10px] bg-emerald-500/10 px-1.5 py-0.5 rounded border border-emerald-500/20">
                                    已载入 {{ libraryState.uploadForm.content.length }} 字
                                </span>
                            </label>
                            <div class="flex bg-dark-950 rounded-lg p-0.5 border border-white/10">
                                <button @click="libraryState.uploadType = 'text'" :class="['px-3 py-1.5 rounded-md text-[10px] font-bold transition-all', libraryState.uploadType === 'text' ? 'bg-slate-700 text-white shadow' : 'text-slate-500 hover:text-slate-300']">直接粘贴</button>
                                <button @click="libraryState.uploadType = 'file'" :class="['px-3 py-1.5 rounded-md text-[10px] font-bold transition-all', libraryState.uploadType === 'file' ? 'bg-slate-700 text-white shadow' : 'text-slate-500 hover:text-slate-300']">上传文件</button>
                            </div>
                        </div>

                        <div class="flex-1 relative">
                            <div v-if="libraryState.uploadType === 'text'" class="absolute inset-0 p-0">
                                <textarea v-model="libraryState.uploadForm.content" class="w-full h-full bg-transparent border-0 resize-none outline-none p-6 text-slate-300 font-mono text-sm leading-relaxed custom-scrollbar placeholder-slate-700" placeholder="请在此处粘贴模组正文内容..."></textarea>
                            </div>
                            
                            <div v-else class="absolute inset-0 p-6 flex flex-col items-center justify-center">
                                <div class="w-full h-full border-2 border-dashed border-white/10 rounded-xl flex flex-col items-center justify-center text-slate-500 hover:border-purple-500/50 hover:text-purple-400 transition-all cursor-pointer bg-white/5 hover:bg-white/10 group relative">
                                    <input type="file" accept=".txt,.md,.json,.docx" @change="handleLibraryFileUpload" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                                    <div class="w-16 h-16 rounded-full bg-dark-950 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform border border-white/10 shadow-lg">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    </div>
                                    <p class="font-bold text-lg mb-1 group-hover:text-purple-300 transition-colors">点击或拖拽文件</p>
                                    <p class="text-xs opacity-60">支持 .txt, .md, .docx</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-5 border-t border-white/5 flex justify-end gap-3 bg-dark-900/80 backdrop-blur">
                    <button @click="libraryState.showUpload = false" class="px-5 py-2.5 text-slate-400 hover:text-slate-200 text-sm font-bold transition-colors">取消操作</button>
                    <button @click="uploadToLibrary" :disabled="!libraryState.uploadForm.title || !libraryState.uploadForm.content || libraryState.isUploading" class="px-8 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white rounded-lg font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-lg shadow-purple-900/20 transition-all hover:scale-[1.02] active:scale-[0.98]">
                        <svg v-if="libraryState.isUploading" class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        {{ libraryState.isUploading ? '正在入库...' : '确认贡献藏书' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Alchemy Table Modal (AI) -->
        <div v-if="libraryState.showAlchemyTable" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm safe-pt safe-pb">
            <div class="bg-dark-950 border border-red-500/30 rounded-xl shadow-[0_0_50px_rgba(220,38,38,0.1)] max-w-6xl w-full flex flex-col h-[85vh] relative overflow-hidden ring-1 ring-white/5">
                <!-- Background Decoration -->
                <div class="absolute inset-0 pointer-events-none overflow-hidden">
                    <div class="absolute -top-40 -right-40 w-96 h-96 bg-red-900/20 rounded-full blur-3xl"></div>
                    <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-purple-900/10 rounded-full blur-3xl"></div>
                    <svg class="absolute -right-10 -top-10 w-64 h-64 text-red-900/10 rotate-12" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/></svg>
                </div>

                <!-- Header -->
                <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center shrink-0 bg-white/5 backdrop-blur-xl relative z-20">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center border border-red-500/20 text-red-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-100 font-serif tracking-wide">扎克托的炼金写字台</h3>
                            <p class="text-xs text-red-400 font-medium tracking-wider uppercase">Alchemy Workbench</p>
                        </div>
                    </div>
                    <button @click="libraryState.showAlchemyTable = false" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-slate-400 hover:text-white transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Content Body -->
                <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative z-10">
                    <!-- Left Column: Input Source -->
                    <div class="flex-1 flex flex-col min-w-0 border-r border-white/5 bg-black/20">
                        <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center">
                            <h4 class="text-sm font-bold text-slate-300 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-slate-500"></span>
                                原始素材 (Source)
                            </h4>
                            <div class="flex gap-2">
                                <div class="relative group">
                                    <input type="file" accept=".txt,.md,.json,.docx,.doc" @change="handleAlchemyFileUpload" class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full">
                                    <button class="px-3 py-1.5 bg-white/5 hover:bg-white/10 text-slate-300 border border-white/10 rounded-md text-xs font-medium transition-colors flex items-center gap-2">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                        导入文件
                                    </button>
                                </div>
                                <button @click="libraryState.alchemyForm.content = ''" class="px-3 py-1.5 hover:bg-red-500/10 text-slate-400 hover:text-red-400 rounded-md text-xs transition-colors" title="清空">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex-1 relative p-4">
                            <textarea v-model="libraryState.alchemyForm.content"
                                class="w-full h-full bg-transparent border-0 resize-none outline-none text-sm font-mono text-slate-300 placeholder-slate-600 leading-relaxed custom-scrollbar p-2"
                                placeholder=">>> 在此输入混乱的小说、大纲或灵感碎片...
>>> 炼金术将为您重构出有序的 COC 模组结构..."></textarea>
                        </div>

                        <div class="p-4 border-t border-white/5 bg-white/5">
                            <button @click="adaptNovelToModule"
                                :disabled="!libraryState.alchemyForm.content || libraryState.isAdapting"
                                class="w-full py-3 bg-gradient-to-r from-red-900 to-red-800 hover:from-red-800 hover:to-red-700 text-red-100 rounded-lg font-bold text-sm shadow-lg shadow-red-900/20 border border-red-500/20 flex items-center justify-center gap-2 transition-all hover:scale-[1.01] active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed group">
                                <svg v-if="libraryState.isAdapting" class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <span v-else class="group-hover:animate-pulse">✦</span>
                                {{ libraryState.isAdapting ? '正在重构现实结构...' : '开始炼金重构 (Transmute)' }}
                            </button>
                        </div>
                    </div>

                    <!-- Right Column: Output Result -->
                    <div class="flex-1 flex flex-col min-w-0 bg-dark-900/50">
                        <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center">
                            <h4 class="text-sm font-bold text-red-400 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse-slow"></span>
                                炼金产物 (Result)
                            </h4>
                            <div v-if="libraryState.alchemyForm.result" class="flex items-center gap-3 animate-fade-in">
                                <label class="flex items-center gap-2 cursor-pointer group select-none">
                                    <div class="relative">
                                        <input type="checkbox" v-model="libraryState.alchemyForm.isPublic" class="sr-only">
                                        <div :class="['w-8 h-4 rounded-full transition-colors duration-300', libraryState.alchemyForm.isPublic ? 'bg-teal-900/80 border border-teal-500/50' : 'bg-slate-700 border border-slate-600']"></div>
                                        <div :class="['absolute top-0.5 left-0.5 w-3 h-3 rounded-full transition-transform duration-300 shadow-sm', libraryState.alchemyForm.isPublic ? 'translate-x-4 bg-teal-400' : 'translate-x-0 bg-slate-400']"></div>
                                    </div>
                                    <span :class="['text-xs font-bold transition-colors', libraryState.alchemyForm.isPublic ? 'text-teal-400' : 'text-slate-500']">
                                        {{ libraryState.alchemyForm.isPublic ? '公开' : '私有' }}
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div class="flex-1 relative overflow-hidden flex flex-col">
                            <div v-if="!libraryState.alchemyForm.result" class="flex-1 flex flex-col items-center justify-center text-slate-600 p-8 text-center">
                                <div class="w-20 h-20 rounded-full border-2 border-dashed border-slate-700 flex items-center justify-center mb-4 opacity-50">
                                    <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                                </div>
                                <span class="text-sm font-serif italic text-slate-500">等待左侧投入素材...</span>
                            </div>
                            
                            <div v-else class="flex-1 flex flex-col animate-fade-in min-h-0">
                                <div class="p-4 pb-0">
                                    <input v-model="libraryState.alchemyForm.title" placeholder="模组标题" class="w-full bg-transparent border-b border-white/10 px-2 py-2 text-lg font-bold text-red-100 placeholder-slate-600 focus:border-red-500/50 outline-none transition-colors">
                                </div>
                                <div class="flex-1 p-4 overflow-y-auto custom-scrollbar">
                                    <textarea v-model="libraryState.alchemyForm.result" class="w-full h-full min-h-[300px] bg-transparent border-0 resize-none outline-none text-sm font-mono text-slate-300 leading-relaxed"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 border-t border-white/5 bg-white/5 flex gap-3">
                            <button @click="exportAlchemyResult" :disabled="!libraryState.alchemyForm.result" class="flex-1 py-2.5 bg-dark-800 hover:bg-dark-700 text-slate-300 border border-white/10 rounded-lg font-bold text-xs flex items-center justify-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                导出 Word
                            </button>
                            <button @click="uploadAlchemyResult" :disabled="!libraryState.alchemyForm.result || libraryState.isUploading" class="flex-[2] py-2.5 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-2 shadow-lg shadow-red-900/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg v-if="libraryState.isUploading" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                {{ libraryState.isUploading ? '正在封存入库...' : '确认入库 (Save to Library)' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal (Cthulhu Themed) -->
        <div v-if="showDeleteModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/95 backdrop-blur-md safe-pt safe-pb">
            <div class="bg-dark-950 border border-red-900/50 rounded-xl shadow-[0_0_100px_rgba(153,27,27,0.3)] max-w-md w-full p-8 animate-fade-in ring-1 ring-white/5 relative overflow-hidden group">
                <!-- Background decoration -->
                <div class="absolute -top-20 -right-20 w-64 h-64 bg-red-900/10 rounded-full blur-3xl pointer-events-none group-hover:bg-red-900/20 transition-colors duration-1000"></div>
                <div class="absolute -bottom-20 -left-20 w-64 h-64 bg-purple-900/10 rounded-full blur-3xl pointer-events-none"></div>
                
                <h3 class="text-2xl font-bold text-red-500 font-serif mb-6 flex items-center gap-3 relative z-10">
                    <svg class="w-8 h-8 animate-pulse-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    不可逆的湮灭
                </h3>
                
                <p class="text-slate-300 text-base leading-relaxed mb-8 relative z-10">
                    你确定要将《<span class="text-mystic-gold font-bold font-serif">{{ moduleToDelete?.title }}</span>》从现实层面彻底抹除吗？
                    <br><br>
                    <span class="text-slate-500 italic text-sm font-serif border-l-2 border-red-900/30 pl-3 block">“一旦跨越这道边界，这本典籍将永远消失在虚空之中，连残响都不会留下...”</span>
                </p>
                
                <div class="flex justify-end gap-4 relative z-10">
                    <button @click="cancelDelete" class="px-5 py-2.5 text-slate-400 hover:text-slate-200 text-sm font-bold transition-colors hover:underline decoration-slate-600 underline-offset-4">
                        我犹豫了 (Cancel)
                    </button>
                    <button @click="confirmDelete" class="px-6 py-2.5 bg-gradient-to-r from-red-950 to-red-900 hover:from-red-900 hover:to-red-800 text-red-200 border border-red-800 rounded-lg shadow-lg shadow-red-950/50 text-sm font-bold transition-all flex items-center gap-2 hover:scale-[1.02] active:scale-[0.98] group-hover:border-red-500/50">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        确认抹除 (Obliterate)
                    </button>
                </div>
            </div>
        </div>

        <!-- SQL Setup Modal -->
        <div v-if="showSqlModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm safe-pt safe-pb">
            <div class="bg-dark-900 border border-red-500/50 rounded-lg shadow-2xl max-w-2xl w-full flex flex-col max-h-[90vh] md:max-h-[80vh] animate-fade-in">
                <div class="p-6 border-b border-dark-800 flex justify-between items-center bg-red-900/10 flex-shrink-0">
                    <h3 class="text-xl font-bold text-red-400 font-serif flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        数据库未初始化
                    </h3>
                    <button @click="showSqlModal = false" class="text-slate-500 hover:text-slate-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar">
                    <p class="text-slate-300 mb-4 text-sm leading-relaxed">
                        检测到 Supabase 数据库缺少必要的表结构。这通常发生在首次连接新项目时。<br>
                        请复制以下 SQL 语句，并在 Supabase 的 <a href="https://supabase.com/dashboard/project/_/sql" target="_blank" class="text-mystic-gold hover:underline">SQL Editor</a> 中运行以修复此问题：
                    </p>
                    <div class="relative group">
                        <pre class="bg-dark-950 p-4 rounded border border-dark-700 text-xs font-mono text-slate-400 overflow-x-auto whitespace-pre-wrap select-all">{{ sqlToRun }}</pre>
                        <button @click="copyToClipboard(sqlToRun)" class="absolute top-2 right-2 p-2 bg-dark-800 text-slate-400 hover:text-white rounded border border-dark-600 hover:border-mystic-gold transition-all" title="复制 SQL">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 border-t border-dark-800 flex justify-end">
                    <button @click="showSqlModal = false" class="px-6 py-2 bg-dark-800 text-slate-300 hover:text-white border border-dark-600 rounded transition-colors">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;

        createApp({
            setup() {
                // State
                const user = reactive({ name: '游客', avatar: '', uuid: '' });
                const settings = reactive({
                    apiUrl: 'https://sta1n.zeabur.app',
                    apiKey: 'sk-DbpuLgh6XZyTyhy5yzRntgNDGlEsquBD9sxTFCFR2SMSd5A5',
                    model: 'gemini-3-pro-preview-maxthinking',
                    supabaseUrl: 'https://ghswjgxrblpdklukxjnq.supabase.co',
                    supabaseKey: 'sb_publishable_rIc2MYg6kaGIQcddDgVKYw_uLkWaY4E',
                    temperature: 1.0
                });
                
                // 默认配置 - 公益项目预设值，强制使用
                const DEFAULT_API_CONFIG = {
                    apiUrl: 'https://sta1n.zeabur.app',
                    apiKey: 'sk-DbpuLgh6XZyTyhy5yzRntgNDGlEsquBD9sxTFCFR2SMSd5A5',
                    model: 'gemini-3-pro-preview-maxthinking',
                    supabaseUrl: 'https://ghswjgxrblpdklukxjnq.supabase.co',
                    supabaseKey: 'sb_publishable_rIc2MYg6kaGIQcddDgVKYw_uLkWaY4E'
                };
                const toasts = ref([]);
                const libraryState = reactive({
                    modules: [],
                    loading: false,
                    isSummarizing: false,
                    isUploading: false,
                    isAdapting: false,
                    searchQuery: '',
                    currentSection: 'reading', // 'reading' | 'restricted'
                    showUpload: false,
                    showAlchemyTable: false,
                    uploadType: 'text',
                    uploadForm: { title: '', description: '', content: '', type: 'original', min_players: null, max_players: null },
                    alchemyForm: { content: '', result: '', title: '', description: '', isPublic: true }
                });
                const showSqlModal = ref(false);
                const showDeleteModal = ref(false);
                const moduleToDelete = ref(null);
                const sqlToRun = ref('');
                let supabaseClient = null;

                // Utils
                const showToast = (msg, type = 'info') => {
                    const id = Date.now();
                    toasts.value.push({ id, message: msg, type });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
                };

                const copyToClipboard = (text) => {
                    if (!text) return;
                    navigator.clipboard.writeText(text).then(() => showToast('已复制到剪贴板', 'success')).catch(() => showToast('复制失败', 'error'));
                };

                // Init Logic
                const loadData = () => {
                    const lUser = localStorage.getItem('coc_user');
                    if (lUser) Object.assign(user, JSON.parse(lUser));
                    
                    const lSettings = localStorage.getItem('coc_settings');
                    if (lSettings) Object.assign(settings, JSON.parse(lSettings));

                    // 强制刷新API配置为默认值（公益项目，不需要用户自己填写）
                    settings.apiUrl = DEFAULT_API_CONFIG.apiUrl;
                    settings.apiKey = DEFAULT_API_CONFIG.apiKey;
                    settings.model = DEFAULT_API_CONFIG.model;
                    settings.supabaseUrl = DEFAULT_API_CONFIG.supabaseUrl;
                    settings.supabaseKey = DEFAULT_API_CONFIG.supabaseKey;
                };

                const initSupabase = () => {
                    if (!settings.supabaseUrl || !settings.supabaseKey) return showToast('请先在主页设置 Supabase 连接', 'warning');
                    try {
                        supabaseClient = window.supabase.createClient(settings.supabaseUrl, settings.supabaseKey);
                        fetchLibraryModules();
                    } catch(e) { showToast('Supabase 连接失败', 'error'); }
                };

                // Library Functions
                const fetchLibraryModules = async () => {
                    if (!supabaseClient) return;
                    libraryState.loading = true;
                    try {
                        let query = supabaseClient.from('coc_modules').select('*').order('created_at', { ascending: false });
                        
                        // Section Filter
                        if (libraryState.currentSection === 'reading') {
                            query = query.in('type', ['original', 'reprint']);
                        } else {
                            // Fetch both public and private AI mods, filter in memory for simplicity due to RLS limitations
                            query = query.in('type', ['ai_adapt', 'ai_adapt_private']);
                        }

                        if (libraryState.searchQuery) {
                            query = query.ilike('title', `%${libraryState.searchQuery}%`);
                        }
                        
                        const { data, error } = await query;
                        if (error) throw error;
                        
                        // Post-filtering for Restricted Section
                        if (libraryState.currentSection === 'restricted') {
                            libraryState.modules = data.filter(mod => {
                                if (mod.type === 'ai_adapt') return true; // Public
                                if (mod.type === 'ai_adapt_private' && mod.author_id === user.uuid) return true; // Own private
                                return false;
                            });
                        } else {
                            libraryState.modules = data;
                        }
                    } catch (err) {
                        console.error('Library Fetch Error:', err);
                        // showToast('无法获取图书馆藏书', 'error');
                    } finally {
                        libraryState.loading = false;
                    }
                };

                const deleteModule = (mod) => {
                    moduleToDelete.value = mod;
                    showDeleteModal.value = true;
                };

                const cancelDelete = () => {
                    showDeleteModal.value = false;
                    moduleToDelete.value = null;
                };

                const confirmDelete = async () => {
                    const mod = moduleToDelete.value;
                    if (!mod) return;
                    if (!supabaseClient) return showToast('未连接服务器', 'error');
                    
                    try {
                        const { error, count } = await supabaseClient
                            .from('coc_modules')
                            .delete({ count: 'exact' })
                            .eq('id', mod.id)
                            .eq('author_id', user.uuid);

                        if (error) {
                            if (error.code === '42501' || (error.message && error.message.includes('policy'))) {
                                const fixSql = `do $$\nbegin\n  if not exists (select 1 from pg_policies where tablename = 'coc_modules' and policyname = 'Allow delete') then\n    create policy "Allow delete" on coc_modules for delete using ( true );\n  end if;\nend\n$$;`;
                                sqlToRun.value = fixSql;
                                showSqlModal.value = true;
                                throw new Error('权限不足，请运行修复 SQL');
                            }
                            throw error;
                        }

                        if (count === 0) {
                            const fixSql = `do $$\nbegin\n  if not exists (select 1 from pg_policies where tablename = 'coc_modules' and policyname = 'Allow delete') then\n    create policy "Allow delete" on coc_modules for delete using ( true );\n  end if;\nend\n$$;`;
                            sqlToRun.value = fixSql;
                            showSqlModal.value = true;
                            throw new Error('权限不足：请运行显示的 SQL 脚本以启用删除功能');
                        }
                        
                        showToast('模组已彻底湮灭', 'success');
                        libraryState.modules = libraryState.modules.filter(m => m.id !== mod.id);
                        showDeleteModal.value = false;
                        moduleToDelete.value = null;
                        
                        setTimeout(fetchLibraryModules, 1000);
                    } catch (err) {
                        console.error('Delete Error:', err);
                        showToast('抹除失败: ' + err.message, 'error');
                    }
                };

                const uploadToLibrary = async () => {
                    if (!supabaseClient) return showToast('未连接服务器', 'error');
                    if (!libraryState.uploadForm.title || !libraryState.uploadForm.content) return showToast('标题和内容不能为空', 'warning');
                    
                    libraryState.isUploading = true;
                    try {
                        // Sanitize inputs: convert empty strings to null for integer fields
                        const minP = libraryState.uploadForm.min_players === '' ? null : libraryState.uploadForm.min_players;
                        const maxP = libraryState.uploadForm.max_players === '' ? null : libraryState.uploadForm.max_players;

                        const { error } = await supabaseClient.from('coc_modules').insert({
                            title: libraryState.uploadForm.title,
                            description: libraryState.uploadForm.description,
                            content: libraryState.uploadForm.content,
                            author_name: user.name,
                            author_id: user.uuid,
                            type: libraryState.uploadForm.type || 'original',
                            min_players: minP,
                            max_players: maxP
                        });
                        
                        if (error) {
                            // Check for table missing, 404, or column missing errors (schema cache issues)
                            if (error.code === '42P01' ||
                                (error.message && (
                                    error.message.includes('404') ||
                                    error.message.includes('Could not find the table') ||
                                    error.message.includes('Could not find the') ||
                                    error.message.includes('min_players') ||
                                    error.message.includes('max_players')
                                ))) {
                                const setupSql = `-- 1. Create the table (if not exists)
create table if not exists coc_modules (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  title text not null,
  description text,
  content text not null,
  author_name text,
  author_id text,
  type text default 'original',
  downloads bigint default 0,
  min_players integer,
  max_players integer
);

-- Add columns if they don't exist (migration)
do $$
begin
  if not exists (select 1 from information_schema.columns where table_name='coc_modules' and column_name='min_players') then
    alter table coc_modules add column min_players integer;
  end if;
  if not exists (select 1 from information_schema.columns where table_name='coc_modules' and column_name='max_players') then
    alter table coc_modules add column max_players integer;
  end if;
end
$$;

-- 2. Enable RLS
alter table coc_modules enable row level security;

-- 3. Create policies (Check if they exist first to avoid errors if re-running)
do $$
begin
  if not exists (select 1 from pg_policies where tablename = 'coc_modules' and policyname = 'Public modules are viewable by everyone') then
    create policy "Public modules are viewable by everyone" on coc_modules for select using ( true );
  end if;
  
  if not exists (select 1 from pg_policies where tablename = 'coc_modules' and policyname = 'Anyone can upload modules') then
    create policy "Anyone can upload modules" on coc_modules for insert with check ( true );
  end if;

  if not exists (select 1 from pg_policies where tablename = 'coc_modules' and policyname = 'Allow delete') then
    create policy "Allow delete" on coc_modules for delete using ( true );
  end if;
end
$$;

-- 4. Create function
create or replace function increment_downloads(row_id bigint) returns void as $$
begin
  update coc_modules set downloads = downloads + 1 where id = row_id;
end;
$$ language plpgsql;`;
                                sqlToRun.value = setupSql;
                                showSqlModal.value = true;
                                throw new Error('数据库表缺失，请运行初始化脚本');
                            }
                            throw error;
                        }
                        
                        showToast('贡献成功，感谢您的慷慨！', 'success');
                        libraryState.showUpload = false;
                        libraryState.uploadForm = { title: '', description: '', content: '', type: 'original', min_players: null, max_players: null };
                        fetchLibraryModules();
                    } catch (err) {
                        console.error('Upload Error:', err);
                        const msg = err.message || JSON.stringify(err);
                        showToast('上传失败: ' + msg, 'error');
                    } finally {
                        libraryState.isUploading = false;
                    }
                };

                const useLibraryModule = async (mod, mode) => {
                    // Try to increment download count
                    if (supabaseClient) {
                        mod.downloads = (mod.downloads || 0) + 1;
                        supabaseClient.rpc('increment_downloads', { row_id: mod.id }).then(({ error }) => {
                            if (error) console.warn('Failed to increment downloads', error);
                        });
                    }
                    
                    // Store module in localStorage for main app to pick up
                    const moduleData = {
                        name: mod.title,
                        content: mod.content,
                        mode: mode // 'single' or 'multi'
                    };
                    localStorage.setItem('coc_pending_module', JSON.stringify(moduleData));
                    
                    showToast(`已借阅《${mod.title}》，正在返回...`, 'success');
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 800);
                };

                const generateModuleSummary = async (content) => {
                    if (!content || content.length < 50) return;
                    libraryState.isSummarizing = true;
                    
                    try {
                        const msgs = [
                            { role: 'system', content: '你是一个专业的跑团模组编辑。请根据用户提供的模组内容，生成一段简短、吸引人的简介（100字以内）。重点概括模组的背景、氛围和核心谜团，不要剧透关键结局。' },
                            { role: 'user', content: `请为以下模组生成简介：\n\n${content.slice(0, 5000)}` }
                        ];

                        const res = await fetch(`${settings.apiUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: msgs,
                                temperature: 0.7
                            })
                        });

                        const data = await res.json();
                        if (data.choices && data.choices[0]?.message?.content) {
                            libraryState.uploadForm.description = data.choices[0].message.content.trim();
                        }
                    } catch (e) {
                        console.error('Summary Generation Error:', e);
                    } finally {
                        libraryState.isSummarizing = false;
                    }
                };

                const handleLibraryFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    const processContent = (content) => {
                        libraryState.uploadForm.content = content;
                        if(!libraryState.uploadForm.title) libraryState.uploadForm.title = file.name.replace(/\.[^/.]+$/, "");
                        if(!libraryState.uploadForm.description) generateModuleSummary(content);
                    };

                    if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                        reader.onload = (ev) => {
                            mammoth.extractRawText({ arrayBuffer: ev.target.result })
                                .then((result) => processContent(result.value))
                                .catch((err) => showToast('无法读取 Word 文档，请确认格式', 'error'));
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        reader.onload = (ev) => processContent(ev.target.result);
                        reader.readAsText(file);
                    }
                };

                const handleAlchemyFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    const processContent = (content) => {
                        libraryState.alchemyForm.content = content;
                        showToast('炼金素材已注入', 'success');
                    };

                    if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                        reader.onload = (ev) => {
                            mammoth.extractRawText({ arrayBuffer: ev.target.result })
                                .then((result) => processContent(result.value))
                                .catch((err) => showToast('无法读取 Word 文档，请确认格式', 'error'));
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        reader.onload = (ev) => processContent(ev.target.result);
                        reader.readAsText(file);
                    }
                };

                const adaptNovelToModule = async () => {
                    const novelContent = libraryState.alchemyForm.content;
                    if (!novelContent || novelContent.length < 50) return showToast('内容太短，无法改编', 'warning');
                    
                    libraryState.isAdapting = true;
                    showToast('正在召唤灵感之源，请耐心等待...', 'info');

                    try {
                        const msgs = [
                            { role: 'system', content: `你是一位资深的 COC (Call of Cthulhu 7th Edition) 跑团模组作者。你的任务是将用户提供的小说内容或故事大纲，重构改编成一个结构完整、细节丰富且可直接用于跑团的**长篇大型 COC 战役模组书 (Campaign)**。

**核心原则（非常重要）：**
1.  **极度详尽，禁止概括**：原文非常长，但我需要你将其转化为一个**超长篇、细节极其丰富**的模组。**绝对不要**为了讲完故事而概括剧情。宁可只写完前几章的超详细内容，也不要写一个匆忙的全文大纲。
2.  **场景化写作**：对于每一个场景，**必须**包含：
    *   **念白（Boxed Text）**：一段可以直接读给玩家听的、充满氛围感的环境描写（至少150字）。
    *   **详细调查点**：将场景拆分为“书桌”、“尸体”、“书架”、“暗门”等具体交互点，每个点都要有对应的检定（Check）和发现。
    *   **NPC 互动**：保留原文中的精彩对话，转化为 RP（角色扮演）指南。
3.  **数据与机制**：不要只写剧情，要写**规则**。包括特殊机制（如san值惩罚规则）、怪物数据、物品属性。

**请严格按照以下格式输出（请输出尽可能多的字数，直到达到你的输出上限）：**

# [模组标题] - 长篇战役模组

> **简介**：[推荐人数] | [时代背景] | [预计时长：20-30小时]

## 第一部分：守秘人（KP）情报
*   **核心真相**：(详细揭示幕后黑手和神话生物的阴谋)
*   **主要 NPC 图鉴**：(包含姓名、外貌、性格、扮演建议、关键台词)

## 第二部分：模组正文（请尽可能详细地扩写以下章节）

### 第一章：[章节名]
#### 场景 1：[场景名]
*   **【念白/环境描述】**：
    > (这里请根据原文，写一段极具代入感的环境描写，包含视觉、听觉、嗅觉细节...)
*   **【探索与检定】**：
    *   **[位置A]**：
        *   **【侦查】**：...
        *   **【图书馆】**：...
    *   **[位置B]**：...
*   **【NPC 互动】**：...

#### 场景 2：[场景名]
... (以此类推，请保留原文的所有细节，不要跳过任何一个重要场景)

...

**(请一直写下去，直到达到你的输出长度极限。如果写不完，请在最后列出剩余章节的大纲)**

## 附录：数据统计
*   **NPC/怪物数据**：(STR, CON, SIZ, DEX, APP, INT, POW, EDU, HP, MP, SAN, 伤害)
` },
                            { role: 'user', content: `请依据上述规则，将以下长篇内容改编为一部宏大的 COC 战役模组书。请务必保留丰富的细节，宁可写不完也不要概括：\n\n${novelContent.slice(0, 100000)}` }
                        ];

                        const res = await fetch(`${settings.apiUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: msgs,
                                temperature: 0.8
                            })
                        });

                        const data = await res.json();
                        if (data.choices && data.choices[0]?.message?.content) {
                            const adaptedContent = data.choices[0].message.content;
                            // 将结果写入炼金写字台的结果区域
                            libraryState.alchemyForm.result = adaptedContent;
                            
                            // 尝试从内容中提取标题
                            const titleMatch = adaptedContent.match(/^#\s+(.+)$/m);
                            if (titleMatch) {
                                libraryState.alchemyForm.title = titleMatch[1].replace(/[\[\]]/g, '');
                            } else {
                                libraryState.alchemyForm.title = '炼金产物';
                            }
                            
                            showToast('炼金重构完成！请在右侧查看并编辑结果。', 'success');
                        } else {
                            throw new Error('API 返回数据为空');
                        }
                    } catch (e) {
                        console.error('Adaptation Error:', e);
                        showToast('改编失败: ' + e.message, 'error');
                    } finally {
                        libraryState.isAdapting = false;
                    }
                };

                const exportModuleToWord = (mod) => {
                    try {
                        const htmlContent = marked.parse(mod.content);
                        const docHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body { font-family: 'SimSun', 'Times New Roman', serif; line-height: 1.5; } h1 { font-size: 24pt; color: #2e74b5; text-align: center; margin-bottom: 20px; } h2 { font-size: 18pt; color: #1f4d78; border-bottom: 1px solid #1f4d78; padding-bottom: 5px; margin-top: 20px; } h3 { font-size: 14pt; color: #1f4d78; margin-top: 15px; } p { font-size: 12pt; margin-bottom: 10px; text-align: justify; } ul, ol { margin-bottom: 10px; } li { margin-bottom: 5px; } strong { color: #b7950b; } blockquote { border-left: 4px solid #5e8d83; padding-left: 10px; color: #555; font-style: italic; background-color: #f9f9f9; } table { border-collapse: collapse; width: 100%; margin-bottom: 15px; } th, td { border: 1px solid #ccc; padding: 8px; text-align: left; } th { background-color: #e9ecef; }</style></head><body><h1>${mod.title}</h1><p style="text-align: center; color: #666; font-size: 10pt;">作者：${mod.author_name || '佚名'} | 来源：Zarkto's Table</p><hr/>${htmlContent}</body></html>`;
                        const converted = htmlDocx.asBlob(docHtml);
                        saveAs(converted, `${mod.title}.docx`);
                        showToast('导出成功', 'success');
                    } catch (e) {
                        console.error('Export Error:', e);
                        showToast('导出失败: ' + e.message, 'error');
                    }
                };

                const exportAlchemyResult = () => {
                    if (!libraryState.alchemyForm.result) return showToast('没有可导出的内容', 'warning');
                    
                    const tempMod = {
                        title: libraryState.alchemyForm.title || '炼金产物',
                        author_name: user.name,
                        content: libraryState.alchemyForm.result
                    };
                    exportModuleToWord(tempMod);
                };

                const uploadAlchemyResult = async () => {
                    if (!supabaseClient) return showToast('未连接服务器', 'error');
                    if (!libraryState.alchemyForm.result) return showToast('没有可入库的内容', 'warning');
                    
                    libraryState.isUploading = true;
                    const finalTitle = libraryState.alchemyForm.title || '未命名炼金产物';
                    
                    try {
                        const { error } = await supabaseClient.from('coc_modules').insert({
                            title: finalTitle,
                            description: libraryState.alchemyForm.description || '由扎克托的炼金写字台重构生成',
                            content: libraryState.alchemyForm.result,
                            author_name: user.name,
                            author_id: user.uuid,
                            type: libraryState.alchemyForm.isPublic ? 'ai_adapt' : 'ai_adapt_private'
                        });
                        
                        if (error) throw error;
                        
                        showToast('炼金产物已成功入库！', 'success');
                        libraryState.showAlchemyTable = false;
                        // Reset form
                        libraryState.alchemyForm = { content: '', result: '', title: '', description: '', isPublic: true };
                        fetchLibraryModules();
                    } catch (err) {
                        console.error('Alchemy Upload Error:', err);
                        showToast('入库失败: ' + err.message, 'error');
                    } finally {
                        libraryState.isUploading = false;
                    }
                };

                onMounted(() => {
                    loadData();
                    initSupabase();
                });

                return {
                    user, libraryState, toasts, showSqlModal, sqlToRun,
                    fetchLibraryModules, uploadToLibrary, handleLibraryFileUpload, handleAlchemyFileUpload, useLibraryModule,
                    adaptNovelToModule, exportModuleToWord, copyToClipboard, generateModuleSummary,
                    uploadAlchemyResult, exportAlchemyResult, deleteModule, confirmDelete, cancelDelete,
                    showDeleteModal, moduleToDelete
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
