<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zarkto's Table - TRPG</title>
    <!-- å¼•å…¥è¡¬çº¿å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Noto Serif SC"', 'SimSun', 'Songti SC', 'serif'],
                        sans: ['"Noto Serif SC"', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            950: '#020617', 900: '#0a0f1e', 850: '#141b2d', 800: '#1e293b', 700: '#334155',
                        },
                        mystic: {
                            gold: '#d4af37', gold_dim: '#8a7120', green: '#2d6a4f', teal: '#115e59', red: '#8a1c1c', purple: '#581c87',
                        }
                    },
                    boxShadow: {
                        'glow-gold': '0 0 15px rgba(212, 175, 55, 0.15)',
                        'glow-green': '0 0 15px rgba(45, 106, 79, 0.2)',
                        'inner-glow': 'inset 0 0 20px rgba(0,0,0,0.5)',
                    },
                    backgroundImage: {
                        'void-noise': "url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22 opacity=%220.07%22/%3E%3C/svg%3E')",
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'fade-in-bg': 'fadeInBg 2s ease-out forwards',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'message-in': 'messageIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeInBg: { '0%': { opacity: '0' }, '100%': { opacity: '0.05' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        messageIn: { '0%': { transform: 'translateY(15px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } },
                    }
                }
            }
        }
    </script>
    <style>
        html, body { -webkit-text-size-adjust: 100%; height: 100%; height: 100dvh; overflow: hidden; background-color: #020617; color: #cbd5e1; font-family: 'Noto Serif SC', serif; }
        body::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 50; opacity: 0.4; }
        [v-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; border-left: 1px solid #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border: 1px solid #0f172a; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; border-color: #d4af37; }
        .text-shadow-gold { text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
        .text-shadow-red { text-shadow: 0 0 10px rgba(138, 28, 28, 0.4); }
        .markdown-body { font-size: 0.9375rem; line-height: 1.65; color: #e2e8f0; font-family: 'Noto Serif SC', serif; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; }
        @media (min-width: 768px) { .markdown-body { font-size: 0.95rem; line-height: 1.7; } }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body strong { font-weight: 700; color: #c0a062; }
        .markdown-body blockquote { border-left: 2px solid #2d6a4f; padding-left: 1em; color: #94a3b8; font-style: italic; background: rgba(0,0,0,0.2); padding: 0.5em 1em; }
        .markdown-body code { background-color: #1e293b; padding: 0.1em 0.3em; border-radius: 0.2em; font-family: monospace; font-size: 0.9em; color: #c0a062; border: 1px solid #334155; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin-bottom: 0.8em; list-style-type: disc; }
        .markdown-body ol { list-style-type: decimal; }
        .markdown-body li { margin-bottom: 0.3em; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: #c0a062; font-family: 'Noto Serif SC', serif; margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; }
        .markdown-body h1 { font-size: 1.5em; border-bottom: 1px solid #334155; padding-bottom: 0.2em; }
        .markdown-body h2 { font-size: 1.3em; }
        .typing-indicator { display: flex; align-items: center; gap: 4px; }
        .typing-indicator span { display: block; width: 4px; height: 4px; background-color: #5eead4; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
        .list-enter-active, .list-leave-active { transition: all 0.4s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(-20px); }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .nav-active { background: linear-gradient(90deg, rgba(20, 184, 166, 0.15) 0%, transparent 100%); border-left: 3px solid #14b8a6; color: #ccfbf1; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .cot-wrapper { border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 0.5rem; overflow: hidden; background: rgba(2, 6, 23, 0.3); margin-bottom: 1rem; }
        .cot-header { padding: 0.5rem 0.75rem; background: rgba(30, 41, 59, 0.4); cursor: pointer; font-size: 0.75rem; color: #64748b; display: flex; align-items: center; justify-content: space-between; user-select: none; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; border-bottom: 1px solid transparent; transition: all 0.2s; }
        .cot-header:hover { background: rgba(30, 41, 59, 0.6); color: #94a3b8; }
        .cot-header.active { border-bottom-color: rgba(148, 163, 184, 0.1); }
        .cot-content { padding: 1rem; background: rgba(15, 23, 42, 0.4); font-size: 0.85rem; color: #94a3b8; font-family: 'Noto Serif SC', serif; line-height: 1.6; }
        .cot-content ul { list-style: none; padding-left: 1rem; margin: 0; position: relative; }
        .medal-icon { filter: drop-shadow(0 0 5px rgba(212, 175, 55, 0.3)); transition: transform 0.3s; }
        .medal-icon:hover { transform: scale(1.1) rotate(5deg); }
        .cot-content ul li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .cot-content ul li::before { content: ""; position: absolute; left: 0; top: 0.7em; width: 1rem; height: 1px; background-color: #475569; opacity: 0.5; }
        .cot-content ul li::after { content: ""; position: absolute; left: 0; top: -0.6em; bottom: 0; width: 1px; background-color: #475569; opacity: 0.5; }
        .cot-content ul li:last-child::after { height: 1.3em; }
        .cot-content > ul > li:first-child::after { top: 0.7em; height: calc(100% - 0.7em); }
        .cot-content code { background: rgba(0,0,0,0.3); color: #e2e8f0; padding: 0.1em 0.3em; border-radius: 0.2em; font-size: 0.9em; }
    </style>
</head>
<body class="selection:bg-teal-900 selection:text-teal-100">
    <div id="app" v-cloak class="h-full flex flex-col md:flex-row relative bg-dark-950 text-slate-300">
        
        <!-- Toast Notification -->
        <div class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[1000] flex flex-col gap-2 pointer-events-none items-center w-full max-w-sm px-4 safe-pt">
            <transition-group name="list" tag="div" class="flex flex-col items-center w-full">
                <div v-for="toast in toasts" :key="toast.id"
                     class="pointer-events-auto flex items-center px-4 py-3 rounded-xl shadow-2xl border bg-dark-900/95 backdrop-blur-md text-sm font-medium w-full"
                     :class="{ 'border-mystic-green/50 text-mystic-green': toast.type === 'success', 'border-mystic-red/50 text-red-400': toast.type === 'error', 'border-blue-500/50 text-blue-400': toast.type === 'info', 'border-mystic-gold/50 text-mystic-gold': toast.type === 'warning' }">
                    <span class="flex-1">{{ toast.message }}</span>
                </div>
            </transition-group>
        </div>

        <!-- Custom Confirm Modal -->
        <div v-if="confirmState.show" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in safe-pt safe-pb">
            <div class="bg-dark-900 border border-mystic-gold/50 rounded-lg shadow-[0_0_30px_rgba(212,175,55,0.15)] max-w-sm w-full flex flex-col relative overflow-hidden transform transition-all scale-100">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-mystic-gold to-transparent opacity-50"></div>
                <div class="p-6">
                    <h3 class="text-xl font-bold text-mystic-gold font-serif mb-3 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        {{ confirmState.title || 'ç¡®è®¤æ“ä½œ' }}
                    </h3>
                    <p class="text-slate-300 text-sm leading-relaxed mb-6 font-serif">{{ confirmState.message }}</p>
                    <div class="flex justify-end gap-3">
                        <button @click="confirmState.resolve(false); confirmState.show = false" class="px-4 py-2 text-slate-400 hover:text-slate-200 text-sm font-bold transition-colors">{{ confirmState.cancelText || 'å–æ¶ˆ' }}</button>
                        <button @click="confirmState.resolve(true); confirmState.show = false" class="px-6 py-2 bg-mystic-gold text-dark-950 font-bold rounded shadow-lg hover:bg-yellow-600 transition-all text-sm uppercase tracking-wide">{{ confirmState.confirmText || 'ç¡®å®š' }}</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settlement Modal -->
        <div v-if="settlementState.show" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-fade-in safe-pt safe-pb">
            <div class="bg-dark-900 border border-mystic-gold/50 rounded-xl shadow-[0_0_50px_rgba(212,175,55,0.2)] max-w-2xl w-full flex flex-col relative overflow-hidden max-h-[90vh]">
                <div class="p-6 border-b border-dark-800 bg-gradient-to-r from-mystic-gold/10 to-transparent flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-mystic-gold font-serif flex items-center gap-3">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        ç»“å›¢å¥–åŠ±ç»“ç®—
                    </h3>
                    <button @click="settlementState.show = false" class="text-slate-500 hover:text-slate-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-8">
                    <div v-if="settlementState.step === 1" class="space-y-6 animate-slide-up">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">æ¨¡ç»„åç§°</label>
                            <input v-model="settlementState.moduleName" class="w-full bg-dark-950 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-mystic-gold outline-none">
                        </div>
                        <div class="p-4 bg-dark-800/50 rounded border border-dark-700">
                            <h4 class="text-sm font-bold text-mystic-green mb-4 flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> SAN å€¼å›å¤</h4>
                            <div class="flex gap-4 items-center">
                                <input v-model="settlementState.sanRewardExpr" placeholder="1d6" class="w-24 bg-dark-950 border border-dark-700 rounded px-3 py-2 text-center font-mono text-slate-300 focus:border-mystic-green outline-none">
                                <button @click="rollSanReward" class="px-4 py-2 bg-mystic-green/20 text-mystic-green border border-mystic-green/30 rounded font-bold text-xs hover:bg-mystic-green/30 transition-all">ğŸ² æŠ•æ·</button>
                                <div class="flex-1 text-right"><span class="text-xs text-slate-500 mr-2">å›å¤é‡:</span><span class="text-2xl font-bold text-mystic-green font-mono">{{ settlementState.sanRewardVal }}</span></div>
                            </div>
                        </div>
                        <div class="p-4 bg-dark-800/50 rounded border border-dark-700">
                            <h4 class="text-sm font-bold text-mystic-gold mb-4 flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> æŠ€èƒ½æˆé•¿æ£€å®š</h4>
                            <p class="text-xs text-slate-500 mb-3">è¯·å‹¾é€‰æœ¬æ¬¡æ¨¡ç»„ä¸­æˆåŠŸä½¿ç”¨è¿‡çš„æŠ€èƒ½ï¼š</p>
                            <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1">
                                <label v-for="skill in cocState.investigators[cocState.activeInvestigatorIndex].skills" :key="skill.name" class="cursor-pointer px-3 py-1.5 rounded border text-xs transition-all select-none flex items-center gap-2" :class="settlementState.selectedSkills.includes(skill.name) ? 'bg-mystic-gold text-dark-950 border-mystic-gold font-bold' : 'bg-dark-950 text-slate-400 border-dark-700 hover:border-slate-500'">
                                    <input type="checkbox" v-model="settlementState.selectedSkills" :value="skill.name" class="hidden"> {{ skill.name }} ({{ skill.value }})
                                </label>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">ç‰¹æ®Šå¥–åŠ± (ç‰©å“/äººè„‰)</label><textarea v-model="settlementState.specialReward" rows="3" class="w-full bg-dark-950 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-mystic-gold outline-none resize-none text-sm"></textarea></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">å±¥å†æ‘˜è¦</label><textarea v-model="settlementState.historyLog" rows="3" class="w-full bg-dark-950 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-mystic-gold outline-none resize-none text-sm"></textarea></div>
                        </div>
                        <div class="p-4 bg-dark-800/50 rounded border border-dark-700 flex gap-4 items-center">
                            <div class="w-12 h-12 bg-dark-950 rounded-full border border-mystic-gold/30 flex items-center justify-center text-2xl cursor-pointer hover:bg-dark-900 relative"><input v-model="settlementState.badge.icon" class="w-full h-full text-center bg-transparent outline-none cursor-pointer" title="è¾“å…¥Emoji"></div>
                            <div class="flex-1 space-y-2">
                                <input v-model="settlementState.badge.name" placeholder="å‹‹ç« åç§° (å¦‚: å¹¸å­˜è€…)" class="w-full bg-dark-950 border-b border-dark-700 px-2 py-1 text-sm text-mystic-gold font-bold focus:border-mystic-gold outline-none">
                                <input v-model="settlementState.badge.desc" placeholder="å‹‹ç« æè¿°" class="w-full bg-transparent px-2 py-1 text-xs text-slate-500 outline-none">
                            </div>
                        </div>
                    </div>
                    <div v-if="settlementState.step >= 2" class="space-y-4 animate-fade-in">
                        <div v-if="settlementState.isRolling" class="text-center py-10"><div class="typing-indicator justify-center mb-4"><span></span><span></span><span></span></div><p class="text-mystic-gold font-serif">å‘½è¿ä¹‹è½®æ­£åœ¨è½¬åŠ¨...</p></div>
                        <div v-else class="space-y-2">
                            <div v-for="res in settlementState.skillGrowths" :key="res.name" class="flex items-center justify-between p-3 rounded border" :class="res.success ? 'bg-mystic-green/10 border-mystic-green/30' : 'bg-dark-950 border-dark-700 opacity-60'">
                                <div class="font-bold text-slate-200">{{ res.name }}</div>
                                <div class="flex items-center gap-4 text-sm font-mono"><span class="text-slate-500">1d100={{ res.checkVal }} / {{ res.oldVal }}</span><span :class="res.success ? 'text-mystic-green font-bold' : 'text-slate-600'">{{ res.success ? 'æˆé•¿æˆåŠŸ' : 'æˆé•¿å¤±è´¥' }}</span><div v-if="res.success" class="flex items-center gap-1 text-mystic-gold font-bold"><span>+{{ res.growth }}</span><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg><span>{{ res.newVal }}</span></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-dark-800 bg-dark-900/80 flex justify-between items-center">
                    <div class="text-xs text-slate-500"><span v-if="settlementState.step === 1">ç¬¬ä¸€æ­¥ï¼šè¾“å…¥å¥–åŠ±ä¸é€‰æ‹©æŠ€èƒ½</span><span v-if="settlementState.step === 2">ç¬¬äºŒæ­¥ï¼šæˆé•¿æ£€å®š</span><span v-if="settlementState.step === 3">ç¬¬ä¸‰æ­¥ï¼šç¡®è®¤ç»“æœ</span></div>
                    <div class="flex gap-3">
                        <button v-if="settlementState.step === 1" @click="processSkillGrowth" class="px-6 py-2 bg-mystic-gold text-dark-950 font-bold rounded shadow-lg hover:bg-yellow-600 transition-all text-sm">å¼€å§‹æ£€å®š</button>
                        <div v-else-if="settlementState.step === 3" class="flex gap-2">
                            <button @click="exportCurrentInvestigatorJSON" class="px-4 py-2 border border-dark-600 text-slate-400 rounded hover:text-slate-200 hover:border-slate-400 transition-all text-xs font-bold uppercase tracking-wider">å¯¼å‡º JSON</button>
                            <button @click="exportCurrentInvestigatorPNG" class="px-4 py-2 border border-mystic-gold/30 text-mystic-gold rounded hover:bg-mystic-gold/10 transition-all text-xs font-bold uppercase tracking-wider">å¯¼å‡º PNG</button>
                            <button @click="confirmSettlement" class="px-6 py-2 bg-mystic-green text-teal-100 font-bold rounded shadow-lg hover:bg-teal-700 transition-all text-sm">ç¡®è®¤æ›´æ–°è§’è‰²å¡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Sidebar Overlay -->
        <div v-if="showMobileMenu" @click="showMobileMenu = false" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-20 md:hidden transition-opacity"></div>

        <!-- Sidebar -->
        <div :class="['fixed inset-y-0 left-0 z-30 w-72 bg-dark-900 border-r border-dark-800 transform transition-transform duration-300 md:relative md:translate-x-0 flex flex-col shadow-2xl bg-void-noise', showMobileMenu ? 'translate-x-0' : '-translate-x-full']">
            <div class="h-24 flex items-center px-6 border-b border-dark-800 bg-dark-950/50 backdrop-blur-sm relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-b from-mystic-gold/5 to-transparent pointer-events-none"></div>
                <div class="font-bold text-xl text-mystic-gold flex items-center tracking-wider relative z-10 text-shadow-gold">
                    <svg class="w-8 h-8 mr-3 text-mystic-gold animate-pulse-slow" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8 c0-4.41,3.59-8,8-8s8,3.59,8,8C20,16.41,16.41,20,12,20z M12,6c-3.31,0-6,2.69-6,6c0,1.36,0.46,2.61,1.23,3.62l1.46-1.46 C8.26,13.61,8,12.84,8,12c0-2.21,1.79-4,4-4s4,1.79,4,4c0,0.84-0.26,1.61-0.69,2.16l1.46,1.46C17.54,14.61,18,13.36,18,12 C18,8.69,15.31,6,12,6z M12,10c-1.1,0-2,0.9-2,2c0,0.55,0.22,1.05,0.59,1.41l2.83-2.83C13.05,10.22,12.55,10,12,10z"/></svg>
                    <div class="flex flex-col"><span class="leading-none">Call of</span><span class="text-2xl leading-none font-serif">Cthulhu</span></div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto py-6 px-4 space-y-3">
                <button @click="currentView = 'chat'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'chat' ? 'bg-mystic-green/10 border-mystic-green/40 text-mystic-green shadow-glow-green' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-mystic-green/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    <span class="relative z-10">è†å¬ä½è¯­</span>
                </button>
                <button @click="if(cocState.gameState !== 'playing') { currentView = 'coc'; showMobileMenu = false; }" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'coc' ? 'bg-mystic-gold/10 border-mystic-gold/40 text-mystic-gold shadow-glow-gold' : (cocState.gameState === 'playing' ? 'opacity-50 cursor-not-allowed text-slate-600 border-transparent' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700')]">
                    <div class="absolute inset-0 bg-gradient-to-r from-mystic-gold/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="relative z-10">ä»ªå¼å‡†å¤‡</span>
                </button>
                <button @click="currentView = 'saves'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'saves' ? 'bg-indigo-900/20 border-indigo-500/30 text-indigo-400' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-indigo-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    <span class="relative z-10">è®°å¿†å›å»Š</span>
                </button>
                <button @click="currentView = 'tavern'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'tavern' ? 'bg-amber-900/20 border-amber-500/30 text-amber-400' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-amber-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    <span class="relative z-10">å¼‚é—»é…’é¦†</span>
                </button>
                <button @click="currentView = 'friends'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'friends' ? 'bg-blue-900/20 border-blue-500/30 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                    <span class="relative z-10">æ”¶éŸ³æœºè°ƒé¢‘</span>
                </button>
                <button @click="openCocCard" class="w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700">
                    <div class="absolute inset-0 bg-gradient-to-r from-mystic-purple/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0c0 .884-.5 2-2 2h4c-1.5 0-2-1.116-2-2z"></path></svg>
                    <span class="relative z-10">è°ƒæŸ¥å‘˜æ¡£æ¡ˆ</span>
                </button>
                <button @click="openLibrary" class="w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    <span class="relative z-10">å¯†å¤§å›¾ä¹¦é¦†</span>
                </button>
            </div>

            <div class="p-4 border-t border-dark-800 bg-dark-950/50 cursor-pointer hover:bg-dark-800 transition-colors group safe-pb" @click="currentView = 'settings'; showMobileMenu = false">
                <div class="flex items-center" v-if="cocState.gameState === 'playing' && cocState.activeInvestigatorIndex !== -1 && cocState.investigators[cocState.activeInvestigatorIndex]">
                    <div class="w-10 h-10 rounded-full overflow-hidden shadow-lg ring-2 ring-mystic-gold/50">
                        <img v-if="cocState.investigators[cocState.activeInvestigatorIndex].avatar" :src="cocState.investigators[cocState.activeInvestigatorIndex].avatar" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full bg-dark-800 flex items-center justify-center text-mystic-gold font-bold font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].name.charAt(0) }}</div>
                    </div>
                    <div class="ml-3 overflow-hidden">
                        <div class="text-sm font-bold text-mystic-gold truncate font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].name }}</div>
                        <div class="text-xs text-slate-500 truncate font-mono">æ‰®æ¼”ä¸­...</div>
                    </div>
                </div>
                <div class="flex items-center" v-else>
                    <div class="w-10 h-10 rounded-full overflow-hidden shadow-lg ring-2 ring-dark-700">
                        <img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover grayscale-[30%]">
                        <div v-else class="w-full h-full bg-dark-800 flex items-center justify-center text-mystic-gold font-bold border border-dark-700">{{ user.name.charAt(0).toUpperCase() }}</div>
                    </div>
                    <div class="ml-3 overflow-hidden">
                        <div class="text-sm font-bold text-slate-300 truncate">{{ user.name }}</div>
                        <div class="text-xs text-slate-500 truncate font-mono">{{ user.uuid ? 'ID: ' + user.uuid.slice(0,6) + '...' : 'æ¸¸å®¢' }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Broadcast Modal (Zarkto's Old Broadcast) -->
        <div v-if="showBroadcast" class="fixed inset-0 z-[300] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
            <div class="bg-dark-900 border border-mystic-gold/50 rounded-xl shadow-[0_0_50px_rgba(212,175,55,0.15)] max-w-lg w-full flex flex-col relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-mystic-gold/10 to-transparent pointer-events-none"></div>
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-mystic-gold/5 rounded-full blur-3xl pointer-events-none"></div>
                
                <div class="p-6 md:p-8 relative z-10">
                    <h3 class="text-2xl font-bold text-mystic-gold font-serif mb-2 flex items-center gap-3">
                        <svg class="w-8 h-8 animate-pulse-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                        æ‰å…‹æ‰˜çš„æ—§æ—¥å¹¿æ’­
                    </h3>
                    <div class="text-xs text-slate-500 font-mono mb-6 uppercase tracking-widest border-b border-dark-700 pb-2 flex justify-between">
                        <span>Frequency: 192.8 MHz</span>
                        <span>Ver 2.0 Beta</span>
                    </div>
                    
                    <div class="prose prose-invert prose-sm max-w-none text-slate-300 font-serif leading-relaxed mb-6 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                        <p>æ¬¢è¿æ¥åˆ° <strong>Zarkto's Table</strong> (Ver 2.0 Beta)ã€‚</p>
                        <p class="text-mystic-gold font-bold">æˆ‘ä»¬è¿æ¥äº†é‡å¤§æ›´æ–°ï¼æ›´æ™ºèƒ½çš„ AIï¼Œæ›´ä¸°å¯Œçš„å™äº‹ä½“éªŒã€‚</p>
                        <p>æœ¬æ¬¡æ›´æ–°äº®ç‚¹ï¼š</p>
                        <ul class="list-disc pl-4 space-y-1 marker:text-mystic-gold">
                            <li><strong>AI é˜Ÿå‹å…¨é¢è¿›åŒ–</strong>ï¼š
                                <ul class="list-none pl-2 text-xs text-slate-400 mt-1 space-y-1 border-l border-dark-700">
                                    <li>â€¢ <strong>å•äººæ‰˜ç®¡</strong>ï¼šç‹¬è‡ªè·‘å›¢å¤ªå­¤å•ï¼Ÿç°åœ¨å•äººæ¨¡å¼ä¹Ÿå¯å¼€å¯ AI é˜Ÿå‹æ‰˜ç®¡ï¼Œä¸æ‚¨å¹¶è‚©ä½œæˆ˜ã€‚</li>
                                    <li>â€¢ <strong>æ—¶å…‰å›æº¯</strong>ï¼šé˜Ÿå‹æ“ä½œä¸æ»¡æ„ï¼Ÿæ–°å¢â€œé‡æˆâ€åŠŸèƒ½ï¼Œå›æº¯å‰§æƒ…ï¼Œè®© AI é‡æ–°æ€è€ƒæœ€ä½³è¡ŒåŠ¨ã€‚</li>
                                </ul>
                            </li>
                            <li><strong>å¼‚é—»é…’é¦†å¼€ä¸š</strong>ï¼šå°†æ‚¨çš„è·‘å›¢è®°å½•ä¸€é”®æ”¹ç¼–ä¸ºç²¾å½©å°è¯´ï¼æ”¯æŒå¤šç§æ–‡é£ï¼ˆæ´›å¤«å…‹æ‹‰å¤«ç‰¹å¼ã€ç°ä»£æƒŠæ‚šç­‰ï¼‰ä¸è§†è§’åˆ‡æ¢ã€‚</li>
                            <li><strong>ä½“éªŒå‡çº§</strong>ï¼šä¼˜åŒ–äº†ç»“å›¢å¥–åŠ±ç»“ç®—æµç¨‹ï¼Œä¿®å¤äº†å¤šå¤„æ—¶ç©ºè£‚éš™ï¼ˆBugï¼‰ã€‚</li>
                        </ul>
                        <div class="mt-4 pt-4 border-t border-dark-800">
                            <p class="mb-2 font-bold text-slate-200">æ ¸å¿ƒåŠŸèƒ½ä¸€è§ˆï¼š</p>
                            <ul class="list-disc pl-4 space-y-1 marker:text-mystic-gold text-xs">
                                <li><strong>è†å¬ä½è¯­</strong>ï¼šæ²‰æµ¸å¼è·‘å›¢å¯¹è¯ã€‚</li>
                                <li><strong>ä»ªå¼å‡†å¤‡</strong>ï¼šæ¨¡ç»„å¯¼å…¥ä¸è°ƒæŸ¥å‘˜ç®¡ç†ã€‚</li>
                                <li><strong>è®°å¿†å›å»Š</strong>ï¼šäº‘ç«¯/æœ¬åœ°å­˜æ¡£ç®¡ç†ã€‚</li>
                                <li><strong>å¯†å¤§å›¾ä¹¦é¦†</strong>ï¼šæŸ¥é˜…è§„åˆ™ä¸æ¨¡ç»„ï¼ˆå¼€å‘ä¸­ï¼‰ã€‚</li>
                            </ul>
                        </div>
                        <div class="mt-6 p-4 bg-mystic-gold/5 border border-mystic-gold/20 rounded-lg text-xs text-mystic-gold/80">â€œæ—§æ—¥æ”¯é…è€…çš„ä½è¯­æ„ˆå‘æ¸…æ™°... äº«å—æ‚¨çš„æ¸¸æˆã€‚â€</div>
                        <div class="mt-4 text-xs text-slate-500 font-serif italic text-right">
                            <p>æœ¬ç½‘ç«™ç”± <strong>Z4RKTO</strong> å’Œ <strong>STA1N</strong> å…±åŒå¼€å‘ã€‚</p>
                            <p>ç‰¹åˆ«é¸£è°¢ <strong>STA1N</strong>ï¼Œä»–è´Ÿè´£åç«¯å’Œè¯¸å¤šé¡¹ç›®çš„å¼€å‘ä¸ä¼˜åŒ–ã€‚</p>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-4 border-t border-dark-700">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" v-model="dontShowBroadcast" class="checkbox checkbox-xs border-slate-600 checked:border-mystic-gold checked:bg-mystic-gold rounded-sm transition-all" />
                            <span class="text-xs text-slate-500 group-hover:text-slate-300 transition-colors select-none">ä¸å†æ”¶å¬æ­¤é¢‘æ®µ</span>
                        </label>
                        <button @click="closeBroadcast" class="px-6 py-2 bg-mystic-gold hover:bg-yellow-600 text-dark-900 font-bold rounded shadow-lg shadow-mystic-gold/20 transition-all text-sm font-serif">å…³é—­é€šè®¯</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden relative bg-black/20">
            <div class="absolute inset-0 pointer-events-none overflow-hidden flex items-center justify-center animate-fade-in-bg">
                <svg class="w-[800px] h-[800px] text-mystic-gold animate-pulse-slow" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8 c0-4.41,3.59-8,8-8s8,3.59,8,8C20,16.41,16.41,20,12,20z M12,6c-3.31,0-6,2.69-6,6c0,1.36,0.46,2.61,1.23,3.62l1.46-1.46 C8.26,13.61,8,12.84,8,12c0-2.21,1.79-4,4-4s4,1.79,4,4c0,0.84-0.26,1.61-0.69,2.16l1.46,1.46C17.54,14.61,18,13.36,18,12 C18,8.69,15.31,6,12,6z M12,10c-1.1,0-2,0.9-2,2c0,0.55,0.22,1.05,0.59,1.41l2.83-2.83C13.05,10.22,12.55,10,12,10z"/></svg>
            </div>
            
            <!-- Mobile Header -->
            <div v-if="cocState.gameState !== 'playing' || currentView !== 'chat'" class="md:hidden min-h-14 py-2 bg-dark-900 border-b border-dark-800 flex items-center justify-between px-4 z-10 flex-shrink-0 safe-pt">
                <button @click="showMobileMenu = !showMobileMenu" class="text-slate-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button>
                <div class="font-bold text-mystic-gold font-serif tracking-wider truncate mx-2">{{ getPageTitle() }}</div>
                <div class="w-6"></div>
            </div>

            <!-- Views -->
            <!-- 1. Chat View (New) -->
            <div v-if="currentView === 'chat'" class="flex-1 flex flex-col h-full bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                <div v-if="cocState.gameState !== 'playing'" class="flex-1 flex items-center justify-center text-slate-500 font-serif italic">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 text-dark-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        <p>æš‚æ— è¿›è¡Œä¸­çš„è·‘å›¢ä¼šè¯</p>
                        <button @click="currentView = 'coc'" class="mt-4 px-4 py-2 bg-dark-800 border border-dark-600 rounded hover:border-mystic-gold hover:text-mystic-gold transition-colors text-sm">å‰å¾€ä»ªå¼å‡†å¤‡</button>
                    </div>
                </div>
                <div v-else class="flex-1 flex flex-col h-full overflow-hidden relative">
                        <!-- Game Header -->
                        <div class="min-h-16 py-2 bg-dark-950/80 backdrop-blur-md border-b border-dark-800 flex items-center justify-between px-4 md:px-6 z-10 shadow-2xl flex-shrink-0 relative safe-pt">
                            <div class="absolute inset-0 bg-gradient-to-r from-mystic-gold/5 via-transparent to-transparent pointer-events-none"></div>
                            <div class="flex items-center gap-4 overflow-hidden relative z-10">
                                <button @click="showMobileMenu = !showMobileMenu" class="md:hidden text-slate-400 flex-shrink-0 hover:text-mystic-gold transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button>
                                <div class="flex flex-col">
                                    <div class="text-[10px] text-mystic-gold/60 uppercase tracking-[0.2em] font-bold">å½“å‰æ¨¡ç»„</div>
                                    <div class="font-bold text-mystic-gold truncate max-w-[200px] md:max-w-[400px] font-serif tracking-wide text-lg text-shadow-gold">{{ cocState.module?.name || 'æœªå‘½åæ¨¡ç»„' }}</div>
                                </div>
                                <!-- Player Preview (Top Bar) -->
                                <div v-if="cocState.mode === 'multi' && multiplayerState.members.length > 0" class="hidden md:flex items-center -space-x-2 ml-6 border-l border-dark-700 pl-6 py-1">
                                    <div v-for="member in multiplayerState.members" :key="member.id" class="w-8 h-8 rounded-full border-2 bg-dark-800 overflow-hidden relative group cursor-help transition-all z-0 hover:z-10 hover:scale-110" :class="member.isHost ? 'border-mystic-gold shadow-[0_0_8px_rgba(212,175,55,0.6)] z-10' : 'border-slate-400'" :title="member.name + (member.isHost ? ' (æˆ¿ä¸»)' : '')">
                                        <img v-if="member.avatar" :src="member.avatar" class="w-full h-full object-cover">
                                        <div v-else class="w-full h-full flex items-center justify-center text-xs font-bold text-slate-500">{{ member.name.charAt(0) }}</div>
                                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full border-2 border-dark-950" :class="member.isReady || member.isHost ? 'bg-mystic-green' : 'bg-slate-500'"></div>
                                    </div>
                                    <div v-if="multiplayerState.members.length > 5" class="w-8 h-8 rounded-full border-2 border-slate-400 bg-dark-800 flex items-center justify-center text-[10px] text-slate-400 font-bold">+{{ multiplayerState.members.length - 5 }}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 relative z-10">
                                <!-- Room ID Display (Multiplayer Only) -->
                                <div v-if="cocState.mode === 'multi'" class="hidden md:flex items-center gap-2 mr-2 px-3 py-1.5 rounded border border-dark-700 bg-dark-900/50 cursor-pointer hover:bg-dark-800 hover:border-mystic-gold/30 transition-all group" @click="copyToClipboard(multiplayerState.roomId)" title="ç‚¹å‡»å¤åˆ¶æˆ¿é—´å·">
                                    <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">æˆ¿é—´å·</span>
                                    <span class="text-xs text-mystic-gold font-mono font-bold">{{ multiplayerState.roomId }}</span>
                                    <svg class="w-3 h-3 text-slate-600 group-hover:text-mystic-gold transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                </div>
                                <button @click="showMobileRightSidebar = !showMobileRightSidebar" class="md:hidden p-2 text-slate-400 hover:text-mystic-gold transition-colors rounded-lg border border-transparent hover:border-dark-700 hover:bg-dark-800"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></button>
                                <button v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" @click="saveGame" class="group flex items-center gap-2 px-3 py-1.5 rounded border border-indigo-900/30 bg-indigo-900/10 hover:bg-indigo-900/20 hover:border-indigo-500/50 transition-all mr-2">
                                    <span class="text-[10px] text-indigo-400 group-hover:text-indigo-300 uppercase font-bold tracking-widest">ä¿å­˜</span>
                                    <svg class="w-3 h-3 text-indigo-500/70 group-hover:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                                </button>
                                <button @click="exitCocGame" class="group flex items-center gap-2 px-3 py-1.5 rounded border border-red-900/30 bg-red-900/10 hover:bg-red-900/20 hover:border-red-500/50 transition-all">
                                    <span class="text-[10px] text-red-400 group-hover:text-red-300 uppercase font-bold tracking-widest">é€€å‡º</span>
                                    <svg class="w-3 h-3 text-red-500/70 group-hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                </button>
                            </div>
                        </div>
    
                        <div class="flex-1 flex overflow-hidden relative">
                            <!-- Chat Log -->
                            <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-4 custom-scrollbar scroll-smooth" ref="cocChatContainer">
                                <div v-for="(msg, index) in cocState.log" :key="index" class="flex w-full animate-message-in group" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                                    <!-- User Message -->
                                    <div v-if="msg.role === 'user' || msg.role === 'whisper'" class="flex flex-row-reverse max-w-[95%] md:max-w-[80%] gap-2 md:gap-4 ml-auto mb-2">
                                        <div class="flex-shrink-0 mt-1">
                                            <div class="w-8 h-8 md:w-10 md:h-10 rounded bg-dark-800 overflow-hidden border border-slate-600 shadow-lg group-hover:border-mystic-gold/50 transition-colors">
                                                <img v-if="msg.avatar" :src="msg.avatar" class="w-full h-full object-cover">
                                                <div v-else class="w-full h-full flex items-center justify-center text-slate-500 font-bold text-xs md:text-sm font-serif">{{ (msg.name || 'P').charAt(0) }}</div>
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-end min-w-0">
                                            <div class="text-[10px] text-slate-500 mb-1 mr-1 font-mono tracking-wider uppercase opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-2">
                                                {{ msg.name }} <span v-if="msg.role === 'whisper'" class="text-purple-400 bg-purple-900/20 px-1 rounded text-[9px] border border-purple-900/30">ç§è¯­</span>
                                            </div>
                                            <div class="px-2.5 pt-1.5 pb-1 md:px-3 md:pt-2 md:pb-1.5 rounded-2xl rounded-tr-none border shadow-xl relative overflow-hidden" :class="msg.role === 'whisper' ? 'bg-purple-900/10 border-purple-500/20 text-purple-200' : 'bg-dark-800 border-dark-700 text-slate-200'">
                                                <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>
                                                <div class="markdown-body relative z-10" v-html="renderMarkdown(msg.content)"></div>
                                                <!-- Stat Changes Display -->
                                                <div v-if="msg.stLogs && msg.stLogs.length > 0" class="mt-3 space-y-2">
                                                    <div v-for="(log, lIdx) in msg.stLogs" :key="lIdx"
                                                         class="rounded-lg relative overflow-hidden border transition-all duration-300"
                                                         :class="parseStLogDiff(log) < 0 ? 'bg-red-900/10 border-red-500/30' : 'bg-mystic-green/10 border-mystic-green/30'">
                                                        <div class="absolute -right-4 -top-4 w-16 h-16 rounded-full opacity-10 blur-xl"
                                                             :class="parseStLogDiff(log) < 0 ? 'bg-red-500' : 'bg-mystic-green'"></div>
                                                        <div class="p-3 relative z-10 flex items-center gap-3">
                                                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl shadow-inner"
                                                                 :class="parseStLogDiff(log) < 0 ? 'bg-red-900/20 text-red-400' : 'bg-mystic-green/20 text-mystic-green'">
                                                                <span v-if="parseStLogDiff(log) < 0">ğŸ’”</span>
                                                                <span v-else>ğŸ’š</span>
                                                            </div>
                                                            <div class="flex-1 min-w-0">
                                                                <div class="flex justify-between items-baseline mb-0.5">
                                                                    <span class="font-bold text-slate-200 text-sm font-serif tracking-wide">å±æ€§å˜æ›´</span>
                                                                    <span class="text-xs font-bold uppercase tracking-wider"
                                                                          :class="parseStLogDiff(log) < 0 ? 'text-red-400' : 'text-mystic-green'">
                                                                        {{ parseStLogDiff(log) < 0 ? 'å‡å°‘' : 'å¢åŠ ' }}
                                                                    </span>
                                                                </div>
                                                                <div class="text-xs font-mono text-slate-400" v-html="formatStLog(log)"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Dice Result Display -->
                                                <div v-if="msg.diceResult" class="mt-3 mb-2 rounded-lg relative overflow-hidden group/dice border transition-all duration-300"
                                                     :class="msg.diceResult.success === true ? 'bg-mystic-green/10 border-mystic-green/30' : (msg.diceResult.success === false ? 'bg-red-900/10 border-red-500/30' : 'bg-mystic-gold/5 border-mystic-gold/20')">
                                                    <!-- è£…é¥°èƒŒæ™¯ -->
                                                    <div class="absolute -right-4 -top-4 w-16 h-16 rounded-full opacity-10 blur-xl"
                                                         :class="msg.diceResult.success === true ? 'bg-mystic-green' : (msg.diceResult.success === false ? 'bg-red-500' : 'bg-mystic-gold')"></div>
                                                    
                                                    <div class="p-3 relative z-10 flex items-center gap-3">
                                                        <!-- éª°å­å›¾æ ‡å®¹å™¨ -->
                                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl shadow-inner"
                                                             :class="msg.diceResult.success === true ? 'bg-mystic-green/20 text-mystic-green' : (msg.diceResult.success === false ? 'bg-red-900/20 text-red-400' : 'bg-mystic-gold/10 text-mystic-gold')">
                                                            ğŸ²
                                                        </div>
                                                        
                                                        <div class="flex-1 min-w-0">
                                                            <div class="flex justify-between items-baseline mb-0.5">
                                                                <span class="font-bold text-slate-200 text-sm font-serif tracking-wide">{{ msg.diceResult.label || 'å‘½è¿æŠ•æ·' }}</span>
                                                                <span class="text-xs font-bold uppercase tracking-wider"
                                                                      :class="msg.diceResult.success === true ? 'text-mystic-green' : (msg.diceResult.success === false ? 'text-red-400' : 'text-mystic-gold')">
                                                                    {{ msg.diceResult.level || (msg.diceResult.success === true ? 'SUCCESS' : (msg.diceResult.success === false ? 'FAILURE' : 'RESULT')) }}
                                                                </span>
                                                            </div>
                                                            
                                                            <div class="flex items-center gap-2 text-xs font-mono text-slate-400">
                                                                <span class="text-lg font-bold"
                                                                      :class="msg.diceResult.success === true ? 'text-mystic-green' : (msg.diceResult.success === false ? 'text-red-300' : 'text-slate-200')">
                                                                    {{ msg.diceResult.roll }}
                                                                </span>
                                                                <span v-if="msg.diceResult.target" class="opacity-60">/ {{ msg.diceResult.target }}</span>
                                                                <span v-if="msg.diceResult.extra" class="ml-auto opacity-70 italic font-serif">{{ msg.diceResult.extra }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-if="msg.isAiGenerated && (cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)) && !isGenerating" class="mt-1 animate-fade-in flex justify-end">
                                                <button @click="regenerateAiMessage(index)" class="text-[9px] text-slate-500 hover:text-mystic-gold flex items-center gap-1 transition-colors bg-dark-900/50 px-2 py-0.5 rounded-full border border-transparent hover:border-mystic-gold/30">
                                                    <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> é‡æˆ
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Keeper Message -->
                                    <div v-else-if="msg.role === 'assistant'" class="flex max-w-full md:max-w-[85%] gap-2 md:gap-4 mr-auto mb-2">
                                        <div class="flex-shrink-0 mt-1">
                                            <div class="w-8 h-8 md:w-10 md:h-10 rounded bg-dark-900 overflow-hidden border border-mystic-gold/30 shadow-[0_0_15px_rgba(204,164,59,0.15)]">
                                                <div class="w-full h-full flex items-center justify-center bg-dark-950 text-mystic-gold"><svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg></div>
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-start min-w-0">
                                            <div class="text-[10px] text-mystic-gold mb-1 ml-1 font-mono tracking-widest uppercase font-bold flex items-center gap-2">
                                                å®ˆå¯†äºº (Keeper) <span class="w-8 h-[1px] bg-mystic-gold/30"></span>
                                            </div>
                                            <div class="p-3 md:p-4 rounded-2xl rounded-tl-none bg-dark-900/80 border border-mystic-gold/20 text-slate-300 shadow-2xl relative backdrop-blur-sm">
                                                <div class="absolute inset-0 rounded-2xl rounded-tl-none overflow-hidden pointer-events-none"><div class="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-mystic-gold/40 to-transparent"></div></div>
                                                <!-- CoT Rendering -->
                                                <div v-if="hasCot(msg.content)" class="cot-wrapper">
                                                    <div class="cot-header" @click="toggleCot(index)" :class="{ active: msg.showCot }">
                                                        <span class="flex items-center gap-2"><svg class="w-3.5 h-3.5" :class="msg.showCot ? 'rotate-90' : ''" style="transition: transform 0.2s" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> é˜¿æ’’æ‰˜æ–¯çš„ä½è¯­ (COT)</span>
                                                        <span class="text-[10px] opacity-50 font-mono"></span>
                                                    </div>
                                                    <div v-show="msg.showCot" class="cot-content markdown-body" v-html="renderMarkdown(getCotContent(msg.content), true)"></div>
                                                </div>
                                                <div class="markdown-body relative z-10 font-serif leading-loose" v-html="renderMarkdown(removeCot(msg.content))"></div>
                                                <!-- Stat Changes Display (Keeper) -->
                                                <div v-if="msg.stLogs && msg.stLogs.length > 0" class="mt-3 space-y-2 relative z-10">
                                                    <div v-for="(log, lIdx) in msg.stLogs" :key="lIdx"
                                                         class="rounded-lg relative overflow-hidden border transition-all duration-300"
                                                         :class="parseStLogDiff(log) < 0 ? 'bg-red-900/10 border-red-500/30' : 'bg-mystic-green/10 border-mystic-green/30'">
                                                        <div class="absolute -right-4 -top-4 w-16 h-16 rounded-full opacity-10 blur-xl"
                                                             :class="parseStLogDiff(log) < 0 ? 'bg-red-500' : 'bg-mystic-green'"></div>
                                                        <div class="p-3 relative z-10 flex items-center gap-3">
                                                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl shadow-inner"
                                                                 :class="parseStLogDiff(log) < 0 ? 'bg-red-900/20 text-red-400' : 'bg-mystic-green/20 text-mystic-green'">
                                                                <span v-if="parseStLogDiff(log) < 0">ğŸ’”</span>
                                                                <span v-else>ğŸ’š</span>
                                                            </div>
                                                            <div class="flex-1 min-w-0">
                                                                <div class="flex justify-between items-baseline mb-0.5">
                                                                    <span class="font-bold text-slate-200 text-sm font-serif tracking-wide">å±æ€§å˜æ›´</span>
                                                                    <span class="text-xs font-bold uppercase tracking-wider"
                                                                          :class="parseStLogDiff(log) < 0 ? 'text-red-400' : 'text-mystic-green'">
                                                                        {{ parseStLogDiff(log) < 0 ? 'å‡å°‘' : 'å¢åŠ ' }}
                                                                    </span>
                                                                </div>
                                                                <div class="text-xs font-mono text-slate-400" v-html="formatStLog(log)"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div v-if="isGenerating && index === cocState.log.length - 1 && !removeCot(msg.content)" class="typing-indicator py-1"><span class="bg-mystic-gold/60"></span><span class="bg-mystic-gold/60"></span><span class="bg-mystic-gold/60"></span></div>
                                            </div>
                                            <div v-if="index === lastAssistantIndex && (cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)) && !isGenerating" class="mt-2 animate-fade-in">
                                                <button @click="regenerateLastResponse" class="flex items-center gap-1.5 px-3 py-1 bg-dark-800/80 border border-mystic-gold/30 rounded-full text-[10px] text-mystic-gold hover:bg-mystic-gold hover:text-dark-900 transition-all shadow-lg backdrop-blur-sm group opacity-80 hover:opacity-100">
                                                    <svg class="w-3 h-3 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> å›æº¯/é‡æ–°ç”Ÿæˆ
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- System Message -->
                                    <div v-else class="flex w-full justify-center my-2">
                                        <div class="bg-dark-950/80 border border-dark-800 px-4 py-2 rounded text-xs text-slate-500 font-mono flex items-center gap-3 shadow-inner max-w-[90%]">
                                            <span class="w-1.5 h-1.5 rounded-full bg-slate-600"></span><div class="markdown-body !text-xs !text-slate-500" v-html="renderMarkdown(msg.content)"></div>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="isGenerating && cocState.log[cocState.log.length-1]?.role !== 'assistant'" class="flex w-full justify-start animate-message-in gap-2 md:gap-4 mr-auto mb-2">
                                    <div class="flex-shrink-0 mt-1"><div class="w-8 h-8 md:w-10 md:h-10 rounded bg-dark-900 overflow-hidden border border-mystic-gold/30 shadow-[0_0_15px_rgba(204,164,59,0.15)]"><div class="w-full h-full flex items-center justify-center bg-dark-950 text-mystic-gold"><svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg></div></div></div>
                                    <div class="flex flex-col items-start min-w-0">
                                        <div class="text-[10px] text-mystic-gold mb-1 ml-1 font-mono tracking-widest uppercase font-bold flex items-center gap-2">å®ˆå¯†äºº (Keeper) <span class="w-8 h-[1px] bg-mystic-gold/30"></span></div>
                                        <div class="px-6 py-4 rounded-2xl rounded-tl-none bg-dark-900/50 border border-dark-700/50 shadow-inner flex items-center justify-center"><div class="typing-indicator"><span></span><span></span><span></span></div></div>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Mobile Right Sidebar Overlay -->
                            <div v-if="showMobileRightSidebar" @click="showMobileRightSidebar = false" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-20 md:hidden transition-opacity"></div>

                            <!-- Sidebar Info (Desktop & Mobile) -->
                            <div :class="['fixed inset-y-0 right-0 z-30 w-72 bg-dark-900 border-l border-dark-800 transform transition-transform duration-300 md:relative md:translate-x-0 flex flex-col shadow-2xl md:shadow-none overflow-y-auto safe-pb', showMobileRightSidebar ? 'translate-x-0' : 'translate-x-full']">
                                <div v-if="cocState.activeInvestigatorIndex !== -1 && cocState.investigators[cocState.activeInvestigatorIndex]" class="p-5 space-y-6">
                                    <!-- å¤´åƒ & åŸºç¡€ä¿¡æ¯ -->
                                    <div class="flex items-center gap-4 pb-4 border-b border-dark-800">
                                        <div class="w-16 h-16 rounded-xl bg-dark-800 overflow-hidden border-2 border-dark-700 shadow-[0_0_15px_rgba(0,0,0,0.5)] relative group cursor-pointer">
                                            <img v-if="cocState.investigators[cocState.activeInvestigatorIndex].avatar" :src="cocState.investigators[cocState.activeInvestigatorIndex].avatar" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                            <div v-else class="w-full h-full flex items-center justify-center text-2xl font-bold text-dark-600 font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].name.charAt(0) }}</div>
                                            <div class="absolute inset-0 ring-1 ring-inset ring-white/10 rounded-xl"></div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-lg font-serif text-mystic-gold truncate">{{ cocState.investigators[cocState.activeInvestigatorIndex].name }}</div>
                                            <div class="text-xs text-slate-500 font-mono truncate mt-0.5">{{ cocState.investigators[cocState.activeInvestigatorIndex].job }}</div>
                                            <div class="flex items-center gap-2 mt-2">
                                                 <span class="px-1.5 py-0.5 rounded bg-dark-800 border border-dark-700 text-[10px] text-slate-400 font-mono">AGE: {{ cocState.investigators[cocState.activeInvestigatorIndex].age }}</span>
                                                 <span class="px-1.5 py-0.5 rounded bg-dark-800 border border-dark-700 text-[10px] text-slate-400 font-mono">{{ cocState.investigators[cocState.activeInvestigatorIndex].gender }}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- çŠ¶æ€æ  (HP/MP/SAN) -->
                                    <div class="space-y-3">
                                        <!-- HP -->
                                        <div class="group cursor-help">
                                            <div class="flex justify-between text-[10px] font-bold tracking-widest mb-1">
                                                <span class="text-red-500/80">HP (ç”Ÿå‘½)</span>
                                                <span class="font-mono text-red-400">{{ cocState.investigators[cocState.activeInvestigatorIndex].hp }} <span class="text-slate-600">/ {{ cocState.investigators[cocState.activeInvestigatorIndex].maxHp || cocState.investigators[cocState.activeInvestigatorIndex].hp }}</span></span>
                                            </div>
                                            <div class="h-1.5 w-full bg-dark-950 rounded-full overflow-hidden border border-dark-800/50">
                                                <div class="h-full bg-gradient-to-r from-red-900 to-red-600 transition-all duration-500" :style="{ width: Math.min(100, (cocState.investigators[cocState.activeInvestigatorIndex].hp / (cocState.investigators[cocState.activeInvestigatorIndex].maxHp || cocState.investigators[cocState.activeInvestigatorIndex].hp || 1)) * 100) + '%' }"></div>
                                            </div>
                                        </div>
                                        <!-- MP -->
                                        <div class="group cursor-help">
                                            <div class="flex justify-between text-[10px] font-bold tracking-widest mb-1">
                                                <span class="text-blue-500/80">MP (é­”æ³•)</span>
                                                <span class="font-mono text-blue-400">{{ cocState.investigators[cocState.activeInvestigatorIndex].mp }} <span class="text-slate-600">/ {{ cocState.investigators[cocState.activeInvestigatorIndex].maxMp || cocState.investigators[cocState.activeInvestigatorIndex].mp }}</span></span>
                                            </div>
                                            <div class="h-1.5 w-full bg-dark-950 rounded-full overflow-hidden border border-dark-800/50">
                                                <div class="h-full bg-gradient-to-r from-blue-900 to-blue-600 transition-all duration-500" :style="{ width: Math.min(100, (cocState.investigators[cocState.activeInvestigatorIndex].mp / (cocState.investigators[cocState.activeInvestigatorIndex].maxMp || cocState.investigators[cocState.activeInvestigatorIndex].mp || 1)) * 100) + '%' }"></div>
                                            </div>
                                        </div>
                                        <!-- SAN -->
                                        <div class="group cursor-help">
                                            <div class="flex justify-between text-[10px] font-bold tracking-widest mb-1">
                                                <span class="text-purple-500/80">SAN (ç†æ™º)</span>
                                                <span class="font-mono text-purple-400">{{ cocState.investigators[cocState.activeInvestigatorIndex].san }} <span class="text-slate-600">/ {{ cocState.investigators[cocState.activeInvestigatorIndex].maxSan || 99 }}</span></span>
                                            </div>
                                            <div class="h-1.5 w-full bg-dark-950 rounded-full overflow-hidden border border-dark-800/50">
                                                <div class="h-full bg-gradient-to-r from-purple-900 to-purple-600 transition-all duration-500" :style="{ width: Math.min(100, (cocState.investigators[cocState.activeInvestigatorIndex].san / (cocState.investigators[cocState.activeInvestigatorIndex].maxSan || 99)) * 100) + '%' }"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Stats Grid -->
                                    <div v-if="cocState.investigators[cocState.activeInvestigatorIndex].stats">
                                        <h4 class="font-bold text-slate-500 text-[10px] mb-3 uppercase tracking-widest flex items-center gap-2">
                                            <span class="w-1 h-1 rounded-full bg-slate-500"></span> åŸºç¡€å±æ€§
                                        </h4>
                                        <div class="grid grid-cols-3 gap-2">
                                            <div v-for="(val, key) in cocState.investigators[cocState.activeInvestigatorIndex].stats" :key="key"
                                                 class="bg-dark-800/50 hover:bg-mystic-gold/5 border border-dark-700/50 hover:border-mystic-gold/30 rounded p-2 text-center cursor-pointer transition-all group"
                                                 @click="cocInput = `.ra ${key}`" title="ç‚¹å‡»æ£€å®š">
                                                <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider mb-0.5 group-hover:text-mystic-gold/70">{{ key }}</div>
                                                <div class="font-bold text-sm text-slate-300 font-mono group-hover:text-mystic-gold">{{ val }}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Skills -->
                                    <div class="flex-1 min-h-0 flex flex-col" v-if="cocState.investigators[cocState.activeInvestigatorIndex].skills">
                                        <h4 class="font-bold text-slate-500 text-[10px] mb-3 uppercase tracking-widest flex items-center gap-2">
                                            <span class="w-1 h-1 rounded-full bg-slate-500"></span> æŠ€èƒ½åˆ—è¡¨
                                        </h4>
                                        <div class="overflow-y-auto custom-scrollbar pr-1 -mr-1 flex-1">
                                            <div class="flex flex-wrap gap-2">
                                                <button v-for="skill in cocState.investigators[cocState.activeInvestigatorIndex].skills.filter(s => s.value > 0).sort((a,b) => b.value - a.value)" :key="skill.name"
                                                        class="px-2.5 py-1 bg-dark-800 hover:bg-mystic-green/10 border border-dark-700 hover:border-mystic-green/40 rounded text-xs text-slate-400 hover:text-mystic-green transition-all flex items-center gap-2 group"
                                                        @click="cocInput = `.ra ${skill.name}`" title="ç‚¹å‡»æ£€å®š">
                                                    <span>{{ skill.name }}</span>
                                                    <span class="font-mono font-bold text-slate-500 group-hover:text-mystic-green/80">{{ skill.value }}</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Badges -->
                                    <div v-if="cocState.investigators[cocState.activeInvestigatorIndex].badges && cocState.investigators[cocState.activeInvestigatorIndex].badges.length > 0">
                                        <h4 class="font-bold text-slate-500 text-[10px] mb-3 uppercase tracking-widest flex items-center gap-2">
                                            <span class="w-1 h-1 rounded-full bg-slate-500"></span> å‹‹ç« å¢™
                                        </h4>
                                        <div class="flex flex-wrap gap-2">
                                            <div v-for="(badge, bIdx) in cocState.investigators[cocState.activeInvestigatorIndex].badges" :key="bIdx" class="group relative w-9 h-9 flex items-center justify-center bg-dark-800 rounded-lg border border-mystic-gold/20 hover:border-mystic-gold/50 cursor-help transition-all hover:shadow-[0_0_10px_rgba(212,175,55,0.2)]">
                                                <span class="text-lg medal-icon select-none" v-html="sanitizeBadgeIcon(badge.icon)"></span>
                                                <!-- Tooltip -->
                                                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-3 bg-dark-900/95 backdrop-blur-md border border-mystic-gold/30 rounded-lg text-[10px] opacity-0 group-hover:opacity-100 transition-all pointer-events-none z-50 shadow-2xl scale-95 group-hover:scale-100 origin-bottom">
                                                    <div class="font-bold text-mystic-gold text-xs mb-1 font-serif">{{ badge.name }}</div>
                                                    <div class="text-slate-400 leading-relaxed">{{ badge.desc }}</div>
                                                    <div class="absolute bottom-[-5px] left-1/2 -translate-x-1/2 w-2 h-2 bg-dark-900 border-r border-b border-mystic-gold/30 transform rotate-45"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Footer Actions -->
                                    <div class="pt-4 mt-auto border-t border-dark-800/50">
                                         <button @click="openSettlement" class="w-full py-2.5 bg-gradient-to-r from-mystic-gold/5 via-mystic-gold/10 to-mystic-gold/5 border border-mystic-gold/20 hover:border-mystic-gold/40 rounded text-mystic-gold text-xs font-bold uppercase tracking-widest hover:bg-mystic-gold/10 transition-all flex items-center justify-center gap-2 group shadow-lg shadow-black/20">
                                            <svg class="w-4 h-4 group-hover:rotate-180 transition-transform duration-700 text-mystic-gold/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span>å¥–åŠ±ç»“ç®—</span>
                                         </button>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Input -->
                        <div class="p-4 bg-dark-900 border-t border-dark-800 z-20 relative safe-pb">
                            <!-- Mention Auto-complete List -->
                            <div v-if="showMentionList && mentionCandidates.length > 0" class="absolute bottom-full left-4 mb-2 w-64 bg-dark-800 border border-dark-600 rounded-lg shadow-2xl overflow-hidden z-50 animate-fade-in">
                                <div class="text-[10px] bg-dark-900 px-3 py-1 text-slate-500 uppercase tracking-widest font-bold border-b border-dark-700">æåŠ (Mention)</div>
                                <div class="max-h-48 overflow-y-auto custom-scrollbar">
                                    <div v-for="(candidate, idx) in mentionCandidates" :key="idx" @click="selectMention(candidate)" class="px-3 py-2 flex items-center gap-3 hover:bg-mystic-gold/10 cursor-pointer transition-colors group border-b border-dark-700/50 last:border-0">
                                        <div class="w-6 h-6 rounded bg-dark-700 overflow-hidden flex-shrink-0 border border-dark-600 group-hover:border-mystic-gold/50">
                                            <img v-if="candidate.avatar" :src="candidate.avatar" class="w-full h-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-[10px] font-bold text-slate-500">{{ candidate.name.charAt(0) }}</div>
                                        </div>
                                        <div class="flex flex-col min-w-0"><span class="text-sm font-bold text-slate-300 group-hover:text-mystic-gold truncate">{{ candidate.name }}</span><span class="text-[10px] text-slate-500 truncate">{{ candidate.type === 'character' ? 'è§’è‰²' : 'ç©å®¶' }}</span></div>
                                    </div>
                                </div>
                            </div>

                            <div class="max-w-4xl mx-auto flex gap-3">
                                <textarea v-model="cocInput" ref="cocInputRef" @input="handleInput" @keydown.enter.prevent="sendCocMessage" @keydown.esc="showMentionList = false" :placeholder="isRoundLocked ? 'æœ¬è½®å·²è¡ŒåŠ¨ï¼Œç­‰å¾…é˜Ÿå‹...' : 'ä½ çš„è¡ŒåŠ¨...'" :disabled="isRoundLocked" class="flex-1 bg-dark-800 rounded-lg px-4 py-3 resize-none border border-dark-700 focus:ring-1 focus:ring-mystic-gold focus:border-mystic-gold focus:bg-dark-900 text-slate-200 placeholder-slate-600 transition-all h-[56px] custom-scrollbar disabled:opacity-50 disabled:cursor-not-allowed"></textarea>
                                <button @click="sendCocMessage" :disabled="!cocInput.trim() || isGenerating || isRoundLocked" class="w-[56px] h-[56px] bg-dark-800 hover:bg-mystic-gold hover:text-dark-950 text-mystic-gold border border-mystic-gold/50 rounded-lg flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed transition-all shadow-lg group"><svg class="w-6 h-6 transform rotate-90 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg></button>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- 2. COC Mode Selection View -->
            <div v-if="currentView === 'coc'" class="flex-1 flex flex-col overflow-hidden relative">
                <div class="flex-1 overflow-y-auto p-4 md:p-8 flex items-center justify-center animate-fade-in">
                    <div class="max-w-5xl w-full">
                        <h2 class="text-3xl md:text-4xl font-bold text-mystic-gold mb-10 text-center tracking-wider font-serif">é€‰æ‹©ä½ çš„å‘½è¿</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div @click="selectCocMode('single')" class="group glass-panel p-8 rounded border border-dark-700 hover:border-mystic-gold hover:bg-dark-800/50 transition-all cursor-pointer relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><svg class="w-32 h-32 text-mystic-gold" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg></div>
                                <div class="relative z-10">
                                    <div class="w-16 h-16 bg-dark-900 text-mystic-gold border border-dark-700 rounded flex items-center justify-center mb-6 shadow-lg group-hover:shadow-mystic-gold/20 transition-shadow"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>
                                    <h3 class="text-2xl font-bold mb-3 text-slate-200 group-hover:text-mystic-gold transition-colors font-serif">å•äººæ¨¡å¼</h3>
                                    <p class="text-slate-500 text-sm leading-relaxed">ç‹¬è‡ªé¢å¯¹æœªçŸ¥çš„ææƒ§ã€‚ç”± AI æ‹…ä»» Keeper (å®ˆå¯†äºº)ï¼Œä¸ºä½ ç¼–ç»‡ä¸€åœºä¸“å±çš„å™©æ¢¦ã€‚</p>
                                </div>
                            </div>
                            <div @click="selectCocMode('multi')" class="group glass-panel p-8 rounded border border-dark-700 hover:border-mystic-green hover:bg-dark-800/50 transition-all cursor-pointer relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><svg class="w-32 h-32 text-mystic-green" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div>
                                <div class="relative z-10">
                                    <div class="w-16 h-16 bg-dark-900 text-mystic-green border border-dark-700 rounded flex items-center justify-center mb-6 shadow-lg group-hover:shadow-mystic-green/20 transition-shadow"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                                    <h3 class="text-2xl font-bold mb-3 text-slate-200 group-hover:text-mystic-green transition-colors font-serif">å¤šäººè”æœº</h3>
                                    <p class="text-slate-500 text-sm leading-relaxed">ä¸è°ƒæŸ¥å‘˜åŒä¼´ä»¬ç»„é˜Ÿã€‚éœ€å…ˆåœ¨â€œå¤šäººè”æœºâ€é¡µé¢å»ºç«‹è¿æ¥ã€‚</p>
                                    <div class="mt-4 inline-flex items-center text-xs font-bold px-3 py-1 rounded border" :class="multiplayerState.inRoom ? 'bg-mystic-green/10 text-mystic-green border-mystic-green/30' : 'bg-red-900/10 text-red-400 border-red-900/30'">{{ multiplayerState.inRoom ? `å·²è¿æ¥: ${multiplayerState.roomId}` : 'æœªè¿æ¥æˆ¿é—´' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2.5 Multiplayer View -->
            <div v-if="currentView === 'multiplayer'" class="flex-1 overflow-y-auto p-4 md:p-8 animate-fade-in flex flex-col items-center justify-center">
                <div class="max-w-md w-full glass-panel p-8 rounded-xl border border-dark-700 shadow-2xl relative overflow-hidden">
                     <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-mystic-green to-transparent opacity-50"></div>
                     <h2 class="text-3xl font-bold text-mystic-green mb-8 text-center font-serif tracking-wider">å¤šé‡å®‡å®™è¿æ¥</h2>
                     
                     <div class="space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">æˆ¿é—´é€šè®¯ç </label>
                            <input v-model="joinRoomId" placeholder="è¾“å…¥ Room ID..." class="w-full bg-dark-950 border border-dark-700 rounded-lg px-4 py-3 text-slate-200 focus:border-mystic-green focus:ring-1 focus:ring-mystic-green/50 outline-none transition-all font-mono text-center tracking-widest text-lg">
                        </div>
                        
                        <button @click="joinRoom(joinRoomId)" :disabled="!joinRoomId" class="w-full py-3 bg-dark-800 hover:bg-mystic-green hover:text-dark-950 text-mystic-green border border-mystic-green/30 rounded-lg font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed uppercase tracking-widest shadow-lg">åŠ å…¥æˆ¿é—´</button>
                        
                        <div class="relative flex items-center py-2">
                            <div class="flex-grow border-t border-dark-700"></div>
                            <span class="flex-shrink-0 mx-4 text-slate-600 text-xs font-serif">æˆ–è€…</span>
                            <div class="flex-grow border-t border-dark-700"></div>
                        </div>
                        
                        <button @click="createRoom()" class="w-full py-3 bg-gradient-to-r from-mystic-green to-teal-900 text-teal-100 font-bold rounded-lg shadow-lg hover:shadow-mystic-green/20 transition-all border border-mystic-green/50 uppercase tracking-widest">å»ºç«‹æ–°ä¿¡æ ‡ (åˆ›å»ºæˆ¿é—´)</button>
                     </div>
                     
                     <div class="mt-8 text-center">
                        <button @click="currentView = 'coc'" class="text-slate-500 hover:text-slate-300 text-sm underline decoration-slate-700 underline-offset-4">è¿”å›</button>
                     </div>
                </div>
            </div>

            <!-- 3. Preparing View (Shared for Single/Multi) -->
            <div v-if="currentView === 'preparing'" class="flex-1 overflow-y-auto p-4 md:p-6 animate-fade-in">
                <div class="flex items-center justify-between mb-8 border-b border-dark-800 pb-4">
                    <div class="flex items-center">
                        <button @click="exitCocMode" class="mr-4 p-2 bg-dark-800 border border-dark-700 rounded text-slate-400 hover:text-slate-200 hover:border-slate-500 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg></button>
                        <h2 class="text-2xl font-bold text-mystic-gold font-serif">è·‘å›¢å‡†å¤‡</h2>
                    </div>
                    <!-- Room ID Display in Preparing View -->
                    <div v-if="cocState.mode === 'multi' && multiplayerState.inRoom" class="flex items-center gap-2 px-4 py-2 bg-dark-800/80 border border-mystic-green/30 rounded-lg shadow-lg cursor-pointer hover:bg-dark-800 hover:border-mystic-green/50 transition-all group" @click="copyToClipboard(multiplayerState.roomId)" title="ç‚¹å‡»å¤åˆ¶æˆ¿é—´å·">
                        <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">æˆ¿é—´å·</span>
                        <span class="text-lg font-mono font-bold text-mystic-green tracking-widest">{{ multiplayerState.roomId }}</span>
                        <svg class="w-4 h-4 text-slate-500 group-hover:text-mystic-green transition-colors ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto space-y-8">
                    <!-- Module (Host Only in Multi) -->
                    <div class="glass-panel p-6 rounded-lg">
                        <h3 class="font-bold text-slate-200 mb-6 flex items-center font-serif text-lg"><span class="w-1 h-6 bg-mystic-gold mr-3"></span> æ¨¡ç»„æ¡£æ¡ˆ</h3>
                        <!-- Host or Single Mode -->
                        <div v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost) || (cocState.mode === 'multi' && !multiplayerState.isHost && cocState.module)">
                            <div v-if="!cocState.module && (cocState.mode === 'single' || multiplayerState.isHost)" class="flex flex-col gap-6">
                                <label class="w-full h-48 border border-dashed border-slate-600 hover:border-mystic-gold bg-dark-900/30 hover:bg-dark-800/50 rounded-lg cursor-pointer flex flex-col items-center justify-center text-slate-400 transition-all group relative overflow-hidden">
                                    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')] opacity-20"></div>
                                    <svg class="w-12 h-12 mb-4 text-slate-600 group-hover:text-mystic-gold transition-colors transform group-hover:scale-110 duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    <span class="font-serif text-lg tracking-widest group-hover:text-mystic-gold transition-colors">å¯¼å…¥æ¨¡ç»„æ¡£æ¡ˆ</span>
                                    <span class="text-xs text-slate-600 mt-2 font-mono">(.txt, .md, .docx, .json)</span>
                                    <input type="file" accept=".json,.txt,.md,.docx,.doc" @change="importCocModule" class="hidden">
                                </label>
                                <div class="relative flex items-center py-2"><div class="flex-grow border-t border-dark-700"></div><span class="flex-shrink-0 mx-4 text-slate-600 text-xs font-serif tracking-widest uppercase">æˆ–</span><div class="flex-grow border-t border-dark-700"></div></div>
                                <div class="relative group">
                                    <textarea v-model="cocState.tempModuleText" placeholder="åœ¨æ­¤ç²˜è´´æ¨¡ç»„å†…å®¹..." class="w-full h-40 p-6 rounded-lg bg-dark-900/50 border border-dark-700 text-sm text-slate-300 focus:border-mystic-gold/50 focus:bg-dark-900 focus:ring-1 focus:ring-mystic-gold/50 outline-none resize-none font-serif leading-relaxed transition-all placeholder-slate-700"></textarea>
                                    <div class="absolute bottom-4 right-4"><button @click="saveManualModule" :disabled="!cocState.tempModuleText" class="px-6 py-2 bg-dark-800 text-mystic-gold border border-mystic-gold/30 hover:bg-mystic-gold hover:text-dark-900 rounded transition-all font-bold disabled:opacity-0 disabled:cursor-not-allowed text-sm tracking-widest uppercase shadow-lg hover:shadow-mystic-gold/20">ç¡®è®¤å½•å…¥</button></div>
                                </div>
                            </div>
                            <div v-else-if="cocState.module" class="bg-dark-800/50 p-5 rounded border border-dark-700 flex justify-between items-start">
                                <div><h4 class="font-bold text-mystic-gold text-lg font-serif mb-1">{{ cocState.module.name }}</h4><p class="text-xs text-slate-500 font-mono">{{ cocState.module.content ? cocState.module.content.length : 0 }} chars</p></div>
                                <button v-if="cocState.mode === 'single' || multiplayerState.isHost" @click="cocState.module = null" class="text-dark-400 hover:text-red-500 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                            </div>
                        </div>
                        <!-- Guest in Multi Mode (No module yet) -->
                        <div v-else class="text-center py-8 border border-dark-800 border-dashed rounded bg-dark-900/30">
                            <div class="text-slate-500 italic">ç­‰å¾…æˆ¿ä¸»é€‰æ‹©æ¨¡ç»„...</div>
                        </div>
                    </div>

                    <!-- Investigators -->
                    <div class="glass-panel p-6 rounded-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none"><svg class="w-40 h-40 text-mystic-green" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg></div>
                        <div class="flex justify-between items-center mb-6 relative z-10">
                            <h3 class="font-bold text-slate-200 flex items-center font-serif text-lg"><span class="w-1 h-6 bg-mystic-green mr-3 shadow-[0_0_10px_rgba(45,106,79,0.5)]"></span> è°ƒæŸ¥å‘˜åå†Œ</h3>
                            <div v-if="cocState.mode === 'multi' && multiplayerState.members.length > 0" class="flex-1 flex items-center justify-center gap-4 mx-4">
                                <div class="text-center text-xs font-bold uppercase tracking-wider">
                                    <span v-if="multiplayerState.members[multiplayerState.turnIndex]?.id === user.uuid" class="text-mystic-gold animate-pulse">å½“å‰è½®æ¬¡ï¼šè½®åˆ°ä½ äº†ï¼è¯·é€‰æ‹©è§’è‰²</span>
                                    <span v-else class="text-slate-500">å½“å‰è½®æ¬¡ï¼šç­‰å¾… {{ multiplayerState.members[multiplayerState.turnIndex]?.name || 'Unknown' }} é€‰æ‹©...</span>
                                </div>
                            </div>
                            <label v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" class="text-xs px-4 py-2 bg-dark-800 hover:bg-mystic-green hover:text-dark-900 border border-dark-600 hover:border-mystic-green rounded cursor-pointer transition-all text-slate-300 font-bold uppercase tracking-wide shadow-lg">å¯¼å…¥ (.json/.png)<input type="file" accept=".json,.png" @change="importInvestigator" class="hidden"></label>
                        </div>
                        
                        <div v-if="cocState.investigators.length === 0" class="text-center py-12 text-slate-600 border border-dark-800 border-dashed rounded bg-dark-900/30 font-serif italic">æš‚æ— è°ƒæŸ¥å‘˜è®°å½•... ä¹Ÿè®¸ä»–ä»¬éƒ½å·²è¿·å¤±åœ¨æ—¶ç©ºè£‚éš™ä¸­ã€‚</div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-4 relative z-10">
                            <div v-for="(inv, index) in cocState.investigators" :key="index" class="relative p-4 rounded border transition-all cursor-pointer flex gap-4 group overflow-hidden" :class="[ cocState.activeInvestigatorIndex === index ? 'border-mystic-green bg-mystic-green/10 shadow-glow-green' : 'border-dark-700 bg-dark-800/40 hover:border-slate-500 hover:bg-dark-800', multiplayerState.assignments[index] && multiplayerState.assignments[index] !== user.uuid ? 'opacity-50' : '' ]" @click="handleInvestigatorClick(index)">
                                <div class="absolute inset-0 bg-gradient-to-r from-mystic-green/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="w-16 h-16 rounded bg-dark-900 flex-shrink-0 overflow-hidden border border-dark-600 group-hover:border-slate-400 transition-colors shadow-lg relative">
                                    <img v-if="inv.avatar" :src="inv.avatar" class="w-full h-full object-cover grayscale-[20%] group-hover:grayscale-0 transition-all duration-500">
                                    <div v-else class="w-full h-full flex items-center justify-center text-slate-600 font-serif font-bold text-2xl">{{ inv.name.charAt(0) }}</div>
                                </div>
                                <div class="flex-1 min-w-0 flex flex-col justify-center relative z-10">
                                    <div class="font-bold truncate text-slate-200 font-serif text-lg group-hover:text-mystic-green transition-colors">{{ inv.name }}</div>
                                    <div class="text-xs text-slate-500 flex gap-2 mt-1.5 font-mono"><span class="text-red-400 bg-red-900/20 px-1.5 py-0.5 rounded border border-red-900/30">HP: {{inv.hp}}</span><span class="text-blue-400 bg-blue-900/20 px-1.5 py-0.5 rounded border border-blue-900/30">SAN: {{inv.san}}</span></div>
                                    <!-- Assignment Status -->
                                    <div v-if="cocState.mode === 'multi'" class="mt-2 text-[10px] font-bold uppercase tracking-widest flex items-center gap-1">
                                        <template v-if="multiplayerState.assignments[index]">
                                            <span class="w-1.5 h-1.5 rounded-full" :class="multiplayerState.assignments[index] === user.uuid ? 'bg-mystic-green' : (multiplayerState.assignments[index].startsWith('ai_') ? 'bg-purple-500' : 'bg-slate-500')"></span>
                                            <span :class="multiplayerState.assignments[index] === user.uuid ? 'text-mystic-green' : (multiplayerState.assignments[index].startsWith('ai_') ? 'text-purple-500' : 'text-slate-500')">
                                                {{ multiplayerState.assignments[index] === user.uuid ? 'å·²é€‰æ‹© (ä½ )' : (multiplayerState.assignments[index].startsWith('ai_') ? 'AI æ‰˜ç®¡' : 'å·²è¢«å ç”¨') }}
                                            </span>
                                        </template>
                                        <template v-else-if="multiplayerState.assignmentDetails && multiplayerState.assignmentDetails[index]"><span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span><span class="text-yellow-500">ç­‰å¾…å½’ä½: {{ multiplayerState.assignmentDetails[index].name }}</span></template>
                                    </div>
                                </div>
                                <div class="self-start relative z-10 flex gap-1">
                                    <button v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" @click.stop="toggleAiPlayer(index)" class="p-1 rounded transition-colors" :class="multiplayerState.assignments[index]?.startsWith('ai_') ? 'text-mystic-green bg-mystic-green/10 border border-mystic-green/30' : 'text-slate-600 hover:text-mystic-gold'" title="AI æ‰˜ç®¡">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                    </button>
                                    <button v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" @click.stop="deleteInvestigator(index)" class="text-dark-600 hover:text-red-500 transition-colors p-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ready Status (Multiplayer) -->
                    <div v-if="cocState.mode === 'multi'" class="glass-panel p-6 rounded-lg">
                        <h3 class="font-bold text-slate-200 mb-4 flex items-center font-serif text-lg"><span class="w-1 h-6 bg-blue-500 mr-3"></span> å°é˜ŸçŠ¶æ€</h3>
                        <div class="space-y-2">
                            <div v-for="member in multiplayerState.members" :key="member.id" class="flex items-center justify-between p-3 bg-dark-800/50 rounded border border-dark-700">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded bg-dark-700 flex items-center justify-center font-bold text-xs text-slate-500">{{ member.name.charAt(0) }}</div>
                                    <span class="font-serif text-slate-300">{{ member.name }}</span>
                                    <span v-if="member.isHost" class="text-[10px] bg-mystic-gold/10 text-mystic-gold border border-mystic-gold/20 px-2 py-0.5 rounded uppercase">æˆ¿ä¸»</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span v-if="member.isReady" class="text-xs text-mystic-green font-bold flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> å·²å‡†å¤‡</span>
                                    <span v-else class="text-xs text-slate-600 font-mono">å‡†å¤‡ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end pt-4 gap-4">
                        <button v-if="cocState.mode === 'multi' && !multiplayerState.isHost" @click="toggleReady" :class="['px-10 py-4 font-bold font-serif tracking-widest rounded shadow-lg transition-all border', multiplayerState.isReady ? 'bg-mystic-green/20 text-mystic-green border-mystic-green' : 'bg-dark-800 text-slate-400 border-dark-600 hover:bg-dark-700']">{{ multiplayerState.isReady ? 'å·²å‡†å¤‡' : 'å‡†å¤‡å°±ç»ª' }}</button>
                        <button v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" @click="startCocGame" :disabled="cocState.mode === 'multi' && !allPlayersReady" class="px-10 py-4 bg-gradient-to-r from-mystic-green to-teal-900 text-teal-100 font-bold font-serif tracking-widest rounded shadow-lg hover:shadow-mystic-green/30 transition-all border border-mystic-green/50 disabled:opacity-50 disabled:cursor-not-allowed">å¼€å§‹è·‘å›¢</button>
                    </div>
                </div>
            </div>

            <!-- 4. Saves View -->
            <div v-if="currentView === 'saves'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-indigo-400 font-serif flex items-center gap-3"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg> è®°å¿†å›å»Š</h2>
                    <label class="px-4 py-2 bg-indigo-900/20 text-indigo-400 border border-indigo-500/30 rounded hover:bg-indigo-900/40 font-bold text-sm flex items-center gap-2 cursor-pointer transition-colors uppercase tracking-wider"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg> å¯¼å…¥è®°å¿†<input type="file" accept=".json" @change="importSave" class="hidden"></label>
                </div>
                <div class="max-w-4xl mx-auto">
                    <div v-if="savedGames.length === 0" class="text-center py-20 border border-dashed border-dark-700 rounded-lg bg-dark-900/30"><div class="text-slate-500 font-serif italic mb-4">è¿™é‡Œç©ºæ— ä¸€ç‰©ï¼Œåªæœ‰æ—¶é—´çš„å°˜åŸƒ...</div><button @click="currentView = 'coc'" class="px-6 py-2 bg-dark-800 text-mystic-gold border border-mystic-gold/30 rounded hover:bg-mystic-gold hover:text-dark-900 transition-all font-bold text-sm">å¼€å§‹æ–°çš„æ—…ç¨‹</button></div>
                    <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div v-for="(save, index) in savedGames" :key="save.id" class="group relative bg-dark-900/80 border border-dark-700 rounded-lg overflow-hidden hover:border-indigo-500/50 transition-all shadow-lg">
                            <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500/30 group-hover:bg-indigo-500 transition-colors"></div>
                            <div class="p-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div><div class="text-xs text-indigo-400 font-bold uppercase tracking-widest mb-1">{{ save.mode === 'multi' ? 'å¤šäººè”æœº' : 'å•äººæ¨¡å¼' }}</div><h3 class="text-xl font-bold text-slate-200 font-serif truncate pr-4">{{ save.moduleName || 'æœªå‘½åç¯‡ç« ' }}</h3></div>
                                    <button @click="deleteSave(index)" class="text-slate-600 hover:text-red-500 transition-colors p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                                <div class="text-sm text-slate-500 font-mono mb-6 line-clamp-2 h-10">{{ save.lastMessage || 'æ— è®°å½•...' }}</div>
                                <div class="flex items-center justify-between mt-auto pt-4 border-t border-dark-800">
                                    <div class="text-xs text-slate-600 font-mono">{{ new Date(save.timestamp).toLocaleString() }}</div>
                                    <div class="flex gap-2">
                                        <button @click="exportSave(index)" class="px-3 py-1.5 bg-dark-800 text-slate-400 border border-dark-600 rounded hover:text-indigo-400 hover:border-indigo-500/30 transition-all text-xs font-bold uppercase tracking-wider" title="å¯¼å‡ºå­˜æ¡£"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg></button>
                                        <button @click="loadSave(index)" class="px-4 py-1.5 bg-indigo-900/20 text-indigo-400 border border-indigo-500/30 rounded hover:bg-indigo-500 hover:text-white transition-all text-xs font-bold uppercase tracking-wider">è¯»å–è®°å¿†</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Friends View -->
            <div v-if="currentView === 'friends'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                <h2 class="text-2xl font-bold mb-8 text-mystic-gold font-serif">åŒä¼´åå½•</h2>
                <div class="max-w-2xl mx-auto space-y-6">
                    <div class="glass-panel p-6 rounded-lg shadow-sm flex justify-between items-center">
                        <div><h3 class="font-bold text-lg text-slate-200 font-serif">{{ user.name }}</h3><p class="text-sm text-slate-500 font-mono select-all">UID: {{ user.uuid }}</p></div>
                        <div class="flex gap-2"><input v-model="friendInput" placeholder="è¾“å…¥åŒä¼´ ID" class="bg-dark-900 border border-dark-600 text-slate-300 rounded px-3 py-1.5 text-sm focus:border-mystic-gold outline-none"><button @click="addFriend" class="bg-dark-800 text-mystic-gold border border-mystic-gold/30 px-4 py-1.5 rounded text-sm font-bold hover:bg-mystic-gold hover:text-dark-900 transition-colors">æ·»åŠ </button></div>
                    </div>
                    <div v-if="friendRequests.length > 0" class="space-y-2"><h4 class="font-bold text-xs text-slate-500 uppercase tracking-widest mb-2">æ”¶åˆ°çš„ä¿¡å·</h4><div v-for="req in friendRequests" :key="req.id" class="bg-dark-800 p-4 rounded border border-mystic-gold/30 flex justify-between items-center"><span class="font-bold text-slate-200 font-serif">{{ req.name }}</span><div class="flex gap-2"><button @click="acceptFriend(req)" class="px-3 py-1 text-xs bg-mystic-gold text-dark-900 rounded font-bold hover:bg-yellow-600">æ¥å—</button><button @click="rejectFriend(req)" class="px-3 py-1 text-xs bg-dark-700 text-slate-400 rounded hover:bg-dark-600">æ‹’ç»</button></div></div></div>
                    <div class="space-y-3"><div v-for="friend in friends" :key="friend.uuid" class="glass-panel p-4 rounded border border-dark-700 flex justify-between items-center hover:border-slate-600 transition-colors"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded bg-dark-800 overflow-hidden relative border border-dark-600"><img v-if="friend.avatar" :src="friend.avatar" class="w-full h-full object-cover"><div v-if="friend.isOnline" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-mystic-green border border-dark-900 rounded-full shadow-[0_0_8px_rgba(45,212,191,0.8)]"></div></div><div><div class="font-bold text-slate-200 font-serif">{{ friend.name }}</div><div class="text-xs font-mono" :class="friend.isOnline ? 'text-mystic-green' : 'text-slate-600'">{{ friend.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿' }}</div></div></div><button v-if="friend.isOnline" @click="inviteFriend(friend)" class="px-3 py-1.5 bg-dark-800 text-slate-300 border border-dark-600 rounded text-xs font-bold hover:text-mystic-gold hover:border-mystic-gold transition-colors uppercase tracking-wider">é‚€è¯·</button></div><div v-if="friends.length === 0" class="text-center py-12 text-slate-600 border border-dashed border-dark-800 rounded bg-dark-900/20 font-serif italic">å­¤ç‹¬æ˜¯ç†æ™ºçš„æœ€åé˜²çº¿...</div></div>
                </div>
            </div>

            <!-- 6. Settings View -->
            <div v-if="currentView === 'settings'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                <h2 class="text-2xl font-bold mb-8 text-slate-200 font-serif flex items-center gap-3">
                    <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    è®¾ç½®ä¸­å¿ƒ
                </h2>
                <div class="max-w-2xl mx-auto space-y-6">
                    <!-- User Profile -->
                    <div class="glass-panel p-6 rounded-lg">
                        <h3 class="font-bold text-slate-200 mb-6 flex items-center font-serif text-lg"><span class="w-1 h-6 bg-mystic-gold mr-3"></span> ä¸ªäººä¿¡æ¯</h3>
                        <div class="flex items-center gap-6 mb-6">
                            <label class="relative cursor-pointer group">
                                <div class="w-20 h-20 rounded-full overflow-hidden border-2 border-dark-600 group-hover:border-mystic-gold transition-colors shadow-lg">
                                    <img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover">
                                    <div v-else class="w-full h-full bg-dark-800 flex items-center justify-center text-2xl font-bold text-mystic-gold font-serif">{{ user.name.charAt(0).toUpperCase() }}</div>
                                </div>
                                <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                                <input type="file" accept="image/*" @change="handleUserAvatarUpload" class="hidden">
                            </label>
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">æ˜µç§°</label>
                                <input v-model="user.name" @change="saveData" class="w-full bg-dark-900 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-mystic-gold outline-none">
                            </div>
                        </div>
                        <div class="bg-dark-800/50 p-4 rounded border border-dark-700">
                            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">ç”¨æˆ· ID</label>
                            <div class="flex items-center gap-2">
                                <code class="flex-1 text-sm text-mystic-gold font-mono select-all bg-dark-900 px-3 py-2 rounded">{{ user.uuid }}</code>
                                <button @click="copyToClipboard(user.uuid)" class="px-3 py-2 bg-dark-900 border border-dark-600 rounded hover:border-mystic-gold hover:text-mystic-gold transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- API Settings -->
                    <div class="glass-panel p-6 rounded-lg">
                        <h3 class="font-bold text-slate-200 mb-6 flex items-center font-serif text-lg"><span class="w-1 h-6 bg-mystic-green mr-3"></span> API é…ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">API åœ°å€</label>
                                <input v-model="settings.apiUrl" @change="saveData" class="w-full bg-dark-900 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-mystic-green outline-none font-mono text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">API Key</label>
                                <input v-model="settings.apiKey" @change="saveData" type="password" class="w-full bg-dark-900 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-mystic-green outline-none font-mono text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">æ¨¡å‹</label>
                                <input v-model="settings.model" @change="saveData" class="w-full bg-dark-900 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-mystic-green outline-none font-mono text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Connection Settings -->
                    <div class="glass-panel p-6 rounded-lg">
                        <h3 class="font-bold text-slate-200 mb-6 flex items-center font-serif text-lg"><span class="w-1 h-6 bg-indigo-500 mr-3"></span> è”æœºæœåŠ¡</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">Supabase URL</label>
                                <input v-model="settings.supabaseUrl" @change="saveData" class="w-full bg-dark-900 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-indigo-500 outline-none font-mono text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">Supabase Key</label>
                                <input v-model="settings.supabaseKey" @change="saveData" type="password" class="w-full bg-dark-900 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-indigo-500 outline-none font-mono text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- App Info -->
                    <div class="glass-panel p-6 rounded-lg">
                        <h3 class="font-bold text-slate-200 mb-4 flex items-center font-serif text-lg"><span class="w-1 h-6 bg-slate-600 mr-3"></span> å…³äº</h3>
                        <div class="text-sm text-slate-500 space-y-2">
                            <p><span class="text-slate-400">ç‰ˆæœ¬ï¼š</span> 2.0 Beta</p>
                            <p><span class="text-slate-400">å¼€å‘è€…ï¼š</span> Z4RKTO & STA1N</p>
                            <p class="text-xs italic mt-4">"åœ¨ç–¯ç‹‚ä¸ç†æ™ºçš„è¾¹ç¼˜ï¼Œæˆ‘ä»¬å¯»æ‰¾çœŸç›¸ã€‚"</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 7. Tavern View (New) -->
            <div v-if="currentView === 'tavern'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-amber-500 font-serif flex items-center gap-3">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        å¼‚é—»é…’é¦†
                    </h2>
                    <div class="flex gap-2">
                        <button @click="tavernState.view = 'create'" :class="['px-4 py-2 rounded border font-bold text-xs uppercase tracking-wider transition-all', tavernState.view === 'create' ? 'bg-amber-900/40 text-amber-400 border-amber-500/50' : 'bg-dark-800 text-slate-500 border-dark-600 hover:text-slate-300']">è†å¬æ•…äº‹</button>
                        <button @click="tavernState.view = 'list'" :class="['px-4 py-2 rounded border font-bold text-xs uppercase tracking-wider transition-all', tavernState.view === 'list' ? 'bg-amber-900/40 text-amber-400 border-amber-500/50' : 'bg-dark-800 text-slate-500 border-dark-600 hover:text-slate-300']">è—ä¹¦é˜</button>
                    </div>
                </div>

                <!-- Create View -->
                <div v-if="tavernState.view === 'create'" class="max-w-4xl mx-auto space-y-8 animate-fade-in">
                    <!-- Step 1: Upload -->
                    <div v-if="!tavernState.generatedContent" class="glass-panel p-8 rounded-xl border border-dark-700 shadow-2xl relative overflow-hidden">
                         <div class="absolute top-0 right-0 p-6 opacity-5"><svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg></div>
                         <h3 class="text-xl font-bold text-slate-200 font-serif mb-6 flex items-center gap-2"><span class="w-1.5 h-6 bg-amber-500 rounded-full"></span> æäº¤å†’é™©è®°å½•</h3>
                         
                         <div class="space-y-6 relative z-10">
                             <div class="border-2 border-dashed border-dark-600 rounded-xl bg-dark-900/50 hover:bg-dark-800/50 hover:border-amber-500/50 transition-all p-8 text-center cursor-pointer group" @click="$refs.tavernFileInput.click()">
                                 <input ref="tavernFileInput" type="file" accept=".json" class="hidden" @change="importTavernSave">
                                 <svg class="w-12 h-12 mx-auto text-slate-600 group-hover:text-amber-500 transition-colors mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                 <p class="text-slate-300 font-bold mb-2">ç‚¹å‡»ä¸Šä¼ è·‘å›¢å­˜æ¡£ (.json)</p>
                                 <p class="text-xs text-slate-500">æ”¯æŒä»â€œè®°å¿†å›å»Šâ€å¯¼å‡ºçš„å­˜æ¡£æ–‡ä»¶</p>
                             </div>

                             <div v-if="tavernState.sourceData" class="bg-dark-800/80 rounded-lg p-4 border border-amber-500/30 flex justify-between items-center animate-slide-up">
                                 <div>
                                     <div class="text-xs text-amber-500 font-bold uppercase tracking-wider mb-1">å·²åŠ è½½å­˜æ¡£</div>
                                     <div class="text-slate-200 font-serif font-bold">{{ tavernState.sourceData.moduleName || 'æœªå‘½åæ¨¡ç»„' }}</div>
                                     <div class="text-xs text-slate-500 mt-1">è®°å½•æ•°: {{ tavernState.sourceData.log?.length || 0 }} | è°ƒæŸ¥å‘˜: {{ tavernState.sourceData.investigators?.map(i=>i.name).join(', ') || 'æœªçŸ¥' }}</div>
                                 </div>
                                 <button @click="tavernState.sourceData = null" class="text-slate-500 hover:text-red-400 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                             </div>

                             <div v-if="tavernState.sourceData" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                 <div>
                                     <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">å™äº‹é£æ ¼</label>
                                     <select v-model="tavernState.settings.style" class="w-full bg-dark-950 border border-dark-700 rounded px-4 py-2.5 text-slate-300 focus:border-amber-500 outline-none text-sm">
                                         <option value="æ´›å¤«å…‹æ‹‰å¤«ç‰¹å¼ (æ‚¬ç–‘/æ™¦æ¶©)">æ´›å¤«å…‹æ‹‰å¤«ç‰¹å¼ (ç»å…¸)</option>
                                         <option value="ç°ä»£æƒŠæ‚š (å¿«èŠ‚å¥/ç”µå½±æ„Ÿ)">ç°ä»£æƒŠæ‚š (ç”µå½±æ„Ÿ)</option>
                                         <option value="è°ƒæŸ¥å‘˜æ—¥è®° (ç¬¬ä¸€äººç§°/ä¸»è§‚)">è°ƒæŸ¥å‘˜æ—¥è®° (è®°å½•ä½“)</option>
                                         <option value="é»‘æš—ç«¥è¯ (å¥‡å¹»/è¯¡è°²)">é»‘æš—ç«¥è¯ (è¯¡è°²)</option>
                                     </select>
                                 </div>
                                 <div>
                                     <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">å™äº‹è§†è§’</label>
                                     <select v-model="tavernState.settings.perspective" class="w-full bg-dark-950 border border-dark-700 rounded px-4 py-2.5 text-slate-300 focus:border-amber-500 outline-none text-sm">
                                         <option value="ç¬¬ä¸‰äººç§°å…¨çŸ¥">ç¬¬ä¸‰äººç§°å…¨çŸ¥</option>
                                         <option value="ç¬¬ä¸€äººç§° (éšæœºä¸»è§’)">ç¬¬ä¸€äººç§° (éšæœºä¸»è§’)</option>
                                     </select>
                                 </div>
                             </div>

                             <div class="flex justify-end pt-4">
                                 <button v-if="tavernState.sourceData" @click="generateNovel" :disabled="tavernState.isGenerating" class="px-8 py-3 bg-amber-600 hover:bg-amber-500 text-amber-50 font-bold rounded shadow-lg shadow-amber-900/20 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                     <svg v-if="!tavernState.isGenerating" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                     <span v-if="tavernState.isGenerating" class="loading loading-spinner loading-sm"></span>
                                     {{ tavernState.isGenerating ? 'æ­£åœ¨æ’°å†™...' : 'å¼€å§‹åˆ›ä½œ' }}
                                 </button>
                             </div>
                         </div>
                    </div>

                    <!-- Result View -->
                    <div v-else class="space-y-6 animate-slide-up">
                        <div class="flex justify-between items-center bg-dark-900/80 p-4 rounded-lg border border-dark-700 backdrop-blur-md sticky top-0 z-20 shadow-xl">
                             <div class="flex items-center gap-4">
                                 <button @click="tavernState.generatedContent = ''" class="text-slate-400 hover:text-slate-200 text-sm flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> è¿”å›</button>
                                 <span class="w-px h-4 bg-dark-700"></span>
                                 <span class="text-amber-500 font-bold font-serif">{{ tavernState.novelTitle || 'æ— é¢˜' }}</span>
                             </div>
                             <div class="flex gap-2">
                                 <button @click="saveNovel" :disabled="tavernState.isGenerating" class="px-3 py-1.5 bg-dark-800 border border-amber-500/30 text-amber-500 rounded hover:bg-amber-900/20 text-xs font-bold flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg> æ”¶è—</button>
                                 <button @click="exportNovel('markdown')" :disabled="tavernState.isGenerating" class="px-3 py-1.5 bg-dark-800 border border-dark-600 text-slate-300 rounded hover:text-slate-100 text-xs font-bold">å¯¼å‡º MD</button>
                                 <button @click="exportNovel('docx')" :disabled="tavernState.isGenerating" class="px-3 py-1.5 bg-dark-800 border border-dark-600 text-slate-300 rounded hover:text-slate-100 text-xs font-bold">å¯¼å‡º Word</button>
                             </div>
                        </div>

                        <div class="bg-dark-900 shadow-2xl rounded-sm p-8 md:p-12 min-h-[60vh] relative overflow-hidden">
                             <!-- Paper Texture Overlay -->
                             <div class="absolute inset-0 bg-[#fffdf5] opacity-[0.03] pointer-events-none mix-blend-overlay"></div>
                             
                             <div class="prose prose-invert prose-lg max-w-none font-serif leading-loose text-slate-300">
                                 <div v-if="tavernState.isGenerating && !tavernState.generatedContent" class="flex flex-col items-center justify-center py-20 opacity-50">
                                     <div class="typing-indicator scale-150 mb-6"><span></span><span></span><span></span></div>
                                     <p class="text-amber-500 italic">ç¾½æ¯›ç¬”æ­£åœ¨çº¸ä¸Šé£èˆ...</p>
                                 </div>
                                 <div v-else class="markdown-body !bg-transparent !text-slate-300" v-html="renderMarkdown(tavernState.generatedContent)"></div>
                                 <div v-if="tavernState.isGenerating && tavernState.generatedContent" class="mt-4 animate-pulse text-amber-500 text-center text-xl">...</div>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- List View -->
                <div v-if="tavernState.view === 'list'" class="max-w-5xl mx-auto animate-fade-in">
                    <div v-if="tavernState.savedNovels.length === 0" class="text-center py-20 border border-dashed border-dark-700 rounded-lg bg-dark-900/30">
                        <div class="text-slate-500 font-serif italic mb-4">ä¹¦æ¶ä¸Šç©ºç©ºå¦‚ä¹Ÿ...</div>
                        <button @click="tavernState.view = 'create'" class="px-6 py-2 bg-dark-800 text-amber-500 border border-amber-500/30 rounded hover:bg-amber-500 hover:text-dark-900 transition-all font-bold text-sm">å»åˆ›ä½œç¬¬ä¸€ç¯‡</button>
                    </div>
                    <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="(novel, index) in tavernState.savedNovels" :key="novel.id" class="group bg-dark-900 border border-dark-700 hover:border-amber-500/50 rounded-lg overflow-hidden transition-all shadow-lg flex flex-col h-[300px]">
                            <div class="h-2 bg-gradient-to-r from-amber-700 to-amber-900"></div>
                            <div class="p-6 flex-1 flex flex-col">
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="font-bold text-lg text-slate-200 font-serif line-clamp-2 leading-tight group-hover:text-amber-500 transition-colors">{{ novel.title }}</h3>
                                </div>
                                <div class="text-xs text-slate-500 mb-4 font-mono">
                                    <span>{{ new Date(novel.timestamp).toLocaleDateString() }}</span> â€¢ <span>{{ novel.style }}</span>
                                </div>
                                <p class="text-sm text-slate-400 font-serif line-clamp-4 leading-relaxed opacity-70 mb-4 flex-1">{{ novel.preview }}...</p>
                                <div class="flex justify-between items-center pt-4 border-t border-dark-800 mt-auto">
                                    <button @click="viewNovel(index)" class="text-xs font-bold text-amber-500 hover:text-amber-400 uppercase tracking-widest">é˜…è¯»å…¨æ–‡</button>
                                    <button @click="deleteNovel(index)" class="text-slate-600 hover:text-red-500 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, watch, nextTick } = Vue;
        marked.use({ breaks: true });

        // IndexedDB æ•°æ®åº“ç®¡ç†
        const DB_NAME = 'CocTrpgDB';
        const DB_VERSION = 1;
        const STORE_SAVES = 'saves';
        let dbInstance = null;

        const openDatabase = () => {
            return new Promise((resolve, reject) => {
                if (dbInstance) {
                    resolve(dbInstance);
                    return;
                }
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    dbInstance = request.result;
                    resolve(dbInstance);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_SAVES)) {
                        const store = db.createObjectStore(STORE_SAVES, { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        };

        const dbGetAllSaves = async () => {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_SAVES, 'readonly');
                const store = tx.objectStore(STORE_SAVES);
                const request = store.getAll();
                request.onsuccess = () => {
                    const saves = request.result || [];
                    saves.sort((a, b) => b.timestamp - a.timestamp);
                    resolve(saves);
                };
                request.onerror = () => reject(request.error);
            });
        };

        const dbAddSave = async (save) => {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_SAVES, 'readwrite');
                const store = tx.objectStore(STORE_SAVES);
                const request = store.add(save);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const dbDeleteSave = async (id) => {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_SAVES, 'readwrite');
                const store = tx.objectStore(STORE_SAVES);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        };

        const dbGetSave = async (id) => {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_SAVES, 'readonly');
                const store = tx.objectStore(STORE_SAVES);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        createApp({
            setup() {
                const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); });

                const extractPngData = async (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const buffer = e.target.result;
                                const view = new DataView(buffer);
                                let offset = 8; 
                                while (offset < view.byteLength) {
                                    const length = view.getUint32(offset);
                                    const type = String.fromCharCode(view.getUint8(offset+4), view.getUint8(offset+5), view.getUint8(offset+6), view.getUint8(offset+7));
                                    if (type === 'tEXt') {
                                        const dataStart = offset + 8;
                                        const chunkData = new Uint8Array(buffer, dataStart, length);
                                        let nullIdx = -1;
                                        for(let i=0; i<chunkData.length; i++) { if(chunkData[i] === 0) { nullIdx = i; break; } }
                                        if (nullIdx > -1) {
                                            const keyword = new TextDecoder('iso-8859-1').decode(chunkData.slice(0, nullIdx));
                                            const text = new TextDecoder('utf-8').decode(chunkData.slice(nullIdx + 1));
                                            let jsonStr = text;
                                            if (keyword === 'coc_data') { try { jsonStr = decodeURIComponent(escape(window.atob(text))); } catch (e) {} }
                                            try {
                                                if (jsonStr.includes('%7B')) try { jsonStr = decodeURIComponent(jsonStr); } catch(e){}
                                                const firstBrace = jsonStr.indexOf('{');
                                                const lastBrace = jsonStr.lastIndexOf('}');
                                                if (firstBrace !== -1 && lastBrace !== -1) {
                                                    const obj = JSON.parse(jsonStr.substring(firstBrace, lastBrace + 1));
                                                    if (obj.name || obj.stats || obj.skills) { resolve(obj); return; }
                                                }
                                            } catch(e) {}
                                        }
                                    }
                                    offset += 12 + length;
                                }
                                resolve(null);
                            } catch (err) { resolve(null); }
                        };
                        reader.readAsArrayBuffer(file);
                    });
                };

                const compressImage = (source, maxWidth = 300, quality = 0.7) => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.src = source;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width, height = img.height;
                            if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, width, height); ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = () => resolve(source);
                    });
                };

                const currentView = ref('coc');
                const showMobileMenu = ref(false);
                const showMobileRightSidebar = ref(false);
                const toasts = ref([]);
                const confirmState = reactive({ show: false, title: '', message: '', confirmText: 'ç¡®å®š', cancelText: 'å–æ¶ˆ', resolve: null });
                const settlementState = reactive({ show: false, moduleName: '', sanRewardExpr: '1d6', sanRewardVal: 0, skillGrowths: [], specialReward: '', badge: { name: '', desc: '', icon: 'ğŸ…' }, historyLog: '', step: 1, selectedSkills: [], skillSearch: '', customSkillName: '', isRolling: false });
                const tavernState = reactive({ view: 'create', sourceData: null, settings: { style: 'æ´›å¤«å…‹æ‹‰å¤«ç‰¹å¼ (æ‚¬ç–‘/æ™¦æ¶©)', perspective: 'ç¬¬ä¸‰äººç§°å…¨çŸ¥' }, isGenerating: false, generatedContent: '', novelTitle: '', savedNovels: [] });

                const showConfirm = (message, title = 'ç¡®è®¤æ“ä½œ') => { return new Promise((resolve) => { confirmState.message = message; confirmState.title = title; confirmState.show = true; confirmState.resolve = resolve; }); };
                const user = reactive({ name: 'æ¸¸å®¢', avatar: '', uuid: generateUUID() });
                const settings = reactive({ apiUrl: 'https://opis.zeabur.app', apiKey: 'sk-XdfGk68aG9Z4TwnELnXS9PL097BZmC4XIahJldIwiEmswjWy', model: 'gemini-3-pro-preview-maxthinking', supabaseUrl: 'https://ghswjgxrblpdklukxjnq.supabase.co', supabaseKey: 'sb_publishable_rIc2MYg6kaGIQcddDgVKYw_uLkWaY4E', temperature: 1.0 });

                const statDisplayMap = { STR: 'åŠ›é‡', CON: 'ä½“è´¨', SIZ: 'ä½“å‹', DEX: 'æ•æ·', APP: 'å¤–è²Œ', INT: 'æ™ºåŠ›', POW: 'æ„å¿—', EDU: 'æ•™è‚²', LUCK: 'å¹¸è¿' };
                const cocState = reactive({ mode: null, module: null, tempModuleText: '', investigators: [], activeInvestigatorIndex: -1, gameState: 'idle', log: [], systemPrompt: '', pendingRolls: [] });
                const lastAssistantIndex = Vue.computed(() => { let idx = -1; for (let i = 0; i < cocState.log.length; i++) { if (cocState.log[i].role === 'assistant') idx = i; } return idx; });

                const clearUserAssignments = (userId) => { Object.keys(multiplayerState.assignments).forEach(key => { if (multiplayerState.assignments[key] === userId) delete multiplayerState.assignments[key]; }); };
                // ç±»å‹å®‰å…¨çš„å­—ç¬¦ä¸²è½¬æ¢å‡½æ•°
                const ensureString = (val) => {
                    if (val === null || val === undefined) return '';
                    if (typeof val === 'string') return val;
                    if (typeof val === 'object') {
                        try { return JSON.stringify(val); } catch(e) { return String(val); }
                    }
                    return String(val);
                };
                const hasCot = (text) => { const s = ensureString(text); return s && (s.includes('<cot>') || s.includes('<cot')); };
                const getCotContent = (text) => { const s = ensureString(text); if (!s) return ''; const match = s.match(/<cot>([\s\S]*?)(?:<\/cot>|<cot>|$)/); return match ? match[1] : (s.includes('<cot>') ? s.split('<cot>')[1] || '' : ''); };
                const removeCot = (text) => { const s = ensureString(text); if (!s) return ''; let clean = s.replace(/<cot>[\s\S]*?(?:<\/cot>|<cot>)/g, '').trim(); if (clean.includes('<cot>')) clean = clean.split('<cot>')[0].trim(); return clean; };
                const toggleCot = async (index) => { if (cocState.mode === 'multi' && !multiplayerState.isHost && !multiplayerState.cotAuthorizedUsers.includes(user.uuid)) { if (await showConfirm('æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹æ€ç»´é“¾ (CoT)ã€‚æ˜¯å¦å‘æˆ¿ä¸»ç”³è¯·æƒé™ï¼Ÿ', 'ç”³è¯·æƒé™')) requestCotAccess(); return; } const msg = cocState.log[index]; if (msg) msg.showCot = !msg.showCot; };
                const requestCotAccess = () => { if (!multiplayerState.inRoom) return; broadcastMessage({ type: 'request_cot_access', userId: user.uuid, userName: user.name }); showToast('å·²å‘é€æƒé™ç”³è¯·', 'info'); };
                const grantCotAccess = (targetUserId) => { if (!multiplayerState.cotAuthorizedUsers.includes(targetUserId)) { multiplayerState.cotAuthorizedUsers.push(targetUserId); broadcastMessage({ type: 'grant_cot_access', userId: targetUserId, authorizedUsers: multiplayerState.cotAuthorizedUsers }); showToast('å·²æˆæƒæŸ¥çœ‹ CoT', 'success'); } };

                const regenerateLastResponse = async () => {
                    if (cocState.mode === 'multi' && !multiplayerState.isHost) return showToast('ä»…æˆ¿ä¸»å¯ä»¥é‡æ–°ç”Ÿæˆ', 'warning');
                    const lastAiIdx = lastAssistantIndex.value;
                    if (lastAiIdx === -1) return;
                    if (!await showConfirm('ç¡®å®šè¦å›æº¯åˆ°æ­¤å¤„å¹¶é‡æ–°ç”Ÿæˆå—ï¼Ÿè¯¥æ¶ˆæ¯åŠä¹‹åçš„æ‰€æœ‰å¯¹è¯å°†è¢«æ¸…é™¤ã€‚', 'å›æº¯é‡ç”Ÿæˆ')) return;
                    
                    // Rollback state changes from deleted messages
                    for (let i = cocState.log.length - 1; i >= lastAiIdx; i--) {
                        const msg = cocState.log[i];
                        if (msg.stRollbacks) {
                            rollbackStChanges(msg.stRollbacks);
                        }
                    }

                    cocState.log.splice(lastAiIdx);
                    multiplayerState.roundActionIds = [];
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        broadcastMessage({ type: 'sync_state', log: cocState.log, gameState: cocState.gameState, investigators: cocState.investigators, assignments: multiplayerState.assignments, assignmentDetails: multiplayerState.assignmentDetails, turnIndex: multiplayerState.turnIndex, roundActionIds: [], cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers });
                        broadcastMessage({ type: 'regenerate_start' });
                    }
                    generateResponse();
                };
                const regenerateAiMessage = async (index) => {
                    const msg = cocState.log[index];
                    if (!msg || !msg.isAiGenerated) return;
                    if (cocState.mode === 'multi' && !multiplayerState.isHost) return showToast('ä»…æˆ¿ä¸»å¯ä»¥é‡æ–°ç”Ÿæˆ', 'warning');
                    if (!await showConfirm('ç¡®å®šè¦å›æº¯åˆ°æ­¤å¤„å¹¶é‡æ–°ç”Ÿæˆå—ï¼Ÿè¯¥æ¶ˆæ¯åŠä¹‹åçš„æ‰€æœ‰å¯¹è¯å°†è¢«æ¸…é™¤ã€‚', 'å›æº¯é‡ç”Ÿæˆ')) return;
                    
                    // Rollback state changes from deleted messages
                    for (let i = cocState.log.length - 1; i >= index; i--) {
                        const m = cocState.log[i];
                        if (m.stRollbacks) {
                            rollbackStChanges(m.stRollbacks);
                        }
                    }

                    const aiIndex = msg.aiIndex;
                    cocState.log.splice(index);
                    multiplayerState.roundActionIds = [];
                    
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                         broadcastMessage({ type: 'sync_log', log: cocState.log });
                         broadcastMessage({ type: 'sync_state', roundActionIds: [] });
                         broadcastMessage({ type: 'sync_investigators', investigators: cocState.investigators });
                    }
                    
                    await processAiPlayers(aiIndex);
                    generateResponse();
                };
                const cocInput = ref(''); const cocInputRef = ref(null); const cocChatContainer = ref(null); const isGenerating = ref(false);
                const hasAiTeammates = Vue.computed(() => {
                    if (cocState.mode === 'multi') return false;
                    return Object.values(multiplayerState.assignments).some(uid => uid.startsWith('ai_'));
                });
                const isRoundLocked = Vue.computed(() => {
                    if (isGenerating.value) return true;
                    if (cocState.mode === 'multi') {
                        return multiplayerState.roundActionIds.includes(user.uuid);
                    }
                    if (cocState.mode === 'single' && hasAiTeammates.value) {
                        return multiplayerState.roundActionIds.includes(user.uuid);
                    }
                    return false;
                });
                const showMentionList = ref(false); const mentionQuery = ref('');
                const mentionCandidates = Vue.computed(() => { if (!mentionQuery.value && mentionQuery.value !== '') return []; const q = mentionQuery.value.toLowerCase(); let candidates = []; if (cocState.mode === 'multi' || hasAiTeammates.value) { cocState.investigators.forEach((inv, idx) => { if (multiplayerState.assignments[idx] && multiplayerState.assignments[idx] !== user.uuid) candidates.push({ type: 'character', name: inv.name, id: `char_${idx}`, avatar: inv.avatar }); }); } return candidates.filter(c => c.name.toLowerCase().includes(q)); });
                const handleInput = (e) => { const val = e.target.value; const cursor = e.target.selectionStart; const lastAt = val.lastIndexOf('@', cursor - 1); if (lastAt !== -1 && (lastAt === 0 || val[lastAt - 1] === ' ' || val[lastAt - 1] === '\n')) { const query = val.substring(lastAt + 1, cursor); if (!query.includes(' ')) { mentionQuery.value = query; showMentionList.value = true; return; } } showMentionList.value = false; };
                const selectMention = (candidate) => { const val = cocInput.value; const cursor = cocInputRef.value.selectionStart; const lastAt = val.lastIndexOf('@', cursor - 1); if (lastAt !== -1) { const before = val.substring(0, lastAt); const after = val.substring(cursor); cocInput.value = `${before}@${candidate.name} ${after}`; showMentionList.value = false; nextTick(() => { cocInputRef.value.focus(); const newCursorPos = lastAt + 1 + candidate.name.length + 1; cocInputRef.value.setSelectionRange(newCursorPos, newCursorPos); }); } };

                const multiplayerState = reactive({ isConnected: false, inRoom: false, roomId: null, myId: null, isHost: false, members: [], turnStatus: {}, skipStatus: {}, isReady: false, assignments: {}, turnIndex: 0, roundActionIds: [], cotAuthorizedUsers: [], syncReceived: false });
                let joinRetryInterval = null;
                const friends = ref([]); const friendRequests = ref([]); const friendInput = ref(''); const showJoinInput = ref(false); const joinRoomId = ref(''); const savedGames = ref([]);
                const showBroadcast = ref(false); const dontShowBroadcast = ref(false); const currentVersion = '2.0 Beta';
                const checkBroadcast = () => { const lastReadVersion = localStorage.getItem('coc_broadcast_read_version'); if (lastReadVersion !== currentVersion) showBroadcast.value = true; };
                const closeBroadcast = () => { showBroadcast.value = false; if (dontShowBroadcast.value) localStorage.setItem('coc_broadcast_read_version', currentVersion); };
                const openCocCard = () => { window.open('Workshop/index.html', '_blank'); showMobileMenu.value = false; };
                
                let supabaseClient = null; let roomChannel = null;

                const handleUserAvatarUpload = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        const base64 = await compressImage(URL.createObjectURL(file), 300, 0.8);
                        user.avatar = base64;
                        saveData();
                        showToast('å¤´åƒæ›´æ–°æˆåŠŸ', 'success');
                    } catch (err) {
                        showToast('å¤´åƒä¸Šä¼ å¤±è´¥', 'error');
                    }
                };

                const saveData = () => { localStorage.setItem('coc_user', JSON.stringify(user)); localStorage.setItem('coc_settings', JSON.stringify(settings)); localStorage.setItem('coc_investigators', JSON.stringify(cocState.investigators)); localStorage.setItem('coc_friends', JSON.stringify(friends.value)); localStorage.setItem('coc_tavern_novels', JSON.stringify(tavernState.savedNovels)); };
                // é»˜è®¤é…ç½® - å…¬ç›Šé¡¹ç›®é¢„è®¾å€¼ï¼Œå¼ºåˆ¶ä½¿ç”¨
                const DEFAULT_API_CONFIG = {
                    apiUrl: 'https://opis.zeabur.app',
                    apiKey: 'sk-XdfGk68aG9Z4TwnELnXS9PL097BZmC4XIahJldIwiEmswjWy',
                    model: 'gemini-3-pro-preview-maxthinking',
                    supabaseUrl: 'https://ghswjgxrblpdklukxjnq.supabase.co',
                    supabaseKey: 'sb_publishable_rIc2MYg6kaGIQcddDgVKYw_uLkWaY4E'
                };

                const loadData = async () => {
                    const lUser = localStorage.getItem('coc_user'); if (lUser) Object.assign(user, JSON.parse(lUser));
                    const lSettings = localStorage.getItem('coc_settings'); if (lSettings) Object.assign(settings, JSON.parse(lSettings));
                    
                    // å¼ºåˆ¶åˆ·æ–°APIé…ç½®ä¸ºé»˜è®¤å€¼ï¼ˆå…¬ç›Šé¡¹ç›®ï¼Œä¸éœ€è¦ç”¨æˆ·è‡ªå·±å¡«å†™ï¼‰
                    settings.apiUrl = DEFAULT_API_CONFIG.apiUrl;
                    settings.apiKey = DEFAULT_API_CONFIG.apiKey;
                    settings.model = DEFAULT_API_CONFIG.model;
                    settings.supabaseUrl = DEFAULT_API_CONFIG.supabaseUrl;
                    settings.supabaseKey = DEFAULT_API_CONFIG.supabaseKey;
                    
                    const lInv = localStorage.getItem('coc_investigators'); if (lInv) cocState.investigators = JSON.parse(lInv);
                    const lFriends = localStorage.getItem('coc_friends'); if (lFriends) friends.value = JSON.parse(lFriends);
                    const lNovels = localStorage.getItem('coc_tavern_novels'); if (lNovels) tavernState.savedNovels = JSON.parse(lNovels);
                    // ä» IndexedDB åŠ è½½å­˜æ¡£
                    try {
                        savedGames.value = await dbGetAllSaves();
                    } catch (e) {
                        console.error('Failed to load saves from IndexedDB:', e);
                        savedGames.value = [];
                    }
                };

                const parseStLogDiff = (log) => {
                    // è§£æ log ä¸­çš„æ•°å€¼å˜åŒ–
                    // åŸæ ¼å¼: ğŸ”§ **å±æ€§å˜æ›´** è§’è‰²å çš„ HP: 10 â” 7
                    if (!log) return 0;
                    const match = log.match(/:\s*(\d+)\s*â”\s*(\d+)/);
                    if (match) {
                        return parseInt(match[2]) - parseInt(match[1]);
                    }
                    return 0;
                };

                const formatStLog = (log) => {
                    // å°† log æ ¼å¼åŒ–ä¸ºæ›´æ˜“è¯»çš„ HTML
                    // åŸæ ¼å¼: ğŸ”§ **å±æ€§å˜æ›´** è§’è‰²å çš„ HP: 10 â” 7
                    if (!log) return '';
                    // ç§»é™¤ emoji å’Œ markdown
                    let formatted = log.replace(/ğŸ”§\s*\*\*å±æ€§å˜æ›´\*\*\s*/, '');
                    // é«˜äº®è§’è‰²åå’Œå±æ€§
                    formatted = formatted.replace(/(\S+)\s*çš„\s*(\w+):\s*(\d+)\s*â”\s*(\d+)/, (match, name, prop, old, newVal) => {
                        const oldNum = parseInt(old);
                        const newNum = parseInt(newVal);
                        const diff = newNum - oldNum;
                        const diffStr = diff > 0 ? `<span class="text-mystic-green font-bold">+${diff}</span>` : `<span class="text-red-400 font-bold">${diff}</span>`;
                        return `<span class="text-mystic-gold font-bold">${name}</span> <span class="text-slate-500">çš„</span> <span class="font-bold text-slate-200">${prop}</span>: <span class="text-slate-500">${old}</span> <span class="text-slate-500">â”</span> <span class="font-bold ${newNum < oldNum ? 'text-red-300' : 'text-mystic-green'}">${newVal}</span> <span class="ml-1">(${diffStr})</span>`;
                    });
                    return formatted;
                };

                const sanitizeBadgeIcon = (icon) => {
                    if (!icon || typeof icon !== 'string') return 'ğŸ…';
                    const trimmed = icon.trim();
                    if (!trimmed) return 'ğŸ…';
                    // å¦‚æœæ˜¯ emoji (é•¿åº¦1-2ä¸ªå­—ç¬¦ï¼Œä¸å«<)ï¼Œç›´æ¥è¿”å›
                    if (trimmed.length <= 4 && !trimmed.includes('<')) return trimmed;
                    // å¦‚æœåŒ…å« SVG æˆ– HTML æ ‡ç­¾ï¼Œç”¨ DOMPurify æ¸…ç†
                    if (trimmed.includes('<')) return DOMPurify.sanitize(trimmed);
                    return trimmed;
                };
                const showToast = (msg, type = 'info') => { const id = Date.now(); toasts.value.push({ id, message: msg, type }); setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000); };
                const copyToClipboard = (text) => { if (!text) return; navigator.clipboard.writeText(text).then(() => showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')).catch(() => showToast('å¤åˆ¶å¤±è´¥', 'error')); };

                const executeStCommand = (inv, prop, valExpr) => {
                    if (!inv || !prop || !valExpr) return null;
                    const lowerProp = prop.toLowerCase(); let targetKey = ''; let isStat = false;
                    const statMap = { 'åŠ›é‡': 'STR', 'STR': 'STR', 'ä½“è´¨': 'CON', 'CON': 'CON', 'ä½“å‹': 'SIZ', 'SIZ': 'SIZ', 'æ•æ·': 'DEX', 'DEX': 'DEX', 'å¤–è²Œ': 'APP', 'APP': 'APP', 'æ™ºåŠ›': 'INT', 'INT': 'INT', 'çµæ„Ÿ': 'INT', 'æ„å¿—': 'POW', 'POW': 'POW', 'æ•™è‚²': 'EDU', 'EDU': 'EDU', 'çŸ¥è¯†': 'EDU', 'å¹¸è¿': 'LUCK', 'LUCK': 'LUCK' };
                    if (['hp', 'mp', 'san'].includes(lowerProp)) targetKey = lowerProp;
                    else { const key = statMap[prop] || statMap[prop.toUpperCase()]; if (key) { targetKey = key; isStat = true; } }
                    if (!targetKey) return { success: false, msg: `æœªæ‰¾åˆ°å±æ€§: ${prop}` };
                    let currentVal = isStat ? inv.stats[targetKey] : inv[targetKey]; let newVal = currentVal; let change = 0;
                    const match = valExpr.match(/^([+-]?)(\d+|d\d+|\d+d\d+)(.*)$/); let op = '';
                    if (match) {
                        op = match[1]; const valPart = match[2]; let valNum = 0;
                        if (valPart.includes('d')) { const [n, d] = valPart.split('d').map(v => parseInt(v) || 1); for(let i=0; i<n; i++) valNum += Math.floor(Math.random() * d) + 1; } else valNum = parseInt(valPart);
                        if (op === '+') { newVal += valNum; change = valNum; } else if (op === '-') { newVal -= valNum; change = -valNum; } else { newVal = valNum; change = newVal - currentVal; }
                    } else return { success: false, msg: `æ•°å€¼æ ¼å¼é”™è¯¯: ${valExpr}` };
                    if (isStat) inv.stats[targetKey] = newVal; else inv[targetKey] = newVal;
                    if (targetKey === 'san') inv[targetKey] = Math.max(0, Math.min(99, inv[targetKey])); if (targetKey === 'hp') inv[targetKey] = Math.max(0, Math.min(inv.maxHp || 99, inv[targetKey])); if (targetKey === 'mp') inv[targetKey] = Math.max(0, Math.min(inv.maxMp || 99, inv[targetKey]));
                    
                    const finalVal = isStat ? inv.stats[targetKey] : inv[targetKey];
                    saveData();
                    return {
                        success: true,
                        msg: `${prop.toUpperCase()} ${op==='+'?'+':''}${change} => ${finalVal}`,
                        log: `ğŸ”§ **å±æ€§å˜æ›´** ${inv.name} çš„ ${prop.toUpperCase()}: ${currentVal} â” ${finalVal}`,
                        rollback: { invIndex: -1, prop: targetKey, isStat, oldVal: currentVal } // invIndex will be injected by caller
                    };
                };

                const findInvestigatorIndexByName = (name) => {
                    if (!name) return -1;
                    return cocState.investigators.findIndex(i => i.name === name || i.name.includes(name));
                };

                const applyStCommands = (content, defaultInvIndex = -1) => {
                    if (!content) return { logs: [], rollbacks: [] };
                    
                    // å…ˆç§»é™¤ COT å†…å®¹ï¼Œé¿å…æ‰§è¡Œæ€ç»´é“¾ä¸­çš„æŒ‡ä»¤
                    let cleanContent = removeCot(content);
                    
                    // Regex to match .st commands: (@Name)? .st prop val
                    // Updated to support Chinese names and better spacing
                    // Matches:
                    // 1. @OptionalName (lazy)
                    // 2. .st or ã€‚st
                    // 3. property (e.g. hp)
                    // 4. value (e.g. -3, +1d6, 10)
                    const regex = /(?:@([^\s\.]+)\s+)?[\.ã€‚]st\s+(\w+)\s+([+-]?\d+(?:d\d+)?|[+-]?\d+)/gi;
                    const logs = [];
                    const rollbacks = [];
                    
                    let match;
                    while ((match = regex.exec(cleanContent)) !== null) {
                        const targetName = match[1];
                        const prop = match[2];
                        const valExpr = match[3];
                        
                        let invIndex = defaultInvIndex;
                        if (targetName) {
                            const foundIndex = findInvestigatorIndexByName(targetName);
                            if (foundIndex !== -1) invIndex = foundIndex;
                        }
                        
                        if (invIndex !== -1 && cocState.investigators[invIndex]) {
                            const result = executeStCommand(cocState.investigators[invIndex], prop, valExpr);
                            if (result && result.success) {
                                logs.push(result.log);
                                rollbacks.push({ ...result.rollback, invIndex });
                            }
                        }
                    }
                    return { logs, rollbacks };
                };

                const rollbackStChanges = (rollbacks) => {
                    if (!rollbacks || !Array.isArray(rollbacks)) return;
                    rollbacks.reverse().forEach(rb => {
                        const inv = cocState.investigators[rb.invIndex];
                        if (inv) {
                            if (rb.isStat) inv.stats[rb.prop] = rb.oldVal;
                            else inv[rb.prop] = rb.oldVal;
                        }
                    });
                    saveData();
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        broadcastMessage({ type: 'sync_investigators', investigators: cocState.investigators });
                    }
                };
                
                const renderMarkdown = (text, disableCommands = false) => {
                    // ç¡®ä¿è¾“å…¥æ˜¯å­—ç¬¦ä¸²ç±»å‹
                    const str = ensureString(text);
                    if (!str) return '';
                    try {
                        let processed = str;
                        // åªæœ‰éCOTå†…å®¹æ‰æ¸²æŸ“å¯ç‚¹å‡»çš„æŒ‡ä»¤æŒ‰é’®
                        if (!disableCommands) {
                            processed = str.replace(/(^|[\s\n>])(\.(?:ra|rc|sc|san|r|roll|st|set)(?:\s+[^\s\n<ã€‚ï¼Œï¼\?]+)?)(?=$|[\s\n<ã€‚ï¼Œï¼\?])/gi, '$1<span class="cursor-pointer text-mystic-gold font-bold hover:underline decoration-mystic-gold/30" onclick="event.stopPropagation(); window.triggerCocCommand(\'$2\')">$2</span>');
                        }
                        return DOMPurify.sanitize(marked.parse(processed));
                    } catch (e) {
                        console.error('Markdown Render Error:', e);
                        return str;
                    }
                };

                const allPlayersReady = Vue.computed(() => {
                    // å¿…é¡»æœ‰æˆ¿ä¸»
                    const hostPresent = multiplayerState.members.some(m => m.isHost);
                    if (!hostPresent) return false;
                    
                    // æ‰€æœ‰åœ¨åœºæˆå‘˜å¿…é¡»å·²å‡†å¤‡ï¼ˆæˆ¿ä¸»é™¤å¤–ï¼Œæˆ¿ä¸»ç‚¹å¼€å§‹å³è§†ä¸ºå‡†å¤‡ï¼‰
                    const membersReady = multiplayerState.members.every(m => m.isReady || m.isHost);
                    if (!membersReady) return false;

                    // å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªè§’è‰²è¢«åˆ†é…ï¼ˆç»™çœŸäººæˆ–AIï¼‰ï¼Œä¸èƒ½ç©ºç€å¼€å±€
                    const hasAssignments = Object.keys(multiplayerState.assignments).length > 0;
                    return hasAssignments;
                });
                
                const toggleAiPlayer = (index) => {
                    if (multiplayerState.assignments[index] && multiplayerState.assignments[index].startsWith('ai_')) {
                        delete multiplayerState.assignments[index];
                    } else {
                        multiplayerState.assignments[index] = `ai_${index}`;
                    }
                    if (multiplayerState.isHost) broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments });
                };

                const processAiPlayers = async (targetIndex = null) => {
                    let aiIndices = [];
                    if (targetIndex !== null) {
                        if (multiplayerState.assignments[targetIndex] === `ai_${targetIndex}`) aiIndices = [targetIndex];
                    } else {
                        aiIndices = Object.keys(multiplayerState.assignments).filter(k => multiplayerState.assignments[k] === `ai_${k}`);
                    }
                    if (aiIndices.length === 0) return;
                    
                    for (const idx of aiIndices) {
                        const inv = cocState.investigators[idx];
                        if (!inv) continue;
                        
                        const aiSystemPrompt = `ä½ æ­£åœ¨å‚ä¸ä¸€åœºCOCè·‘å›¢æ¸¸æˆï¼Œæ‰®æ¼”è§’è‰²ï¼š${inv.name}ã€‚
è§’è‰²èµ„æ–™ï¼š
${buildInvestigatorProfile(inv)}

ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘
1. **åƒçœŸäººç©å®¶ä¸€æ ·è¡ŒåŠ¨**ï¼šå›å¤å¿…é¡»æå…¶ç®€çŸ­ã€é«˜æ•ˆã€å£è¯­åŒ–ã€‚
2. **å“åº” KP æŒ‡ä»¤**ï¼š
   - å½“ KP è¦æ±‚è¿›è¡ŒæŠ€èƒ½æ£€å®šï¼ˆå¦‚"è¯·è¿‡ä¾¦æŸ¥"ï¼‰æ—¶ï¼Œ**å¿…é¡»**è¾“å‡ºå¯¹åº”çš„æ£€å®šæŒ‡ä»¤ã€‚
   - æ£€å®šæŒ‡ä»¤æ ¼å¼ï¼š.ra æŠ€èƒ½å (å¦‚ .ra ä¾¦æŸ¥ã€.ra è†å¬ã€.ra åŠ›é‡)ã€‚
   - ä¸è¦åªå£å¤´è¯´"æˆ‘ä¾¦æŸ¥ä¸€ä¸‹"ï¼Œè¦ç›´æ¥æ‰”å‡ºæŒ‡ä»¤ã€‚
   - å¦‚æœ KP è¦æ±‚ San Checkï¼Œè¾“å‡º .sc æˆåŠŸæ‰£é™¤/å¤±è´¥æ‰£é™¤ (å¦‚ .sc 1/1d6)ã€‚
3. **ä¸¥ç¦å†™å°è¯´**ï¼šç»å¯¹ä¸è¦æå†™å¿ƒç†æ´»åŠ¨ã€ä¸è¦æ¸²æŸ“æ°”æ°›ã€ä¸è¦é•¿ç¯‡å¤§è®ºã€‚
4. **å­—æ•°é™åˆ¶**ï¼šæ§åˆ¶åœ¨ 30 å­—ä»¥å†…ã€‚
5. **è¡ŒåŠ¨å‡†åˆ™**ï¼šåªæè¿°ä½ åšä»€ä¹ˆæˆ–è¯´ä»€ä¹ˆï¼Œä¸è¦è§£é‡ŠåŸå› ã€‚
6. ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦å¸¦ä»»ä½•å‰ç¼€æˆ–è§£é‡Šã€‚`;

                        const context = cocState.log.slice(-10).map(m => `${m.name}: ${m.content}`).join('\n');

                        try {
                            const res = await fetch(`${settings.apiUrl}/v1/chat/completions`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                                body: JSON.stringify({
                                    model: settings.model,
                                    messages: [
                                        { role: 'system', content: aiSystemPrompt },
                                        { role: 'user', content: `å½“å‰å‰§æƒ…è®°å½•ï¼š\n${context}\n\nè¯·ç»™å‡ºä½ çš„è¡ŒåŠ¨ï¼š` }
                                    ],
                                    stream: false
                                })
                            });
                            const data = await res.json();
                            const content = data.choices[0]?.message?.content;
                            
                            if (content) {
                                const msg = { role: 'user', name: inv.name, avatar: inv.avatar, content, isAiGenerated: true, aiIndex: idx };
                                processAiMessageStCommands(msg); // Process .st commands for AI
                                cocState.log.push(msg);
                                if (cocState.mode === 'multi' && multiplayerState.isHost) {
                                    broadcastMessage({
                                        type: 'sync_state',
                                        log: cocState.log,
                                        gameState: cocState.gameState,
                                        investigators: cocState.investigators,
                                        assignments: multiplayerState.assignments,
                                        assignmentDetails: multiplayerState.assignmentDetails,
                                        turnIndex: multiplayerState.turnIndex,
                                        roundActionIds: multiplayerState.roundActionIds,
                                        cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers
                                    });
                                }
                            }
                        } catch (e) {
                            console.error('AI Player Error:', e);
                        }
                    }
                };

                const processAiMessageStCommands = (msg) => {
                    // For AI messages, we assume the AI is operating on its own character (msg.aiIndex)
                    // But if the AI uses @OtherPlayer .st, it should probably be respected or restricted?
                    // Let's allow AI to modify itself or others if explicitly targeted.
                    // Default target is itself.
                    if (msg && msg.content && typeof msg.aiIndex === 'number') {
                        const { logs, rollbacks } = applyStCommands(msg.content, msg.aiIndex);
                        if (logs.length > 0) {
                            msg.stLogs = logs;
                            msg.stRollbacks = rollbacks;
                            // Optionally append logs to content? Or just keep them hidden/system level?
                            // User request: "ç»™äºˆç³»ç»Ÿæç¤º" -> Show system logs
                            // We can append logs to the message content or insert new system messages.
                            // Inserting new messages might be messy for rollback.
                            // Let's append to the message content for now or add a special visual indicator.
                            // Or better: push system messages to log.
                            // BUT, we need to link them for rollback.
                            // Storing logs in msg object allows display component to render them.
                        }
                    }
                };

                const checkAndTriggerRound = async () => {
                    const isSingleHost = cocState.mode === 'single';
                    if ((!multiplayerState.isHost && !isSingleHost) || isGenerating.value) return;
                    
                    let participants = [];
                    if (isSingleHost) {
                        participants.push(user.uuid);
                        Object.values(multiplayerState.assignments).forEach(uid => {
                            if (uid.startsWith('ai_')) participants.push(uid);
                        });
                    } else {
                        participants = [...new Set(Object.values(multiplayerState.assignments))];
                        // Fix: ç¡®ä¿æˆ¿ä¸»ä¹Ÿåœ¨å‚ä¸è€…åˆ—è¡¨ä¸­ï¼Œé˜²æ­¢æˆå‘˜å…ˆè¡ŒåŠ¨å¯¼è‡´è·³è¿‡æˆ¿ä¸»
                        const host = multiplayerState.members.find(m => m.isHost);
                        if (host && !participants.includes(host.id)) {
                            participants.push(host.id);
                        }
                    }
                    if (participants.length === 0) return;
                    
                    const realPlayers = participants.filter(uid => !uid.startsWith('ai_'));
                    const allActed = realPlayers.every(uid => multiplayerState.roundActionIds.includes(uid));
                    
                    if (allActed) {
                        await processAiPlayers();
                        multiplayerState.roundActionIds = [];
                        if (!isSingleHost && multiplayerState.isHost) {
                            broadcastMessage({
                                type: 'sync_state',
                                roundActionIds: [],
                                log: cocState.log
                            });
                        }
                        generateResponse();
                    }
                };
                
                const selectCocMode = (mode) => {
                    if (mode === 'multi') {
                        if (!multiplayerState.inRoom) { currentView.value = 'multiplayer'; return showToast('è¯·å…ˆåŠ å…¥æˆ¿é—´', 'warning'); }
                        if (multiplayerState.isHost) broadcastMessage({ type: 'change_mode', mode: 'multi', view: 'preparing', gameState: 'preparing' });
                    } else if (mode === 'single') {
                        multiplayerState.assignments = {};
                    }
                    cocState.mode = mode; currentView.value = 'preparing'; cocState.gameState = 'preparing';
                };
                const exitCocMode = () => { if (cocState.mode === 'multi') exitCocGame(); else { cocState.mode = null; cocState.gameState = 'idle'; currentView.value = 'coc'; } };
                const exitCocGame = async () => { if (cocState.mode === 'multi' && multiplayerState.isHost) { if (await showConfirm('æ‚¨æ˜¯æˆ¿ä¸»ï¼Œé€€å‡ºå°†è§£æ•£æˆ¿é—´ã€‚æ˜¯å¦å…ˆä¿å­˜å½“å‰æ¸¸æˆè¿›åº¦ï¼Ÿ', 'ä¿å­˜è¿›åº¦')) saveGame(); else return; if (!await showConfirm('ç¡®å®šè¦è§£æ•£æˆ¿é—´å¹¶é€€å‡ºå—ï¼Ÿæ‰€æœ‰ç©å®¶å°†è¢«å¼ºåˆ¶é€€å‡ºã€‚', 'è§£æ•£æˆ¿é—´')) return; await broadcastMessage({ type: 'room_closed' }); } else { if(!await showConfirm('ç¡®å®šé€€å‡ºå—ï¼Ÿæœªä¿å­˜çš„è¿›åº¦å°†ä¸¢å¤±ã€‚', 'é€€å‡ºç¡®è®¤')) return; } cocState.gameState = 'idle'; cocState.log = []; multiplayerState.assignments = {}; currentView.value = 'coc'; if (multiplayerState.inRoom) leaveRoom(); };
                
                const saveGame = async () => {
                    if (!cocState.mode) {
                        showToast('å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„æ¸¸æˆ', 'warning');
                        return;
                    }
                    const save = { id: Date.now(), timestamp: Date.now(), mode: cocState.mode, moduleName: cocState.module?.name, moduleContent: cocState.module?.content, investigators: cocState.investigators, log: cocState.log, systemPrompt: cocState.systemPrompt, pendingRolls: cocState.pendingRolls, multiplayer: cocState.mode === 'multi' ? { assignments: multiplayerState.assignments, assignmentDetails: Object.entries(multiplayerState.assignments).reduce((acc, [idx, uid]) => { const member = multiplayerState.members.find(m => m.id === uid); if (member) acc[idx] = { id: uid, name: member.name }; return acc; }, {}), turnIndex: multiplayerState.turnIndex, roundActionIds: multiplayerState.roundActionIds } : { assignments: multiplayerState.assignments, roundActionIds: multiplayerState.roundActionIds }, lastMessage: cocState.log.length > 0 ? cocState.log[cocState.log.length - 1].content : '' };
                    
                    try {
                        // å°† Vue å“åº”å¼å¯¹è±¡è½¬æ¢ä¸ºçº¯ JSON å¯¹è±¡ï¼Œé¿å… IndexedDB å…‹éš†é”™è¯¯
                        const pureSave = JSON.parse(JSON.stringify(save));
                        await dbAddSave(pureSave);
                        savedGames.value.unshift(pureSave);
                        showToast('æ¸¸æˆè¿›åº¦å·²ä¿å­˜è‡³è®°å¿†å›å»Š', 'success');
                    } catch (e) {
                        console.error('Save game error:', e);
                        showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
                    }
                };
                const deleteSave = async (index) => {
                    if(await showConfirm('ç¡®å®šè¦é—å¿˜è¿™æ®µè®°å¿†å—ï¼Ÿ', 'åˆ é™¤å­˜æ¡£')) {
                        const save = savedGames.value[index];
                        if (save && save.id) {
                            try {
                                await dbDeleteSave(save.id);
                                savedGames.value.splice(index, 1);
                            } catch (e) {
                                console.error('Delete save error:', e);
                                showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
                            }
                        }
                    }
                };
                const exportSave = (index) => { const save = savedGames.value[index]; if (!save) return showToast('å­˜æ¡£ä¸å­˜åœ¨', 'error'); const modeTag = save.mode === 'multi' ? 'Multi' : 'Single'; const filename = `Zarkto_Save_${modeTag}_${sanitizeFilename(save.moduleName || 'Untitled')}_${new Date(save.timestamp).toISOString().slice(0,10)}.json`; const blob = new Blob([JSON.stringify(save, null, 2)], { type: 'application/json' }); downloadFile(blob, filename); showToast('å­˜æ¡£å·²å¯¼å‡º', 'success'); };
                const importSave = (e) => {
                    const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
                    reader.onload = async (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if (!data.id || !data.timestamp || !data.investigators) throw new Error('æ— æ•ˆçš„å­˜æ¡£æ–‡ä»¶æ ¼å¼');
                            if (data.mode === 'multi') throw new Error('æš‚ä¸æ”¯æŒå¯¼å…¥å¤šäººå›¢å­˜æ¡£');
                            if (savedGames.value.some(s => s.id === data.id)) data.id = Date.now();
                            // ç¡®ä¿æ˜¯çº¯ JSON å¯¹è±¡
                            const pureData = JSON.parse(JSON.stringify(data));
                            await dbAddSave(pureData);
                            savedGames.value.unshift(pureData);
                            showToast('å­˜æ¡£å¯¼å…¥æˆåŠŸ', 'success');
                        } catch (err) {
                            console.error(err);
                            showToast('å¯¼å…¥å¤±è´¥: ' + err.message, 'error');
                        }
                        e.target.value = '';
                    };
                    reader.readAsText(file);
                };
                const loadSave = async (index) => {
                    const save = savedGames.value[index];
                    if (!save) return;

                    // æ·±æ‹·è´å­˜æ¡£æ•°æ®ï¼Œç¡®ä¿æ¯ä¸ªå­˜æ¡£çš„æ•°æ®éš”ç¦»
                    const saveCopy = JSON.parse(JSON.stringify(save));

                    // Fix: å¼ºåˆ¶æŠ˜å  CoTï¼Œé˜²æ­¢åŠ è½½å­˜æ¡£æ—¶é»˜è®¤å±•å¼€
                    if (saveCopy.log) saveCopy.log.forEach(m => m.showCot = false);

                    // åœºæ™¯1: åœ¨å¤šäººæ¸¸æˆä¸­å›æ¡£ (ä»…æˆ¿ä¸»)
                    if (cocState.gameState === 'playing' && cocState.mode === 'multi') {
                        if (saveCopy.mode !== 'multi') return showToast('æ— æ³•åœ¨å¤šäººæ¸¸æˆä¸­è¯»å–å•äººå­˜æ¡£', 'error');
                        if (saveCopy.moduleName !== cocState.module?.name) return showToast('æ— æ³•è¯»å–ï¼šå­˜æ¡£å±äºä¸åŒçš„æ¨¡ç»„ (' + saveCopy.moduleName + ')', 'error');
                        
                        const savedAssignments = saveCopy.multiplayer?.assignments || {};
                        const currentMemberIds = multiplayerState.members.map(m => m.id);
                        // è¿‡æ»¤æ‰ AI å’Œå·²åœ¨æˆ¿é—´çš„ç©å®¶
                        const missingPlayers = Object.values(savedAssignments).filter(uid => !uid.startsWith('ai_') && !currentMemberIds.includes(uid));
                        
                        if (missingPlayers.length > 0) {
                             // æç¤ºä½†ä¸é˜»æ­¢ï¼Œå…è®¸æˆ¿ä¸»å¼ºè¡Œå›æ¡£
                             showToast('æ³¨æ„ï¼šå­˜æ¡£ä¸­çš„éƒ¨åˆ†ç©å®¶ä¸åœ¨å½“å‰æˆ¿é—´', 'warning');
                        }
                        
                        if (!await showConfirm('æ£€æµ‹åˆ°å½“å‰æ­£åœ¨æ¸¸æˆä¸­ã€‚æ˜¯å¦è¿›è¡Œå›æ¡£ï¼ˆè¦†ç›–å½“å‰è¿›åº¦ï¼‰ï¼Ÿ', 'è¦†ç›–ç¡®è®¤')) return;
                        
                        cocState.log = saveCopy.log;
                        cocState.investigators = saveCopy.investigators;
                        cocState.systemPrompt = saveCopy.systemPrompt;
                        cocState.pendingRolls = saveCopy.pendingRolls || [];
                        
                        multiplayerState.assignments = savedAssignments;
                        multiplayerState.assignmentDetails = saveCopy.multiplayer.assignmentDetails || {};
                        multiplayerState.turnIndex = saveCopy.multiplayer.turnIndex || 0;
                        multiplayerState.roundActionIds = saveCopy.multiplayer.roundActionIds || [];
                        
                        updateMyAssignment();
                        broadcastMessage({
                            type: 'sync_state',
                            log: cocState.log,
                            investigators: cocState.investigators,
                            assignments: multiplayerState.assignments,
                            assignmentDetails: multiplayerState.assignmentDetails,
                            turnIndex: multiplayerState.turnIndex,
                            roundActionIds: multiplayerState.roundActionIds,
                            gameState: 'playing'
                        });
                        
                        showToast('å·²æˆåŠŸå›æ¡£', 'success');
                        currentView.value = 'chat';
                        return;
                    }

                    // åœºæ™¯2: ä»å¤§å…è¯»å–å­˜æ¡£
                    if (saveCopy.mode === 'multi') {
                        if (!await showConfirm('è¿™æ˜¯ä¸€ä¸ªå¤šäººå›¢å­˜æ¡£ã€‚æ˜¯å¦åˆ›å»ºæ–°æˆ¿é—´å¹¶ä½œä¸ºæˆ¿ä¸»åŠ è½½æ­¤è¿›åº¦ï¼Ÿ\n(å…¶ä»–ç©å®¶éœ€ä½¿ç”¨æ–°æˆ¿é—´å·é‡æ–°åŠ å…¥)', 'åŠ è½½å¤šäººå­˜æ¡£')) return;

                        // 1. åˆ›å»ºæˆ¿é—´
                        await createRoom();
                        
                        // 2. åŠ è½½æ•°æ®
                        cocState.mode = 'multi';
                        cocState.module = { name: saveCopy.moduleName, content: saveCopy.moduleContent || '' };
                        cocState.investigators = saveCopy.investigators;
                        cocState.log = saveCopy.log;
                        cocState.systemPrompt = saveCopy.systemPrompt;
                        cocState.pendingRolls = saveCopy.pendingRolls || [];
                        
                        // 3. æ¢å¤å¤šäººçŠ¶æ€
                        // é‡è¦ï¼šæ¸…ç©º assignmentsï¼Œåªä¿ç•™ assignmentDetails ä¾›å‚è€ƒï¼Œè®©ç©å®¶é‡æ–°è®¤é¢†
                        if (saveCopy.multiplayer) {
                            multiplayerState.assignments = {}; // é‡ç½®åˆ†é…ï¼Œç­‰å¾…ç©å®¶é‡æ–°åŠ å…¥
                            // ä¿ç•™å†å²åˆ†é…è¯¦æƒ…ï¼Œå¯ä»¥åœ¨ç•Œé¢ä¸Šæ˜¾ç¤º"åŸæ“ä½œè€…ï¼šXXX"
                            multiplayerState.assignmentDetails = saveCopy.multiplayer.assignmentDetails || {};
                            multiplayerState.turnIndex = saveCopy.multiplayer.turnIndex || 0;
                            multiplayerState.roundActionIds = []; // é‡ç½®å›åˆè¡ŒåŠ¨çŠ¶æ€
                            
                            // å°è¯•æ¢å¤ AI æ‰˜ç®¡çš„è§’è‰²
                            const oldAssignments = saveCopy.multiplayer.assignments || {};
                            Object.keys(oldAssignments).forEach(key => {
                                if (oldAssignments[key] && oldAssignments[key].startsWith('ai_')) {
                                    multiplayerState.assignments[key] = oldAssignments[key];
                                }
                            });
                        }

                        // 4. æ›´æ–°è‡ªèº«çŠ¶æ€
                        cocState.activeInvestigatorIndex = -1; // é‡ç½®å½“å‰é€‰æ‹©

                        // 5. è¿›å…¥å‡†å¤‡ç•Œé¢ï¼Œè€Œä¸æ˜¯ç›´æ¥å¼€å§‹æ¸¸æˆ
                        cocState.gameState = 'preparing';
                        currentView.value = 'preparing';
                        
                        showToast('æˆ¿é—´å·²åˆ›å»ºï¼Œè¯·é‚€è¯·ç©å®¶åŠ å…¥å¹¶åˆ†é…è§’è‰²', 'success');
                        
                        // 6. å¹¿æ’­åˆå§‹çŠ¶æ€
                        broadcastMessage({
                            type: 'sync_state',
                            gameState: 'preparing',
                            moduleName: cocState.module.name,
                            investigators: cocState.investigators,
                            assignments: multiplayerState.assignments,
                            assignmentDetails: multiplayerState.assignmentDetails
                        });

                    } else {
                        // å•äººæ¨¡å¼è¯»å–
                        cocState.mode = 'single';
                        cocState.module = { name: saveCopy.moduleName, content: saveCopy.moduleContent || '' };
                        cocState.investigators = saveCopy.investigators;
                        cocState.log = saveCopy.log;
                        cocState.systemPrompt = saveCopy.systemPrompt;
                        cocState.pendingRolls = saveCopy.pendingRolls || [];
                        cocState.gameState = 'playing';
                        cocState.activeInvestigatorIndex = 0;
                        
                        // æ¢å¤å•äººæ¨¡å¼çš„å›åˆçŠ¶æ€å’ŒAIæ‰˜ç®¡
                        if (saveCopy.multiplayer) {
                            multiplayerState.assignments = saveCopy.multiplayer.assignments || {};
                            multiplayerState.roundActionIds = saveCopy.multiplayer.roundActionIds || [];
                        } else {
                            multiplayerState.assignments = {};
                            multiplayerState.roundActionIds = [];
                        }
                        
                        currentView.value = 'chat';
                        showToast('è®°å¿†å·²å”¤é†’', 'success');
                    }
                };

                const importCocModule = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); if (file.name.endsWith('.docx')) { reader.onload = (ev) => { mammoth.extractRawText({ arrayBuffer: ev.target.result }).then((result) => { cocState.module = { name: file.name.replace(/\.[^/.]+$/, ""), content: result.value }; showToast('æ¨¡ç»„å¯¼å…¥æˆåŠŸ', 'success'); if (cocState.mode === 'multi' && multiplayerState.isHost) broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name }); }).catch((err) => { showToast('Docx è§£æå¤±è´¥', 'error'); }); }; reader.readAsArrayBuffer(file); } else { reader.onload = (ev) => { cocState.module = { name: file.name.replace(/\.[^/.]+$/, ""), content: ev.target.result }; showToast('æ¨¡ç»„å¯¼å…¥æˆåŠŸ', 'success'); if (cocState.mode === 'multi' && multiplayerState.isHost) broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name }); }; reader.readAsText(file); } };
                const saveManualModule = () => { if (!cocState.tempModuleText) return; cocState.module = { name: 'æ‰‹åŠ¨æ¨¡ç»„', content: cocState.tempModuleText }; showToast('æ¨¡ç»„ä¿å­˜æˆåŠŸ', 'success'); if (cocState.mode === 'multi' && multiplayerState.isHost) broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name }); };
                const importInvestigator = async (e) => { 
                    const file = e.target.files[0]; if (!file) return;
                    try { let data = null; if (file.type === 'application/json' || file.name.endsWith('.json')) { data = JSON.parse(await file.text()); } else if (file.type === 'image/png' || file.name.endsWith('.png')) { data = await extractPngData(file); if (!data) throw new Error('æœªåœ¨ PNG ä¸­æ‰¾åˆ°åµŒå…¥çš„è§’è‰²æ•°æ®'); data.avatar = await compressImage(URL.createObjectURL(file), 300, 0.8); } if (!data) throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼'); if (!data.stats) data.stats = { STR:50, CON:50, SIZ:65, DEX:50, APP:50, INT:60, POW:50, EDU:60 }; for (let k in data.stats) data.stats[k] = Number(data.stats[k]); if (data.hp === undefined) data.hp = Math.floor((data.stats.CON + data.stats.SIZ)/10); if (data.mp === undefined) data.mp = Math.floor(data.stats.POW/5); if (data.san === undefined) data.san = data.stats.POW; if (data.maxSan === undefined) data.maxSan = 99; if (data.maxHp === undefined) data.maxHp = Math.floor((data.stats.CON + data.stats.SIZ)/10); if (data.maxMp === undefined) data.maxMp = Math.floor(data.stats.POW/5); if (!data.history) data.history = []; if (!data.badges) data.badges = []; if (!data.skills) data.skills = []; cocState.investigators.push(data); if (cocState.mode === 'multi' && multiplayerState.isHost) broadcastMessage({ type: 'sync_investigators', investigators: cocState.investigators }); if (cocState.activeInvestigatorIndex === -1) cocState.activeInvestigatorIndex = cocState.investigators.length - 1; saveData(); showToast('è°ƒæŸ¥å‘˜å¯¼å…¥æˆåŠŸ: ' + data.name, 'success'); } catch(err) { showToast('å¯¼å…¥å¤±è´¥: ' + err.message, 'error'); } e.target.value = ''; 
                };
                const deleteInvestigator = async (index) => { if(await showConfirm('åˆ é™¤æ­¤è°ƒæŸ¥å‘˜ï¼Ÿ', 'åˆ é™¤è§’è‰²')) { cocState.investigators.splice(index, 1); if(cocState.activeInvestigatorIndex >= index) cocState.activeInvestigatorIndex = -1; if (cocState.mode === 'multi' && multiplayerState.isHost) { broadcastMessage({ type: 'sync_investigators', investigators: cocState.investigators }); multiplayerState.assignments = {}; broadcastMessage({ type: 'sync_assignments', assignments: {} }); } saveData(); } };
                const toggleReady = () => {
                    if (!multiplayerState.isReady && cocState.gameState === 'preparing' && cocState.activeInvestigatorIndex === -1) return showToast('è¯·å…ˆé€‰æ‹©ä¸€åè°ƒæŸ¥å‘˜', 'warning');
                    multiplayerState.isReady = !multiplayerState.isReady;
                    // å‘é€å‡†å¤‡çŠ¶æ€æ›´æ–°å¹¿æ’­
                    broadcastMessage({
                        type: 'toggle_ready',
                        userId: user.uuid,
                        isReady: multiplayerState.isReady
                    });
                };
                const buildInvestigatorProfile = (inv) => { let profile = `å§“åï¼š${inv.name}\nèŒä¸šï¼š${inv.job} | å¹´é¾„ï¼š${inv.age} | æ€§åˆ«ï¼š${inv.gender} | ä½åœ°ï¼š${inv.residence}\nå±æ€§ï¼šSTR:${inv.stats.STR} CON:${inv.stats.CON} SIZ:${inv.stats.SIZ} DEX:${inv.stats.DEX} APP:${inv.stats.APP} INT:${inv.stats.INT} POW:${inv.stats.POW} EDU:${inv.stats.EDU}\nçŠ¶æ€ï¼šHP ${inv.hp}/${inv.maxHp} | MP ${inv.mp}/${inv.maxMp} | SAN ${inv.san}/${inv.maxSan}\n`; if (inv.skills && inv.skills.length) profile += `æŠ€èƒ½ï¼š${inv.skills.filter(s => s.value > 0).map(s => `${s.name}(${s.value})`).join(', ')}\n`; if (inv.backstory) { profile += `èƒŒæ™¯ï¼š\n`; for (const [k, v] of Object.entries(inv.backstory)) if (v) profile += `- ${k}: ${v}\n`; } if (inv.inventory) profile += `éšèº«ç‰©å“ï¼š${inv.inventory}\n`; return profile; };
                const openSettlement = () => { const inv = cocState.investigators[cocState.activeInvestigatorIndex]; if (!inv) return showToast('è¯·é€‰æ‹©ä¸€åè°ƒæŸ¥å‘˜', 'warning'); settlementState.moduleName = cocState.module?.name || 'æœªçŸ¥æ¨¡ç»„'; settlementState.sanRewardExpr = '1d6'; settlementState.sanRewardVal = 0; settlementState.specialReward = ''; settlementState.badge = { name: 'å¹¸å­˜è€…', desc: `åœ¨ã€Š${settlementState.moduleName}ã€‹ä¸­å­˜æ´»`, icon: 'ğŸ…' }; settlementState.historyLog = `å®Œæˆæ¨¡ç»„ã€Š${settlementState.moduleName}ã€‹`; settlementState.step = 1; settlementState.selectedSkills = []; settlementState.skillGrowths = []; settlementState.show = true; };
                const rollSanReward = () => { const expr = settlementState.sanRewardExpr; let val = 0; if (expr.includes('d')) { const [n, d] = expr.split('d').map(Number); for(let i=0; i<(n||1); i++) val += Math.floor(Math.random()*(d||6))+1; } else val = parseInt(expr) || 0; settlementState.sanRewardVal = val; };
                const processSkillGrowth = async () => { const inv = cocState.investigators[cocState.activeInvestigatorIndex]; settlementState.isRolling = true; settlementState.skillGrowths = []; for (const skillName of settlementState.selectedSkills) { const skill = inv.skills.find(s => s.name === skillName); if (!skill) continue; const checkVal = Math.floor(Math.random() * 100) + 1; const success = checkVal > skill.value || checkVal > 95; let growth = 0; if (success) growth = Math.floor(Math.random() * 10) + 1; settlementState.skillGrowths.push({ name: skill.name, oldVal: skill.value, checkVal, success, growth, newVal: skill.value + growth }); await new Promise(r => setTimeout(r, 300)); } settlementState.isRolling = false; settlementState.step = 3; };
                const sanitizeFilename = (name, defaultName = 'character') => name ? name.replace(/[<>:"/\\|?*\x00-\x1F]/g, '_').trim() : defaultName;
                const downloadFile = (blob, filename) => { const reader = new FileReader(); reader.onload = (e) => { const a = document.createElement('a'); a.href = e.target.result; a.download = filename; a.style.display = 'none'; document.body.appendChild(a); a.click(); setTimeout(() => document.body.removeChild(a), 100); }; reader.readAsDataURL(blob); };
                const crcTable = []; for (let n =0; n<256; n++){ let c = n; for(let k=0; k<8; k++){ if(c&1) c = 0xedb88320 ^ (c >>> 1); else c = c >>> 1; } crcTable[n] = c; }
                const crc32 = (buf) => { let crc = 0xffffffff; for (let i = 0; i < buf.length; i++) { crc = crcTable[(crc ^ buf[i]) & 0xff] ^ (crc >>> 8); } return crc ^ 0xffffffff; };

                const injectPngChunk = (pngBuffer, key, value) => {
                    const encoder = new TextEncoder();
                    const keyBytes = encoder.encode(key);
                    const valBytes = encoder.encode(value);
                    const chunkLen = keyBytes.length + 1 + valBytes.length;
                    const fullChunkLen = 4 + 4 + chunkLen + 4;
                    const fullChunk = new Uint8Array(fullChunkLen);
                    const view = new DataView(fullChunk.buffer);
                    view.setUint32(0, chunkLen);
                    fullChunk.set(encoder.encode('tEXt'), 4);
                    fullChunk.set(keyBytes, 8);
                    fullChunk[8 + keyBytes.length] = 0;
                    fullChunk.set(valBytes, 8 + keyBytes.length + 1);
                    const crcData = fullChunk.slice(4, 4 + 4 + chunkLen);
                    view.setUint32(fullChunkLen - 4, crc32(crcData)); // Correct CRC32
                    const res = new Uint8Array(pngBuffer.length + fullChunkLen);
                    let pos = 8;
                    while (pos < pngBuffer.length) {
                        const len = new DataView(pngBuffer.buffer).getUint32(pos);
                        const type = String.fromCharCode(...pngBuffer.slice(pos+4, pos+8));
                        if(type === 'IEND') break;
                        pos += 12+len;
                    }
                    res.set(pngBuffer.slice(0, pos));
                    res.set(fullChunk, pos);
                    res.set(pngBuffer.slice(pos), pos + fullChunkLen);
                    return res;
                };

                const getInvestigatorExportData = () => {
                    const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                    if (!inv) return null;
                    const exportData = JSON.parse(JSON.stringify(inv));
                    // Apply settlement changes
                    exportData.san = Math.min(exportData.maxSan||99, exportData.san + settlementState.sanRewardVal);
                    settlementState.skillGrowths.forEach(g => { if(g.success) { const s = exportData.skills.find(sk=>sk.name===g.name); if(s) s.value = g.newVal; } });
                    if (!exportData.history) exportData.history=[];
                    if (settlementState.historyLog) exportData.history.unshift(`[${new Date().toLocaleDateString()}] ${settlementState.historyLog}`);
                    if (settlementState.badge.name) { if(!exportData.badges) exportData.badges=[]; exportData.badges.push({...settlementState.badge}); }
                    return exportData;
                };

                const exportCurrentInvestigatorJSON = () => {
                    const exportData = getInvestigatorExportData();
                    if (!exportData) return;
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
                    downloadFile(blob, `${sanitizeFilename(exportData.name)}_Settled.json`);
                };

                const exportCurrentInvestigatorPNG = async () => {
                    const exportData = getInvestigatorExportData();
                    if (!exportData) return;
                    showToast('æ­£åœ¨ç”Ÿæˆè§’è‰²å¡...', 'info');
                    
                    try {
                        // 1. Prepare Base Image (Avatar or Default)
                        const canvas = document.createElement('canvas');
                        canvas.width = 300; canvas.height = 450;
                        const ctx = canvas.getContext('2d');
                        
                        // Draw Background
                        ctx.fillStyle = '#0f172a';
                        ctx.fillRect(0, 0, 300, 450);
                        
                        // Draw Avatar if available
                        if (exportData.avatar) {
                            const img = new Image();
                            img.src = exportData.avatar;
                            await new Promise((resolve) => { img.onload = resolve; img.onerror = resolve; });
                            // Center crop
                            const aspect = img.width / img.height;
                            let drawW = 300, drawH = 300 / aspect;
                            if (drawH < 300) { drawH = 300; drawW = 300 * aspect; }
                            ctx.drawImage(img, (300 - drawW)/2, 0, drawW, drawH);
                        } else {
                            // Default Avatar Placeholder
                            ctx.fillStyle = '#1e293b';
                            ctx.fillRect(0, 0, 300, 300);
                            ctx.fillStyle = '#334155';
                            ctx.font = 'bold 80px serif';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(exportData.name.charAt(0), 150, 150);
                        }
                        
                        // Overlay Gradient
                        const grad = ctx.createLinearGradient(0, 200, 0, 450);
                        grad.addColorStop(0, 'rgba(15, 23, 42, 0)');
                        grad.addColorStop(0.5, 'rgba(15, 23, 42, 0.9)');
                        grad.addColorStop(1, 'rgba(15, 23, 42, 1)');
                        ctx.fillStyle = grad;
                        ctx.fillRect(0, 200, 300, 250);

                        // Draw Info
                        ctx.fillStyle = '#d4af37';
                        ctx.font = 'bold 24px serif';
                        ctx.textAlign = 'left';
                        ctx.fillText(exportData.name, 20, 340);
                        
                        ctx.fillStyle = '#94a3b8';
                        ctx.font = '14px sans-serif';
                        ctx.fillText(`${exportData.job} | ${exportData.age}å²`, 20, 365);
                        
                        // Stats Bar
                        const drawStat = (label, val, x, color) => {
                            ctx.fillStyle = 'rgba(30, 41, 59, 0.8)';
                            ctx.fillRect(x, 385, 80, 40);
                            ctx.fillStyle = color;
                            ctx.font = 'bold 16px monospace';
                            ctx.fillText(val, x + 10, 410);
                            ctx.fillStyle = '#64748b';
                            ctx.font = '10px sans-serif';
                            ctx.fillText(label, x + 50, 410);
                        };
                        drawStat('HP', `${exportData.hp}/${exportData.maxHp||exportData.hp}`, 20, '#f87171');
                        drawStat('SAN', `${exportData.san}`, 110, '#a78bfa');
                        drawStat('LUCK', `${exportData.stats?.LUCK||50}`, 200, '#fbbf24');

                        // 2. Export to Blob -> ArrayBuffer
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        const buffer = await blob.arrayBuffer();
                        
                        // 3. Prepare Data Chunk
                        // Compatible with extractPngData: btoa(unescape(encodeURIComponent(json)))
                        const jsonStr = JSON.stringify(exportData);
                        const encodedData = window.btoa(unescape(encodeURIComponent(jsonStr)));
                        
                        // 4. Inject
                        const newBuffer = injectPngChunk(new Uint8Array(buffer), 'coc_data', encodedData);
                        
                        // 5. Download
                        const finalBlob = new Blob([newBuffer], { type: 'image/png' });
                        downloadFile(finalBlob, `${sanitizeFilename(exportData.name)}_Card.png`);
                        showToast('è§’è‰²å¡å¯¼å‡ºæˆåŠŸ', 'success');
                        
                    } catch (e) {
                        console.error(e);
                        showToast('å¯¼å‡ºå¤±è´¥: ' + e.message, 'error');
                    }
                };
                const confirmSettlement = () => { const inv = cocState.investigators[cocState.activeInvestigatorIndex]; inv.san = Math.min(inv.maxSan||99, inv.san + settlementState.sanRewardVal); settlementState.skillGrowths.forEach(g => { if(g.success) { const s = inv.skills.find(sk=>sk.name===g.name); if(s) s.value = g.newVal; } }); if(!inv.history) inv.history=[]; inv.history.unshift(`[${new Date().toLocaleDateString()}] ${settlementState.historyLog}`); if(settlementState.badge.name) { if(!inv.badges) inv.badges=[]; inv.badges.push({...settlementState.badge}); } saveData(); showToast('ç»“ç®—å®Œæˆ', 'success'); settlementState.show = false; };

                const importTavernSave = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if (!data.log || !Array.isArray(data.log)) throw new Error('æ— æ•ˆçš„è·‘å›¢å­˜æ¡£ï¼šç¼ºå°‘è®°å½•');
                            tavernState.sourceData = data;
                            tavernState.generatedContent = '';
                            tavernState.novelTitle = '';
                            showToast('å­˜æ¡£åŠ è½½æˆåŠŸï¼Œè¯·é…ç½®ç”Ÿæˆé€‰é¡¹', 'success');
                        } catch (err) {
                            showToast('å­˜æ¡£è¯»å–å¤±è´¥: ' + err.message, 'error');
                        }
                        e.target.value = '';
                    };
                    reader.readAsText(file);
                };

                const generateNovel = async () => {
                    if (!tavernState.sourceData) return;
                    tavernState.isGenerating = true;
                    tavernState.generatedContent = '';
                    tavernState.novelTitle = '';
                    
                    const logContent = tavernState.sourceData.log.map(m => `${m.name}: ${m.content}`).join('\n');
                    const moduleInfo = tavernState.sourceData.moduleName ? `æ¨¡ç»„ï¼šã€Š${tavernState.sourceData.moduleName}ã€‹` : '';
                    const style = tavernState.settings.style;
                    const perspective = tavernState.settings.perspective;
                    
                    const prompt = `ä½ æ˜¯ä¸€ä½æ°å‡ºçš„å°è¯´å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹COCè·‘å›¢ï¼ˆå…‹è‹é²çš„å‘¼å”¤ï¼‰çš„æ¸¸æˆè®°å½•ï¼Œå°†å…¶æ”¹ç¼–æˆä¸€ç¯‡å¼•äººå…¥èƒœçš„å°è¯´ã€‚
                    
ã€è¦æ±‚ã€‘
1. é£æ ¼ï¼š${style}
2. è§†è§’ï¼š${perspective}
3. è¿™æ˜¯ä¸€ä¸ª${moduleInfo}çš„æ•…äº‹ã€‚
4. è¯·ä¿ç•™æ ¸å¿ƒå‰§æƒ…å’Œé«˜å…‰æ—¶åˆ»ï¼Œå¯¹å¯¹è¯å’Œåœºæ™¯è¿›è¡Œæ–‡å­¦åŒ–æ¶¦è‰²ï¼Œæå†™ç¯å¢ƒæ°›å›´ã€å¿ƒç†æ´»åŠ¨å’ŒåŠ¨ä½œç»†èŠ‚ã€‚
5. å»é™¤æ¸¸æˆæœ¯è¯­ï¼ˆå¦‚"éª°ç‚¹"ã€"è¿‡æ£€å®š"ç­‰ï¼‰ï¼Œå°†å…¶è½¬åŒ–ä¸ºè‡ªç„¶çš„å™äº‹æè¿°ã€‚
6. ä½¿ç”¨Markdownæ ¼å¼è¾“å‡ºã€‚
7. ç¬¬ä¸€è¡Œå¿…é¡»æ˜¯å°è¯´çš„æ ‡é¢˜ï¼ˆMarkdownä¸€çº§æ ‡é¢˜ # æ ‡é¢˜ï¼‰ã€‚

ã€è·‘å›¢è®°å½•ã€‘
${logContent.slice(0, 50000)}
`;
                    try {
                        const res = await fetch(`${settings.apiUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({ model: settings.model, messages: [{ role: 'user', content: prompt }], stream: true })
                        });
                        const reader = res.body.getReader();
                        const decoder = new TextDecoder();
                        let fullText = '';
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');
                            for (const line of lines) {
                                if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                    try {
                                        const json = JSON.parse(line.slice(6));
                                        if (json.choices[0]?.delta?.content) {
                                            const content = json.choices[0].delta.content;
                                            fullText += content;
                                            tavernState.generatedContent = fullText;
                                            if (!tavernState.novelTitle) { const match = fullText.match(/^#\s+(.+)$/m); if (match) tavernState.novelTitle = match[1].trim(); }
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                        if (!tavernState.novelTitle) tavernState.novelTitle = (tavernState.sourceData.moduleName || 'æœªçŸ¥æ¨¡ç»„') + ' æ”¹ç¼–å°è¯´';
                    } catch (e) { tavernState.generatedContent += `\n\n[ç”Ÿæˆå‡ºé”™: ${e.message}]`; } finally { tavernState.isGenerating = false; }
                };

                const saveNovel = () => {
                    if (!tavernState.generatedContent) return;
                    const novel = { id: Date.now(), title: tavernState.novelTitle || 'æœªå‘½åå°è¯´', content: tavernState.generatedContent, timestamp: Date.now(), style: tavernState.settings.style, preview: tavernState.generatedContent.replace(/[#*`]/g, '').slice(0, 100) };
                    tavernState.savedNovels.unshift(novel);
                    saveData();
                    showToast('å°è¯´å·²æ”¶è—è‡³è—ä¹¦é˜', 'success');
                };
                const deleteNovel = async (index) => { if (await showConfirm('ç¡®å®šè¦é”€æ¯è¿™ç¯‡å°è¯´å—ï¼Ÿ', 'é”€æ¯æ‰‹ç¨¿')) { tavernState.savedNovels.splice(index, 1); saveData(); } };
                const viewNovel = (index) => { const novel = tavernState.savedNovels[index]; tavernState.generatedContent = novel.content; tavernState.novelTitle = novel.title; tavernState.view = 'create'; tavernState.sourceData = null; };
                const exportNovel = (format) => {
                    if (!tavernState.generatedContent) return;
                    const title = tavernState.novelTitle || 'Exported_Novel';
                    if (format === 'markdown') {
                        const blob = new Blob([tavernState.generatedContent], { type: 'text/markdown' });
                        downloadFile(blob, `${sanitizeFilename(title)}.md`);
                    } else if (format === 'docx') {
                        const htmlContent = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${title}</title></head><body>${marked.parse(tavernState.generatedContent)}</body></html>`;
                        const converted = htmlDocx.asBlob(htmlContent);
                        saveAs(converted, `${sanitizeFilename(title)}.docx`);
                    }
                };
                
                const startCocGame = () => {
                    if (!cocState.module || cocState.investigators.length === 0) return showToast('è¯·å…ˆå¯¼å…¥æ¨¡ç»„å’Œè°ƒæŸ¥å‘˜', 'warning');
                    if (cocState.mode === 'multi') { /* ... multi validation ... */ } else { if (cocState.activeInvestigatorIndex === -1) cocState.activeInvestigatorIndex = 0; }
                    
                    let systemPrompt = [
                        "ä½ ç°åœ¨æ˜¯ã€Šå…‹è‹é²çš„å‘¼å”¤ã€‹(Call of Cthulhu 7th Edition) çš„ Keeper (å®ˆå¯†äºº)ã€‚",
                        "ä½ æ­£åœ¨ä¸»æŒä¸€åœºæ²‰æµ¸å¼çš„è·‘å›¢æ¸¸æˆã€‚ä½ çš„ç›®æ ‡æ˜¯ä¸ºè°ƒæŸ¥å‘˜ä»¬ç¼–ç»‡ä¸€åœºæƒŠå¿ƒåŠ¨é­„ã€å……æ»¡æ‚¬ç–‘ä¸æœªçŸ¥çš„å†’é™©ã€‚",
                        "",
                        "ã€æ ¸å¿ƒèŒè´£ã€‘",
                        "1. **å™äº‹ä¸æ°›å›´**ï¼š",
                        "   - ä¿æŒæ´›å¤«å…‹æ‹‰å¤«ç‰¹å¼çš„æ–‡å­¦é£æ ¼ï¼šå¼ºè°ƒæœªçŸ¥çš„ææƒ§ã€å¤è€çš„ç¥ç§˜å’Œäººç±»çš„æ¸ºå°ã€‚",
                        "   - **æ°›å›´çƒ˜æ‰˜ä¸è‚®è„ç¾å­¦**ï¼š",
                        "     * æ•¢äºæå†™ä»¤äººä¸é€‚çš„ç»†èŠ‚ï¼ˆå¦‚'æµ‘æµŠçš„æµ†ç³Š'ã€'æµ“é‡çš„ç‰²ç•œè‡­å‘³'ã€'æµ‘æµŠçš„çœ¼ç¥'ï¼‰ï¼Œç”¨æåº¦å†™å®çš„ç¬”è§¦å¢å¼ºçœŸå®æ„Ÿã€‚",
                        "     * **ç”Ÿç†ä¸å¿ƒç†å…±æŒ¯**ï¼šé€šè¿‡æè¿°è§’è‰²çš„ç”Ÿç†ååº”ï¼ˆå¦‚'æ—§ä¼¤éšéšä½œç—›'ã€'èƒƒéƒ¨ç—‰æŒ›'ã€'å¯’æ„é¡ºç€è„ŠèƒŒçˆ¬å‡'ï¼‰æ¥æš—ç¤ºç¯å¢ƒçš„å‹æŠ‘å’Œä¸å¯åçŠ¶çš„å±é™©ã€‚",
                        "   - **é‡è§†ç¾ç»Š**ï¼šæ—¶åˆ»å…³æ³¨è§’è‰²å¡ä¸­çš„èƒŒæ™¯è®¾å®šå’Œäººç‰©å…³ç³»ï¼ˆå¦‚'æˆ˜å‹'ã€'å¸ˆå¾’'ã€'æ—§è¯†'ï¼‰ã€‚åœ¨å™äº‹ä¸­é€šè¿‡çœ¼ç¥äº¤æµã€é»˜å¥‘é…åˆæˆ–ä¸‹æ„è¯†çš„ä¿æŠ¤åŠ¨ä½œæ¥ä½“ç°è¿™äº›å…³ç³»ï¼Œç»å¯¹ä¸è¦æŠŠè€ç†Ÿäººå½“æˆé™Œç”Ÿäººã€‚",
                        "   - **é¡ºåŠ¿è€Œä¸º**ï¼šç´§æ‰£ç©å®¶çš„è¡ŒåŠ¨åŠ¨æœºï¼ˆå¦‚ç©å®¶è¯´'å€Ÿå£æ•£æ­¥'ï¼Œä½ å°±é¡ºç€æè¿°ä»–æ•£æ­¥åˆ°çš„åœ°æ–¹ï¼‰ï¼Œè®©åœºæ™¯åˆ‡æ¢è‡ªç„¶æµç•…ã€‚",
                        "   - é€‚å½“åœ°æ”¾æ…¢å™äº‹èŠ‚å¥ï¼Œåœ¨å…³é”®æ—¶åˆ»ä½¿ç”¨çŸ­å¥åˆ¶é€ å‹æŠ‘æ„Ÿå’Œæ‚¬å¿µã€‚",
                        "   - æ°¸è¿œä¿æŒå®¢è§‚ä¸­ç«‹ï¼Œä½ æè¿°çš„æ˜¯ä¸–ç•Œæœ¬èº«ï¼Œè€Œä¸æ˜¯æ›¿ç©å®¶åšå†³å®šã€‚",
                        "",
                        "2. **è§„åˆ™è£å†³ä¸éª°ç‚¹å¤„ç†**ï¼š",
                        "   - **ç³»ç»Ÿæ·éª°åŸåˆ™**ï¼šç©å®¶çš„æ·éª°æŒ‡ä»¤ï¼ˆå¦‚ .ra, .scï¼‰å·²è¢«ç³»ç»Ÿè‡ªåŠ¨å¤„ç†å¹¶é™„å¸¦äº†ç»“æœï¼ˆæ˜¾ç¤ºä¸º'> ğŸ² ...'ï¼‰ã€‚",
                        "   - **KPèŒè´£**ï¼šè¯·ç›´æ¥åŸºäºç³»ç»Ÿç»™å‡ºçš„éª°ç‚¹ç»“æœè¿›è¡Œå™äº‹ã€‚ä¸è¦é‡å¤æ·éª°ï¼Œä¹Ÿä¸è¦å¿½ç•¥å·²æœ‰çš„ç»“æœã€‚",
                        "   - **å¥–æƒ©éª°æœºåˆ¶ (Bonus/Penalty Dice)**ï¼š",
                        "     * å¦‚æœä½ è®¤ä¸ºå½“å‰æƒ…å¢ƒéœ€è¦åº”ç”¨å¥–åŠ±éª°æˆ–æƒ©ç½šéª°ï¼Œè¯·åŸºäºç©å®¶å·²æŠ•å‡ºçš„ã€ä¸ªä½æ•°ã€‘ä¿æŒä¸å˜ï¼Œé‡æ–°æŠ•æ·ã€åä½æ•°ã€‘è¿›è¡Œè°ƒæ•´ã€‚",
                        "     * åœ¨å›å¤ä¸­æ˜ç¡®è¯´æ˜ï¼š'ç”±äº[åŸå› ]ï¼Œé€‚ç”¨(å¥–åŠ±/æƒ©ç½š)éª°ã€‚åŸç»“æœ[X]ï¼Œè°ƒæ•´ä¸º...'",
                        "     * å¦‚æœç³»ç»Ÿå·²ç»™å‡ºæ˜ç¡®çš„æˆåŠŸ/å¤±è´¥åˆ¤å®šï¼Œä¸”ä½ è®¤ä¸ºæ— éœ€è°ƒæ•´ï¼Œåˆ™ç›´æ¥é‡‡çº³è¯¥ç»“æœã€‚",
                        "   - **ä¸»åŠ¨è¦æ±‚æ£€å®š (æ ¸å¿ƒ)**ï¼š",
                        "     * å½“ç©å®¶è¡ŒåŠ¨å­˜åœ¨é£é™©æˆ–é­é‡éœ€è¦æ£€å®šçš„æƒ…å†µæ—¶ï¼Œ**å¿…é¡»**è¾“å‡ºæ˜ç¡®çš„ç³»ç»ŸæŒ‡ä»¤ï¼Œä¸¥ç¦ä½¿ç”¨â€œè¯·è¿›è¡ŒXXæ£€å®šâ€è¿™ç±»æ¨¡ç³Šçš„è‡ªç„¶è¯­è¨€ã€‚",
                        "     * **æŠ€èƒ½æ£€å®š**ï¼š`@ç©å®¶å .ra æŠ€èƒ½å` (ä¾‹ï¼š`@æ—è¯­é£ .ra ä¾¦æŸ¥`ï¼Œè€Œä¸æ˜¯â€œè¯·è¿‡ä¸€ä¸ªä¾¦æŸ¥â€)ã€‚",
                        "     * **San Check (ç†æ™ºæ£€å®š)**ï¼šå¿…é¡»ç»™å‡ºå…·ä½“çš„æ‰£é™¤æ•°å€¼ã€‚",
                        "       - æ ¼å¼ï¼š`@ç©å®¶å .sc æˆåŠŸæ‰£é™¤/å¤±è´¥æ‰£é™¤`",
                        "       - ä¾‹ï¼š`@æ°å…‹ .sc 1/1d4` (æˆåŠŸæ‰£1ï¼Œå¤±è´¥æ‰£1d4)",
                        "       - ä¾‹ï¼š`@è‰¾ç±³ .sc 0/1d6` (æˆåŠŸä¸æ‰£ï¼Œå¤±è´¥æ‰£1d6)",
                        "     * è¿™äº›æŒ‡ä»¤ä¼šè¢«ç³»ç»Ÿè¯†åˆ«ä¸ºå¯ç‚¹å‡»çš„æŒ‰é’®ï¼Œæå¤§æå‡ç©å®¶ä½“éªŒã€‚",
                        "   - **æ›´æ–°ç©å®¶çŠ¶æ€ (æ ¸å¿ƒ)**ï¼š",
                        "     * å½“å‰§æƒ…å¯¼è‡´ç©å®¶ HP/MP/SAN å˜åŒ–æ—¶ï¼Œ**å¿…é¡»**è¾“å‡ºä»¥ä¸‹æ ¼å¼çš„æŒ‡ä»¤ï¼ˆä¸è¦åªå£å¤´æè¿°ï¼‰ï¼š",
                        "     * **å¿…é¡»æŒ‡å®šå¯¹è±¡**ï¼š`@ç©å®¶å .st å±æ€§ å˜æ›´å€¼`",
                        "     * ä¾‹ï¼š`@æ—è¯­é£ .st hp -1` (æ‰£é™¤æ—è¯­é£1ç‚¹HP)",
                        "     * ä¾‹ï¼š`@æ°å…‹ .st san -1d6` (æ‰£é™¤æ°å…‹1d6ç‚¹SAN)",
                        "     * ä¾‹ï¼š`@è‰¾ç±³ .st mp +2` (æ¢å¤è‰¾ç±³2ç‚¹MP)",
                        "     * å¦‚æœä¸åŠ @ç©å®¶åï¼Œç³»ç»Ÿå°†æ— æ³•ç¡®å®šä¿®æ”¹å¯¹è±¡ï¼ˆé™¤éæ˜¯å•äººæ¨¡å¼ï¼‰ã€‚åœ¨å¤šäººæ¨¡å¼ä¸‹ï¼Œè¯·åŠ¡å¿…æ˜ç¡®@ã€‚",
                        "     * æŒ‡ä»¤ä¼šè‡ªåŠ¨è¢«ç³»ç»Ÿæ•è·å¹¶æ›´æ–°å¯¹åº”è§’è‰²çš„è§’è‰²å¡ã€‚",
                        "   - **æš—éª° (Hidden Dice)**ï¼šå¯¹äºç©å®¶ä¸åº”çŸ¥æ™“çš„ä¿¡æ¯ï¼ˆå¦‚ NPC è¡ŒåŠ¨ã€éšç§˜çº¿ç´¢ï¼‰ï¼Œè¯·è‡ªè¡Œåœ¨æ€ç»´é“¾ (CoT) ä¸­è¿›è¡Œæš—éª°ã€‚",
                        "   - **æ£€å®šç»“æœåé¦ˆ**ï¼šæ ¹æ®æ£€å®šç»“æœï¼ˆå¤§æˆåŠŸ/æˆåŠŸ/å¤±è´¥/å¤§å¤±è´¥ï¼‰ç»™äºˆå·®å¼‚åŒ–çš„å™äº‹åé¦ˆã€‚å¤±è´¥æ„å‘³ç€'æˆåŠŸä½†æœ‰ä»£ä»·'æˆ–'æƒ…å†µæ¶åŒ–'ã€‚",
                        "",
                        "3. **å‰§æƒ…æŠŠæ§**ï¼š",
                        "   - ä¸è¦ä¸€æ¬¡æ€§å€¾å€’æ‰€æœ‰ä¿¡æ¯ã€‚çº¿ç´¢åº”é€šè¿‡ç©å®¶çš„æ¢ç´¢ã€å¯¹è¯å’Œæ£€å®šé€æ­¥è·å¾—ã€‚",
                        "   - å¦‚æœç©å®¶è¿·å¤±æ–¹å‘ï¼Œåˆ©ç”¨ç¯å¢ƒå˜åŒ–ã€NPC ä»‹å…¥æˆ–çªå‘äº‹ä»¶ï¼ˆå¦‚å³å…´çš„ San Checkï¼‰æ¥æ¨åŠ¨èŠ‚å¥ã€‚",
                        "   - æ‰®æ¼” NPC æ—¶è¦é²œæ´»ç«‹ä½“ï¼Œä»–ä»¬æœ‰è‡ªå·±çš„åŠ¨æœºã€ææƒ§å’Œç§˜å¯†ã€‚",
                        "",
                        "4. **å¤šç©å®¶å¤„ç†**ï¼š",
                        "   - ç©å®¶ï¼ˆåŒ…æ‹¬AIé˜Ÿå‹ï¼‰ä¼šä»¥ã€è§’è‰²åã€‘: ... æ ¼å¼è¡ŒåŠ¨ã€‚",
                        "   - **è§†è§’åˆ†éš”**ï¼šä¸ºäº†ä¿è¯æ¯ä½ç©å®¶éƒ½èƒ½æ¸…æ™°åœ°æ¥æ”¶åˆ°å±äºè‡ªå·±çš„åé¦ˆï¼Œè¯·**åŠ¡å¿…ä½¿ç”¨åˆ†å‰²çº¿** `---` å’Œ äºŒä¸‰çº§markdownæ ‡é¢˜æ ¼å¼çš„**è§’è‰²åæ ‡é¢˜**ï¼ˆå¦‚ ##ã€è§’è‰²Aã€‘ï¼‰æ¥åŒºåˆ†ä¸åŒç©å®¶çš„è§†è§’å’Œç»“æœã€‚",
                        "   - **å³ä½¿åœ¨åŒä¸€åœºæ™¯**ï¼šä¹Ÿè¦é€šè¿‡åˆ†æ®µæˆ–å°æ ‡é¢˜æ¥æ˜ç¡®åŒºåˆ†'è¿™æ˜¯å¯¹Açš„åé¦ˆ'å’Œ'è¿™æ˜¯å¯¹Bçš„åé¦ˆ'ï¼Œé¿å…ä¿¡æ¯æ··æ·†ã€‚",
                        "   - **åœºæ™¯ç»Ÿä¸€æ„Ÿ**ï¼šè™½ç„¶ä½¿ç”¨åˆ†å‰²çº¿ï¼Œä½†åœ¨æè¿°æ—¶ä»éœ€ä½“ç°è§’è‰²é—´çš„äº’åŠ¨ï¼ˆä¾‹å¦‚åœ¨å¯¹Açš„åé¦ˆä¸­æåˆ°Bçš„åŠ¨ä½œï¼‰ï¼Œä¿æŒæ—¶ç©ºçš„è¿è´¯æ€§ã€‚",
                        "",
                        "ã€æ€è€ƒæŒ‡å¼•ã€‘",
                        "åœ¨è¾“å‡ºå‰§æƒ…å‰ï¼Œè¯·å…ˆåœ¨ <cot>...</cot> æ ‡ç­¾å†…è¿›è¡Œæ€è€ƒï¼ˆThink Step-by-Stepï¼‰ï¼š",
                        "- **æ£€ç´¢è§’è‰²å¡**ï¼šå½“å‰è¡ŒåŠ¨çš„ç©å®¶æœ‰å“ªäº›å…³é”®æŠ€èƒ½ï¼Ÿæ•°å€¼æ˜¯å¤šå°‘ï¼Ÿå¦‚æœä»–æ²¡æœ‰å¯¹åº”æŠ€èƒ½ï¼Œæˆ‘æœ‰æƒè®©ä»–æ£€å®šä»€ä¹ˆå±æ€§ï¼Ÿ",
                        "- **äººé™…å…³ç³»**ï¼šåœ¨åœºçš„è§’è‰²ä¹‹é—´æœ‰ä½•ç¾ç»Šï¼Ÿ",
                        "- å½“å‰åœºæ™¯çš„é‡ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ",
                        "- ç©å®¶çš„è¡ŒåŠ¨æ˜¯å¦éœ€è¦æ£€å®šï¼Ÿ",
                        "- NPC ä¼šå¦‚ä½•ååº”ï¼Ÿ",
                        "- ä¸‹ä¸€æ­¥çš„ææ€–æ°›å›´å¦‚ä½•å±‚å±‚é€’è¿›ï¼Ÿ",
                        "",
                        "è¯·æ ¹æ®æ¨¡ç»„èƒŒæ™¯å’Œç©å®¶è¡ŒåŠ¨ï¼Œè¾“å‡ºä¸€æ®µç²¾å½©çš„å‰§æƒ…æè¿°ã€‚"
                    ].join('\n');
                    
                    // Insert Inv Profile & Module
                    // ä¿®å¤ï¼šåœ¨å¤šäººæ¨¡å¼æˆ–å•äººå¸¦ AI æ¨¡å¼ä¸‹ï¼Œéœ€è¦å°†æ‰€æœ‰å‚ä¸çš„è°ƒæŸ¥å‘˜èµ„æ–™éƒ½å‘ç»™ KP
                    let investigatorsProfiles = '';
                    if (cocState.mode === 'multi') {
                        // å¤šäººæ¨¡å¼ï¼šéå†æ‰€æœ‰å·²åˆ†é…çš„è§’è‰²
                        Object.keys(multiplayerState.assignments).forEach(idx => {
                            const investigator = cocState.investigators[idx];
                            if (investigator) {
                                investigatorsProfiles += `\n---\nã€è°ƒæŸ¥å‘˜ï¼š${investigator.name}ã€‘\n${buildInvestigatorProfile(investigator)}`;
                            }
                        });
                    } else {
                        // å•äººæ¨¡å¼ï¼šä¾ç„¶å¯èƒ½å­˜åœ¨ AI é˜Ÿå‹ï¼Œä¸ä»…æ˜¯ activeInvestigatorIndex
                        // æ£€æŸ¥æ˜¯å¦æœ‰ assignments (AI æ‰˜ç®¡)
                        const aiIndices = Object.keys(multiplayerState.assignments).filter(k => multiplayerState.assignments[k] && multiplayerState.assignments[k].startsWith('ai_'));
                        
                        // æ·»åŠ ç©å®¶è§’è‰²
                        const playerInv = cocState.investigators[cocState.activeInvestigatorIndex];
                        if (playerInv) {
                            investigatorsProfiles += `\n---\nã€è°ƒæŸ¥å‘˜ï¼š${playerInv.name} (ç©å®¶)ã€‘\n${buildInvestigatorProfile(playerInv)}`;
                        }
                        
                        // æ·»åŠ  AI é˜Ÿå‹
                        aiIndices.forEach(idx => {
                            // é¿å…é‡å¤æ·»åŠ ç©å®¶è§’è‰²ï¼ˆå¦‚æœç©å®¶è§’è‰²ä¹Ÿè¢«æ ‡è®°ä¸º AIï¼Œè™½ç„¶é€»è¾‘ä¸Šä¸åº”å‘ç”Ÿï¼‰
                            if (parseInt(idx) !== cocState.activeInvestigatorIndex) {
                                const aiInv = cocState.investigators[idx];
                                if (aiInv) {
                                    investigatorsProfiles += `\n---\nã€è°ƒæŸ¥å‘˜ï¼š${aiInv.name} (AIé˜Ÿå‹)ã€‘\n${buildInvestigatorProfile(aiInv)}`;
                                }
                            }
                        });
                    }
                    
                    if (!investigatorsProfiles) {
                        // Fallback
                        const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                        investigatorsProfiles = `\n\nã€å½“å‰è°ƒæŸ¥å‘˜èµ„æ–™ã€‘\n${buildInvestigatorProfile(inv)}`;
                    }

                    systemPrompt += `\n\nã€å‚ä¸æ¸¸æˆçš„è°ƒæŸ¥å‘˜åå•ä¸èµ„æ–™ã€‘${investigatorsProfiles}`;
                    systemPrompt += `\n\nã€æ¨¡ç»„èƒŒæ™¯ã€‘\n${cocState.module.content.slice(0, 5000)}`;

                    if (cocState.log.length === 0) {
                        const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                        const invName = inv ? inv.name : 'è°ƒæŸ¥å‘˜';
                        const openingContent = `*çƒ›ç«æ‘‡æ›³ï¼Œå¤è€çš„æ—¶é’Ÿæ•²å“äº†åˆå¤œçš„é’Ÿå£°...*

æ¬¢è¿æ¥åˆ° **ã€Š${cocState.module.name}ã€‹**

---

${invName}ï¼Œå‘½è¿çš„é½¿è½®å·²ç»å¼€å§‹è½¬åŠ¨ã€‚åœ¨è¿™ç‰‡è¢«è¿·é›¾ç¬¼ç½©çš„ä¸–ç•Œé‡Œï¼ŒçœŸç›¸ä¸ç–¯ç‹‚å¾€å¾€åªæœ‰ä¸€çº¿ä¹‹éš”ã€‚

*æ„¿ç†æ™ºä¸ä½ åŒåœ¨... å°½ç®¡åœ¨è¿™é‡Œï¼Œå®ƒå¾€å¾€æ˜¯æœ€å…ˆæ¶ˆé€çš„ã€‚*

---

**å‡†å¤‡å¥½ç›´é¢å‘½è¿äº†å—ï¼Ÿ**`;
                        cocState.log = [{ role: 'assistant', name: 'å®ˆå¯†äºº', content: openingContent }];
                    }
                    cocState.systemPrompt = systemPrompt;
                    cocState.gameState = 'playing';
                    currentView.value = 'chat';
                    if (cocState.mode === 'multi' && multiplayerState.isHost) broadcastMessage({ type: 'game_start', log: cocState.log });
                };

                const handleInvestigatorClick = (index) => {
                    // å¦‚æœæ­£åœ¨æ¸¸æˆä¸­ï¼Œç¦æ­¢åˆ‡æ¢è§’è‰²ï¼ˆé™¤éæ˜¯æˆ¿ä¸»åœ¨ç®¡ç† AIï¼‰
                    if (cocState.gameState === 'playing') {
                        if (cocState.mode === 'multi') {
                            const isMyChar = multiplayerState.assignments[index] === user.uuid;
                            const isAi = multiplayerState.assignments[index]?.startsWith('ai_');
                            // æˆ¿ä¸»å¯ä»¥ç‚¹å‡» AI è§’è‰²æ¥æŸ¥çœ‹/ç®¡ç†ï¼Œç©å®¶åªèƒ½ç‚¹å‡»è‡ªå·±çš„è§’è‰²
                            if (multiplayerState.isHost && isAi) {
                                cocState.activeInvestigatorIndex = index;
                                return;
                            }
                            if (isMyChar) {
                                cocState.activeInvestigatorIndex = index;
                                return;
                            }
                            return showToast('æ¸¸æˆä¸­æ— æ³•åˆ‡æ¢è§’è‰²', 'warning');
                        }
                        // å•äººæ¨¡å¼å…è®¸åˆ‡æ¢æŸ¥çœ‹
                        cocState.activeInvestigatorIndex = index;
                        return;
                    }

                    // å‡†å¤‡é˜¶æ®µ
                    if (cocState.mode === 'multi') {
                        const currentAssignee = multiplayerState.assignments[index];
                        
                        // å¦‚æœè¯¥è§’è‰²å·²è¢«å…¶ä»–äººå ç”¨
                        if (currentAssignee && currentAssignee !== user.uuid && !currentAssignee.startsWith('ai_')) {
                            const ownerName = multiplayerState.members.find(m => m.id === currentAssignee)?.name || 'å…¶ä»–ç©å®¶';
                            return showToast(`è¯¥è§’è‰²å·²è¢« ${ownerName} é€‰æ‹©`, 'warning');
                        }

                        // æˆ¿ä¸»ç›´æ¥æ“ä½œå¹¶å¹¿æ’­
                        if (multiplayerState.isHost) {
                            if (currentAssignee === user.uuid) {
                                delete multiplayerState.assignments[index];
                                cocState.activeInvestigatorIndex = -1;
                            } else {
                                clearUserAssignments(user.uuid);
                                multiplayerState.assignments[index] = user.uuid;
                                cocState.activeInvestigatorIndex = index;
                            }
                            broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments });
                        } else {
                            // æˆå‘˜å‘é€è¯·æ±‚ç»™æˆ¿ä¸»
                            // å…ˆæœ¬åœ°æš‚æ—¶æ›´æ–°UIä»¥æå‡ä½“éªŒï¼ˆå¯é€‰ï¼Œä½†ä¸ºäº†é˜²æ­¢å†²çªæœ€å¥½ç­‰å¾…æˆ¿ä¸»ç¡®è®¤ï¼‰
                            // è¿™é‡Œé€‰æ‹©ç­‰å¾…æˆ¿ä¸»ç¡®è®¤ï¼Œåªå‘é€è¯·æ±‚
                            broadcastMessage({
                                type: 'request_assignment',
                                user: { id: user.uuid },
                                index: index,
                                isCancel: currentAssignee === user.uuid
                            });
                        }
                    } else {
                        cocState.activeInvestigatorIndex = index;
                    }
                };

                const updateMyAssignment = () => {
                    if (cocState.mode === 'multi') {
                        // æ ¹æ® assignments æ‰¾åˆ°è‡ªå·±çš„è§’è‰²ç´¢å¼•
                        const myIndex = Object.keys(multiplayerState.assignments).find(k => multiplayerState.assignments[k] === user.uuid);
                        if (myIndex !== undefined) {
                            cocState.activeInvestigatorIndex = parseInt(myIndex);
                        } else {
                            cocState.activeInvestigatorIndex = -1;
                        }
                    }
                };
                const scrollToBottom = () => { nextTick(() => { if (cocChatContainer.value) cocChatContainer.value.scrollTop = cocChatContainer.value.scrollHeight; }); };
                // éª°å­å¤„ç†å‡½æ•°
                const processDiceCommand = (content, inv) => {
                    // 1. æŠ€èƒ½/å±æ€§æ£€å®š .ra / .rc
                    const raMatch = content.match(/^[\.ã€‚](?:ra|rc)\s+([^\s\d]+)/i);
                    if (raMatch && inv) {
                        const skillName = raMatch[1];
                        // æŸ¥æ‰¾æŠ€èƒ½æˆ–å±æ€§å€¼
                        let skillVal = 0;
                        let skillLabel = skillName;
                        
                        const statKeyMap = { 'åŠ›é‡': 'STR', 'ä½“è´¨': 'CON', 'ä½“å‹': 'SIZ', 'æ•æ·': 'DEX', 'å¤–è²Œ': 'APP', 'æ™ºåŠ›': 'INT', 'çµæ„Ÿ': 'INT', 'æ„å¿—': 'POW', 'æ•™è‚²': 'EDU', 'çŸ¥è¯†': 'EDU', 'å¹¸è¿': 'LUCK' };
                        const statKey = statKeyMap[skillName] || (inv.stats[skillName.toUpperCase()] ? skillName.toUpperCase() : null);
                        
                        if (statKey) {
                            skillVal = inv.stats[statKey];
                            skillLabel = statDisplayMap[statKey] || statKey;
                        } else {
                            const skill = inv.skills.find(s => s.name === skillName);
                            if (skill) skillVal = skill.value;
                        }
                        
                        const roll = Math.floor(Math.random() * 100) + 1;
                        let diceResult = null;
                        
                        if (skillVal > 0) {
                            let level = '';
                            let success = false;
                            
                            if (roll === 1) { level = 'å¤§æˆåŠŸ'; success = true; }
                            else if (roll === 100) { level = 'å¤§å¤±è´¥'; success = false; }
                            else if (roll <= skillVal / 5) { level = 'æéš¾æˆåŠŸ'; success = true; }
                            else if (roll <= skillVal / 2) { level = 'å›°éš¾æˆåŠŸ'; success = true; }
                            else if (roll <= skillVal) { level = 'æˆåŠŸ'; success = true; }
                            else if (roll > 95) { level = 'å¤§å¤±è´¥'; success = false; }
                            else { level = 'å¤±è´¥'; success = false; }
                            
                            diceResult = {
                                label: `${skillLabel} æ£€å®š`,
                                roll: roll,
                                target: skillVal,
                                level: level,
                                success: success
                            };
                        } else {
                            diceResult = {
                                label: `${skillLabel} æ£€å®š`,
                                roll: roll,
                                level: 'æœªä¹ å¾—',
                                success: null
                            };
                        }
                        
                        return { content, diceResult };
                    }
                    
                    // 2. San Check .sc
                    const scMatch = content.match(/^[\.ã€‚]sc(?:\s+([^\s\/]+)\/([^\s]+))?/i);
                    if (scMatch && (scMatch[0].trim() === '.sc' || scMatch[0].trim() === 'ã€‚sc' || scMatch[1])) {
                        if (inv) {
                            const successExpr = scMatch[1];
                            const failExpr = scMatch[2];
                            const san = inv.san;
                            const roll = Math.floor(Math.random() * 100) + 1;
                            const isSuccess = roll <= san;
                            
                            let extra = '';
                            if (successExpr && failExpr) {
                                const parseDice = (expr) => {
                                    let total = 0;
                                    const parts = expr.split('+');
                                    for (let p of parts) {
                                        if (p.includes('d')) {
                                            const [n, d] = p.split('d').map(Number);
                                            for(let i=0; i<(n||1); i++) total += Math.floor(Math.random()*(d||6))+1;
                                        } else {
                                            total += parseInt(p) || 0;
                                        }
                                    }
                                    return total;
                                };
                                const loss = parseDice(isSuccess ? successExpr : failExpr);
                                extra = `ç†æ™ºæ‰£é™¤: ${loss}`;
                                inv.san = Math.max(0, inv.san - loss); // å®æ—¶æ›´æ–°SAN
                            }
                            
                            return {
                                content,
                                diceResult: {
                                    label: 'San Check (ç†æ™ºæ£€å®š)',
                                    roll: roll,
                                    target: san,
                                    level: isSuccess ? 'æˆåŠŸ' : 'å¤±è´¥',
                                    success: isSuccess,
                                    extra: extra
                                }
                            };
                        }
                    }
                    
                    // 3. æ™®é€šæŠ•éª° .r
                    const rMatch = content.match(/^[\.ã€‚]r\s+(.+)/i);
                    if (rMatch) {
                        const expr = rMatch[1];
                        try {
                            const safeEval = (str) => new Function('return ' + str.replace(/[^-()\d/*+.]/g, ''))();
                            const calcStr = expr.replace(/(\d*)d(\d+)/g, (match, n, d) => {
                                let subTotal = 0;
                                const count = parseInt(n) || 1;
                                const sides = parseInt(d);
                                for(let i=0; i<count; i++) subTotal += Math.floor(Math.random() * sides) + 1;
                                return subTotal;
                            });
                            
                            return {
                                content,
                                diceResult: {
                                    label: `æŠ•éª° ${expr}`,
                                    roll: safeEval(calcStr),
                                    success: null
                                }
                            };
                        } catch (e) {
                            return { content, diceResult: null };
                        }
                    }

                    return { content, diceResult: null };
                };

                const sendCocMessage = async (manualContent = null) => {
                    let rawContent = (typeof manualContent === 'string' && manualContent) ? manualContent : cocInput.value.trim();
                    if (!rawContent) return;
                    
                    const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                    
                    // æ ¸å¿ƒä¿®æ”¹ï¼šæ¥æ”¶ç»“æ„åŒ–æ•°æ®
                    const { content, diceResult } = processDiceCommand(rawContent, inv);

                    const isWhisper = /@\S+/.test(rawContent);
                    const msg = {
                        role: isWhisper ? 'whisper' : 'user',
                        content: content,
                        diceResult: diceResult, // æ³¨å…¥ diceResult
                        timestamp: Date.now()
                    };
                    
                    if (cocState.mode === 'multi') {
                        // å¦‚æœåœ¨å¤šäººæ¨¡å¼ä¸‹å·²é€‰æ‹©è§’è‰²ï¼Œä¼˜å…ˆä½¿ç”¨è§’è‰²ä¿¡æ¯
                        if (inv) {
                            msg.name = inv.name;
                            msg.avatar = inv.avatar;
                        } else {
                            msg.name = user.name;
                            msg.avatar = user.avatar;
                        }
                        msg.id = user.uuid;
                    } else {
                        if (inv) {
                            msg.name = inv.name;
                            msg.avatar = inv.avatar;
                        } else {
                            msg.name = 'Player';
                        }
                    }

                    // Process .st commands for user
                    const { logs, rollbacks } = applyStCommands(content, cocState.activeInvestigatorIndex);
                    if (logs.length > 0) {
                        msg.stLogs = logs;
                        msg.stRollbacks = rollbacks;
                    }
                    
                    cocState.log.push(msg);
                    cocInput.value = '';
                    showMentionList.value = false;
                    scrollToBottom();
                    
                    if (cocState.mode === 'multi') {
                        broadcastMessage({ type: 'sync_log_append', message: msg });
                        // åªæœ‰éç§èŠæ¶ˆæ¯æ‰è§†ä¸ºè¡ŒåŠ¨
                        if (msg.role !== 'whisper' && !multiplayerState.roundActionIds.includes(user.uuid)) {
                            multiplayerState.roundActionIds.push(user.uuid);
                            broadcastMessage({ type: 'action_taken', userId: user.uuid });
                            checkAndTriggerRound();
                        }
                    } else {
                        // å•äººæ¨¡å¼
                        if (hasAiTeammates.value) {
                            // æœ‰ AI é˜Ÿå‹ï¼šå¼€å¯å›åˆåˆ¶é€»è¾‘
                            if (!multiplayerState.roundActionIds.includes(user.uuid)) {
                                multiplayerState.roundActionIds.push(user.uuid);
                                checkAndTriggerRound();
                            }
                        } else {
                            // çº¯å•äººæ¨¡å¼ï¼šç«‹å³é”å®šè¾“å…¥
                            isGenerating.value = true;
                            try {
                                await processAiPlayers();
                                await generateResponse();
                            } catch (e) {
                                console.error(e);
                                isGenerating.value = false;
                            }
                        }
                    }
                };
                
                const generateResponse = async () => {
                    isGenerating.value = true;
                    const assistantMsg = { role: 'assistant', name: 'å®ˆå¯†äºº', content: '', showCot: false };
                    cocState.log.push(assistantMsg);
                    
                    // å¤šäººæ¨¡å¼ä¸‹ï¼Œæˆ¿ä¸»å…ˆå¹¿æ’­ä¸€æ¡ç©ºæ¶ˆæ¯å ä½ï¼Œå¹¶é€šçŸ¥å…¶ä»–ç©å®¶æ­£åœ¨ç”Ÿæˆ
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        broadcastMessage({ type: 'generating_start' }); // æ–°å¢ï¼šå¹¿æ’­ç”Ÿæˆå¼€å§‹çŠ¶æ€
                        broadcastMessage({ type: 'sync_log_append', message: assistantMsg });
                    }

                    try {
                        // æ¸…æ´—æ¶ˆæ¯è®°å½•ï¼Œç¡®ä¿ç¬¦åˆ API è§„èŒƒï¼Œå¹¶æ³¨å…¥è§’è‰²å
                        const validMessages = cocState.log.slice(0, -1)
                            .filter(m => m.content && typeof m.content === 'string' && m.content.trim() !== '')
                            .map(m => {
                                if (m.role === 'user' || m.role === 'whisper') {
                                    let content = `ã€${m.name}ã€‘: ${m.content}`;
                                    // å°†éª°ç‚¹ç»“æœé™„åŠ åˆ°æ¶ˆæ¯ä¸­ï¼Œè®©AIèƒ½çœ‹åˆ°å®é™…ç»“æœ
                                    if (m.diceResult) {
                                        const dr = m.diceResult;
                                        content += `\n> ğŸ² ${dr.label || 'æŠ•æ·'}: ${dr.roll}${dr.target ? ` / ${dr.target}` : ''} â†’ ${dr.level || (dr.success ? 'æˆåŠŸ' : 'å¤±è´¥')}${dr.extra ? ` (${dr.extra})` : ''}`;
                                    }
                                    // å°†å±æ€§å˜æ›´æ—¥å¿—ä¹Ÿé™„åŠ 
                                    if (m.stLogs && m.stLogs.length > 0) {
                                        content += '\n> ' + m.stLogs.join('\n> ');
                                    }
                                    return { role: 'user', content };
                                }
                                return { role: m.role, content: removeCot(m.content) };
                            });

                        if (validMessages.length === 0 && !cocState.systemPrompt) {
                            throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„å¯¹è¯å†å²');
                        }

                        // è°ƒè¯•æ—¥å¿—
                        console.log('%c[COC Debug] ç³»ç»Ÿæç¤ºè¯:', 'color: #d4af37; font-weight: bold;');
                        console.log(cocState.systemPrompt);
                        console.log('%c[COC Debug] å¯¹è¯è®°å½•:', 'color: #2d6a4f; font-weight: bold;');
                        console.log(validMessages);

                        const res = await fetch(`${settings.apiUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: [{role:'system', content: cocState.systemPrompt || 'You are a Keeper.'}, ...validMessages],
                                stream: true
                            })
                        });
                        
                        if (!res.ok) {
                            throw new Error(`API Error: ${res.status} ${res.statusText}`);
                        }

                        const reader = res.body.getReader();
                        const decoder = new TextDecoder();
                        let lastBroadcastTime = 0;

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');
                            for (const line of lines) {
                                if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                    try {
                                        const json = JSON.parse(line.slice(6));
                                        if (json.choices[0]?.delta?.content) {
                                            assistantMsg.content += json.choices[0].delta.content;
                                            scrollToBottom();
                                            
                                            // å¤šäººæ¨¡å¼ä¸‹ï¼ŒèŠ‚æµå¹¿æ’­æµå¼æ›´æ–°ï¼ˆæ¯1.5ç§’ä¸€æ¬¡ï¼‰ï¼Œé˜²æ­¢æˆå‘˜ä¸€ç›´çœ‹ç©ºæ³¡æ³¡
                                            if (cocState.mode === 'multi' && multiplayerState.isHost) {
                                                const now = Date.now();
                                                if (now - lastBroadcastTime > 1500) {
                                                    broadcastMessage({ type: 'update_last_message', content: assistantMsg.content });
                                                    lastBroadcastTime = now;
                                                }
                                            }
                                        }
                                    } catch(e){}
                                }
                            }
                        }
                        // è°ƒè¯•æ—¥å¿—ï¼šAIæœ€æ–°æ¶ˆæ¯å®Œæ•´å†…å®¹
                        console.log('%c[COC Debug] AIæœ€æ–°æ¶ˆæ¯å®Œæ•´å†…å®¹:', 'color: #a78bfa; font-weight: bold;');
                        console.log(assistantMsg.content);
                    } catch (e) {
                        assistantMsg.content += `\n[Error: ${e.message}]`;
                    } finally {
                        // Apply .st commands from Assistant response
                        const { logs, rollbacks } = applyStCommands(assistantMsg.content);
                        if (logs.length > 0) {
                            assistantMsg.stLogs = logs;
                            assistantMsg.stRollbacks = rollbacks;
                            if (cocState.mode === 'multi' && multiplayerState.isHost) {
                                broadcastMessage({ type: 'sync_investigators', investigators: cocState.investigators });
                            }
                        }

                        isGenerating.value = false;
                        // ç”Ÿæˆå®Œæˆåï¼Œæˆ¿ä¸»å¹¿æ’­æœ€ç»ˆå®Œæ•´å†…å®¹ï¼Œå¹¶é€šçŸ¥ç”Ÿæˆç»“æŸ
                        if (cocState.mode === 'multi' && multiplayerState.isHost) {
                            // Need to broadcast full message object to include stLogs
                            // broadcastMessage({ type: 'update_last_message', content: assistantMsg.content });
                            // update_last_message only updates content. We need to sync log or update message with logs.
                            // Let's use a new type or repurpose sync_log_append (but it appends).
                            // Let's trigger a full log sync or update the specific message.
                            // For simplicity, let's sync the last message fully.
                            broadcastMessage({ type: 'update_last_message_full', message: assistantMsg });
                            broadcastMessage({ type: 'generating_end' }); // æ–°å¢ï¼šå¹¿æ’­ç”Ÿæˆç»“æŸçŠ¶æ€
                        }
                    }
                };

                const broadcastMessage = async (payload) => { if (roomChannel) await roomChannel.send({ type: 'broadcast', event: 'message', payload }); };

                const broadcastState = () => {
                    if (!multiplayerState.isHost) return;
                    broadcastMessage({
                        type: 'sync_state',
                        gameState: cocState.gameState,
                        module: cocState.module,
                        members: multiplayerState.members,
                        investigators: cocState.investigators,
                        assignments: multiplayerState.assignments,
                        assignmentDetails: multiplayerState.assignmentDetails,
                        turnIndex: multiplayerState.turnIndex,
                        roundActionIds: multiplayerState.roundActionIds,
                        cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers,
                        log: cocState.log
                    });
                };

                const handleBroadcastMessage = (payload) => {
                    switch (payload.type) {
                        case 'player_joined':
                            if (multiplayerState.isHost) {
                                const newMember = payload.user;
                                if (!multiplayerState.members.some(m => m.id === newMember.id)) {
                                    multiplayerState.members.push({ ...newMember, isHost: false, isReady: false });
                                    showToast(`${newMember.name} åŠ å…¥äº†æˆ¿é—´`, 'success');
                                    broadcastState();
                                }
                            }
                            break;
                        case 'sync_state':
                            if (!multiplayerState.isHost) {
                                if (payload.gameState) cocState.gameState = payload.gameState;
                                if (payload.module) cocState.module = payload.module;
                                if (payload.members) multiplayerState.members = payload.members;
                                if (payload.investigators) cocState.investigators = payload.investigators;
                                if (payload.assignments) multiplayerState.assignments = payload.assignments || {};
                                if (payload.assignmentDetails) multiplayerState.assignmentDetails = payload.assignmentDetails || {};
                                if (payload.log) cocState.log = payload.log;
                                if (payload.roundActionIds) multiplayerState.roundActionIds = payload.roundActionIds;
                                if (typeof payload.turnIndex === 'number') multiplayerState.turnIndex = payload.turnIndex;
                                if (payload.cotAuthorizedUsers) multiplayerState.cotAuthorizedUsers = payload.cotAuthorizedUsers;
                                multiplayerState.isConnected = true;
                                multiplayerState.inRoom = true;
                                
                                if (!multiplayerState.syncReceived) {
                                    multiplayerState.syncReceived = true;
                                    showToast('åŒæ­¥å®Œæˆ', 'success');
                                    if (joinRetryInterval) {
                                        clearInterval(joinRetryInterval);
                                        joinRetryInterval = null;
                                    }
                                }
                            }
                            break;
                        case 'sync_log_append':
                             cocState.log.push(payload.message);
                             scrollToBottom();
                             break;
                        case 'update_last_message':
                             if (cocState.log.length > 0) {
                                 // å°è¯•æ‰¾åˆ°æœ€åä¸€æ¡ Keeper æ¶ˆæ¯è¿›è¡Œæ›´æ–°
                                 let targetMsg = cocState.log[cocState.log.length - 1];
                                 // å¦‚æœæœ€åä¸€æ¡ä¸æ˜¯ assistantï¼Œå°è¯•å¾€å‰æ‰¾ï¼ˆé˜²æ­¢å¹¶å‘æ¶ˆæ¯å¯¼è‡´é”™ä½ï¼‰
                                 if (targetMsg.role !== 'assistant') {
                                     for (let i = cocState.log.length - 1; i >= 0; i--) {
                                         if (cocState.log[i].role === 'assistant') {
                                             targetMsg = cocState.log[i];
                                             break;
                                         }
                                     }
                                 }
                                 
                                 if (targetMsg && targetMsg.role === 'assistant') {
                                     targetMsg.content = payload.content;
                                     scrollToBottom();
                                 }
                             }
                             break;
                        case 'update_last_message_full':
                             if (cocState.log.length > 0) {
                                 let targetMsg = cocState.log[cocState.log.length - 1];
                                 if (targetMsg.role !== 'assistant') {
                                     for (let i = cocState.log.length - 1; i >= 0; i--) {
                                         if (cocState.log[i].role === 'assistant') {
                                             targetMsg = cocState.log[i];
                                             break;
                                         }
                                     }
                                 }
                                 if (targetMsg && targetMsg.role === 'assistant') {
                                     // Update full properties
                                     Object.assign(targetMsg, payload.message);
                                     scrollToBottom();
                                 }
                             }
                             break;
                        case 'sync_module':
                            if (!multiplayerState.isHost) cocState.module = { name: payload.moduleName, content: '' };
                            break;
                        case 'sync_investigators':
                            if (!multiplayerState.isHost) cocState.investigators = payload.investigators;
                            break;
                        case 'sync_assignments':
                            if (!multiplayerState.isHost) {
                                multiplayerState.assignments = payload.assignments;
                                updateMyAssignment();
                            }
                            break;
                        case 'request_assignment':
                            if (multiplayerState.isHost) {
                                const requesterId = payload.user.id;
                                const targetIndex = payload.index;
                                
                                // å¤„ç†å–æ¶ˆé€‰æ‹©
                                if (payload.isCancel) {
                                    if (multiplayerState.assignments[targetIndex] === requesterId) {
                                        delete multiplayerState.assignments[targetIndex];
                                        broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments });
                                    }
                                    break;
                                }

                                // å¤„ç†é€‰æ‹©æ–°è§’è‰²
                                const currentOwner = multiplayerState.assignments[targetIndex];
                                if (!currentOwner || currentOwner === requesterId) {
                                    clearUserAssignments(requesterId);
                                    multiplayerState.assignments[targetIndex] = requesterId;
                                    broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments });
                                } else {
                                    // ç›®æ ‡å·²è¢«å ç”¨ï¼Œå¿½ç•¥æˆ–å‘é€é”™è¯¯æç¤ºï¼ˆè¿™é‡Œç®€åŒ–ä¸ºå¿½ç•¥ï¼Œå› ä¸ºå‰ç«¯å·²åšæ ¡éªŒï¼‰
                                }
                            }
                            break;
                        case 'game_start':
                             if (!multiplayerState.isHost) {
                                 cocState.log = payload.log;
                                 cocState.gameState = 'playing';
                                 currentView.value = 'chat';
                                 showToast('æˆ¿ä¸»å¼€å§‹äº†æ¸¸æˆ', 'success');
                             }
                             break;
                        case 'room_closed':
                             if (!multiplayerState.isHost) {
                                 showToast('æˆ¿ä¸»å·²è§£æ•£æˆ¿é—´', 'warning');
                                 leaveRoom();
                                 currentView.value = 'coc';
                             }
                             break;
                        case 'request_cot_access':
                            if (multiplayerState.isHost) {
                                showToast(`${payload.userName} ç”³è¯·æŸ¥çœ‹æ€è€ƒè¿‡ç¨‹`, 'info');
                                grantCotAccess(payload.userId);
                            }
                            break;
                        case 'grant_cot_access':
                             if (payload.userId === user.uuid) {
                                 showToast('å·²è·å¾—æ€è€ƒè¿‡ç¨‹æŸ¥çœ‹æƒé™', 'success');
                                 multiplayerState.cotAuthorizedUsers = payload.authorizedUsers;
                             }
                             break;
                        case 'generating_start':
                            if (!multiplayerState.isHost) isGenerating.value = true;
                            break;
                        case 'generating_end':
                            if (!multiplayerState.isHost) isGenerating.value = false;
                            break;
                        case 'regenerate_start':
                            if (!multiplayerState.isHost) {
                                showToast('æˆ¿ä¸»æ­£åœ¨é‡æ–°ç”Ÿæˆ...', 'info');
                                isGenerating.value = true; // ä¿®å¤ï¼šé‡æ–°ç”Ÿæˆæ—¶ä¹ŸåŒæ­¥çŠ¶æ€
                            }
                            break;
                        case 'action_taken':
                            if (multiplayerState.isHost) {
                                if (!multiplayerState.roundActionIds.includes(payload.userId)) {
                                    multiplayerState.roundActionIds.push(payload.userId);
                                    checkAndTriggerRound();
                                }
                            }
                            break;
                        case 'toggle_ready':
                            if (multiplayerState.isHost) {
                                const member = multiplayerState.members.find(m => m.id === payload.userId);
                                if (member) {
                                    member.isReady = payload.isReady;
                                    // æˆ¿ä¸»å¹¿æ’­æœ€æ–°çŠ¶æ€ï¼Œç¡®ä¿æ‰€æœ‰äººçœ‹åˆ°å‡†å¤‡çŠ¶æ€æ›´æ–°
                                    broadcastState();
                                }
                            }
                            break;
                    }
                };

                const initSupabase = () => {
                    if (typeof supabase === 'undefined') return;
                    try {
                        supabaseClient = supabase.createClient(settings.supabaseUrl, settings.supabaseKey);
                    } catch (e) {
                        console.error('Supabase init error:', e);
                    }
                };

                const joinRoomChannel = async (roomId) => {
                    if (!supabaseClient) {
                         initSupabase();
                         if (!supabaseClient) {
                             showToast('æœåŠ¡è¿æ¥å¤±è´¥', 'error');
                             throw new Error('Supabase client init failed');
                         }
                    }
                    
                    // ç¡®ä¿å½»åº•æ–­å¼€æ—§è¿æ¥
                    if (roomChannel) {
                        await supabaseClient.removeChannel(roomChannel);
                        roomChannel = null;
                    }

                    return new Promise((resolve, reject) => {
                        const channel = supabaseClient.channel(`room:${roomId}`, {
                            config: { broadcast: { self: false } }
                        });

                        // è®¾ç½®è¿æ¥è¶…æ—¶
                        const timeout = setTimeout(() => {
                            if (multiplayerState.isConnected) return;
                            showToast('è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
                            supabaseClient.removeChannel(channel);
                            reject('TIMEOUT');
                        }, 10000);

                        channel.on('broadcast', { event: 'message' }, ({ payload }) => {
                            handleBroadcastMessage(payload);
                        }).subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                clearTimeout(timeout);
                                roomChannel = channel; // è¿æ¥æˆåŠŸæ‰èµ‹å€¼ç»™å…¨å±€å˜é‡
                                multiplayerState.isConnected = true;
                                multiplayerState.inRoom = true;
                                
                                if (!multiplayerState.isHost) {
                                    multiplayerState.syncReceived = false;
                                    showToast('å·²è¿æ¥æˆ¿é—´ï¼Œè¯·æ±‚åŒæ­¥...', 'success');
                                    
                                    broadcastMessage({
                                        type: 'player_joined',
                                        user: { id: user.uuid, name: user.name, avatar: user.avatar }
                                    });

                                    if (joinRetryInterval) clearInterval(joinRetryInterval);
                                    joinRetryInterval = setInterval(() => {
                                        if (multiplayerState.syncReceived || !multiplayerState.inRoom) {
                                            clearInterval(joinRetryInterval);
                                            joinRetryInterval = null;
                                            return;
                                        }
                                        broadcastMessage({
                                            type: 'player_joined',
                                            user: { id: user.uuid, name: user.name, avatar: user.avatar }
                                        });
                                    }, 2000);
                                }
                                resolve();
                            } else if (status === 'CHANNEL_ERROR') {
                                clearTimeout(timeout);
                                // å°è¯•é™é»˜é‡è¿æˆ–æ‹’ç»
                                console.warn('Channel error, retrying...');
                                // è¿™é‡Œä¸rejectï¼ŒSupabase å¯èƒ½ä¼šè‡ªåŠ¨é‡è¿ï¼Œæˆ–è€…ç­‰å¾…ç”¨æˆ·å†æ¬¡ç‚¹å‡»
                                // åªæœ‰æ˜ç¡®çš„é”™è¯¯æ‰å¼¹çª—
                            } else if (status === 'TIMED_OUT') {
                                clearTimeout(timeout);
                                showToast('è¿æ¥è¶…æ—¶', 'error');
                                reject(status);
                            }
                        });
                    });
                };
                
                const isConnecting = ref(false); // æ·»åŠ è¿æ¥çŠ¶æ€é”

                const createRoom = async (isLoadGame = false) => {
                    if (isConnecting.value) return;
                    isConnecting.value = true;
                    
                    if (!supabaseClient) initSupabase();
                    const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                    
                    multiplayerState.roomId = roomId;
                    multiplayerState.isHost = true;
                    multiplayerState.myId = user.uuid;
                    multiplayerState.members = [{ id: user.uuid, name: user.name, avatar: user.avatar, isHost: true, isReady: true }];
                    
                    try {
                        await joinRoomChannel(roomId);
                        showToast(`æˆ¿é—´ ${roomId} å·²åˆ›å»º`, 'success');
                        selectCocMode('multi');
                    } catch (e) {
                        console.error('Create room failed:', e);
                        showToast('åˆ›å»ºæˆ¿é—´å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    } finally {
                        isConnecting.value = false;
                    }
                };

                const joinRoom = async (id = null, asHost = false) => {
                    if (!id || isConnecting.value) return;
                    isConnecting.value = true;
                    
                    if (!supabaseClient) initSupabase();
                    
                    multiplayerState.roomId = id;
                    multiplayerState.isHost = asHost;
                    multiplayerState.myId = user.uuid;
                    multiplayerState.members = [{ id: user.uuid, name: user.name, avatar: user.avatar, isHost: asHost, isReady: false }];
                    
                    try {
                        await joinRoomChannel(id);
                        selectCocMode('multi');
                    } catch (e) {
                        console.error('Join room failed:', e);
                        // showToast å·²ç»åœ¨ joinRoomChannel é‡Œå¤„ç†äº†éƒ¨åˆ†é”™è¯¯ï¼Œè¿™é‡Œå¯ä»¥è¡¥å……é€šç”¨æç¤º
                    } finally {
                        isConnecting.value = false;
                    }
                };

                const leaveRoom = async () => {
                    if (joinRetryInterval) {
                        clearInterval(joinRetryInterval);
                        joinRetryInterval = null;
                    }
                    if (roomChannel) {
                        supabaseClient.removeChannel(roomChannel);
                        roomChannel = null;
                    }
                    multiplayerState.inRoom = false;
                    multiplayerState.isConnected = false;
                    multiplayerState.roomId = null;
                    multiplayerState.members = [];
                    multiplayerState.assignments = {};
                    multiplayerState.syncReceived = false;
                    showToast('å·²æ–­å¼€è¿æ¥', 'info');
                };
                const addFriend = () => { /* ... */ };
                const acceptFriend = (req) => { /* ... */ };
                const inviteFriend = (f) => { /* ... */ };

                const checkPendingModule = () => {
                    const pendingStr = localStorage.getItem('coc_pending_module');
                    if (pendingStr) {
                        try {
                            const pending = JSON.parse(pendingStr);
                            localStorage.removeItem('coc_pending_module');
                            cocState.module = { name: pending.name, content: pending.content };
                            showToast(`å·²åŠ è½½æ¨¡ç»„: ${pending.name}`, 'success');
                            if (pending.mode === 'single') selectCocMode('single');
                            else if (pending.mode === 'multi') selectCocMode('multi');
                        } catch (e) { console.error(e); }
                    }
                };

                const openLibrary = () => { window.location.href = 'Library/index.html'; };

                onMounted(async () => {
                    await loadData();
                    checkBroadcast();
                    if (settings.supabaseUrl) initSupabase();
                    checkPendingModule();
                });

                return {
                    currentView, showMobileMenu, showMobileRightSidebar, user, settings, toasts, confirmState, showBroadcast, dontShowBroadcast, closeBroadcast,
                    cocState, cocInput, cocInputRef, cocChatContainer, isGenerating, multiplayerState, showJoinInput, joinRoomId, friends, friendRequests, friendInput,
                    showMentionList, mentionCandidates, handleInput, selectMention, savedGames, isRoundLocked, hasAiTeammates,
                    selectCocMode, exitCocMode, exitCocGame, startCocGame, sendCocMessage, saveGame, deleteSave, loadSave, exportSave, importSave,
                    importCocModule, saveManualModule, importInvestigator, deleteInvestigator,
                    initSupabase, createRoom, joinRoom, leaveRoom, addFriend, acceptFriend, inviteFriend,
                    handleUserAvatarUpload, saveData, renderMarkdown, copyToClipboard,
                    toggleReady, allPlayersReady, handleInvestigatorClick, toggleAiPlayer,
                    openLibrary, openCocCard,
                    hasCot, getCotContent, removeCot, toggleCot, regenerateLastResponse, lastAssistantIndex, statDisplayMap, sanitizeBadgeIcon, formatStLog, parseStLogDiff,
                    settlementState, openSettlement, rollSanReward, processSkillGrowth, confirmSettlement,
                    tavernState, importTavernSave, generateNovel, saveNovel, deleteNovel, viewNovel, exportNovel,
                    exportCurrentInvestigatorJSON, exportCurrentInvestigatorPNG,
                    getPageTitle: () => {
                        switch(currentView.value) {
                            case 'coc': return 'å‘½è¿é€‰æ‹©'; case 'saves': return 'è®°å¿†å›å»Š'; case 'friends': return 'åŒä¼´åå½•'; case 'settings': return 'è®¾ç½®ä¸­å¿ƒ'; case 'multiplayer': return 'å¤šé‡å®‡å®™'; case 'preparing': return 'è·‘å›¢å‡†å¤‡'; default: return 'The Call of Cthulhu';
                        }
                    }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
