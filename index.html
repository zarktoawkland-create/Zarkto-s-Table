<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zarkto's Table - TRPG</title>
    <!-- 引入衬线字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Noto Serif SC"', 'SimSun', 'Songti SC', 'serif'],
                        sans: ['"Noto Serif SC"', 'system-ui', 'sans-serif'], // 强制全局使用衬线体风格
                    },
                    colors: {
                        dark: {
                            950: '#020617', // Slate 950
                            900: '#0a0f1e', // Deep Void
                            850: '#141b2d', // Lighter Void
                            800: '#1e293b', // Slate 800
                            700: '#334155', // Slate 700
                        },
                        mystic: {
                            gold: '#d4af37', // 更加鲜亮的暗金
                            gold_dim: '#8a7120',
                            green: '#2d6a4f', // 深绿
                            teal: '#115e59', // 蓝绿
                            red: '#8a1c1c', // 血红
                            purple: '#581c87', // 深紫
                        }
                    },
                    boxShadow: {
                        'glow-gold': '0 0 15px rgba(212, 175, 55, 0.15)',
                        'glow-green': '0 0 15px rgba(45, 106, 79, 0.2)',
                        'inner-glow': 'inset 0 0 20px rgba(0,0,0,0.5)',
                    },
                    backgroundImage: {
                        'void-noise': "url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22 opacity=%220.07%22/%3E%3C/svg%3E')",
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'message-in': 'messageIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        messageIn: { '0%': { transform: 'translateY(15px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } },
                    }
                }
            }
        }
    </script>
    <style>
        html, body {
            -webkit-text-size-adjust: 100%;
            height: 100%;
            height: 100dvh; /* 移动端高度修复 */
            overflow: hidden;
            background-color: #020617;
            color: #cbd5e1;
            font-family: 'Noto Serif SC', serif;
        }
        /* Global Noise Overlay */
        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 50;
            opacity: 0.4;
        }

        [v-cloak] { display: none !important; }
        
        /* Custom Scrollbar - Antique Style */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; border-left: 1px solid #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border: 1px solid #0f172a; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; border-color: #d4af37; }
        
        /* Text Effects */
        .text-shadow-gold { text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
        .text-shadow-red { text-shadow: 0 0 10px rgba(138, 28, 28, 0.4); }
        
        /* Markdown Styles (Dark) */
        .markdown-body { font-size: 0.95rem; line-height: 1.7; color: #e2e8f0; font-family: 'Noto Serif SC', serif; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body strong { font-weight: 700; color: #c0a062; } /* Gold highlight */
        .markdown-body blockquote { border-left: 2px solid #2d6a4f; padding-left: 1em; color: #94a3b8; font-style: italic; background: rgba(0,0,0,0.2); padding: 0.5em 1em; }
        .markdown-body code { background-color: #1e293b; padding: 0.1em 0.3em; border-radius: 0.2em; font-family: monospace; font-size: 0.9em; color: #c0a062; border: 1px solid #334155; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin-bottom: 0.8em; }
        .markdown-body li { margin-bottom: 0.3em; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: #c0a062; font-family: 'Noto Serif SC', serif; margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; }
        .markdown-body h1 { font-size: 1.5em; border-bottom: 1px solid #334155; padding-bottom: 0.2em; }
        .markdown-body h2 { font-size: 1.3em; }
        
        /* Typing Indicator */
        .typing-indicator { display: flex; align-items: center; gap: 4px; }
        .typing-indicator span { display: block; width: 4px; height: 4px; background-color: #5eead4; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        /* Transitions */
        .list-enter-active, .list-leave-active { transition: all 0.4s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(-20px); }
        
        /* Utilities */
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .nav-active { background: linear-gradient(90deg, rgba(20, 184, 166, 0.15) 0%, transparent 100%); border-left: 3px solid #14b8a6; color: #ccfbf1; }

        /* Safe Area Support */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }

        /* CoT Styles */
        .cot-wrapper {
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
            background: rgba(2, 6, 23, 0.3);
            margin-bottom: 1rem;
        }
        .cot-header {
            padding: 0.5rem 0.75rem;
            background: rgba(30, 41, 59, 0.4);
            cursor: pointer;
            font-size: 0.75rem;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
        }
        .cot-header:hover {
            background: rgba(30, 41, 59, 0.6);
            color: #94a3b8;
        }
        .cot-header.active {
            border-bottom-color: rgba(148, 163, 184, 0.1);
        }
        .cot-content {
            padding: 1rem;
            background: rgba(15, 23, 42, 0.4);
            font-size: 0.85rem;
            color: #94a3b8;
            font-family: 'Noto Serif SC', serif;
            line-height: 1.6;
        }
        
        /* CoT Tree View Optimization */
        .cot-content ul {
            list-style: none;
            padding-left: 1rem;
            margin: 0;
            position: relative;
        }
        .cot-content ul li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .cot-content ul li::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0.7em;
            width: 1rem;
            height: 1px;
            background-color: #475569;
            opacity: 0.5;
        }
        .cot-content ul li::after {
            content: "";
            position: absolute;
            left: 0;
            top: -0.6em;
            bottom: 0;
            width: 1px;
            background-color: #475569;
            opacity: 0.5;
        }
        .cot-content ul li:last-child::after {
            height: 1.3em;
        }
        /* Root level ul shouldn't have line from top if it's the start */
        .cot-content > ul > li:first-child::after {
            top: 0.7em;
            height: calc(100% - 0.7em);
        }
        .cot-content code {
            background: rgba(0,0,0,0.3);
            color: #e2e8f0;
            padding: 0.1em 0.3em;
            border-radius: 0.2em;
            font-size: 0.9em;
        }
    </style>
</head>
<body class="selection:bg-teal-900 selection:text-teal-100">
    <div id="app" v-cloak class="h-full flex flex-col md:flex-row relative bg-dark-950 text-slate-300">
        
        <!-- Toast Notification -->
        <div class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[1000] flex flex-col gap-2 pointer-events-none items-center w-full max-w-sm px-4 safe-pt">
            <transition-group name="list" tag="div" class="flex flex-col items-center w-full">
                <div v-for="toast in toasts" :key="toast.id"
                     class="pointer-events-auto flex items-center px-4 py-3 rounded-xl shadow-2xl border bg-dark-900/95 backdrop-blur-md text-sm font-medium w-full"
                     :class="{
                        'border-mystic-green/50 text-mystic-green': toast.type === 'success',
                        'border-mystic-red/50 text-red-400': toast.type === 'error',
                        'border-blue-500/50 text-blue-400': toast.type === 'info',
                        'border-mystic-gold/50 text-mystic-gold': toast.type === 'warning'
                     }">
                    <span class="flex-1">{{ toast.message }}</span>
                </div>
            </transition-group>
        </div>

        <!-- Custom Confirm Modal -->
        <div v-if="confirmState.show" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in safe-pt safe-pb">
            <div class="bg-dark-900 border border-mystic-gold/50 rounded-lg shadow-[0_0_30px_rgba(212,175,55,0.15)] max-w-sm w-full flex flex-col relative overflow-hidden transform transition-all scale-100">
                <!-- Header Decoration -->
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-mystic-gold to-transparent opacity-50"></div>
                
                <div class="p-6">
                    <h3 class="text-xl font-bold text-mystic-gold font-serif mb-3 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        {{ confirmState.title || '确认操作' }}
                    </h3>
                    <p class="text-slate-300 text-sm leading-relaxed mb-6 font-serif">
                        {{ confirmState.message }}
                    </p>
                    <div class="flex justify-end gap-3">
                        <button @click="confirmState.resolve(false); confirmState.show = false" class="px-4 py-2 text-slate-400 hover:text-slate-200 text-sm font-bold transition-colors">
                            {{ confirmState.cancelText || '取消' }}
                        </button>
                        <button @click="confirmState.resolve(true); confirmState.show = false" class="px-6 py-2 bg-mystic-gold text-dark-950 font-bold rounded shadow-lg hover:bg-yellow-600 transition-all text-sm uppercase tracking-wide">
                            {{ confirmState.confirmText || '确定' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Confirm Modal -->
        <div v-if="confirmState.show" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in safe-pt safe-pb">
            <div class="bg-dark-900 border border-mystic-gold/50 rounded-lg shadow-[0_0_30px_rgba(212,175,55,0.15)] max-w-sm w-full flex flex-col relative overflow-hidden transform transition-all scale-100">
                <!-- Header Decoration -->
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-mystic-gold to-transparent opacity-50"></div>
                
                <div class="p-6">
                    <h3 class="text-xl font-bold text-mystic-gold font-serif mb-3 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        {{ confirmState.title || '确认操作' }}
                    </h3>
                    <p class="text-slate-300 text-sm leading-relaxed mb-6 font-serif">
                        {{ confirmState.message }}
                    </p>
                    <div class="flex justify-end gap-3">
                        <button @click="confirmState.resolve(false); confirmState.show = false" class="px-4 py-2 text-slate-400 hover:text-slate-200 text-sm font-bold transition-colors">
                            {{ confirmState.cancelText || '取消' }}
                        </button>
                        <button @click="confirmState.resolve(true); confirmState.show = false" class="px-6 py-2 bg-mystic-gold text-dark-950 font-bold rounded shadow-lg hover:bg-yellow-600 transition-all text-sm uppercase tracking-wide">
                            {{ confirmState.confirmText || '确定' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Sidebar Overlay -->
        <div v-if="showMobileMenu" @click="showMobileMenu = false" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-20 md:hidden transition-opacity"></div>

        <!-- Sidebar -->
        <div :class="['fixed inset-y-0 left-0 z-30 w-72 bg-dark-900 border-r border-dark-800 transform transition-transform duration-300 md:relative md:translate-x-0 flex flex-col shadow-2xl bg-void-noise', showMobileMenu ? 'translate-x-0' : '-translate-x-full']">
            <div class="h-24 flex items-center px-6 border-b border-dark-800 bg-dark-950/50 backdrop-blur-sm relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-b from-mystic-gold/5 to-transparent pointer-events-none"></div>
                <div class="font-bold text-xl text-mystic-gold flex items-center tracking-wider relative z-10 text-shadow-gold">
                    <!-- Cthulhu Icon -->
                    <svg class="w-8 h-8 mr-3 text-mystic-gold animate-pulse-slow" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8 c0-4.41,3.59-8,8-8s8,3.59,8,8C20,16.41,16.41,20,12,20z M12,6c-3.31,0-6,2.69-6,6c0,1.36,0.46,2.61,1.23,3.62l1.46-1.46 C8.26,13.61,8,12.84,8,12c0-2.21,1.79-4,4-4s4,1.79,4,4c0,0.84-0.26,1.61-0.69,2.16l1.46,1.46C17.54,14.61,18,13.36,18,12 C18,8.69,15.31,6,12,6z M12,10c-1.1,0-2,0.9-2,2c0,0.55,0.22,1.05,0.59,1.41l2.83-2.83C13.05,10.22,12.55,10,12,10z"/></svg>
                    <div class="flex flex-col">
                        <span class="leading-none">Call of</span>
                        <span class="text-2xl leading-none font-serif">Cthulhu</span>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto py-6 px-4 space-y-3">
                <button @click="currentView = 'chat'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'chat' ? 'bg-mystic-green/10 border-mystic-green/40 text-mystic-green shadow-glow-green' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-mystic-green/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    <span class="relative z-10">聆听低语</span>
                </button>
                <button @click="if(cocState.gameState !== 'playing') { currentView = 'coc'; showMobileMenu = false; }" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'coc' ? 'bg-mystic-gold/10 border-mystic-gold/40 text-mystic-gold shadow-glow-gold' : (cocState.gameState === 'playing' ? 'opacity-50 cursor-not-allowed text-slate-600 border-transparent' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700')]">
                    <div class="absolute inset-0 bg-gradient-to-r from-mystic-gold/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="relative z-10">仪式准备</span>
                </button>
                <button @click="currentView = 'saves'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'saves' ? 'bg-indigo-900/20 border-indigo-500/30 text-indigo-400' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-indigo-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    <span class="relative z-10">记忆回廊</span>
                <button @click="currentView = 'friends'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'friends' ? 'bg-blue-900/20 border-blue-500/30 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <span class="relative z-10">调查员名单</span>
                </button>
                <button @click="openCocCard" class="w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700">
                    <div class="absolute inset-0 bg-gradient-to-r from-mystic-purple/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span class="relative z-10">调查员雇佣</span>
                </button>
                <button disabled class="w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden border-transparent text-slate-600 opacity-50 cursor-not-allowed">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-900/20 to-transparent opacity-0 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    <span class="relative z-10">密大图书馆（暂未开馆）</span>
                </button>
            </div>

            <div class="p-4 border-t border-dark-800 bg-dark-950/50 cursor-pointer hover:bg-dark-800 transition-colors group safe-pb" @click="currentView = 'settings'; showMobileMenu = false">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full overflow-hidden shadow-lg ring-2 ring-dark-700">
                        <img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover grayscale-[30%]">
                        <div v-else class="w-full h-full bg-dark-800 flex items-center justify-center text-mystic-gold font-bold border border-dark-700">
                            {{ user.name.charAt(0).toUpperCase() }}
                        </div>
                    </div>
                    <div class="ml-3 overflow-hidden">
                        <div class="text-sm font-bold text-slate-300 truncate">{{ user.name }}</div>
                        <div class="text-xs text-slate-500 truncate font-mono">{{ user.uuid ? 'ID: ' + user.uuid.slice(0,6) + '...' : '游客' }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Broadcast Modal (Zarkto's Old Broadcast) -->
        <div v-if="showBroadcast" class="fixed inset-0 z-[300] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
            <div class="bg-dark-900 border border-mystic-gold/50 rounded-xl shadow-[0_0_50px_rgba(212,175,55,0.15)] max-w-lg w-full flex flex-col relative overflow-hidden">
                <!-- Decorative Header Background -->
                <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-mystic-gold/10 to-transparent pointer-events-none"></div>
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-mystic-gold/5 rounded-full blur-3xl pointer-events-none"></div>
                
                <div class="p-6 md:p-8 relative z-10">
                    <h3 class="text-2xl font-bold text-mystic-gold font-serif mb-2 flex items-center gap-3">
                        <svg class="w-8 h-8 animate-pulse-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                        扎克托的旧日广播
                    </h3>
                    <div class="text-xs text-slate-500 font-mono mb-6 uppercase tracking-widest border-b border-dark-700 pb-2 flex justify-between">
                        <span>Frequency: 192.8 MHz</span>
                        <span>Ver 1.0</span>
                    </div>
                    
                    <div class="prose prose-invert prose-sm max-w-none text-slate-300 font-serif leading-relaxed mb-6 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                        <p>欢迎来到 <strong>Zarkto's Table</strong> (Ver 1.0)。</p>
                        <p class="text-mystic-gold font-bold">目前本网站只有coc跑团功能。</p>
                        <p>这里是为 TRPG 爱好者打造的跑团中心。目前，您可以体验以下功能：</p>
                        <ul class="list-disc pl-4 space-y-1 marker:text-mystic-gold">
                            <li><strong>聆听低语</strong>：与 AI Keeper 进行单人跑团，或作为房主主持游戏。</li>
                            <li><strong>仪式准备</strong>：选择模组，创建或导入调查员。</li>
                            <li><strong>记忆回廊</strong>：保存和读取您的跑团记录。</li>
                            <li><strong>调查员雇佣</strong>：使用全新的车卡器创建您的角色。</li>
                            <li><strong>多人联机</strong>：与朋友们建立连接，共同探索未知。</li>
                        </ul>
                        <p class="mt-4 text-slate-400 italic">
                            更多功能正在开发中，包括“密大图书馆”模组库等。
                        </p>
                        <div class="mt-6 p-4 bg-mystic-gold/5 border border-mystic-gold/20 rounded-lg text-xs text-mystic-gold/80">
                            “本网站尚处于测试阶段，许多功能尚未完全，有任何问题可以联系开发者本人，欢迎大家积极反馈。”
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-4 border-t border-dark-700">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" v-model="dontShowBroadcast" class="checkbox checkbox-xs border-slate-600 checked:border-mystic-gold checked:bg-mystic-gold rounded-sm transition-all" />
                            <span class="text-xs text-slate-500 group-hover:text-slate-300 transition-colors select-none">不再收听此频段</span>
                        </label>
                        <button @click="closeBroadcast" class="px-6 py-2 bg-mystic-gold hover:bg-yellow-600 text-dark-900 font-bold rounded shadow-lg shadow-mystic-gold/20 transition-all text-sm font-serif">
                            关闭通讯
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden relative bg-black/20">
            <!-- Background Decoration -->
            <div class="absolute inset-0 pointer-events-none overflow-hidden flex items-center justify-center opacity-5">
                <svg class="w-[800px] h-[800px] text-mystic-gold animate-pulse-slow" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8 c0-4.41,3.59-8,8-8s8,3.59,8,8C20,16.41,16.41,20,12,20z M12,6c-3.31,0-6,2.69-6,6c0,1.36,0.46,2.61,1.23,3.62l1.46-1.46 C8.26,13.61,8,12.84,8,12c0-2.21,1.79-4,4-4s4,1.79,4,4c0,0.84-0.26,1.61-0.69,2.16l1.46,1.46C17.54,14.61,18,13.36,18,12 C18,8.69,15.31,6,12,6z M12,10c-1.1,0-2,0.9-2,2c0,0.55,0.22,1.05,0.59,1.41l2.83-2.83C13.05,10.22,12.55,10,12,10z"/>
                </svg>
            </div>
            
            <!-- Mobile Header -->
            <div v-if="cocState.gameState !== 'playing'" class="md:hidden min-h-14 py-2 bg-dark-900 border-b border-dark-800 flex items-center justify-between px-4 z-10 flex-shrink-0 safe-pt">
                <button @click="showMobileMenu = !showMobileMenu" class="text-slate-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <div class="font-bold text-mystic-gold font-serif tracking-wider truncate mx-2">{{ getPageTitle() }}</div>
                <div class="w-6"></div> <!-- Spacer -->
            </div>

            <!-- Views -->
            
            <!-- 1. Chat View (New) -->
            <div v-if="currentView === 'chat'" class="flex-1 flex flex-col h-full bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                <div v-if="cocState.gameState !== 'playing'" class="flex-1 flex items-center justify-center text-slate-500 font-serif italic">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 text-dark-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        <p>暂无进行中的跑团会话</p>
                        <button @click="currentView = 'coc'" class="mt-4 px-4 py-2 bg-dark-800 border border-dark-600 rounded hover:border-mystic-gold hover:text-mystic-gold transition-colors text-sm">前往开始跑团</button>
                    </div>
                </div>
                <div v-else class="flex-1 flex flex-col h-full overflow-hidden relative">
                        <!-- Game Header -->
                        <div class="min-h-16 py-2 bg-dark-950/80 backdrop-blur-md border-b border-dark-800 flex items-center justify-between px-4 md:px-6 z-10 shadow-2xl flex-shrink-0 relative safe-pt">
                            <div class="absolute inset-0 bg-gradient-to-r from-mystic-gold/5 via-transparent to-transparent pointer-events-none"></div>
                            <div class="flex items-center gap-4 overflow-hidden relative z-10">
                                <button @click="showMobileMenu = !showMobileMenu" class="md:hidden text-slate-400 flex-shrink-0 hover:text-mystic-gold transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                                </button>
                                <div class="flex flex-col">
                                    <div class="text-[10px] text-mystic-gold/60 uppercase tracking-[0.2em] font-bold">当前模组</div>
                                    <div class="font-bold text-mystic-gold truncate max-w-[200px] md:max-w-[400px] font-serif tracking-wide text-lg text-shadow-gold">{{ cocState.module?.name || '未命名模组' }}</div>
                                </div>
                                <!-- Player Preview (Top Bar) -->
                                <div v-if="cocState.mode === 'multi' && multiplayerState.members.length > 0" class="hidden md:flex items-center -space-x-2 ml-6 border-l border-dark-700 pl-6 py-1">
                                    <div v-for="member in multiplayerState.members" :key="member.id"
                                         class="w-8 h-8 rounded-full border-2 bg-dark-800 overflow-hidden relative group cursor-help transition-all z-0 hover:z-10 hover:scale-110"
                                         :class="member.isHost ? 'border-mystic-gold shadow-[0_0_8px_rgba(212,175,55,0.6)] z-10' : 'border-slate-400'"
                                         :title="member.name + (member.isHost ? ' (房主)' : '')">
                                        <img v-if="member.avatar" :src="member.avatar" class="w-full h-full object-cover">
                                        <div v-else class="w-full h-full flex items-center justify-center text-xs font-bold text-slate-500">{{ member.name.charAt(0) }}</div>
                                        <!-- Status Dot -->
                                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full border-2 border-dark-950"
                                             :class="member.isReady || member.isHost ? 'bg-mystic-green' : 'bg-slate-500'"></div>
                                    </div>
                                    <div v-if="multiplayerState.members.length > 5" class="w-8 h-8 rounded-full border-2 border-slate-400 bg-dark-800 flex items-center justify-center text-[10px] text-slate-400 font-bold">
                                        +{{ multiplayerState.members.length - 5 }}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 relative z-10">
                                <!-- Room ID Display (Multiplayer Only) -->
                                <div v-if="cocState.mode === 'multi'" class="hidden md:flex items-center gap-2 mr-2 px-3 py-1.5 rounded border border-dark-700 bg-dark-900/50 cursor-pointer hover:bg-dark-800 hover:border-mystic-gold/30 transition-all group" @click="copyToClipboard(multiplayerState.roomId)" title="点击复制房间号">
                                    <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">房间号</span>
                                    <span class="text-xs text-mystic-gold font-mono font-bold">{{ multiplayerState.roomId }}</span>
                                    <svg class="w-3 h-3 text-slate-600 group-hover:text-mystic-gold transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                </div>

                                <button @click="showMobileRightSidebar = !showMobileRightSidebar" class="md:hidden p-2 text-slate-400 hover:text-mystic-gold transition-colors rounded-lg border border-transparent hover:border-dark-700 hover:bg-dark-800">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                </button>
                                <button v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" @click="saveGame" class="group flex items-center gap-2 px-3 py-1.5 rounded border border-indigo-900/30 bg-indigo-900/10 hover:bg-indigo-900/20 hover:border-indigo-500/50 transition-all mr-2">
                                    <span class="text-[10px] text-indigo-400 group-hover:text-indigo-300 uppercase font-bold tracking-widest">保存</span>
                                    <svg class="w-3 h-3 text-indigo-500/70 group-hover:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                                </button>
                                <button @click="exitCocGame" class="group flex items-center gap-2 px-3 py-1.5 rounded border border-red-900/30 bg-red-900/10 hover:bg-red-900/20 hover:border-red-500/50 transition-all">
                                    <span class="text-[10px] text-red-400 group-hover:text-red-300 uppercase font-bold tracking-widest">退出</span>
                                    <svg class="w-3 h-3 text-red-500/70 group-hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                </button>
                            </div>
                        </div>
    
                        <div class="flex-1 flex overflow-hidden relative">
                            <!-- Chat Log -->
                            <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-4 custom-scrollbar scroll-smooth" ref="cocChatContainer">
                                <div v-for="(msg, index) in cocState.log" :key="index" class="flex w-full animate-message-in group" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                                    
                                    <!-- User Message -->
                                    <!-- User Message -->
                                    <div v-if="msg.role === 'user' || msg.role === 'whisper'" class="flex flex-row-reverse max-w-[90%] md:max-w-[80%] gap-2 md:gap-4 ml-auto mb-2">
                                        <div class="flex-shrink-0 mt-1">
                                            <div class="w-8 h-8 md:w-10 md:h-10 rounded bg-dark-800 overflow-hidden border border-slate-600 shadow-lg group-hover:border-mystic-gold/50 transition-colors">
                                                <img v-if="msg.avatar" :src="msg.avatar" class="w-full h-full object-cover">
                                                <div v-else class="w-full h-full flex items-center justify-center text-slate-500 font-bold text-xs md:text-sm font-serif">{{ (msg.name || 'P').charAt(0) }}</div>
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-end min-w-0">
                                            <div class="text-[10px] text-slate-500 mb-1 mr-1 font-mono tracking-wider uppercase opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-2">
                                                {{ msg.name }}
                                                <span v-if="msg.role === 'whisper'" class="text-purple-400 bg-purple-900/20 px-1 rounded text-[9px] border border-purple-900/30">私语</span>
                                            </div>
                                            <div class="px-3 py-2 md:px-4 md:py-3 rounded-2xl rounded-tr-none border shadow-xl relative overflow-hidden"
                                                 :class="msg.role === 'whisper' ? 'bg-purple-900/10 border-purple-500/20 text-purple-200' : 'bg-dark-800 border-dark-700 text-slate-200'">
                                                <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>
                                                <div class="markdown-body relative z-10" v-html="renderMarkdown(msg.content)"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Keeper Message -->
                                    <div v-else-if="msg.role === 'assistant'" class="flex max-w-[95%] md:max-w-[85%] gap-2 md:gap-4 mr-auto mb-2">
                                        <div class="flex-shrink-0 mt-1">
                                            <div class="w-8 h-8 md:w-10 md:h-10 rounded bg-dark-900 overflow-hidden border border-mystic-gold/30 shadow-[0_0_15px_rgba(204,164,59,0.15)]">
                                                <div class="w-full h-full flex items-center justify-center bg-dark-950 text-mystic-gold">
                                                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-start min-w-0">
                                            <div class="text-[10px] text-mystic-gold mb-1 ml-1 font-mono tracking-widest uppercase font-bold flex items-center gap-2">
                                                守密人 (Keeper)
                                                <span class="w-8 h-[1px] bg-mystic-gold/30"></span>
                                            </div>
                                            <div class="p-4 md:p-6 rounded-2xl rounded-tl-none bg-dark-900/80 border border-mystic-gold/20 text-slate-300 shadow-2xl relative overflow-hidden backdrop-blur-sm">
                                                <div class="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-mystic-gold/40 to-transparent"></div>
                                                
                                                <!-- CoT Rendering -->
                                                <div v-if="hasCot(msg.content)" class="cot-wrapper">
                                                    <div class="cot-header" @click="toggleCot(index)" :class="{ active: msg.showCot }">
                                                        <span class="flex items-center gap-2">
                                                            <svg class="w-3.5 h-3.5" :class="msg.showCot ? 'rotate-90' : ''" style="transition: transform 0.2s" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                                            阿撒托斯的低语 (Whispers of Azathoth)
                                                        </span>
                                                        <span class="text-[10px] opacity-50 font-mono">Forbidden Knowledge</span>
                                                    </div>
                                                    <div v-show="msg.showCot" class="cot-content markdown-body" v-html="renderMarkdown(getCotContent(msg.content))"></div>
                                                </div>

                                                <div class="markdown-body relative z-10 font-serif leading-loose" v-html="renderMarkdown(removeCot(msg.content))"></div>
                                                
                                                <!-- In-Bubble Loading Indicator -->
                                                <div v-if="isGenerating && index === cocState.log.length - 1 && !removeCot(msg.content)" class="typing-indicator py-1">
                                                    <span class="bg-mystic-gold/60"></span>
                                                    <span class="bg-mystic-gold/60"></span>
                                                    <span class="bg-mystic-gold/60"></span>
                                                </div>
                                            </div>
                                            
                                            <!-- Regenerate Button (Attached to Bubble) -->
                                            <div v-if="index === lastAssistantIndex && (cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)) && !isGenerating" class="mt-2 animate-fade-in">
                                                <button @click="regenerateLastResponse" class="flex items-center gap-1.5 px-3 py-1 bg-dark-800/80 border border-mystic-gold/30 rounded-full text-[10px] text-mystic-gold hover:bg-mystic-gold hover:text-dark-900 transition-all shadow-lg backdrop-blur-sm group opacity-80 hover:opacity-100">
                                                    <svg class="w-3 h-3 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                                    回溯/重新生成
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- System Message -->
                                    <div v-else class="flex w-full justify-center my-2">
                                        <div class="bg-dark-950/80 border border-dark-800 px-4 py-2 rounded text-xs text-slate-500 font-mono flex items-center gap-3 shadow-inner max-w-[90%]">
                                            <span class="w-1.5 h-1.5 rounded-full bg-slate-600"></span>
                                            <div class="markdown-body !text-xs !text-slate-500" v-html="renderMarkdown(msg.content)"></div>
                                        </div>
                                    </div>

                                </div>
                                
                                <div v-if="isGenerating && cocState.log[cocState.log.length-1]?.role !== 'assistant'" class="flex w-full justify-start animate-message-in gap-2 md:gap-4 mr-auto mb-2">
                                    <!-- Keeper Avatar for Loading State -->
                                    <div class="flex-shrink-0 mt-1">
                                        <div class="w-8 h-8 md:w-10 md:h-10 rounded bg-dark-900 overflow-hidden border border-mystic-gold/30 shadow-[0_0_15px_rgba(204,164,59,0.15)]">
                                            <div class="w-full h-full flex items-center justify-center bg-dark-950 text-mystic-gold">
                                                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-start min-w-0">
                                        <div class="text-[10px] text-mystic-gold mb-1 ml-1 font-mono tracking-widest uppercase font-bold flex items-center gap-2">
                                            守密人 (Keeper)
                                            <span class="w-8 h-[1px] bg-mystic-gold/30"></span>
                                        </div>
                                        <div class="px-6 py-4 rounded-2xl rounded-tl-none bg-dark-900/50 border border-dark-700/50 shadow-inner flex items-center justify-center">
                                            <div class="typing-indicator">
                                                <span></span>
                                                <span></span>
                                                <span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
    
                            <!-- Mobile Right Sidebar Overlay -->
                            <div v-if="showMobileRightSidebar" @click="showMobileRightSidebar = false" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-20 md:hidden transition-opacity"></div>

                            <!-- Sidebar Info (Desktop & Mobile) -->
                            <div :class="['fixed inset-y-0 right-0 z-30 w-72 bg-dark-900 border-l border-dark-800 transform transition-transform duration-300 md:relative md:translate-x-0 flex flex-col shadow-2xl md:shadow-none overflow-y-auto safe-pb', showMobileRightSidebar ? 'translate-x-0' : 'translate-x-full']">
                                <div v-if="cocState.activeInvestigatorIndex !== -1 && cocState.investigators[cocState.activeInvestigatorIndex]" class="p-5">
                                    <div class="flex flex-col items-center mb-6 relative">
                                        <div class="w-20 h-20 rounded bg-dark-800 overflow-hidden mb-3 border-2 border-dark-700 shadow-xl">
                                            <img v-if="cocState.investigators[cocState.activeInvestigatorIndex].avatar" :src="cocState.investigators[cocState.activeInvestigatorIndex].avatar" class="w-full h-full object-cover">
                                            <div v-else class="w-full h-full flex items-center justify-center text-2xl font-bold text-dark-600 font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].name.charAt(0) }}</div>
                                        </div>
                                        <div class="font-bold text-lg font-serif text-mystic-gold">{{ cocState.investigators[cocState.activeInvestigatorIndex].name }}</div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 text-center mb-6">
                                        <div class="bg-red-900/10 p-2 rounded border border-red-900/20"><div class="text-[10px] text-red-500/70 tracking-widest mb-1">HP</div><div class="font-bold text-red-500 text-lg font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].hp }}</div></div>
                                        <div class="bg-blue-900/10 p-2 rounded border border-blue-900/20"><div class="text-[10px] text-blue-500/70 tracking-widest mb-1">MP</div><div class="font-bold text-blue-500 text-lg font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].mp }}</div></div>
                                        <div class="bg-purple-900/10 p-2 rounded border border-purple-900/20"><div class="text-[10px] text-purple-500/70 tracking-widest mb-1">SAN</div><div class="font-bold text-purple-500 text-lg font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].san }}</div></div>
                                    </div>
    
                                    <!-- Stats -->
                                    <div class="mb-6" v-if="cocState.investigators[cocState.activeInvestigatorIndex].stats">
                                        <h4 class="font-bold text-slate-500 text-[10px] mb-3 border-b border-dark-800 pb-1 uppercase tracking-widest">基础属性</h4>
                                        <div class="grid grid-cols-4 gap-2">
                                            <div v-for="(val, key) in cocState.investigators[cocState.activeInvestigatorIndex].stats" :key="key"
                                                 class="bg-dark-800 p-1.5 rounded text-center cursor-pointer hover:bg-mystic-gold/10 hover:text-mystic-gold transition-colors border border-transparent hover:border-mystic-gold/30"
                                                 @click="cocInput = `.ra ${key}`" title="点击检定">
                                                <div class="text-[10px] text-slate-500 uppercase font-bold mb-0.5">{{ statDisplayMap[key] || key }}</div>
                                                <div class="font-bold text-sm text-slate-300 font-mono">{{val}}</div>
                                            </div>
                                        </div>
                                    </div>
    
                                    <!-- Skills -->
                                    <div class="mb-6" v-if="cocState.investigators[cocState.activeInvestigatorIndex].skills">
                                        <h4 class="font-bold text-slate-500 text-[10px] mb-3 border-b border-dark-800 pb-1 uppercase tracking-widest">技能列表</h4>
                                        <div class="flex flex-wrap gap-1.5 max-h-60 overflow-y-auto custom-scrollbar pr-1">
                                            <span v-for="skill in cocState.investigators[cocState.activeInvestigatorIndex].skills.filter(s => s.value > 0)" :key="skill.name"
                                                  class="px-2 py-1 bg-dark-800 rounded text-xs text-slate-400 border border-dark-700 cursor-pointer hover:bg-mystic-green/10 hover:text-mystic-green hover:border-mystic-green/30 transition-colors select-none"
                                                  @click="cocInput = `.ra ${skill.name}`" title="点击检定">
                                                {{ skill.name }} <span class="font-bold text-slate-300 ml-1">{{ skill.value }}</span>
                                            </span>
                                        </div>
                                    </div>
    
                                    <div class="text-xs text-slate-600 border-t border-dark-800 pt-3 font-mono leading-relaxed">
                                        <div class="mb-1 text-dark-500 uppercase text-[10px] font-bold">常用指令:</div>
                                        <code class="bg-dark-800 px-1 py-0.5 rounded text-slate-400 cursor-pointer hover:text-slate-200" @click="cocInput = '.r 1d100'">.r 1d100</code>
                                        <code class="bg-dark-800 px-1 py-0.5 rounded text-slate-400 cursor-pointer hover:text-slate-200" @click="cocInput = '.sc 1/1d6'">.sc 1/1d6</code>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Input -->
                        <div class="p-4 bg-dark-900 border-t border-dark-800 z-20 relative safe-pb">
                            <!-- Mention Auto-complete List -->
                            <div v-if="showMentionList && mentionCandidates.length > 0" class="absolute bottom-full left-4 mb-2 w-64 bg-dark-800 border border-dark-600 rounded-lg shadow-2xl overflow-hidden z-50 animate-fade-in">
                                <div class="text-[10px] bg-dark-900 px-3 py-1 text-slate-500 uppercase tracking-widest font-bold border-b border-dark-700">提及 (Mention)</div>
                                <div class="max-h-48 overflow-y-auto custom-scrollbar">
                                    <div v-for="(candidate, idx) in mentionCandidates" :key="idx"
                                         @click="selectMention(candidate)"
                                         class="px-3 py-2 flex items-center gap-3 hover:bg-mystic-gold/10 cursor-pointer transition-colors group border-b border-dark-700/50 last:border-0">
                                        <div class="w-6 h-6 rounded bg-dark-700 overflow-hidden flex-shrink-0 border border-dark-600 group-hover:border-mystic-gold/50">
                                            <img v-if="candidate.avatar" :src="candidate.avatar" class="w-full h-full object-cover">
                                            <div v-else class="w-full h-full flex items-center justify-center text-[10px] font-bold text-slate-500">{{ candidate.name.charAt(0) }}</div>
                                        </div>
                                        <div class="flex flex-col min-w-0">
                                            <span class="text-sm font-bold text-slate-300 group-hover:text-mystic-gold truncate">{{ candidate.name }}</span>
                                            <span class="text-[10px] text-slate-500 truncate">{{ candidate.type === 'character' ? '角色' : '玩家' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="max-w-4xl mx-auto flex gap-3">
                                <textarea v-model="cocInput"
                                          ref="cocInputRef"
                                          @input="handleInput"
                                          @keydown.enter.prevent="sendCocMessage"
                                          @keydown.esc="showMentionList = false"
                                          :placeholder="cocState.mode === 'multi' && multiplayerState.roundActionIds.includes(user.uuid) ? '本轮已行动，等待其他玩家...' : '你的行动...'"
                                          :disabled="cocState.mode === 'multi' && multiplayerState.roundActionIds.includes(user.uuid)"
                                          class="flex-1 bg-dark-800 rounded-lg px-4 py-3 resize-none border border-dark-700 focus:ring-1 focus:ring-mystic-gold focus:border-mystic-gold focus:bg-dark-900 text-slate-200 placeholder-slate-600 transition-all h-[56px] custom-scrollbar disabled:opacity-50 disabled:cursor-not-allowed"></textarea>
                                <button @click="sendCocMessage"
                                        :disabled="!cocInput.trim() || isGenerating || (cocState.mode === 'multi' && multiplayerState.roundActionIds.includes(user.uuid))"
                                        class="w-[56px] h-[56px] bg-dark-800 hover:bg-mystic-gold hover:text-dark-950 text-mystic-gold border border-mystic-gold/50 rounded-lg flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed transition-all shadow-lg group">
                                    <svg class="w-6 h-6 transform rotate-90 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- 2. COC Mode Selection View -->
            <div v-if="currentView === 'coc'" class="flex-1 flex flex-col overflow-hidden relative">
                <div class="flex-1 overflow-y-auto p-4 md:p-8 flex items-center justify-center animate-fade-in">
                    <div class="max-w-5xl w-full">
                        <h2 class="text-3xl md:text-4xl font-bold text-mystic-gold mb-10 text-center tracking-wider font-serif">选择你的命运</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div @click="selectCocMode('single')" class="group glass-panel p-8 rounded border border-dark-700 hover:border-mystic-gold hover:bg-dark-800/50 transition-all cursor-pointer relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <svg class="w-32 h-32 text-mystic-gold" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
                                </div>
                                <div class="relative z-10">
                                    <div class="w-16 h-16 bg-dark-900 text-mystic-gold border border-dark-700 rounded flex items-center justify-center mb-6 shadow-lg group-hover:shadow-mystic-gold/20 transition-shadow">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    </div>
                                    <h3 class="text-2xl font-bold mb-3 text-slate-200 group-hover:text-mystic-gold transition-colors font-serif">单人模式</h3>
                                    <p class="text-slate-500 text-sm leading-relaxed">独自面对未知的恐惧。由 AI 担任 Keeper (守密人)，为你编织一场专属的噩梦。</p>
                                </div>
                            </div>
                            <div @click="selectCocMode('multi')" class="group glass-panel p-8 rounded border border-dark-700 hover:border-mystic-green hover:bg-dark-800/50 transition-all cursor-pointer relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <svg class="w-32 h-32 text-mystic-green" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                                </div>
                                <div class="relative z-10">
                                    <div class="w-16 h-16 bg-dark-900 text-mystic-green border border-dark-700 rounded flex items-center justify-center mb-6 shadow-lg group-hover:shadow-mystic-green/20 transition-shadow">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    </div>
                                    <h3 class="text-2xl font-bold mb-3 text-slate-200 group-hover:text-mystic-green transition-colors font-serif">多人联机</h3>
                                    <p class="text-slate-500 text-sm leading-relaxed">与调查员同伴们组队。需先在“多人联机”页面建立连接。</p>
                                    <div class="mt-4 inline-flex items-center text-xs font-bold px-3 py-1 rounded border" :class="multiplayerState.inRoom ? 'bg-mystic-green/10 text-mystic-green border-mystic-green/30' : 'bg-red-900/10 text-red-400 border-red-900/30'">
                                        {{ multiplayerState.inRoom ? `已连接: ${multiplayerState.roomId}` : '未连接房间' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Preparing View (Shared for Single/Multi) -->
            <div v-if="currentView === 'preparing'" class="flex-1 overflow-y-auto p-4 md:p-6 animate-fade-in">
                <div class="flex items-center mb-8 border-b border-dark-800 pb-4">
                    <button @click="exitCocMode" class="mr-4 p-2 bg-dark-800 border border-dark-700 rounded text-slate-400 hover:text-slate-200 hover:border-slate-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <h2 class="text-2xl font-bold text-mystic-gold font-serif">跑团准备</h2>
                </div>

                <div class="max-w-4xl mx-auto space-y-8">
                    <!-- Module (Host Only in Multi) -->
                    <div class="glass-panel p-6 rounded-lg">
                        <h3 class="font-bold text-slate-200 mb-6 flex items-center font-serif text-lg">
                            <span class="w-1 h-6 bg-mystic-gold mr-3"></span>
                            模组档案
                        </h3>
                        
                        <!-- Host or Single Mode -->
                        <div v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)">
                            <div v-if="!cocState.module" class="flex flex-col gap-6">
                                <label class="w-full h-48 border border-dashed border-slate-600 hover:border-mystic-gold bg-dark-900/30 hover:bg-dark-800/50 rounded-lg cursor-pointer flex flex-col items-center justify-center text-slate-400 transition-all group relative overflow-hidden">
                                    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')] opacity-20"></div>
                                    <svg class="w-12 h-12 mb-4 text-slate-600 group-hover:text-mystic-gold transition-colors transform group-hover:scale-110 duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    <span class="font-serif text-lg tracking-widest group-hover:text-mystic-gold transition-colors">导入模组档案</span>
                                    <span class="text-xs text-slate-600 mt-2 font-mono">(.txt, .md, .docx, .json)</span>
                                    <input type="file" accept=".json,.txt,.md,.docx,.doc" @change="importCocModule" class="hidden">
                                </label>
                                
                                <div class="relative flex items-center py-2">
                                    <div class="flex-grow border-t border-dark-700"></div>
                                    <span class="flex-shrink-0 mx-4 text-slate-600 text-xs font-serif tracking-widest uppercase">或</span>
                                    <div class="flex-grow border-t border-dark-700"></div>
                                </div>
    
                                <div class="relative group">
                                    <textarea v-model="cocState.tempModuleText" placeholder="在此粘贴模组内容..." class="w-full h-40 p-6 rounded-lg bg-dark-900/50 border border-dark-700 text-sm text-slate-300 focus:border-mystic-gold/50 focus:bg-dark-900 focus:ring-1 focus:ring-mystic-gold/50 outline-none resize-none font-serif leading-relaxed transition-all placeholder-slate-700"></textarea>
                                    <div class="absolute bottom-4 right-4">
                                        <button @click="saveManualModule" :disabled="!cocState.tempModuleText" class="px-6 py-2 bg-dark-800 text-mystic-gold border border-mystic-gold/30 hover:bg-mystic-gold hover:text-dark-900 rounded transition-all font-bold disabled:opacity-0 disabled:cursor-not-allowed text-sm tracking-widest uppercase shadow-lg hover:shadow-mystic-gold/20">
                                            确认录入
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="bg-dark-800/50 p-5 rounded border border-dark-700 flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-mystic-gold text-lg font-serif mb-1">{{ cocState.module.name }}</h4>
                                    <p class="text-xs text-slate-500 font-mono">{{ cocState.module.content.length }} chars</p>
                                </div>
                                <button @click="cocState.module = null" class="text-dark-400 hover:text-red-500 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Guest in Multi Mode -->
                        <div v-else class="text-center py-8 border border-dark-800 border-dashed rounded bg-dark-900/30">
                            <div v-if="cocState.module" class="text-mystic-gold font-bold font-serif text-xl">{{ cocState.module.name }}</div>
                            <div v-else class="text-slate-500 italic">等待房主选择模组...</div>
                        </div>
                    </div>

                    <!-- Investigators -->
                    <div class="glass-panel p-6 rounded-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none">
                            <svg class="w-40 h-40 text-mystic-green" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                        </div>
                        <div class="flex justify-between items-center mb-6 relative z-10">
                            <h3 class="font-bold text-slate-200 flex items-center font-serif text-lg">
                                <span class="w-1 h-6 bg-mystic-green mr-3 shadow-[0_0_10px_rgba(45,106,79,0.5)]"></span>
                                调查员名册
                            </h3>
                            
                            <div v-if="cocState.mode === 'multi' && multiplayerState.members.length > 0" class="flex-1 flex items-center justify-center gap-4 mx-4">
                                <div class="text-center text-xs font-bold uppercase tracking-wider">
                                    <span v-if="multiplayerState.members[multiplayerState.turnIndex]?.id === user.uuid" class="text-mystic-gold animate-pulse">
                                        当前轮次：轮到你了！请选择角色
                                    </span>
                                    <span v-else class="text-slate-500">
                                        当前轮次：等待 {{ multiplayerState.members[multiplayerState.turnIndex]?.name || 'Unknown' }} 选择...
                                    </span>
                                </div>
                            </div>

                            <label v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" class="text-xs px-4 py-2 bg-dark-800 hover:bg-mystic-green hover:text-dark-900 border border-dark-600 hover:border-mystic-green rounded cursor-pointer transition-all text-slate-300 font-bold uppercase tracking-wide shadow-lg">
                                导入 (.json/.png)
                                <input type="file" accept=".json,.png" @change="importInvestigator" class="hidden">
                            </label>
                        </div>
                        
                        <div v-if="cocState.investigators.length === 0" class="text-center py-12 text-slate-600 border border-dark-800 border-dashed rounded bg-dark-900/30 font-serif italic">
                            暂无调查员记录... 也许他们都已迷失在时空裂隙中。
                        </div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-4 relative z-10">
                            <div v-for="(inv, index) in cocState.investigators" :key="index"
                                    class="relative p-4 rounded border transition-all cursor-pointer flex gap-4 group overflow-hidden"
                                    :class="[
                                        cocState.activeInvestigatorIndex === index ? 'border-mystic-green bg-mystic-green/10 shadow-glow-green' : 'border-dark-700 bg-dark-800/40 hover:border-slate-500 hover:bg-dark-800',
                                        multiplayerState.assignments[index] && multiplayerState.assignments[index] !== user.uuid ? 'opacity-50' : ''
                                    ]"
                                    @click="handleInvestigatorClick(index)">
                                <div class="absolute inset-0 bg-gradient-to-r from-mystic-green/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="w-16 h-16 rounded bg-dark-900 flex-shrink-0 overflow-hidden border border-dark-600 group-hover:border-slate-400 transition-colors shadow-lg relative">
                                    <img v-if="inv.avatar" :src="inv.avatar" class="w-full h-full object-cover grayscale-[20%] group-hover:grayscale-0 transition-all duration-500">
                                    <div v-else class="w-full h-full flex items-center justify-center text-slate-600 font-serif font-bold text-2xl">{{ inv.name.charAt(0) }}</div>
                                </div>
                                <div class="flex-1 min-w-0 flex flex-col justify-center relative z-10">
                                    <div class="font-bold truncate text-slate-200 font-serif text-lg group-hover:text-mystic-green transition-colors">{{ inv.name }}</div>
                                    <div class="text-xs text-slate-500 flex gap-2 mt-1.5 font-mono">
                                        <span class="text-red-400 bg-red-900/20 px-1.5 py-0.5 rounded border border-red-900/30">HP: {{inv.hp}}</span>
                                        <span class="text-blue-400 bg-blue-900/20 px-1.5 py-0.5 rounded border border-blue-900/30">SAN: {{inv.san}}</span>
                                    </div>
                                    <!-- Assignment Status -->
                                    <div v-if="cocState.mode === 'multi'" class="mt-2 text-[10px] font-bold uppercase tracking-widest flex items-center gap-1">
                                        <template v-if="multiplayerState.assignments[index]">
                                            <span class="w-1.5 h-1.5 rounded-full" :class="multiplayerState.assignments[index] === user.uuid ? 'bg-mystic-green' : 'bg-slate-500'"></span>
                                            <span :class="multiplayerState.assignments[index] === user.uuid ? 'text-mystic-green' : 'text-slate-500'">
                                                {{ multiplayerState.assignments[index] === user.uuid ? '已选择 (你)' : '已被占用' }}
                                            </span>
                                        </template>
                                        <template v-else-if="multiplayerState.assignmentDetails && multiplayerState.assignmentDetails[index]">
                                            <span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span>
                                            <span class="text-yellow-500">
                                                等待归位: {{ multiplayerState.assignmentDetails[index].name }}
                                            </span>
                                        </template>
                                    </div>
                                </div>
                                <button v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" @click.stop="deleteInvestigator(index)" class="text-dark-600 hover:text-red-500 transition-colors self-start relative z-10 p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Ready Status (Multiplayer) -->
                    <div v-if="cocState.mode === 'multi'" class="glass-panel p-6 rounded-lg">
                        <h3 class="font-bold text-slate-200 mb-4 flex items-center font-serif text-lg">
                            <span class="w-1 h-6 bg-blue-500 mr-3"></span>
                            小队状态
                        </h3>
                        <div class="space-y-2">
                            <div v-for="member in multiplayerState.members" :key="member.id" class="flex items-center justify-between p-3 bg-dark-800/50 rounded border border-dark-700">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded bg-dark-700 flex items-center justify-center font-bold text-xs text-slate-500">{{ member.name.charAt(0) }}</div>
                                    <span class="font-serif text-slate-300">{{ member.name }}</span>
                                    <span v-if="member.isHost" class="text-[10px] bg-mystic-gold/10 text-mystic-gold border border-mystic-gold/20 px-2 py-0.5 rounded uppercase">房主</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span v-if="member.isReady" class="text-xs text-mystic-green font-bold flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        已准备
                                    </span>
                                    <span v-else class="text-xs text-slate-600 font-mono">准备中...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end pt-4 gap-4">
                        <button v-if="cocState.mode === 'multi' && !multiplayerState.isHost"
                                @click="toggleReady"
                                :class="['px-10 py-4 font-bold font-serif tracking-widest rounded shadow-lg transition-all border', multiplayerState.isReady ? 'bg-mystic-green/20 text-mystic-green border-mystic-green' : 'bg-dark-800 text-slate-400 border-dark-600 hover:bg-dark-700']">
                            {{ multiplayerState.isReady ? '已准备' : '准备就绪' }}
                        </button>
                        <button v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)"
                                @click="startCocGame"
                                :disabled="cocState.mode === 'multi' && !allPlayersReady"
                                class="px-10 py-4 bg-gradient-to-r from-mystic-green to-teal-900 text-teal-100 font-bold font-serif tracking-widest rounded shadow-lg hover:shadow-mystic-green/30 transition-all border border-mystic-green/50 disabled:opacity-50 disabled:cursor-not-allowed">
                            开始跑团
                        </button>
                    </div>
                </div>
            </div>
            <!-- 2. Settings View -->
            <div v-if="currentView === 'settings'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-2xl font-bold mb-8 text-mystic-gold font-serif">设置中心</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            
                            <!-- Left Column: User Profile -->
                            <div class="glass-panel p-8 rounded-lg shadow-xl h-fit">
                                <h3 class="font-bold text-lg mb-8 flex items-center text-slate-200 font-serif">
                                    <span class="w-1 h-5 bg-mystic-gold mr-3"></span>
                                    调查员档案
                                </h3>
                                
                                <div class="flex flex-col items-center mb-8">
                                    <div class="w-32 h-32 rounded-full overflow-hidden border-2 border-dark-600 shadow-2xl mb-4 relative group cursor-pointer ring-2 ring-transparent hover:ring-mystic-gold/50 transition-all" @click="$refs.avatarInput.click()">
                                        <img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 filter brightness-90 group-hover:brightness-100">
                                        <div v-else class="w-full h-full bg-dark-900 flex items-center justify-center text-5xl text-mystic-gold font-serif font-bold">
                                            {{ user.name.charAt(0).toUpperCase() }}
                                        </div>
                                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-[1px]">
                                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                        </div>
                                    </div>
                                    <input type="file" ref="avatarInput" @change="handleUserAvatarUpload" class="hidden" accept="image/*">
                                    <button @click="$refs.avatarInput.click()" class="text-xs tracking-widest text-mystic-gold font-bold hover:text-white bg-dark-800 border border-dark-600 hover:bg-dark-700 px-6 py-2 rounded transition-colors uppercase">更换头像</button>
                                </div>
                                
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-2 ml-1 uppercase tracking-widest">代号 (Codename)</label>
                                        <input v-model="user.name" @change="saveData" class="w-full bg-dark-900 border-dark-700 border rounded px-4 py-3 focus:ring-1 focus:ring-mystic-gold focus:bg-dark-800 focus:border-mystic-gold transition-all font-serif text-slate-200 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-2 ml-1 uppercase tracking-widest">身份标识 (UID)</label>
                                        <div class="relative group">
                                            <input :value="user.uuid" readonly class="w-full bg-dark-900 border-dark-700 border rounded px-4 py-3 text-sm font-mono text-slate-500 select-all outline-none">
                                            <button @click="copyToClipboard(user.uuid)" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-slate-600 hover:text-mystic-gold hover:bg-dark-800 rounded transition-all opacity-0 group-hover:opacity-100" title="复制 ID">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Right Column: System Settings -->
                            <div class="space-y-6">
                                <div class="glass-panel p-8 rounded-lg shadow-xl">
                                    <h3 class="font-bold text-lg mb-6 flex items-center text-slate-200 font-serif">
                                        <span class="w-1 h-5 bg-mystic-green mr-3"></span>
                                        LLM 通讯协议
                                    </h3>
                                    <div class="space-y-5">
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-2 ml-1 uppercase tracking-widest">API 地址 (Endpoint)</label>
                                            <input v-model="settings.apiUrl" @change="saveData" placeholder="https://api.example.com" class="w-full bg-dark-900 border-dark-700 border rounded px-4 py-3 focus:ring-1 focus:ring-mystic-green focus:bg-dark-800 focus:border-mystic-green transition-all outline-none text-slate-300 font-mono text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-2 ml-1 uppercase tracking-widest">密钥 (Key)</label>
                                            <input v-model="settings.apiKey" type="password" @change="saveData" placeholder="sk-..." class="w-full bg-dark-900 border-dark-700 border rounded px-4 py-3 focus:ring-1 focus:ring-mystic-green focus:bg-dark-800 focus:border-mystic-green transition-all outline-none font-mono text-sm text-slate-300">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-2 ml-1 uppercase tracking-widest">模型 ID (Model)</label>
                                            <input v-model="settings.model" @change="saveData" placeholder="gpt-4-turbo" class="w-full bg-dark-900 border-dark-700 border rounded px-4 py-3 focus:ring-1 focus:ring-mystic-green focus:bg-dark-800 focus:border-mystic-green transition-all outline-none font-mono text-sm text-slate-300">
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                    </div>
                </div>
            </div>

            <!-- 3. Multiplayer View -->
                <div v-if="currentView === 'multiplayer'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                    <h2 class="text-2xl font-bold mb-8 text-mystic-gold font-serif">多重宇宙连接</h2>
                    <div class="max-w-xl mx-auto glass-panel rounded-lg shadow-2xl p-8 border border-dark-700">
                        <div v-if="!multiplayerState.isConnected">
                            <h3 class="text-xl font-bold mb-6 text-center text-slate-200 font-serif">建立星之眷族连接</h3>
                            <div class="space-y-4">
                                <input v-model="settings.supabaseUrl" placeholder="Supabase 地址 (URL)" class="w-full bg-dark-900 border-dark-700 text-slate-300 border rounded px-4 py-3 font-mono text-sm focus:border-mystic-green focus:ring-1 focus:ring-mystic-green outline-none">
                                <input v-model="settings.supabaseKey" placeholder="Anon 密钥 (Key)" type="password" class="w-full bg-dark-900 border-dark-700 text-slate-300 border rounded px-4 py-3 font-mono text-sm focus:border-mystic-green focus:ring-1 focus:ring-mystic-green outline-none">
                                <button @click="initSupabase" class="w-full py-3 bg-dark-800 text-mystic-green border border-mystic-green/30 font-bold rounded hover:bg-mystic-green hover:text-dark-900 transition-all uppercase tracking-widest">启动协议</button>
                            </div>
                        </div>
                        <div v-else-if="!multiplayerState.inRoom">
                            <div class="text-center text-mystic-green font-bold mb-8 tracking-wide flex items-center justify-center gap-2">
                                <span class="w-2 h-2 bg-mystic-green rounded-full animate-pulse"></span>
                                连接已建立
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <button @click="createRoom" class="p-6 bg-dark-800 rounded border border-dark-600 hover:border-mystic-gold hover:bg-dark-700 transition-colors text-mystic-gold font-bold font-serif">创建仪式(房间)</button>
                                <button @click="showJoinInput = !showJoinInput" class="p-6 bg-dark-800 rounded border border-dark-600 hover:border-slate-400 hover:bg-dark-700 transition-colors text-slate-300 font-bold font-serif">加入仪式</button>
                            </div>
                            <div v-if="showJoinInput" class="flex gap-2 animate-fade-in">
                                <input v-model="joinRoomId" placeholder="仪式代码" class="flex-1 bg-dark-900 border border-dark-600 text-slate-200 rounded px-4 py-2 uppercase text-center font-mono focus:border-mystic-gold outline-none">
                                <button @click="joinRoom()" class="px-6 bg-mystic-gold text-dark-900 rounded font-bold hover:bg-yellow-600 transition-colors">进入</button>
                            </div>
                        </div>
                        <div v-else class="text-center space-y-8">
                            <div class="p-6 bg-dark-900/50 rounded border border-mystic-gold/30 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-1 bg-mystic-gold/50"></div>
                                <div class="text-xs text-mystic-gold/70 mb-2 uppercase tracking-widest">当前仪式 (房间号)</div>
                                <div @click="copyToClipboard(multiplayerState.roomId)" title="点击复制" class="text-4xl font-mono font-bold text-mystic-gold tracking-wider cursor-pointer hover:text-white transition-colors">{{ multiplayerState.roomId }}</div>
                                <div class="mt-3 inline-block px-3 py-1 text-[10px] font-bold uppercase tracking-widest border rounded" :class="multiplayerState.isHost ? 'text-yellow-500 border-yellow-500/30 bg-yellow-900/10' : 'text-slate-500 border-slate-700 bg-slate-900/30'">{{ multiplayerState.isHost ? '守密人 (房主)' : '调查员' }}</div>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-500 text-xs mb-4 uppercase tracking-widest border-b border-dark-700 pb-2">参与者名单</h4>
                                <div class="space-y-2">
                                    <div v-for="member in multiplayerState.members" :key="member.id" class="flex items-center p-3 bg-dark-800/50 border border-dark-700 rounded hover:border-dark-600 transition-colors">
                                        <div class="w-8 h-8 rounded bg-dark-700 flex-shrink-0 overflow-hidden border border-dark-600">
                                            <img v-if="member.avatar" :src="member.avatar" class="w-full h-full object-cover">
                                            <div v-else class="w-full h-full flex items-center justify-center font-bold text-xs text-slate-500">{{ member.name.charAt(0) }}</div>
                                        </div>
                                        <span class="ml-3 font-medium text-slate-300 font-serif">{{ member.name }}</span>
                                        <div class="ml-auto flex items-center gap-2">
                                            <span v-if="member.isReady" class="text-[10px] text-mystic-green font-bold border border-mystic-green/30 px-2 py-0.5 rounded uppercase tracking-wider">已准备</span>
                                            <span v-if="member.isHost" class="text-[10px] bg-mystic-gold/10 text-mystic-gold border border-mystic-gold/20 px-2 py-0.5 rounded uppercase tracking-wider">房主</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-4">
                                <button @click="leaveRoom" class="flex-1 py-3 border border-red-900/50 text-red-500/80 rounded font-bold hover:bg-red-900/10 hover:text-red-400 hover:border-red-900 transition-all uppercase tracking-widest text-xs">放弃仪式 (离开)</button>
                                <button v-if="!multiplayerState.isHost" @click="toggleReady" :class="['flex-1 py-3 border rounded font-bold transition-all uppercase tracking-widest text-xs', multiplayerState.isReady ? 'bg-mystic-green/20 text-mystic-green border-mystic-green' : 'bg-dark-800 text-slate-400 border-dark-600 hover:bg-dark-700']">
                                    {{ multiplayerState.isReady ? '已准备' : '准备就绪' }}
                                </button>
                                <!-- Host Start Button -->
                                <button v-if="multiplayerState.isHost" @click="selectCocMode('multi')"
                                        :disabled="!allPlayersReady"
                                        class="flex-1 py-3 bg-mystic-gold/10 text-mystic-gold border border-mystic-gold/30 rounded font-bold hover:bg-mystic-gold/20 transition-all uppercase tracking-widest text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                    开始准备
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
    
                <!-- 4. Saves View (Memory Corridor) -->
                <div v-if="currentView === 'saves'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                    <h2 class="text-2xl font-bold mb-8 text-indigo-400 font-serif flex items-center gap-3">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                        记忆回廊
                    </h2>
                    <div class="max-w-4xl mx-auto">
                        <div v-if="savedGames.length === 0" class="text-center py-20 border border-dashed border-dark-700 rounded-lg bg-dark-900/30">
                            <div class="text-slate-500 font-serif italic mb-4">这里空无一物，只有时间的尘埃...</div>
                            <button @click="currentView = 'coc'" class="px-6 py-2 bg-dark-800 text-mystic-gold border border-mystic-gold/30 rounded hover:bg-mystic-gold hover:text-dark-900 transition-all font-bold text-sm">开始新的旅程</button>
                        </div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div v-for="(save, index) in savedGames" :key="save.id" class="group relative bg-dark-900/80 border border-dark-700 rounded-lg overflow-hidden hover:border-indigo-500/50 transition-all shadow-lg">
                                <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500/30 group-hover:bg-indigo-500 transition-colors"></div>
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <div class="text-xs text-indigo-400 font-bold uppercase tracking-widest mb-1">{{ save.mode === 'multi' ? '多人联机' : '单人模式' }}</div>
                                            <h3 class="text-xl font-bold text-slate-200 font-serif truncate pr-4">{{ save.moduleName || '未命名篇章' }}</h3>
                                        </div>
                                        <button @click="deleteSave(index)" class="text-slate-600 hover:text-red-500 transition-colors p-1">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                    <div class="text-sm text-slate-500 font-mono mb-6 line-clamp-2 h-10">
                                        {{ save.lastMessage || '无记录...' }}
                                    </div>
                                    <div class="flex items-center justify-between mt-auto pt-4 border-t border-dark-800">
                                        <div class="text-xs text-slate-600 font-mono">{{ new Date(save.timestamp).toLocaleString() }}</div>
                                        <button @click="loadSave(index)" class="px-4 py-1.5 bg-indigo-900/20 text-indigo-400 border border-indigo-500/30 rounded hover:bg-indigo-500 hover:text-white transition-all text-xs font-bold uppercase tracking-wider">
                                            读取记忆
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    
                <!-- 5. Library View -->
                <div v-if="currentView === 'library'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                    <div class="max-w-6xl mx-auto">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h2 class="text-3xl font-bold text-purple-400 font-serif flex items-center gap-3">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
                                密斯卡托尼克大学图书馆
                            </h2>
                            <div class="flex gap-3 w-full md:w-auto">
                                <div class="relative flex-1 md:w-64">
                                    <input v-model="libraryState.searchQuery" @keyup.enter="fetchLibraryModules" placeholder="搜索典籍..." class="w-full bg-dark-900 border border-dark-700 rounded px-4 py-2 text-sm text-slate-300 focus:border-purple-500 outline-none">
                                    <button @click="fetchLibraryModules" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-purple-400">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    </button>
                                </div>
                                <button @click="libraryState.showUpload = true" class="px-4 py-2 bg-purple-900/20 text-purple-400 border border-purple-500/30 rounded hover:bg-purple-900/40 font-bold text-sm flex items-center gap-2 whitespace-nowrap">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    贡献藏书
                                </button>
                            </div>
                        </div>

                        <!-- Upload Modal -->
                        <!-- Upload Modal -->
                        <div v-if="libraryState.showUpload" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm safe-pt safe-pb">
                            <div class="bg-dark-900 border border-purple-500/30 rounded-lg shadow-2xl max-w-2xl w-full flex flex-col max-h-[90vh] md:max-h-[80vh]">
                                <div class="p-6 border-b border-dark-800 flex justify-between items-center flex-shrink-0">
                                    <h3 class="text-xl font-bold text-purple-400 font-serif flex items-center gap-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        贡献新模组
                                    </h3>
                                    <button @click="libraryState.showUpload = false" class="text-slate-500 hover:text-slate-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                </div>
                                <div class="p-6 overflow-y-auto space-y-5 custom-scrollbar">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">模组标题</label>
                                            <input v-model="libraryState.uploadForm.title" class="w-full bg-dark-950 border border-dark-700 rounded px-3 py-2 text-slate-300 focus:border-purple-500 outline-none transition-colors focus:ring-1 focus:ring-purple-500/50">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">来源类型</label>
                                            <div class="flex bg-dark-950 p-1 rounded border border-dark-700">
                                                <button @click="libraryState.uploadForm.type = 'original'" :class="['flex-1 py-1 text-xs rounded transition-all font-bold', libraryState.uploadForm.type === 'original' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300']">原创</button>
                                                <button @click="libraryState.uploadForm.type = 'reprint'" :class="['flex-1 py-1 text-xs rounded transition-all font-bold', libraryState.uploadForm.type === 'reprint' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300']">搬运</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider flex justify-between">
                                            简介
                                            <span v-if="libraryState.isSummarizing" class="text-purple-400 animate-pulse flex items-center gap-1 normal-case">
                                                <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                正在读取禁忌知识...
                                            </span>
                                        </label>
                                        <textarea v-model="libraryState.uploadForm.description" rows="3" :placeholder="libraryState.isSummarizing ? '正在生成摘要...' : '请输入简介或等待自动生成...'" class="w-full bg-dark-950 border border-dark-700 rounded px-3 py-2 text-slate-300 focus:border-purple-500 outline-none resize-none transition-colors focus:ring-1 focus:ring-purple-500/50" :disabled="libraryState.isSummarizing"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">模组内容</label>
                                        <div class="flex gap-4 mb-2">
                                            <button @click="libraryState.uploadType = 'text'" :class="['px-3 py-1 rounded text-xs border', libraryState.uploadType === 'text' ? 'bg-purple-900/30 border-purple-500 text-purple-300' : 'border-dark-700 text-slate-500']">直接粘贴</button>
                                            <button @click="libraryState.uploadType = 'file'" :class="['px-3 py-1 rounded text-xs border', libraryState.uploadType === 'file' ? 'bg-purple-900/30 border-purple-500 text-purple-300' : 'border-dark-700 text-slate-500']">文件上传</button>
                                        </div>
                                        <textarea v-if="libraryState.uploadType === 'text'" v-model="libraryState.uploadForm.content" rows="10" placeholder="在此粘贴模组正文..." class="w-full bg-dark-950 border border-dark-700 rounded px-3 py-2 text-slate-300 focus:border-purple-500 outline-none font-mono text-sm"></textarea>
                                        <div v-else class="h-40 border-2 border-dashed border-dark-700 rounded flex flex-col items-center justify-center text-slate-500 hover:border-purple-500 hover:text-purple-400 transition-colors cursor-pointer relative">
                                            <input type="file" accept=".txt,.md,.json,.docx" @change="handleLibraryFileUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                                            <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                            <span>点击或拖拽文件至此</span>
                                            <span class="text-xs mt-1" v-if="libraryState.uploadForm.content">已加载: {{ libraryState.uploadForm.content.length }} 字符</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6 border-t border-dark-800 flex justify-end gap-3">
                                    <button @click="libraryState.showUpload = false" class="px-4 py-2 text-slate-400 hover:text-slate-200">取消</button>
                                    <button @click="uploadToLibrary" :disabled="!libraryState.uploadForm.title || !libraryState.uploadForm.content || libraryState.isUploading" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                        <svg v-if="libraryState.isUploading" class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                        {{ libraryState.isUploading ? '正在入库...' : '确认入库' }}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- SQL Setup Modal -->
                        <div v-if="showSqlModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm safe-pt safe-pb">
                            <div class="bg-dark-900 border border-red-500/50 rounded-lg shadow-2xl max-w-2xl w-full flex flex-col max-h-[90vh] md:max-h-[80vh] animate-fade-in">
                                <div class="p-6 border-b border-dark-800 flex justify-between items-center bg-red-900/10 flex-shrink-0">
                                    <h3 class="text-xl font-bold text-red-400 font-serif flex items-center gap-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                        数据库未初始化
                                    </h3>
                                    <button @click="showSqlModal = false" class="text-slate-500 hover:text-slate-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                </div>
                                <div class="p-6 overflow-y-auto custom-scrollbar">
                                    <p class="text-slate-300 mb-4 text-sm leading-relaxed">
                                        检测到 Supabase 数据库缺少必要的表结构。这通常发生在首次连接新项目时。<br>
                                        请复制以下 SQL 语句，并在 Supabase 的 <a href="https://supabase.com/dashboard/project/_/sql" target="_blank" class="text-mystic-gold hover:underline">SQL Editor</a> 中运行以修复此问题：
                                    </p>
                                    <div class="relative group">
                                        <pre class="bg-dark-950 p-4 rounded border border-dark-700 text-xs font-mono text-slate-400 overflow-x-auto whitespace-pre-wrap select-all">{{ sqlToRun }}</pre>
                                        <button @click="copyToClipboard(sqlToRun)" class="absolute top-2 right-2 p-2 bg-dark-800 text-slate-400 hover:text-white rounded border border-dark-600 hover:border-mystic-gold transition-all" title="复制 SQL">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-6 border-t border-dark-800 flex justify-end">
                                    <button @click="showSqlModal = false" class="px-6 py-2 bg-dark-800 text-slate-300 hover:text-white border border-dark-600 rounded transition-colors">关闭</button>
                                </div>
                            </div>
                        </div>
                        <!-- Module List -->
                        <div v-if="libraryState.loading" class="text-center py-20 text-purple-400 animate-pulse">
                            正在从书架上取书...
                        </div>
                        <div v-else-if="libraryState.modules.length === 0" class="text-center py-20 border border-dashed border-dark-700 rounded bg-dark-900/30">
                            <div class="text-slate-500 font-serif italic mb-4">图书馆空空如也，也许你该贡献第一本藏书？</div>
                        </div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div v-for="mod in libraryState.modules" :key="mod.id" class="group relative bg-dark-900 border border-dark-700 rounded-lg overflow-hidden hover:border-purple-500/50 hover:shadow-[0_0_20px_rgba(168,85,247,0.15)] transition-all duration-300 flex flex-col transform hover:-translate-y-1">
                                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-600 to-blue-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="p-5 flex-1 relative">
                                    <!-- Background Pattern -->
                                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity pointer-events-none">
                                        <svg class="w-24 h-24 text-purple-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/></svg>
                                    </div>

                                    <div class="flex justify-between items-start mb-2 relative z-10">
                                        <div class="flex-1 mr-2">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span v-if="mod.type === 'reprint'" class="text-[10px] px-1.5 py-0.5 rounded bg-blue-900/30 text-blue-400 border border-blue-500/30 font-bold uppercase tracking-wider">搬运</span>
                                                <span v-else class="text-[10px] px-1.5 py-0.5 rounded bg-purple-900/30 text-purple-400 border border-purple-500/30 font-bold uppercase tracking-wider">原创</span>
                                                <span class="text-[10px] text-slate-600">{{ new Date(mod.created_at).toLocaleDateString() }}</span>
                                            </div>
                                            <h3 class="text-lg font-bold text-slate-200 font-serif line-clamp-1 group-hover:text-purple-400 transition-colors" :title="mod.title">{{ mod.title }}</h3>
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-500 mb-3 font-mono flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                        {{ mod.author_name || '佚名' }}
                                    </div>
                                    <p class="text-sm text-slate-400 line-clamp-3 mb-4 h-[4.5em] leading-relaxed relative z-10">{{ mod.description || '暂无简介...' }}</p>
                                    <div class="flex gap-4 text-xs text-slate-600 border-t border-dark-800 pt-3">
                                        <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg> {{ Math.ceil(mod.content.length / 1000) }}k 字</span>
                                        <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> {{ mod.downloads || 0 }}</span>
                                    </div>
                                </div>
                                <div class="p-4 border-t border-dark-800 bg-dark-950/30 flex gap-2">
                                    <button @click="useLibraryModule(mod, 'single')" class="flex-1 py-2 bg-dark-800 hover:bg-mystic-gold hover:text-dark-900 text-mystic-gold border border-mystic-gold/30 rounded text-xs font-bold transition-colors">
                                        单人跑团
                                    </button>
                                    <button @click="useLibraryModule(mod, 'multi')" class="flex-1 py-2 bg-dark-800 hover:bg-mystic-green hover:text-dark-900 text-mystic-green border border-mystic-green/30 rounded text-xs font-bold transition-colors">
                                        多人联机
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 6. Friends View -->
                <div v-if="currentView === 'friends'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                    <h2 class="text-2xl font-bold mb-8 text-mystic-gold font-serif">同伴名录</h2>
                    <div class="max-w-2xl mx-auto space-y-6">
                        <!-- My ID -->
                        <div class="glass-panel p-6 rounded-lg shadow-sm flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-slate-200 font-serif">{{ user.name }}</h3>
                                <p class="text-sm text-slate-500 font-mono select-all">UID: {{ user.uuid }}</p>
                            </div>
                            <div class="flex gap-2">
                                <input v-model="friendInput" placeholder="输入同伴 ID" class="bg-dark-900 border border-dark-600 text-slate-300 rounded px-3 py-1.5 text-sm focus:border-mystic-gold outline-none">
                                <button @click="addFriend" class="bg-dark-800 text-mystic-gold border border-mystic-gold/30 px-4 py-1.5 rounded text-sm font-bold hover:bg-mystic-gold hover:text-dark-900 transition-colors">添加</button>
                            </div>
                        </div>
                        <!-- Friend Requests -->
                        <div v-if="friendRequests.length > 0" class="space-y-2">
                            <h4 class="font-bold text-xs text-slate-500 uppercase tracking-widest mb-2">收到的信号</h4>
                            <div v-for="req in friendRequests" :key="req.id" class="bg-dark-800 p-4 rounded border border-mystic-gold/30 flex justify-between items-center">
                                <span class="font-bold text-slate-200 font-serif">{{ req.name }}</span>
                                <div class="flex gap-2">
                                    <button @click="acceptFriend(req)" class="px-3 py-1 text-xs bg-mystic-gold text-dark-900 rounded font-bold hover:bg-yellow-600">接受</button>
                                    <button @click="rejectFriend(req)" class="px-3 py-1 text-xs bg-dark-700 text-slate-400 rounded hover:bg-dark-600">拒绝</button>
                                </div>
                            </div>
                        </div>
                        <!-- List -->
                        <div class="space-y-3">
                            <div v-for="friend in friends" :key="friend.uuid" class="glass-panel p-4 rounded border border-dark-700 flex justify-between items-center hover:border-slate-600 transition-colors">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded bg-dark-800 overflow-hidden relative border border-dark-600">
                                        <img v-if="friend.avatar" :src="friend.avatar" class="w-full h-full object-cover">
                                        <div v-if="friend.isOnline" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-mystic-green border border-dark-900 rounded-full shadow-[0_0_8px_rgba(45,212,191,0.8)]"></div>
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-200 font-serif">{{ friend.name }}</div>
                                        <div class="text-xs font-mono" :class="friend.isOnline ? 'text-mystic-green' : 'text-slate-600'">{{ friend.isOnline ? '在线' : '离线' }}</div>
                                    </div>
                                </div>
                                <button v-if="friend.isOnline" @click="inviteFriend(friend)" class="px-3 py-1.5 bg-dark-800 text-slate-300 border border-dark-600 rounded text-xs font-bold hover:text-mystic-gold hover:border-mystic-gold transition-colors uppercase tracking-wider">邀请</button>
                            </div>
                            <div v-if="friends.length === 0" class="text-center py-12 text-slate-600 border border-dashed border-dark-800 rounded bg-dark-900/20 font-serif italic">孤独是理智的最后防线...</div>
                        </div>
                    </div>
                </div>

        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, watch, nextTick } = Vue;

        // Marked Config
        marked.use({ breaks: true });

        createApp({
            setup() {
                // --- Constants & Utilities ---
                const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });

                // PNG Parsing Utility to extract embedded text chunks (tEXt)
                const extractPngData = async (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const buffer = e.target.result;
                                const view = new DataView(buffer);
                                let offset = 8; // Skip PNG Signature
                                
                                while (offset < view.byteLength) {
                                    const length = view.getUint32(offset);
                                    const type = String.fromCharCode(view.getUint8(offset+4), view.getUint8(offset+5), view.getUint8(offset+6), view.getUint8(offset+7));
                                    
                                    if (type === 'tEXt') {
                                        const dataStart = offset + 8;
                                        const chunkData = new Uint8Array(buffer, dataStart, length);
                                        
                                        // Find null separator
                                        let nullIdx = -1;
                                        for(let i=0; i<chunkData.length; i++) {
                                            if(chunkData[i] === 0) { nullIdx = i; break; }
                                        }
                                        
                                        if (nullIdx > -1) {
                                            const keywordDecoder = new TextDecoder('iso-8859-1');
                                            const keyword = keywordDecoder.decode(chunkData.slice(0, nullIdx));
                                            
                                            const textBytes = chunkData.slice(nullIdx + 1);
                                            const textDecoder = new TextDecoder('utf-8');
                                            const text = textDecoder.decode(textBytes);

                                            console.log('[PNG Parser] Found chunk:', keyword);

                                            let jsonStr = text;

                                            // Special handling for 'coc_data' which uses Base64
                                            if (keyword === 'coc_data') {
                                                try {
                                                    // decodeURIComponent(escape(window.atob(str))) handles UTF-8 in Base64
                                                    jsonStr = decodeURIComponent(escape(window.atob(text)));
                                                    console.log('[PNG Parser] Decoded Base64 coc_data');
                                                } catch (e) {
                                                    console.warn('[PNG Parser] Base64 decode failed, using raw text:', e);
                                                }
                                            }

                                            // Try to find JSON content
                                            try {
                                                // Handle potential URL encoding
                                                if (jsonStr.includes('%7B')) {
                                                    try { jsonStr = decodeURIComponent(jsonStr); } catch(e){}
                                                }
                                                
                                                const firstBrace = jsonStr.indexOf('{');
                                                const lastBrace = jsonStr.lastIndexOf('}');
                                                if (firstBrace !== -1 && lastBrace !== -1) {
                                                    const cleanJson = jsonStr.substring(firstBrace, lastBrace + 1);
                                                    const obj = JSON.parse(cleanJson);
                                                    // Basic validation for COC card
                                                    if (obj.name || obj.stats || obj.skills) {
                                                        console.log('[PNG Parser] Successfully extracted data for:', obj.name);
                                                        resolve(obj);
                                                        return;
                                                    }
                                                }
                                            } catch(e) {
                                                // console.debug('[PNG Parser] JSON parse failed for chunk content');
                                            }
                                        }
                                    }
                                    offset += 12 + length; // Length + Type(4) + Data + CRC(4)
                                }
                                console.log('[PNG Parser] No valid COC data found in PNG chunks');
                                resolve(null);
                            } catch (err) {
                                console.error('PNG Parse Error:', err);
                                resolve(null);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    });
                };

                const compressImage = (source, maxWidth = 300, quality = 0.7) => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.src = source;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width, height = img.height;
                            if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, width, height); ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = () => resolve(source);
                    });
                };

                // --- State ---
                const currentView = ref('coc');
                const showMobileMenu = ref(false);
                const showMobileRightSidebar = ref(false);
                const toasts = ref([]);
                // Confirm Modal State
                const confirmState = reactive({
                    show: false,
                    title: '',
                    message: '',
                    confirmText: '确定',
                    cancelText: '取消',
                    resolve: null
                });

                const showConfirm = (message, title = '确认操作') => {
                    return new Promise((resolve) => {
                        confirmState.message = message;
                        confirmState.title = title;
                        confirmState.show = true;
                        confirmState.resolve = resolve;
                    });
                };

                const user = reactive({ name: '游客', avatar: '', uuid: generateUUID() });
                const settings = reactive({
                    apiUrl: 'https://opis.zeabur.app',
                    apiKey: 'sk-8PZs39TSK9Jde8dpD2IIrJxyAnJQUot7pskCbA4WlyFAwVJd',
                    model: 'gemini-3-pro-preview-maxthinking',
                    supabaseUrl: 'https://ghswjgxrblpdklukxjnq.supabase.co',
                    supabaseKey: 'sb_publishable_rIc2MYg6kaGIQcddDgVKYw_uLkWaY4E',
                    temperature: 1.0
                });

                // COC State
                const statDisplayMap = {
                    STR: '力量', CON: '体质', SIZ: '体型', DEX: '敏捷',
                    APP: '外貌', INT: '智力', POW: '意志', EDU: '教育',
                    LUCK: '幸运'
                };

                const cocState = reactive({
                    mode: null,
                    module: null,
                    tempModuleText: '',
                    investigators: [],
                    activeInvestigatorIndex: -1,
                    gameState: 'idle',
                    log: [],
                    systemPrompt: '',
                    pendingRolls: [] // 待处理的检定列表 [{ target: 'Name', command: 'ra', args: '侦查' }]
                });

                const lastAssistantIndex = Vue.computed(() => {
                    let idx = -1;
                    for (let i = 0; i < cocState.log.length; i++) {
                        if (cocState.log[i].role === 'assistant') idx = i;
                    }
                    return idx;
                });

                // CoT Helpers
                // Helper to clear assignments for a specific user
                const clearUserAssignments = (userId) => {
                    Object.keys(multiplayerState.assignments).forEach(key => {
                        if (multiplayerState.assignments[key] === userId) {
                            delete multiplayerState.assignments[key];
                        }
                    });
                };

                const hasCot = (text) => text && (text.includes('<cot>') || text.includes('<cot'));
                const getCotContent = (text) => {
                    if (!text) return '';
                    // 匹配完整闭合的 <cot>...</cot> 或 <cot>...<cot>
                    const match = text.match(/<cot>([\s\S]*?)(?:<\/cot>|<cot>|$)/);
                    if (match) return match[1];
                    // 处理流式输出中未闭合的情况
                    if (text.includes('<cot>')) {
                        return text.split('<cot>')[1];
                    }
                    return '';
                };
                const removeCot = (text) => {
                    if (!text) return '';
                    // 移除完整闭合的标签
                    let clean = text.replace(/<cot>[\s\S]*?(?:<\/cot>|<cot>)/g, '').trim();
                    // 如果还有未闭合的 <cot> (流式输出中)，则移除 <cot> 之后的所有内容
                    if (clean.includes('<cot>')) {
                        clean = clean.split('<cot>')[0].trim();
                    }
                    return clean;
                };
                const toggleCot = async (index) => {
                    // Multiplayer Permission Check
                    if (cocState.mode === 'multi' && !multiplayerState.isHost) {
                        if (!multiplayerState.cotAuthorizedUsers.includes(user.uuid)) {
                            if (await showConfirm('您没有权限查看思维链 (CoT)。是否向房主申请权限？', '申请权限')) {
                                requestCotAccess();
                            }
                            return;
                        }
                    }
                    const msg = cocState.log[index];
                    if (msg) {
                        msg.showCot = !msg.showCot;
                    }
                };

                const requestCotAccess = () => {
                    if (!multiplayerState.inRoom) return;
                    broadcastMessage({ type: 'request_cot_access', userId: user.uuid, userName: user.name });
                    showToast('已发送权限申请', 'info');
                };

                const grantCotAccess = (targetUserId) => {
                    if (!multiplayerState.cotAuthorizedUsers.includes(targetUserId)) {
                        multiplayerState.cotAuthorizedUsers.push(targetUserId);
                        broadcastMessage({ type: 'grant_cot_access', userId: targetUserId, authorizedUsers: multiplayerState.cotAuthorizedUsers });
                        showToast('已授权查看 CoT', 'success');
                    }
                };

                const regenerateLastResponse = async () => {
                    // Check permissions
                    if (cocState.mode === 'multi' && !multiplayerState.isHost) {
                        return showToast('仅房主可以重新生成', 'warning');
                    }
                    
                    const lastAiIdx = lastAssistantIndex.value;
                    if (lastAiIdx === -1) return;

                    if (!await showConfirm('确定要回溯到此处并重新生成吗？该消息及之后的所有对话将被清除。', '回溯重生成')) return;

                    // Remove from lastAiIdx
                    // 这里的 splice 会移除从 lastAiIdx 开始的所有元素，包括该 AI 消息和之后的所有用户消息
                    cocState.log.splice(lastAiIdx);

                    // Multiplayer Sync
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        // 同步整个状态，因为我们可能删除了多条消息
                        broadcastMessage({
                            type: 'sync_state',
                            log: cocState.log,
                            gameState: cocState.gameState,
                            investigators: cocState.investigators,
                            assignments: multiplayerState.assignments,
                            assignmentDetails: multiplayerState.assignmentDetails,
                            turnIndex: multiplayerState.turnIndex,
                            roundActionIds: multiplayerState.roundActionIds,
                            cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers
                        });
                        broadcastMessage({ type: 'regenerate_start' });
                    }

                    // Trigger generation
                    generateResponse();
                };

                const cocInput = ref('');
                const cocInputRef = ref(null); // Ref for textarea
                const cocChatContainer = ref(null);
                const isGenerating = ref(false);

                // Mention System
                const showMentionList = ref(false);
                const mentionQuery = ref('');
                
                const mentionCandidates = Vue.computed(() => {
                    if (!mentionQuery.value && mentionQuery.value !== '') return [];
                    const q = mentionQuery.value.toLowerCase();
                    
                    let candidates = [];
                    
                    // 2. Add Characters (if assigned)
                    if (cocState.mode === 'multi') {
                        cocState.investigators.forEach((inv, idx) => {
                            // Only add if assigned to someone else
                            if (multiplayerState.assignments[idx] && multiplayerState.assignments[idx] !== user.uuid) {
                                candidates.push({ type: 'character', name: inv.name, id: `char_${idx}`, avatar: inv.avatar });
                            }
                        });
                    }

                    // Filter
                    return candidates.filter(c => c.name.toLowerCase().includes(q));
                });

                const handleInput = (e) => {
                    const val = e.target.value;
                    const cursor = e.target.selectionStart;
                    const lastAt = val.lastIndexOf('@', cursor - 1);
                    
                    if (lastAt !== -1) {
                        // Check if there's a space before @ or it's the start
                        if (lastAt === 0 || val[lastAt - 1] === ' ' || val[lastAt - 1] === '\n') {
                            const query = val.substring(lastAt + 1, cursor);
                            // Stop if query contains space (end of mention)
                            if (!query.includes(' ')) {
                                mentionQuery.value = query;
                                showMentionList.value = true;
                                return;
                            }
                        }
                    }
                    showMentionList.value = false;
                };

                const selectMention = (candidate) => {
                    const val = cocInput.value;
                    const cursor = cocInputRef.value.selectionStart;
                    const lastAt = val.lastIndexOf('@', cursor - 1);
                    
                    if (lastAt !== -1) {
                        const before = val.substring(0, lastAt);
                        const after = val.substring(cursor);
                        cocInput.value = `${before}@${candidate.name} ${after}`;
                        showMentionList.value = false;
                        
                        // Restore focus
                        nextTick(() => {
                            cocInputRef.value.focus();
                            // Move cursor to end of inserted name + space
                            const newCursorPos = lastAt + 1 + candidate.name.length + 1;
                            cocInputRef.value.setSelectionRange(newCursorPos, newCursorPos);
                        });
                    }
                };

                // Multiplayer & Friends
                const multiplayerState = reactive({
                    isConnected: false, inRoom: false, roomId: null, myId: null,
                    isHost: false, members: [], turnStatus: {}, skipStatus: {},
                    isReady: false, // Local player ready status
                    assignments: {}, // { investigatorIndex: userId }
                    turnIndex: 0, // Who is picking now? 0 = Host, 1 = First Guest...
                    roundActionIds: [], // Track who has acted in the current round
                    cotAuthorizedUsers: [] // List of user IDs authorized to view CoT
                });
                const friends = ref([]);
                const friendRequests = ref([]);
                const friendInput = ref('');
                const showJoinInput = ref(false);
                const joinRoomId = ref('');
                const savedGames = ref([]); // Archive list

                // SQL Modal State
                const showSqlModal = ref(false);
                const sqlToRun = ref('');

                // Library State
                const libraryState = reactive({
                    modules: [],
                    loading: false,
                    isSummarizing: false,
                    isUploading: false,
                    searchQuery: '',
                    showUpload: false,
                    uploadType: 'text', // 'text' or 'file'
                    uploadForm: { title: '', description: '', content: '', type: 'original' }
                });

                // Broadcast State
                const showBroadcast = ref(false);
                const dontShowBroadcast = ref(false);
                const currentVersion = '1.0';

                // Check Broadcast on Mount
                const checkBroadcast = () => {
                    const lastReadVersion = localStorage.getItem('coc_broadcast_read_version');
                    if (lastReadVersion !== currentVersion) {
                        showBroadcast.value = true;
                    }
                };

                const closeBroadcast = () => {
                    showBroadcast.value = false;
                    if (dontShowBroadcast.value) {
                        localStorage.setItem('coc_broadcast_read_version', currentVersion);
                    }
                };

                const openCocCard = () => {
                    window.open('Workshop/index.html', '_blank');
                    showMobileMenu.value = false;
                };
                
                let supabaseClient = null;
                let roomChannel = null;
                let personalChannel = null;
                let globalChannel = null;

                // --- Persistence ---
                const saveData = () => {
                    localStorage.setItem('coc_user', JSON.stringify(user));
                    localStorage.setItem('coc_settings', JSON.stringify(settings));
                    localStorage.setItem('coc_investigators', JSON.stringify(cocState.investigators));
                    localStorage.setItem('coc_friends', JSON.stringify(friends.value));
                };

                const loadData = () => {
                    const lUser = localStorage.getItem('coc_user');
                    if (lUser) Object.assign(user, JSON.parse(lUser));
                    
                    const lSettings = localStorage.getItem('coc_settings');
                    if (lSettings) Object.assign(settings, JSON.parse(lSettings));
                    
                    const lInv = localStorage.getItem('coc_investigators');
                    if (lInv) cocState.investigators = JSON.parse(lInv);

                    const lFriends = localStorage.getItem('coc_friends');
                    if (lFriends) friends.value = JSON.parse(lFriends);

                    const lSaves = localStorage.getItem('coc_saves');
                    if (lSaves) savedGames.value = JSON.parse(lSaves);
                };

                // --- Core Logic ---
                const showToast = (msg, type = 'info') => {
                    const id = Date.now();
                    toasts.value.push({ id, message: msg, type });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
                };

                const copyToClipboard = (text) => {
                    if (!text) return;
                    navigator.clipboard.writeText(text).then(() => showToast('已复制到剪贴板', 'success')).catch(() => showToast('复制失败', 'error'));
                };

                // Helper: Execute ST command (Modify Stats)
                const executeStCommand = (inv, prop, valExpr) => {
                    if (!inv || !prop || !valExpr) return null;
                    
                    const lowerProp = prop.toLowerCase();
                    let targetKey = '';
                    let isStat = false;

                    // Map prop to inv key
                    if (['hp', 'mp', 'san'].includes(lowerProp)) {
                        targetKey = lowerProp;
                    } else {
                        // Check stats
                        const statMap = {
                            '力量': 'STR', 'STR': 'STR',
                            '体质': 'CON', 'CON': 'CON',
                            '体型': 'SIZ', 'SIZ': 'SIZ',
                            '敏捷': 'DEX', 'DEX': 'DEX',
                            '外貌': 'APP', 'APP': 'APP',
                            '智力': 'INT', 'INT': 'INT', '灵感': 'INT',
                            '意志': 'POW', 'POW': 'POW',
                            '教育': 'EDU', 'EDU': 'EDU', '知识': 'EDU',
                            '幸运': 'LUCK', 'LUCK': 'LUCK'
                        };
                        const key = statMap[prop] || statMap[prop.toUpperCase()];
                        if (key) {
                            targetKey = key;
                            isStat = true;
                        }
                    }

                    if (!targetKey) return { success: false, msg: `未找到属性: ${prop}` };

                    let currentVal = isStat ? inv.stats[targetKey] : inv[targetKey];
                    let newVal = currentVal;
                    let change = 0;

                    // Parse expression (+10, -5, 50, 1d6)
                    // Simple regex for + / -
                    const match = valExpr.match(/^([+-]?)(\d+|d\d+|\d+d\d+)(.*)$/);
                    let op = '';
                    
                    if (match) {
                        op = match[1]; // + or - or empty
                        const valPart = match[2]; // number or dice
                        
                        let valNum = 0;
                        if (valPart.includes('d')) {
                            const [n, d] = valPart.split('d').map(v => parseInt(v) || 1);
                            for(let i=0; i<n; i++) valNum += Math.floor(Math.random() * d) + 1;
                        } else {
                            valNum = parseInt(valPart);
                        }

                        if (op === '+') {
                            newVal += valNum;
                            change = valNum;
                        } else if (op === '-') {
                            newVal -= valNum;
                            change = -valNum;
                        } else {
                            newVal = valNum; // Set directly
                            change = newVal - currentVal;
                        }
                    } else {
                         return { success: false, msg: `数值格式错误: ${valExpr}` };
                    }

                    // Apply
                    if (isStat) inv.stats[targetKey] = newVal;
                    else inv[targetKey] = newVal;

                    // Bounds check (optional, but good for SAN/HP)
                    if (targetKey === 'san') inv[targetKey] = Math.max(0, Math.min(99, inv[targetKey]));
                    if (targetKey === 'hp') inv[targetKey] = Math.max(0, Math.min(inv.maxHp || 99, inv[targetKey]));
                    if (targetKey === 'mp') inv[targetKey] = Math.max(0, Math.min(inv.maxMp || 99, inv[targetKey]));

                    saveData();
                    return {
                        success: true,
                        msg: `${prop.toUpperCase()} ${op==='+'?'+':''}${change} => ${inv[targetKey]}`,
                        log: `🔧 **属性变更** ${inv.name} 的 ${prop.toUpperCase()}: ${currentVal} ➔ ${inv[targetKey]}`
                    };
                };

                const renderMarkdown = (text) => {
                    if (!text) return '';
                    // Simple regex for dice command linking (simplified from main app)
                    let processed = text.replace(/(^|[\s\n>])(\.(?:ra|rc|sc|san|r|roll|st|set)(?:\s+[^\s\n<。，！\?]+)?)(?=$|[\s\n<。，！\?])/gi,
                        '$1<span class="cursor-pointer text-mystic-gold font-bold hover:underline decoration-mystic-gold/30" onclick="event.stopPropagation(); window.triggerCocCommand(\'$2\')">$2</span>');
                    return DOMPurify.sanitize(marked.parse(processed));
                };

                // Computed
                const allPlayersReady = Vue.computed(() => {
                    // 必须至少有2人（房主+至少1名玩家）才能开始多人游戏
                    if (multiplayerState.members.length < 2) return false;
                    // 检查房主是否在场（虽然通常房主就是当前用户，但为了逻辑严谨）
                    const hostPresent = multiplayerState.members.some(m => m.isHost);
                    if (!hostPresent) return false;
                    // 所有非房主成员必须准备就绪
                    return multiplayerState.members.every(m => m.isReady || m.isHost);
                });

                // COC Logic
                // Moved checkAndTriggerRound definition up to ensure scope availability
                const checkAndTriggerRound = () => {
                    if (!multiplayerState.isHost || isGenerating.value) return;
                    
                    // 获取所有已分配角色的唯一玩家 ID
                    const participants = [...new Set(Object.values(multiplayerState.assignments))];
                    if (participants.length === 0) return;

                    // 检查是否所有玩家都已行动
                    const allActed = participants.every(uid => multiplayerState.roundActionIds.includes(uid));
                    
                    if (allActed) {
                        console.log('所有玩家已行动，触发 Keeper 回复...');
                        generateResponse();
                    }
                };

                const selectCocMode = (mode) => {
                    if (mode === 'multi') {
                        if (!multiplayerState.inRoom) {
                            currentView.value = 'multiplayer';
                            return showToast('请先加入房间', 'warning');
                        }
                        // Host broadcasts mode change to entering preparation phase
                        if (multiplayerState.isHost) {
                            broadcastMessage({ type: 'change_mode', mode: 'multi', view: 'preparing', gameState: 'preparing' });
                        }
                        
                        cocState.mode = mode;
                        currentView.value = 'preparing';
                        cocState.gameState = 'preparing';
                    } else {
                        cocState.mode = mode;
                        currentView.value = 'preparing';
                        cocState.gameState = 'preparing';
                    }
                };

                const exitCocMode = () => {
                    if (cocState.mode === 'multi') {
                        // 多人模式下，准备阶段的返回应当视为退出游戏/房间
                        // 避免用户返回到 multiplayer 界面导致状态不一致
                        exitCocGame();
                    } else {
                        cocState.mode = null;
                        cocState.gameState = 'idle';
                        currentView.value = 'coc';
                    }
                };
                
                const exitCocGame = async () => {
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        if (await showConfirm('您是房主，退出将解散房间。是否先保存当前游戏进度？', '保存进度')) {
                            saveGame();
                        } else {
                            return; // 如果取消保存，则视为取消退出操作，不再弹出解散提示
                        }
                        
                        if (!await showConfirm('确定要解散房间并退出吗？所有玩家将被强制退出。', '解散房间')) return;

                        // Broadcast room closed signal
                        await broadcastMessage({ type: 'room_closed' });
                    } else {
                        if(!await showConfirm('确定退出吗？未保存的进度将丢失。', '退出确认')) return;
                    }

                    cocState.gameState = 'idle';
                    cocState.log = [];
                    currentView.value = 'coc';
                    // Leave room if in multi
                    if (multiplayerState.inRoom) leaveRoom();
                };

                const saveGame = () => {
                    const save = {
                        id: Date.now(),
                        timestamp: Date.now(),
                        mode: cocState.mode,
                        moduleName: cocState.module?.name,
                        moduleContent: cocState.module?.content,
                        investigators: cocState.investigators,
                        log: cocState.log,
                        systemPrompt: cocState.systemPrompt,
                        pendingRolls: cocState.pendingRolls, // Save roll state
                        // Multi specific
                        multiplayer: cocState.mode === 'multi' ? {
                            assignments: multiplayerState.assignments,
                            // Save player names for assignments to allow re-binding
                            assignmentDetails: Object.entries(multiplayerState.assignments).reduce((acc, [idx, uid]) => {
                                const member = multiplayerState.members.find(m => m.id === uid);
                                if (member) acc[idx] = { id: uid, name: member.name };
                                return acc;
                            }, {}),
                            turnIndex: multiplayerState.turnIndex,
                            roundActionIds: multiplayerState.roundActionIds
                        } : null,
                        lastMessage: cocState.log.length > 0 ? cocState.log[cocState.log.length - 1].content : ''
                    };

                    // Update existing if same session? For now just new save
                    savedGames.value.unshift(save);
                    localStorage.setItem('coc_saves', JSON.stringify(savedGames.value));
                    showToast('游戏进度已保存至记忆回廊', 'success');
                };

                const deleteSave = async (index) => {
                    if(await showConfirm('确定要遗忘这段记忆吗？', '删除存档')) {
                        savedGames.value.splice(index, 1);
                        localStorage.setItem('coc_saves', JSON.stringify(savedGames.value));
                    }
                };

                const loadSave = async (index) => {
                    const save = savedGames.value[index];
                    if (!save) return;

                    // --- In-Game Rollback Logic ---
                    if (cocState.gameState === 'playing' && cocState.mode === 'multi') {
                        if (save.mode !== 'multi') return showToast('无法在多人游戏中读取单人存档', 'error');
                        
                        // Check Module
                        if (save.moduleName !== cocState.module?.name) {
                            return showToast('无法读取：存档属于不同的模组 (' + save.moduleName + ')', 'error');
                        }

                        // Check Members (Assignments)
                        const savedAssignments = save.multiplayer?.assignments || {};
                        const currentMemberIds = multiplayerState.members.map(m => m.id);
                        const missingPlayers = Object.values(savedAssignments).filter(uid => !currentMemberIds.includes(uid));
                        
                        if (missingPlayers.length > 0) {
                             return showToast('无法读取：存档中的关键玩家不在当前房间', 'error');
                        }

                        if (!await showConfirm('检测到当前正在游戏中。是否进行回档（覆盖当前进度）？', '覆盖确认')) return;

                        // Execute Rollback
                        cocState.log = save.log;
                        cocState.investigators = save.investigators;
                        cocState.systemPrompt = save.systemPrompt;
                        if (save.pendingRolls !== undefined) cocState.pendingRolls = save.pendingRolls; // Restore roll state
                        else if (save.canRoll !== undefined) cocState.pendingRolls = []; // Migration: clear old boolean
                        
                        multiplayerState.assignments = savedAssignments;
                        multiplayerState.assignmentDetails = save.multiplayer.assignmentDetails || {};
                        multiplayerState.turnIndex = save.multiplayer.turnIndex || 0;
                        multiplayerState.roundActionIds = save.multiplayer.roundActionIds || [];
                        
                        // Update host's own assignment index
                        updateMyAssignment();

                        broadcastMessage({
                            type: 'sync_state',
                            log: cocState.log,
                            investigators: cocState.investigators,
                            assignments: multiplayerState.assignments,
                            assignmentDetails: multiplayerState.assignmentDetails,
                            turnIndex: multiplayerState.turnIndex,
                            roundActionIds: multiplayerState.roundActionIds,
                            gameState: 'playing'
                        });

                        showToast('已成功回档', 'success');
                        currentView.value = 'chat';
                        return;
                    }

                    if (save.mode === 'multi') {
                        // Multi load logic (New Session)
                        // 1. Must be connected to Supabase
                        if (!multiplayerState.isConnected) {
                            currentView.value = 'multiplayer';
                            showToast('请先连接服务器', 'warning');
                            return;
                        }
                        
                        // 2. Create a room automatically (isLoadGame = true)
                        createRoom(true).then(() => {
                            // 3. Restore State (But keep in preparing mode first)
                            cocState.mode = 'multi';
                            cocState.module = { name: save.moduleName, content: save.moduleContent };
                            cocState.investigators = save.investigators;
                            cocState.log = save.log;
                            cocState.systemPrompt = save.systemPrompt;
                            if (save.pendingRolls !== undefined) cocState.pendingRolls = save.pendingRolls;
                            else if (save.canRoll !== undefined) cocState.pendingRolls = [];
                            
                            // Restore assignments logic:
                            // We keep the assignments but mark them as "pending re-connection"
                            // We use a special state to track "expected players"
                            multiplayerState.assignments = save.multiplayer.assignments;
                            multiplayerState.assignmentDetails = save.multiplayer.assignmentDetails || {}; // Load saved details
                            
                            cocState.gameState = 'preparing'; // Force preparing state
                            multiplayerState.turnIndex = 0;
                            multiplayerState.roundActionIds = save.multiplayer.roundActionIds;
                            
                            // Sync to room
                            broadcastMessage({
                                type: 'sync_state',
                                log: cocState.log,
                                moduleName: cocState.module.name,
                                gameState: cocState.gameState,
                                investigators: cocState.investigators,
                                assignments: multiplayerState.assignments,
                                assignmentDetails: multiplayerState.assignmentDetails, // Sync details too
                                turnIndex: multiplayerState.turnIndex,
                                roundActionIds: multiplayerState.roundActionIds
                            });
                            
                            currentView.value = 'multiplayer';
                            showToast('存档已加载。请等待原班人马归位。', 'success');
                        });
                    } else {
                        // Single load logic
                        cocState.mode = 'single';
                        cocState.module = { name: save.moduleName, content: save.moduleContent };
                        cocState.investigators = save.investigators;
                        cocState.log = save.log;
                        cocState.systemPrompt = save.systemPrompt;
                        if (save.pendingRolls !== undefined) cocState.pendingRolls = save.pendingRolls;
                        else if (save.canRoll !== undefined) cocState.pendingRolls = [];
                        cocState.gameState = 'playing';
                        // Restore active investigator (default to first if not tracked, or maybe track it in save?)
                        // For now default to 0 or last active
                        cocState.activeInvestigatorIndex = 0;
                        
                        currentView.value = 'chat';
                        showToast('记忆已唤醒', 'success');
                    }
                };

                const importCocModule = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    
                    // Handle .docx with Mammoth
                    if (file.name.endsWith('.docx')) {
                        reader.onload = (ev) => {
                            const arrayBuffer = ev.target.result;
                            mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                                .then((result) => {
                                    cocState.module = { name: file.name.replace(/\.[^/.]+$/, ""), content: result.value };
                                    showToast('模组导入成功', 'success');
                                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                                        broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name });
                                    }
                                })
                                .catch((err) => {
                                    console.error(err);
                                    showToast('Docx 解析失败', 'error');
                                });
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        // Handle text/json/md
                        reader.onload = (ev) => {
                            cocState.module = { name: file.name.replace(/\.[^/.]+$/, ""), content: ev.target.result };
                            showToast('模组导入成功', 'success');
                            if (cocState.mode === 'multi' && multiplayerState.isHost) {
                                broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name });
                            }
                        };
                        reader.readAsText(file);
                    }
                };

                const saveManualModule = () => {
                    if (!cocState.tempModuleText) return;
                    cocState.module = { name: '手动模组', content: cocState.tempModuleText };
                    showToast('模组保存成功', 'success');
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name });
                    }
                };

                const importInvestigator = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        let data = null;
                        
                        // Handle JSON
                        if (file.type === 'application/json' || file.name.endsWith('.json')) {
                            const text = await file.text();
                            data = JSON.parse(text);
                        }
                        // Handle PNG
                        else if (file.type === 'image/png' || file.name.endsWith('.png')) {
                            data = await extractPngData(file);
                            if (!data) throw new Error('未在 PNG 中找到嵌入的角色数据');
                            
                            // If PNG has data but no avatar, use the image itself
                            if (!data.avatar) {
                                data.avatar = await compressImage(URL.createObjectURL(file), 200, 0.6);
                            }
                        }

                        if (!data) throw new Error('不支持的文件格式');

                        // Ensure basic stats & structure
                        if (!data.stats) data.stats = { STR:50, CON:50, SIZ:65, DEX:50, APP:50, INT:60, POW:50, EDU:60 };
                        if (!data.hp) data.hp = Math.floor((data.stats.CON + data.stats.SIZ)/10);
                        if (!data.mp) data.mp = Math.floor(data.stats.POW/5);
                        if (!data.san) data.san = data.stats.POW;
                        if (!data.maxSan) data.maxSan = 99;
                        if (!data.maxHp) data.maxHp = data.hp;
                        
                        // Store full data structure
                        cocState.investigators.push(data);
                        
                        // Multiplayer Sync
                        if (cocState.mode === 'multi' && multiplayerState.isHost) {
                            broadcastMessage({ type: 'sync_investigators', investigators: cocState.investigators });
                        }

                        // Auto select if none selected (Single mode or Host)
                        if (cocState.activeInvestigatorIndex === -1) {
                            cocState.activeInvestigatorIndex = cocState.investigators.length - 1;
                        }
                        saveData();
                        showToast('调查员导入成功: ' + data.name, 'success');
                    } catch(err) {
                        console.error(err);
                        showToast('导入失败: ' + err.message, 'error');
                    }
                    
                    // Reset input
                    e.target.value = '';
                };

                const deleteInvestigator = async (index) => {
                    if(await showConfirm('删除此调查员？', '删除角色')) {
                        cocState.investigators.splice(index, 1);
                        if(cocState.activeInvestigatorIndex >= index) cocState.activeInvestigatorIndex = -1;
                        
                        // Multiplayer Sync
                        if (cocState.mode === 'multi' && multiplayerState.isHost) {
                            broadcastMessage({ type: 'sync_investigators', investigators: cocState.investigators });
                            // Reset assignments for deleted index
                            multiplayerState.assignments = {};
                            broadcastMessage({ type: 'sync_assignments', assignments: {} });
                        }
                        
                        saveData();
                    }
                };

                const toggleReady = () => {
                    // Check assignment only if we are in preparation phase and trying to get ready
                    if (!multiplayerState.isReady && cocState.gameState === 'preparing') {
                        if (cocState.activeInvestigatorIndex === -1) {
                            return showToast('请先选择一名调查员', 'warning');
                        }
                    }

                    multiplayerState.isReady = !multiplayerState.isReady;
                    if (roomChannel) {
                        // Find my existing presence to keep original online_at
                        const myPresence = multiplayerState.members.find(m => m.id === user.uuid);
                        const onlineAt = myPresence ? myPresence.online_at : new Date();

                        const status = {
                            user_id: user.uuid,
                            name: user.name,
                            avatar: user.avatar,
                            is_host: multiplayerState.isHost,
                            isReady: multiplayerState.isReady,
                            online_at: onlineAt
                        };
                        roomChannel.track(status);
                        
                        // Explicit broadcast for redundancy
                        broadcastMessage({ type: 'member_status', status });
                    }
                };

                const buildInvestigatorProfile = (inv) => {
                    let profile = `姓名：${inv.name}\n职业：${inv.job} | 年龄：${inv.age} | 性别：${inv.gender} | 住地：${inv.residence}\n`;
                    profile += `属性：STR:${inv.stats.STR} CON:${inv.stats.CON} SIZ:${inv.stats.SIZ} DEX:${inv.stats.DEX} APP:${inv.stats.APP} INT:${inv.stats.INT} POW:${inv.stats.POW} EDU:${inv.stats.EDU}\n`;
                    profile += `状态：HP ${inv.hp}/${inv.maxHp} | MP ${inv.mp}/${inv.maxMp} | SAN ${inv.san}/${inv.maxSan}\n`;
                    
                    if (inv.skills && inv.skills.length) {
                        const skillsStr = inv.skills
                            .filter(s => s.value > 0) // Only show learned skills
                            .map(s => `${s.name}(${s.value})`).join(', ');
                        profile += `技能：${skillsStr}\n`;
                    }
                    
                    if (inv.backstory) {
                        profile += `背景：\n`;
                        const map = {
                            personalDescription: "外貌与气质", ideology: "核心信念", significantPeople: "重要之人",
                            meaningfulLocations: "重要之地", treasuredPossessions: "宝贵之物", traits: "性格特质",
                            injuries: "伤疤与残疾", phobias: "恐惧症"
                        };
                        for (const [k, v] of Object.entries(inv.backstory)) {
                            if (v) profile += `- ${map[k]||k}: ${v}\n`;
                        }
                    }
                    
                    if (inv.inventory) profile += `随身物品：${inv.inventory}\n`;
                    return profile;
                };

                const startCocGame = () => {
                    if (!cocState.module || cocState.investigators.length === 0) return showToast('请先导入模组和调查员', 'warning');
                    
                    // Multi-mode validation
                    if (cocState.mode === 'multi') {
                        // Check if all ready players have assignments
                        const readyMembers = multiplayerState.members.filter(m => m.isReady && !m.isHost);
                        if (readyMembers.length === 0) return showToast('没有玩家准备就绪', 'warning');
                        
                        // Check if assignments cover all ready players
                        const assignedUserIds = Object.values(multiplayerState.assignments);
                        const allReadyAssigned = readyMembers.every(m => assignedUserIds.includes(m.id));
                        
                        if (!allReadyAssigned) return showToast('有准备就绪的玩家未分配角色', 'warning');

                        // Fix: Host needs a default view if not assigned
                        if (multiplayerState.isHost && cocState.activeInvestigatorIndex === -1 && cocState.investigators.length > 0) {
                            cocState.activeInvestigatorIndex = 0;
                        }
                    } else {
                        if (cocState.activeInvestigatorIndex === -1) cocState.activeInvestigatorIndex = 0;
                    }
                    
                    let invProfile = '';
                    
                    if (cocState.mode === 'multi') {
                        invProfile = `【调查员队伍】\n`;
                        for (const [idx, uid] of Object.entries(multiplayerState.assignments)) {
                            const inv = cocState.investigators[idx];
                            const player = multiplayerState.members.find(m => m.id === uid);
                            invProfile += `\n--- 玩家: ${player?.name || 'Unknown'} 扮演: ${inv.name} ---\n`;
                            invProfile += buildInvestigatorProfile(inv);
                        }
                    } else {
                        const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                        invProfile = `【当前调查员资料】\n` + buildInvestigatorProfile(inv);
                    }
                    
                    // If resuming from save, use existing prompt but update profiles?
                    // Actually, if we just loaded a save, we might want to keep the old prompt OR update it with new assignments.
                    // Let's regenerate it to be safe with new assignments.
                    
                    let systemPrompt = `你现在是COC跑团 (Call of Cthulhu 7th Edition) 的 Keeper (守密人)。
你的职责是主持游戏，描述环境，扮演 NPC，并根据规则裁定玩家的行动结果。

【核心指令与检定系统 (必须严格遵守)】
你必须严格遵守以下指令格式，**不要修改格式，不要使用代码块包裹**，必须作为独立行输出，随后会将检定结果发送给你，不需要你自己进行检定。如果不按规定格式输出，则无法触发检定逻辑，你将收不到检定结果。
1. **技能/属性检定**：
   - 格式：\`@角色名 .ra 技能名\`
   - 示例：\`@张三 .ra 侦查\`
   - 反面示例：(此时，谢天逸若想分析此地风水，可进行相关检定；陈铜可进行侦查)
   - 说明：当你认为玩家需要进行检定时使用，只有你输出了标准指令，玩家才能进行符合你要求的检定，若没有遵循标准格式，则无法触发系统的检定规则。
   - **重要检查**：请先检查各个玩家的技能列表，确保你要求检定的指定玩家拥有你要求检定的技能。如果实在需要进行检定指定玩家没有的技能，一定要替换为要求检定某项相关的基础属性，如DEX,POW等。

2. **San Check (理智检定)**：
   - 格式：\`@角色名 .sc 成功扣除/失败扣除\`
   - 示例：\`@李四 .sc 1/1d3\`
   - 说明：当玩家遭遇恐怖事物时使用。

3. **暗骰/直接调整数值 (推荐)**：
   - 格式：\`@角色名 .st 属性 变更表达式\`
   - 示例：\`@王五 .st san -1d6\` (直接扣除 1d6 点 SAN)
   - 示例：\`@赵六 .st hp -2\` (扣除 2 点 HP)
   - 说明：用于直接结算伤害、恐惧惩罚，或不希望玩家知道结果的暗骰，san check都是暗骰。


**重要规则**：
- **严格格式**：指令必须严格匹配上述格式，包括空格和符号。
- **独立行**：指令必须写在回复的最后，单独占一行或多行。
- **多人游戏**：必须指定 \`@角色名\`。

【Keeper 行为准则】
1. **极度沉浸**：正文中不要出现"请进行侦查检定"这种出戏的提示语。直接通过环境描述暗示，然后在文末附上指令即可。
2. **恐怖氛围**：使用富有画面感、文学性、克苏鲁风格（恐怖、悬疑、不可名状）的语言。
3. **中立裁定**：不要偏袒玩家，也不要刻意刁难。
4. **禁止代入玩家**：你永远是 Keeper，只描述外界反馈，不扮演玩家角色。
5. **失败向前**：检定失败不应导致剧情卡死，而应带来有趣的麻烦或代价。

【状态感知叙事】
请时刻关注调查员的当前状态（HP, SAN），并将其反映在叙事风格中：
*   **HP 低下**：描述疼痛、虚弱、视线模糊、行动迟缓、濒死的恐惧。
*   **SAN 低下**：描述幻觉、耳鸣、偏执、理智崩坏的疯狂感、不可名状的恐惧。
*   **MP 低下**：描述精神萎靡、注意力涣散、施法后的虚脱。
请根据这些数值的变化，动态调整你的描写色调。`;

                    if (cocState.mode === 'multi') {
                        systemPrompt += `\n\n【多人游戏分镜叙事】
当前为多人联机模式。你必须等待所有玩家行动完毕后才会收到汇总信息。
为了保证每位玩家的体验，请采用**电影分镜**式的叙事手法，清晰地切换不同角色的视角。
请使用 **Markdown 二级或三级标题** (如 \`## 角色名\`) 来作为分镜的开始，分别描述他们的遭遇。

格式示例：
## 张三
你推开门，发现屋内漆黑一片...

## 李四
你在门外负责把风，突然听到楼道里传来了脚步声...

确保每位参与本轮行动的调查员都能得到独立且丰满的回应。`;
                    }

                    // CoT Instruction
                    systemPrompt += `\n\n【思维链 (CoT) 要求】
请在正文输出前，使用markdown格式，以 <cot>...思考内容...<cot> 的方式严密，详细地分析coc跑团游戏的系统规则，调查员和模组设定，历史对话，用户输入等信息，确保符合设定且符合逻辑后再进行正文的输出。
规范格式为 <cot>... <cot>，确保开头结尾都有<cot>标签。
在思考中，你需要：
1. 分析当前场景和玩家行动。
2. 检查规则书，判定是否需要检定，检定格式是否标准，检定的技能/属性是否为该玩家拥有的，若玩家没有该技能，是否进行了基础属性替换。
3. 如果需要检定，构思引导语。
4. 规划剧情走向，确保逻辑自洽。`;

                    // 插入调查员资料
                    systemPrompt += `\n\n${invProfile}`;

                    // 最后插入模组内容
                    systemPrompt += `\n\n【模组背景 (仅 Keeper 可见)】
${cocState.module.content.slice(0, 15000)}`;

                    // Check if we are resuming a game (log already has content)
                    if (cocState.log.length > 0) {
                        systemPrompt += `\n\n【游戏继续】
玩家已重新连接并分配了角色。请继续之前的剧情。
简要回顾一下当前情况，然后等待玩家行动。`;
                        // Don't reset log
                    } else {
                        systemPrompt += `\n\n现在，游戏开始。请根据模组开篇，引导调查员进入场景。`;
                        cocState.log = [{ role: 'assistant', name: '守密人', content: `欢迎来到《${cocState.module.name}》。\n\n(看着手中的调查员档案)\n“各位调查员...”\n\n请确认你的状态，我们即将开始。` }];
                    }
                    
                    cocState.systemPrompt = systemPrompt;
                    cocState.gameState = 'playing';
                    currentView.value = 'chat'; // Switch to chat view
                    
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        broadcastMessage({ type: 'game_start', log: cocState.log });
                    }

                    console.log('=== Game Started ===');
                    console.log('System Prompt Constructed:', systemPrompt);
                };

                const handleInvestigatorClick = (index) => {
                    if (cocState.mode === 'single') {
                        cocState.activeInvestigatorIndex = index;
                    } else {
                        // Multi mode
                        if (cocState.gameState !== 'preparing') return;

                        // Check if this slot is reserved (from save load)
                        if (multiplayerState.assignmentDetails && multiplayerState.assignmentDetails[index]) {
                            const reserved = multiplayerState.assignmentDetails[index];
                            // Allow if ID matches OR Name matches (fuzzy fallback)
                            // Note: ID might change if user cleared cache, so Name is a good fallback
                            const isMe = reserved.id === user.uuid || reserved.name === user.name;
                            
                            if (!isMe && !multiplayerState.isHost) {
                                showToast(`该角色已绑定给玩家: ${reserved.name}`, 'warning');
                                return;
                            }
                            
                            // If it is me, I can "claim" it
                            if (isMe) {
                                if (multiplayerState.isHost) {
                                    // Host claims directly
                                    clearUserAssignments(user.uuid); // Ensure unique assignment
                                    multiplayerState.assignments[index] = user.uuid;
                                    // Remove from pending details once claimed? No, keep for reference or remove?
                                    // Better to update assignments.
                                    broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments });
                                    showToast('欢迎回来，调查员', 'success');
                                } else {
                                    // Client claims
                                    broadcastMessage({ type: 'claim_role', index, userId: user.uuid });
                                }
                                cocState.activeInvestigatorIndex = index;
                                return;
                            }
                        }

                        // Normal Selection Logic (New Game)
                        // 1. Check if occupied by others
                        if (multiplayerState.assignments[index] && multiplayerState.assignments[index] !== user.uuid) {
                            showToast('该角色已被占用', 'warning');
                            return;
                        }

                        if (multiplayerState.isHost) {
                            // Host Logic
                            // Only allow picking if NOT loading a save with bindings (or if bindings are cleared)
                            if (!multiplayerState.assignmentDetails || Object.keys(multiplayerState.assignmentDetails).length === 0) {
                                // Check turn
                                if (multiplayerState.members[multiplayerState.turnIndex]?.id !== user.uuid) {
                                    // If host tries to click during others' turn
                                    // Allow clicking own assigned character to potentially unassign?
                                    // Or if clicking an unassigned character, warn "Not your turn"
                                    if (multiplayerState.assignments[index] === user.uuid) {
                                         // Allowed to click own (maybe to view details), but re-assign logic below handles toggle
                                    } else {
                                        showToast(`还没轮到你！请等待 ${multiplayerState.members[multiplayerState.turnIndex]?.name} 选择`, 'warning');
                                        return;
                                    }
                                }

                                cocState.activeInvestigatorIndex = index;

                                if (multiplayerState.members[multiplayerState.turnIndex]?.id === user.uuid) {
                                    // If clicking already assigned (self), do nothing (prevent unassign)
                                    if (multiplayerState.assignments[index] === user.uuid) {
                                        // Still update active view just in case
                                        cocState.activeInvestigatorIndex = index;
                                        return;
                                    } else {
                                        // Clear previous assignment for this user
                                        clearUserAssignments(user.uuid);
                                        multiplayerState.assignments[index] = user.uuid;
                                        // Advance turn
                                        if (multiplayerState.turnIndex < multiplayerState.members.length - 1) {
                                            multiplayerState.turnIndex++;
                                        }
                                        broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments, turnIndex: multiplayerState.turnIndex });
                                    }
                                }
                            }
                        } else {
                            // Client
                            if (!multiplayerState.assignmentDetails || Object.keys(multiplayerState.assignmentDetails).length === 0) {
                                const currentTurnPlayer = multiplayerState.members[multiplayerState.turnIndex];
                                if (!currentTurnPlayer || currentTurnPlayer.id !== user.uuid) {
                                    showToast(`还没轮到你！请等待 ${currentTurnPlayer?.name} 选择`, 'warning');
                                    return;
                                }
                                const currentOwner = multiplayerState.assignments[index];
                                if (currentOwner === user.uuid) return;
                                if (currentOwner) {
                                    showToast('该角色已被其他玩家选择', 'warning');
                                    return;
                                }
                                broadcastMessage({ type: 'request_assignment', index, userId: user.uuid });
                            }
                        }
                    }
                };

                const updateMyAssignment = () => {
                    // Find if I have an assignment
                    const myIndex = Object.keys(multiplayerState.assignments).find(key => multiplayerState.assignments[key] === user.uuid);
                    if (myIndex !== undefined) {
                        cocState.activeInvestigatorIndex = parseInt(myIndex);
                    } else {
                        // Fix: In playing mode, host needs a view (default to first investigator)
                        // 房主在游戏进行中如果没有角色，默认查看第一个，以确保侧边栏显示
                        if (multiplayerState.isHost && cocState.gameState === 'playing' && cocState.investigators.length > 0) {
                            cocState.activeInvestigatorIndex = 0;
                        } else {
                            cocState.activeInvestigatorIndex = -1;
                        }
                    }
                };

                const scrollToBottom = () => {
                    nextTick(() => { if (cocChatContainer.value) cocChatContainer.value.scrollTop = cocChatContainer.value.scrollHeight; });
                };

                const sendCocMessage = async (manualContent = null) => {
                    const isDirect = typeof manualContent === 'string';
                    const content = isDirect ? manualContent : cocInput.value.trim();
                    if (!content || isGenerating.value) return;
                    if (!isDirect) cocInput.value = '';

                    const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                    // Fix: 如果是房主且未选择调查员（可能是自动重置导致的），尝试自动选择第一个
                    if (!inv && multiplayerState.isHost && cocState.investigators.length > 0) {
                        cocState.activeInvestigatorIndex = 0;
                        inv = cocState.investigators[0];
                    }

                    if (!inv) return showToast('请选择调查员', 'warning');

                    // --- 私聊处理 ---
                    if (content.startsWith('@')) {
                        const spaceIndex = content.indexOf(' ');
                        if (spaceIndex === -1) {
                            showToast('私聊格式错误，请使用 "@名字 消息内容"', 'warning');
                            if (!isDirect) cocInput.value = content;
                            return;
                        }

                        const targetName = content.substring(1, spaceIndex);
                        const msgContent = content.substring(spaceIndex + 1);
                        
                        if (!msgContent.trim()) {
                            showToast('请输入消息内容', 'warning');
                            if (!isDirect) cocInput.value = content;
                            return;
                        }

                        // 查找目标用户（优先匹配角色名，其次匹配玩家名）
                        let targetMember = null;
                        let targetCharName = null;

                        // 1. 尝试通过角色名查找
                        if (cocState.mode === 'multi') {
                            for (const [idx, uid] of Object.entries(multiplayerState.assignments)) {
                                const char = cocState.investigators[idx];
                                if (char && char.name.includes(targetName)) {
                                    targetMember = multiplayerState.members.find(m => m.id === uid);
                                    targetCharName = char.name;
                                    break;
                                }
                            }
                        }

                        // 2. 如果没找到，尝试通过玩家名查找
                        if (!targetMember) {
                            targetMember = multiplayerState.members.find(m => m.name.includes(targetName));
                        }
                        
                        if (targetMember) {
                            const displayName = targetCharName || targetMember.name;
                            // 本地显示
                            const whisperMsg = {
                                role: 'whisper',
                                name: inv.name,
                                avatar: inv.avatar,
                                content: `[对 ${displayName} 说] ${msgContent}`
                            };
                            cocState.log.push(whisperMsg);
                            scrollToBottom();

                            // 广播（只给目标和自己，或者全员可见但标记为私聊）
                            if (multiplayerState.inRoom) {
                                broadcastMessage({
                                    type: 'coc_chat',
                                    role: 'whisper',
                                    name: inv.name,
                                    avatar: inv.avatar,
                                    content: `[对 ${displayName} 说] ${msgContent}`,
                                    senderId: multiplayerState.myId,
                                    targetId: targetMember.id // 用于接收端过滤
                                });
                            }
                            cocInput.value = '';
                            return; // 私聊不触发游戏回合
                        } else {
                            showToast(`找不到名为 "${targetName}" 的玩家或角色`, 'warning');
                            if (!isDirect) cocInput.value = content;
                            return;
                        }
                    }

                    // --- 指令系统处理 ---
                    if (content.startsWith('.')) {
                        const cmdParts = content.trim().split(/\s+/);
                        const cmdType = cmdParts[0].toLowerCase(); // .ra, .sc, etc.
                        const cmdArgs = cmdParts.slice(1).join(' '); // 侦查, 1/1d3, etc.

                        // 1. 验证权限
                        // 必须在 pendingRolls 中找到匹配的 (targetName === inv.name)
                        // 且 command 类型匹配 (.ra/.rc or .sc/.san)
                        // 且如果是 .ra，技能名最好也要匹配（或者允许模糊匹配）
                        
                        const myPendingRollIndex = cocState.pendingRolls.findIndex(p => {
                            if (p.targetName !== inv.name) return false;
                            
                            // 检查指令类型
                            if ((cmdType === '.ra' || cmdType === '.rc') && (p.command === '.ra' || p.command === '.rc')) {
                                // 检查技能名 (如果 Keeper 指定了技能，玩家必须检定该技能)
                                // 简单包含检查
                                if (p.args && cmdArgs && !p.args.includes(cmdArgs) && !cmdArgs.includes(p.args)) {
                                     // 也许可以放宽一点，或者提示用户“Keeper 要求的是 xxx”
                                     return false;
                                }
                                return true;
                            }
                            if ((cmdType === '.sc' || cmdType === '.san') && (p.command === '.sc' || p.command === '.san')) {
                                return true;
                            }
                            return false;
                        });

                        if (myPendingRollIndex === -1) {
                            // 检查是否有任何针对我的检定
                            const hasAnyRoll = cocState.pendingRolls.some(p => p.targetName === inv.name);
                            if (hasAnyRoll) {
                                const req = cocState.pendingRolls.find(p => p.targetName === inv.name);
                                showToast(`指令不匹配。Keeper 要求: ${req.command} ${req.args}`, 'warning');
                            } else {
                                showToast('Keeper 未要求你进行此检定', 'warning');
                            }
                            return;
                        }

                        let systemMsg = '';
                        let logContent = '';
                        
                        // .r / .roll 简单掷骰 (暂时禁用，因为 pendingRolls 机制不支持无目标掷骰，除非 Keeper 显式允许)
                        if (content.match(/^\.(r|roll)(\s|$)/i)) {
                            // 只有当 Keeper 明确发送 @Name .r 时才允许（当前正则未捕获 .r，需扩展正则或保持禁用）
                             showToast('当前规则下仅允许响应 Keeper 的特定检定要求', 'warning');
                             return;
                        }
                        // .st / .set 属性修改 (.st hp -1 / .st san +5 / .st str 60)
                        else if (content.match(/^\.(st|set)(\s|$)/i)) {
                            // .st 指令通常由 KP (AI) 触发，或者玩家在被允许时触发
                            // 解析: .st 属性 值
                            const parts = content.split(/\s+/);
                            if (parts.length < 3) {
                                showToast('格式错误: .st 属性 值', 'warning');
                                return;
                            }
                            const prop = parts[1];
                            const valExpr = parts[2];
                            
                            const res = executeStCommand(inv, prop, valExpr);
                            if (res && res.success) {
                                systemMsg = `[系统] ${res.msg}`;
                                logContent = res.log;
                            } else {
                                showToast(res ? res.msg : '执行失败', 'error');
                                return;
                            }
                        }
                        // .sc / .san SAN Check (.sc 1/1d6)
                        else if (content.match(/^\.(sc|san)(\s|$)/i)) {
                            // 使用 Keeper 指定的参数，或者玩家输入的参数？
                            // 应该优先使用 Keeper 指定的参数，防止玩家作弊
                            const pendingReq = cocState.pendingRolls[myPendingRollIndex];
                            const args = (pendingReq && pendingReq.args) || content.split(/\s+/)[1] || ''; // 优先用 Keeper 的
                            
                            const [successLoss, failLoss] = args.split('/').map(s => s || '0');
                            
                            const val = Math.floor(Math.random() * 100) + 1;
                            const isSuccess = val <= inv.san;
                            let lossExpr = isSuccess ? successLoss : failLoss;
                            
                            // 解析扣除表达式 (如 1d6)
                            let loss = 0;
                            if (lossExpr.includes('d')) {
                                const [n, d] = lossExpr.split('d').map(Number);
                                for(let i=0; i<(n||1); i++) loss += Math.floor(Math.random()*(d||6))+1;
                            } else {
                                loss = parseInt(lossExpr) || 0;
                            }

                            const oldSan = inv.san;
                            inv.san = Math.max(0, inv.san - loss);
                            saveData(); // 保存状态变更

                            const resultStr = isSuccess ? '成功' : '失败';
                            systemMsg = `[系统] ${inv.name} 进行 SAN Check: 1d100=${val}/${oldSan} [${resultStr}]。扣除 SAN 值: ${loss} (当前: ${inv.san})。`;
                            logContent = `👻 **SAN Check ${resultStr}** (1d100=${val}/${oldSan})\n损失 ${loss} 点 SAN (当前: ${inv.san})`;
                        }
                        // .ra / .rc 技能检定 (.ra 侦查)
                        else if (content.match(/^\.(ra|rc)(\s|$)/i)) {
                            const pendingReq = cocState.pendingRolls[myPendingRollIndex];
                            const skillName = (pendingReq && pendingReq.args) || content.split(/\s+/)[1]; // 优先用 Keeper 的
                            
                            let skillVal = 0;
                            let skillLabel = skillName || '属性/技能';

                            // 属性映射表 (支持中文和英文缩写)
                            const statMap = {
                                '力量': 'STR', 'STR': 'STR',
                                '体质': 'CON', 'CON': 'CON',
                                '体型': 'SIZ', 'SIZ': 'SIZ',
                                '敏捷': 'DEX', 'DEX': 'DEX',
                                '外貌': 'APP', 'APP': 'APP',
                                '智力': 'INT', 'INT': 'INT', '灵感': 'INT',
                                '意志': 'POW', 'POW': 'POW',
                                '教育': 'EDU', 'EDU': 'EDU', '知识': 'EDU',
                                '幸运': 'LUCK', 'LUCK': 'LUCK'
                            };

                            // 查找技能或属性
                            if (skillName) {
                                // 模糊匹配技能: 精确匹配 -> 包含匹配
                                const s = inv.skills.find(k => k.name === skillName) ||
                                          inv.skills.find(k => k.name.includes(skillName) || skillName.includes(k.name));
                                          
                                if (s) {
                                    skillVal = s.value;
                                    skillLabel = s.name; // 使用找到的实际技能名
                                } else {
                                    // 尝试查找基础属性
                                    const statKey = statMap[skillName] || statMap[skillName.toUpperCase()];
                                    if (statKey && inv.stats[statKey]) {
                                        skillVal = inv.stats[statKey];
                                        skillLabel = `${skillName}(${statKey})`;
                                    } else if (inv.stats[skillName.toUpperCase()]) {
                                        // Fallback
                                        skillVal = inv.stats[skillName.toUpperCase()];
                                        skillLabel = skillName.toUpperCase();
                                    }
                                }
                            }
                            
                            const val = Math.floor(Math.random() * 100) + 1;
                            let level = '';
                            if (skillVal > 0) {
                                if (val === 1) level = '大成功';
                                else if (val === 100) level = '大失败';
                                else if (val <= skillVal / 5) level = '极难成功';
                                else if (val <= skillVal / 2) level = '困难成功';
                                else if (val <= skillVal) level = '成功';
                                else level = '失败';
                            }

                            const resultStr = skillVal > 0 ? `${level}` : '';
                            systemMsg = `[系统] ${inv.name} 进行 ${skillLabel} 检定: 1d100=${val}/${skillVal || '?'} [${resultStr}]`;
                            logContent = `🎲 **${skillLabel} ${resultStr}** (1d100=${val}/${skillVal || '?'})`;
                        }

                        if (logContent) {
                            // 检定完成后，从 pendingRolls 中移除该请求
                            cocState.pendingRolls.splice(myPendingRollIndex, 1);

                            cocState.log.push({ role: 'user', name: inv.name, avatar: inv.avatar, content });
                            cocState.log.push({ role: 'system', content: logContent });
                            scrollToBottom();

                            if (multiplayerState.inRoom) {
                                broadcastMessage({ type: 'coc_chat', role: 'user', name: inv.name, avatar: inv.avatar, content, senderId: multiplayerState.myId });
                                broadcastMessage({ type: 'coc_chat', role: 'system', content: logContent });
                                
                                // Mark self as acted (prevent duplicates)
                                if (!multiplayerState.roundActionIds.includes(user.uuid)) {
                                    multiplayerState.roundActionIds.push(user.uuid);
                                }
                                broadcastMessage({ type: 'action_taken', userId: user.uuid });
                                
                                if (multiplayerState.isHost) {
                                    checkAndTriggerRound();
                                }
                            } else {
                                generateResponse();
                            }
                            return;
                        }
                    }

                    // 普通对话
                    cocState.log.push({ role: 'user', name: inv.name, avatar: inv.avatar, content });
                    scrollToBottom();

                    if (multiplayerState.inRoom) {
                        broadcastMessage({ type: 'coc_chat', role: 'user', name: inv.name, avatar: inv.avatar, content, senderId: multiplayerState.myId });
                        
                        // 只有在【不需要检定】或者【当前已经是检定结果(但这部分逻辑在上面if块)】时，才算行动结束
                        // 如果当前 Keeper 要求我检定 (pendingRolls has me)，则普通对话不算作“完成行动”，不触发下一轮
                        const hasPending = cocState.pendingRolls.some(p => p.targetName === inv.name);
                        
                        if (!hasPending) {
                            if (!multiplayerState.roundActionIds.includes(user.uuid)) {
                                multiplayerState.roundActionIds.push(user.uuid);
                            }
                            broadcastMessage({ type: 'action_taken', userId: user.uuid });

                            if (multiplayerState.isHost) {
                                checkAndTriggerRound();
                            }
                        }
                    } else {
                        // 单人模式下，无论是否需要检定，普通对话都应触发 AI 回复，避免死锁
                        generateResponse();
                    }
                };

                const generateResponse = async () => {
                    isGenerating.value = true;
                    if (multiplayerState.inRoom && multiplayerState.isHost) {
                        broadcastMessage({ type: 'keeper_typing', status: true });
                    }
                    // 如果是流式，先创建一个空的 assistant 消息
                    const assistantMsg = {
                        role: 'assistant',
                        name: '守密人',
                        content: '',
                        showCot: false // 默认折叠 CoT
                    };
                    cocState.log.push(assistantMsg);
                    
                    try {
                        // 构建当前状态快照
                        let statusSnapshot = "【当前调查员实时状态监控】\n";
                        if (cocState.mode === 'multi') {
                            for (const [idx, uid] of Object.entries(multiplayerState.assignments)) {
                                const inv = cocState.investigators[idx];
                                if (inv) {
                                    statusSnapshot += `- ${inv.name}: HP ${inv.hp}/${inv.maxHp} | MP ${inv.mp}/${inv.maxMp} | SAN ${inv.san}/${inv.maxSan}`;
                                    if (inv.hp < inv.maxHp * 0.3) statusSnapshot += " [重伤/濒死]";
                                    if (inv.san < 30) statusSnapshot += " [精神恍惚/疯狂]";
                                    statusSnapshot += "\n";
                                }
                            }
                        } else {
                            const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                            if (inv) {
                                statusSnapshot += `- ${inv.name}: HP ${inv.hp}/${inv.maxHp} | MP ${inv.mp}/${inv.maxMp} | SAN ${inv.san}/${inv.maxSan}`;
                                if (inv.hp < inv.maxHp * 0.3) statusSnapshot += " [重伤/濒死]";
                                if (inv.san < 30) statusSnapshot += " [精神恍惚/疯狂]";
                                statusSnapshot += "\n";
                            }
                        }
                        statusSnapshot += "请根据以上状态调整你的叙事语气和描述细节。";

                        const msgs = [
                            { role: 'system', content: cocState.systemPrompt },
                            ...cocState.log.slice(0, -1).map(m => { // Exclude the empty assistant msg we just added
                                if (m.role === 'user') return { role: 'user', content: `${m.name}: ${m.content}` };
                                if (m.role === 'assistant') return { role: 'assistant', content: m.content };
                                if (m.role === 'system') return { role: 'system', content: `[系统提示] ${m.content}` };
                                return null;
                            }).filter(Boolean),
                            // 将状态快照作为最新的 System Hint 插入，确保 LLM 能看到最新的数值
                            { role: 'system', content: statusSnapshot }
                        ];

                        const res = await fetch(`${settings.apiUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: msgs,
                                temperature: settings.temperature,
                                stream: true // Enable streaming
                            })
                        });

                        if (!res.ok) {
                            if (res.status === 401) {
                                throw new Error('API Key 无效或已过期，请在设置中更新 Key');
                            }
                            throw new Error(res.statusText);
                        }

                        const reader = res.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop(); // Keep incomplete line in buffer

                            for (const line of lines) {
                                if (line.trim() === '') continue;
                                if (line.trim() === 'data: [DONE]') break;
                                if (line.startsWith('data: ')) {
                                    try {
                                        const json = JSON.parse(line.slice(6));
                                        const content = json.choices[0]?.delta?.content || '';
                                        if (content) {
                                            assistantMsg.content += content;
                                            scrollToBottom();
                                        }
                                    } catch (e) { console.error('Parse Error', e); }
                                }
                            }
                        }
                        
                        // 生成完成后，解析指令 (.ra/.sc/.st)
                        const pending = [];
                        const lines = assistantMsg.content.split('\n');
                        
                        for (const line of lines) {
                            // 1. 提取该行所有 @Name
                            const nameRegex = /@([^\s@,，.。!！?？;；:：]+)/g;
                            const names = [];
                            let nameMatch;
                            while ((nameMatch = nameRegex.exec(line)) !== null) {
                                names.push(nameMatch[1]);
                            }

                            if (names.length === 0) continue;

                            // 2. 提取该行所有指令
                            const cmdRegex = /(\.(?:ra|rc|sc|san|st|set))\s+([^\s\n,，.。!！?？;；:：\(\)（）]+)(?:\s+([^\s\n,，.。!！?？;；:：\(\)（）]+))?/gi;
                            const cmds = [];
                            let cmdMatch;
                            while ((cmdMatch = cmdRegex.exec(line)) !== null) {
                                cmds.push({
                                    command: cmdMatch[1].toLowerCase(),
                                    args: cmdMatch[2],
                                    args2: cmdMatch[3] // For .st prop val
                                });
                            }

                            // 3. 处理指令
                            if (cmds.length > 0) {
                                for (const name of names) {
                                    // Find investigator by name (fuzzy match)
                                    let targetInv = null;
                                    
                                    // Try to match name in cocState.investigators
                                    cocState.investigators.forEach((inv) => {
                                        if (inv.name.includes(name) || name.includes(inv.name)) {
                                            targetInv = inv;
                                        }
                                    });

                                    for (const cmd of cmds) {
                                        // Auto-execute .st (Secret Roll / Stat Mod)
                                        if (cmd.command === '.st' || cmd.command === '.set') {
                                            if (targetInv && cmd.args && cmd.args2) {
                                                const res = executeStCommand(targetInv, cmd.args, cmd.args2);
                                                if (res && res.success) {
                                                    // Add system log for the change
                                                    cocState.log.push({ role: 'system', content: res.log });
                                                    if (multiplayerState.inRoom && multiplayerState.isHost) {
                                                        broadcastMessage({ type: 'coc_chat', role: 'system', content: res.log });
                                                    }
                                                }
                                            }
                                        } else {
                                            // .ra / .sc go to pending
                                            pending.push({
                                                targetName: name, // Keep original name from text for display
                                                command: cmd.command,
                                                args: cmd.args
                                            });
                                        }
                                    }
                                }
                            }
                        }
                        
                        cocState.pendingRolls = pending;
                        if (pending.length > 0) {
                            const myInv = cocState.investigators[cocState.activeInvestigatorIndex];
                            // Check fuzzy match for my name
                            const isMyRoll = myInv && pending.some(p => p.targetName.includes(myInv.name) || myInv.name.includes(p.targetName));
                            
                            if (isMyRoll) showToast('Keeper 要求你进行检定', 'info');
                            else showToast(`Keeper 要求 ${[...new Set(pending.map(p=>p.targetName))].join(', ')} 进行检定`, 'info');
                        }

                        if (multiplayerState.inRoom && multiplayerState.isHost) {
                            broadcastMessage({
                                type: 'coc_chat',
                                role: 'assistant',
                                name: '守密人',
                                content: assistantMsg.content,
                                senderId: multiplayerState.myId,
                                pendingRolls: cocState.pendingRolls
                            });
                            
                            // Reset Round
                            multiplayerState.roundActionIds = [];
                            broadcastMessage({ type: 'round_reset' });
                        }

                    } catch(e) {
                        // cocState.log.pop(); // Remove failed message -> 改为显示错误状态
                        console.error('Generation Error:', e);
                        showToast('生成失败: '+e.message, 'error');
                        
                        // Update the last message to show error state
                        if (cocState.log.length > 0 && cocState.log[cocState.log.length - 1].role === 'assistant') {
                            const errorMsg = cocState.log[cocState.log.length - 1];
                            if (!errorMsg.content) {
                                errorMsg.content = `**[通讯中断]**\n\n*守密人的声音被一阵刺耳的静电噪音淹没...*\n\n(错误信息: ${e.message})`;
                            } else {
                                errorMsg.content += `\n\n**[信号丢失]**\n(错误信息: ${e.message})`;
                            }
                            
                            // Broadcast error state to clients
                            if (multiplayerState.inRoom && multiplayerState.isHost) {
                                broadcastMessage({
                                    type: 'coc_chat',
                                    role: 'assistant',
                                    name: '守密人',
                                    content: errorMsg.content,
                                    senderId: multiplayerState.myId,
                                    isError: true
                                });
                            }
                        }
                    } finally {
                        isGenerating.value = false;
                        if (multiplayerState.inRoom && multiplayerState.isHost) {
                            broadcastMessage({ type: 'keeper_typing', status: false });
                        }
                    }
                };

                // Multiplayer
                const initSupabase = () => {
                    if (!settings.supabaseUrl || !settings.supabaseKey) return showToast('请配置 Supabase', 'error');
                    try {
                        supabaseClient = window.supabase.createClient(settings.supabaseUrl, settings.supabaseKey);
                        multiplayerState.isConnected = true;
                        showToast('已连接服务器', 'success');
                        saveData();
                        fetchLibraryModules(); // Fetch modules on connect
                        
                        // Setup Global Presence & Personal Channel
                        const globalChannel = supabaseClient.channel('global_presence', { config: { presence: { key: user.uuid } } });
                        globalChannel.on('presence', { event: 'sync' }, () => {
                            const state = globalChannel.presenceState();
                            const onlineIds = new Set();
                            Object.values(state).flat().forEach(p => onlineIds.add(p.user_id));
                            friends.value.forEach(f => f.isOnline = onlineIds.has(f.uuid));
                        }).subscribe(async (status) => {
                            if (status === 'SUBSCRIBED') await globalChannel.track({ user_id: user.uuid, online_at: new Date() });
                        });

                        supabaseClient.channel(`personal:${user.uuid}`).on('broadcast', { event: 'message' }, async ({ payload }) => {
                            if (payload.type === 'invite_room') {
                                if(await showConfirm(`${payload.sender.name} 邀请你加入房间 ${payload.roomId}`, '收到邀请')) {
                                    joinRoomId.value = payload.roomId;
                                    currentView.value = 'multiplayer';
                                    joinRoom();
                                }
                            } else if (payload.type === 'friend_request') {
                                if (!friends.value.some(f=>f.uuid===payload.sender.uuid)) friendRequests.value.push(payload.sender);
                            }
                        }).subscribe();

                    } catch(e) { showToast('连接失败', 'error'); }
                };

                const createRoom = async (isLoadGame = false) => {
                    const id = Math.random().toString(36).substring(2, 8).toUpperCase();
                    
                    // Reset game state for new game
                    if (!isLoadGame) {
                        cocState.module = null;
                        cocState.investigators = [];
                        cocState.log = [];
                        cocState.systemPrompt = '';
                        cocState.pendingRolls = [];
                        cocState.activeInvestigatorIndex = -1;
                        
                        multiplayerState.assignments = {};
                        multiplayerState.assignmentDetails = {};
                        multiplayerState.turnIndex = 0;
                        multiplayerState.roundActionIds = [];
                    }

                    await joinRoom(id, true);
                };

                const joinRoom = async (id = null, asHost = false) => {
                    const roomId = id || joinRoomId.value.toUpperCase();
                    if (!roomId || !supabaseClient) return;
                    
                    if (roomChannel) await roomChannel.unsubscribe();
                    
                    // Reset local ready state when joining/re-joining
                    multiplayerState.isReady = false;
                    
                    multiplayerState.roomId = roomId;
                    multiplayerState.isHost = asHost;
                    multiplayerState.myId = user.uuid;

                    // Ensure presence key is unique (UUID) not Name
                    roomChannel = supabaseClient.channel(`room:${roomId}`, { config: { broadcast: { self: false }, presence: { key: user.uuid } } });
                    roomChannel.on('broadcast', { event: 'message' }, async ({ payload }) => {
                        if (payload.type === 'member_status') {
                            // Update local member list immediately from broadcast
                            const idx = multiplayerState.members.findIndex(m => m.id === payload.status.user_id);
                            if (idx !== -1) {
                                Object.assign(multiplayerState.members[idx], {
                                    isReady: payload.status.isReady,
                                    isHost: payload.status.is_host,
                                    name: payload.status.name,
                                    avatar: payload.status.avatar
                                });
                            }
                        } else if (payload.type === 'coc_chat') {
                            // Whisper filtering
                            if (payload.role === 'whisper') {
                                // Only show if I am the target or the sender
                                if (payload.targetId === user.uuid || payload.senderId === user.uuid) {
                                    cocState.log.push({ role: payload.role, name: payload.name, content: payload.content, avatar: payload.avatar });
                                    scrollToBottom();
                                }
                            } else {
                                cocState.log.push({ role: payload.role, name: payload.name, content: payload.content, avatar: payload.avatar });
                                // Client update pendingRolls status from Host
                                if (payload.role === 'assistant' && payload.pendingRolls !== undefined) {
                                    cocState.pendingRolls = payload.pendingRolls;
                                    // Check if I am targeted
                                    const myInv = cocState.investigators[cocState.activeInvestigatorIndex];
                                    if (myInv && cocState.pendingRolls.some(p => p.targetName === myInv.name)) {
                                        showToast('Keeper 要求你进行检定', 'info');
                                    }
                                }
                                scrollToBottom();
                            }
                        } else if (payload.type === 'action_taken') {
                            if (!multiplayerState.roundActionIds.includes(payload.userId)) {
                                multiplayerState.roundActionIds.push(payload.userId);
                            }
                            if (multiplayerState.isHost) checkAndTriggerRound();
                        } else if (payload.type === 'round_reset') {
                            multiplayerState.roundActionIds = [];
                            showToast('新的一轮开始了', 'info');
                        } else if (payload.type === 'request_cot_access' && multiplayerState.isHost) {
                            if (await showConfirm(`${payload.userName} 申请查看思维链 (CoT) 权限`, '权限申请')) {
                                grantCotAccess(payload.userId);
                            }
                        } else if (payload.type === 'grant_cot_access') {
                            multiplayerState.cotAuthorizedUsers = payload.authorizedUsers;
                            if (payload.userId === user.uuid) {
                                showToast('房主已批准您的 CoT 查看权限', 'success');
                            }
                        } else if (payload.type === 'regenerate_start' && !multiplayerState.isHost) {
                            cocState.log.pop(); // Remove last message
                            showToast('房主正在重新生成回复...', 'info');
                        } else if (payload.type === 'sync_state' && !multiplayerState.isHost) {
                            cocState.log = payload.log;
                            if (payload.moduleName) cocState.module = { name: payload.moduleName, content: 'Synced' };
                            if (payload.investigators) cocState.investigators = payload.investigators;
                            if (payload.assignments) {
                                multiplayerState.assignments = payload.assignments;
                                updateMyAssignment();
                            }
                            if (payload.assignmentDetails) multiplayerState.assignmentDetails = payload.assignmentDetails;
                            if (payload.turnIndex !== undefined) multiplayerState.turnIndex = payload.turnIndex;
                            if (payload.roundActionIds) multiplayerState.roundActionIds = payload.roundActionIds;
                            if (payload.cotAuthorizedUsers) multiplayerState.cotAuthorizedUsers = payload.cotAuthorizedUsers;
                            // If game is playing, ensure we are in chat view
                            if (payload.gameState === 'playing') {
                                cocState.gameState = 'playing';
                                currentView.value = 'chat';
                            }
                        } else if (payload.type === 'sync_module' && !multiplayerState.isHost) {
                            cocState.module = { name: payload.moduleName, content: 'Synced' };
                            showToast('房主已选择模组: ' + payload.moduleName, 'info');
                        } else if (payload.type === 'sync_investigators' && !multiplayerState.isHost) {
                            cocState.investigators = payload.investigators;
                            showToast('角色列表已更新', 'info');
                        } else if (payload.type === 'sync_assignments') {
                            multiplayerState.assignments = payload.assignments;
                            if (payload.turnIndex !== undefined) multiplayerState.turnIndex = payload.turnIndex;
                            updateMyAssignment();
                        } else if (payload.type === 'request_sync' && multiplayerState.isHost) {
                            // 响应新加入/重连玩家的同步请求
                            console.log('Received sync request from:', payload.userId);
                            broadcastMessage({
                                type: 'sync_state',
                                log: cocState.log,
                                moduleName: cocState.module?.name,
                                gameState: cocState.gameState,
                                investigators: cocState.investigators,
                                assignments: multiplayerState.assignments,
                                assignmentDetails: multiplayerState.assignmentDetails,
                                turnIndex: multiplayerState.turnIndex,
                                roundActionIds: multiplayerState.roundActionIds,
                                cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers
                            });
                        } else if (payload.type === 'claim_role' && multiplayerState.isHost) {
                            // Handle claim request from client (Resume Mode)
                            const { index, userId } = payload;
                            const reserved = multiplayerState.assignmentDetails[index];
                            // Verify again
                            // We need to find the member to check name
                            const member = multiplayerState.members.find(m => m.id === userId);
                            if (reserved && (reserved.id === userId || (member && reserved.name === member.name))) {
                                clearUserAssignments(userId); // Ensure unique assignment
                                multiplayerState.assignments[index] = userId;
                                broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments });
                            }
                        } else if (payload.type === 'request_assignment' && multiplayerState.isHost) {
                            // Host handles assignment request
                            const { index, userId } = payload;
                            
                            // Validate Turn
                            const currentTurnPlayer = multiplayerState.members[multiplayerState.turnIndex];
                            if (!currentTurnPlayer || currentTurnPlayer.id !== userId) {
                                // Not their turn
                                return;
                            }

                            // If index is -1, it's a skip turn request
                            if (index === -1) {
                                if (multiplayerState.turnIndex < multiplayerState.members.length - 1) {
                                    multiplayerState.turnIndex++;
                                }
                                broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments, turnIndex: multiplayerState.turnIndex });
                                return;
                            }

                            // Check if taken by someone else
                            const currentOwner = multiplayerState.assignments[index];
                            
                            // If already owned by requestor, do nothing (prevent re-assignment logic)
                            if (currentOwner === userId) {
                                // Just sync back to confirm (or do nothing)
                                broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments, turnIndex: multiplayerState.turnIndex });
                                return;
                            }

                            // Ensure one character per player:
                            if (!currentOwner) {
                                // Clear previous assignment for this user
                                clearUserAssignments(userId);
                                multiplayerState.assignments[index] = userId;
                                
                                // Advance turn
                                if (multiplayerState.turnIndex < multiplayerState.members.length - 1) {
                                    multiplayerState.turnIndex++;
                                }
                                
                                broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments, turnIndex: multiplayerState.turnIndex });
                            } else {
                                broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments, turnIndex: multiplayerState.turnIndex });
                            }
                        } else if (payload.type === 'game_start' && !multiplayerState.isHost) {
                            cocState.log = payload.log;
                            cocState.gameState = 'playing';
                            currentView.value = 'chat';
                            showToast('游戏开始！', 'success');
                        } else if (payload.type === 'change_mode' && !multiplayerState.isHost) {
                            cocState.mode = payload.mode;
                            currentView.value = payload.view;
                            cocState.gameState = payload.gameState;
                            showToast('房主已开始准备阶段', 'info');
                        } else if (payload.type === 'room_closed') {
                            showToast('房主已解散房间，游戏结束', 'warning');
                            leaveRoom();
                            cocState.gameState = 'idle';
                            cocState.log = [];
                            currentView.value = 'multiplayer';
                        } else if (payload.type === 'keeper_typing') {
                            isGenerating.value = payload.status;
                            scrollToBottom();
                        }
                    }).on('presence', { event: 'sync' }, () => {
                        const state = roomChannel.presenceState();
                        const flatMembers = Object.values(state).flat();
                        // Sort by online_at to ensure consistent order across clients
                        flatMembers.sort((a, b) => new Date(a.online_at) - new Date(b.online_at));
                        
                        // Check if host is missing
                        const oldHost = multiplayerState.members.find(m => m.isHost);
                        const currentHost = flatMembers.find(m => m.is_host);
                        
                        multiplayerState.members = flatMembers.map(p => ({
                            name: p.name, id: p.user_id, avatar: p.avatar, isHost: p.is_host, isReady: p.isReady, online_at: p.online_at
                        }));

                        // Host Migration Logic
                        if (oldHost && !currentHost && multiplayerState.members.length > 0) {
                            // Host left, the oldest member becomes the new host
                            const newHostCandidate = multiplayerState.members[0];
                            if (newHostCandidate.id === user.uuid) {
                                // I am the new host
                                multiplayerState.isHost = true;
                                showToast('原房主已断开连接，你已自动继任为房主', 'info');
                                
                                // Update my status in presence
                                roomChannel.track({
                                    user_id: user.uuid,
                                    name: user.name,
                                    avatar: user.avatar,
                                    is_host: true,
                                    isReady: multiplayerState.isReady,
                                    online_at: newHostCandidate.online_at // Keep original time
                                });
                                
                                // Broadcast self as new host (redundant with track but safe)
                                // Note: We don't need to explicitly broadcast 'I am host', presence update handles it for others.
                                // But we should sync state immediately to ensure consistency
                                broadcastMessage({
                                    type: 'sync_state',
                                    log: cocState.log,
                                    moduleName: cocState.module?.name,
                                    gameState: cocState.gameState,
                                    investigators: cocState.investigators,
                                    assignments: multiplayerState.assignments,
                                    assignmentDetails: multiplayerState.assignmentDetails,
                                    turnIndex: multiplayerState.turnIndex,
                                    roundActionIds: multiplayerState.roundActionIds,
                                    cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers
                                });
                            }
                        }
                        
                        // Host syncs state to new members
                        if (multiplayerState.isHost && multiplayerState.members.length > 1) {
                            broadcastMessage({
                                type: 'sync_state',
                                log: cocState.log,
                                moduleName: cocState.module?.name,
                                gameState: cocState.gameState,
                                investigators: cocState.investigators,
                                assignments: multiplayerState.assignments,
                                turnIndex: multiplayerState.turnIndex,
                                roundActionIds: multiplayerState.roundActionIds,
                                cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers
                            });
                        }
                    }).subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            multiplayerState.inRoom = true;
                            await roomChannel.track({
                                user_id: user.uuid,
                                name: user.name,
                                avatar: user.avatar,
                                is_host: asHost,
                                isReady: false,
                                online_at: new Date() // For sorting
                            });
                            showToast(`已进入房间 ${roomId}`, 'success');
                            
                            // 主动请求同步状态 (用于断线重连)
                            if (!asHost) {
                                await roomChannel.send({
                                    type: 'broadcast',
                                    event: 'message',
                                    payload: { type: 'request_sync', userId: user.uuid }
                                });
                            }
                        }
                    });
                };

                const leaveRoom = async () => {
                    if (roomChannel) await roomChannel.unsubscribe();
                    multiplayerState.inRoom = false;
                    multiplayerState.roomId = null;
                    multiplayerState.isReady = false; // Reset ready state
                    cocState.mode = null; // Exit multi mode
                };

                const broadcastMessage = async (payload) => {
                    if (roomChannel) await roomChannel.send({ type: 'broadcast', event: 'message', payload });
                };

                // Friends
                const sendSignal = async (targetUuid, type, payload) => {
                    if (!supabaseClient) return;
                    const ch = supabaseClient.channel(`personal:${targetUuid}`);
                    ch.subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            await ch.send({ type: 'broadcast', event: 'message', payload: { type, sender: { uuid: user.uuid, name: user.name }, ...payload } });
                            supabaseClient.removeChannel(ch);
                        }
                    });
                };

                const addFriend = () => {
                    if (!friendInput.value) return;
                    sendSignal(friendInput.value, 'friend_request', {});
                    showToast('已发送请求', 'info');
                    friendInput.value = '';
                };

                const acceptFriend = (req) => {
                    friends.value.push(req);
                    friendRequests.value = friendRequests.value.filter(r => r.uuid !== req.uuid);
                    saveData();
                };

                const inviteFriend = (f) => {
                    if (multiplayerState.inRoom) sendSignal(f.uuid, 'invite_room', { roomId: multiplayerState.roomId });
                    else showToast('请先创建房间', 'warning');
                };

                // Image Utils
                const handleUserAvatarUpload = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = async (ev) => {
                            user.avatar = await compressImage(ev.target.result, 200, 0.6);
                            saveData();
                        };
                        reader.readAsDataURL(file);
                    }
                };

                // Library Functions
                const fetchLibraryModules = async () => {
                    if (!supabaseClient) return;
                    libraryState.loading = true;
                    try {
                        let query = supabaseClient.from('coc_modules').select('*').order('created_at', { ascending: false });
                        if (libraryState.searchQuery) {
                            query = query.ilike('title', `%${libraryState.searchQuery}%`);
                        }
                        const { data, error } = await query;
                        if (error) throw error;
                        libraryState.modules = data;
                    } catch (err) {
                        console.error('Library Fetch Error:', err);
                        // showToast('无法获取图书馆藏书', 'error');
                    } finally {
                        libraryState.loading = false;
                    }
                };

                const uploadToLibrary = async () => {
                    if (!supabaseClient) return showToast('请先连接服务器', 'error');
                    if (!libraryState.uploadForm.title || !libraryState.uploadForm.content) return showToast('标题和内容不能为空', 'warning');
                    
                    libraryState.isUploading = true;
                    try {
                        const { error } = await supabaseClient.from('coc_modules').insert({
                            title: libraryState.uploadForm.title,
                            description: libraryState.uploadForm.description,
                            content: libraryState.uploadForm.content,
                            author_name: user.name,
                            author_id: user.uuid,
                            type: libraryState.uploadForm.type || 'original'
                        });
                        
                        if (error) {
                            // Check for missing table error (Postgres code 42P01 or generic 404 from REST)
                            if (error.code === '42P01' || (error.message && error.message.includes('404')) || (error.message && error.message.includes('Could not find the table'))) {
                                const setupSql = `-- 1. Create the table
create table if not exists coc_modules (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  title text not null,
  description text,
  content text not null,
  author_name text,
  author_id text,
  type text default 'original',
  downloads bigint default 0
);

-- 2. Enable RLS
alter table coc_modules enable row level security;

-- 3. Create policies (Check if they exist first to avoid errors if re-running)
do $$
begin
  if not exists (select 1 from pg_policies where tablename = 'coc_modules' and policyname = 'Public modules are viewable by everyone') then
    create policy "Public modules are viewable by everyone" on coc_modules for select using ( true );
  end if;
  
  if not exists (select 1 from pg_policies where tablename = 'coc_modules' and policyname = 'Anyone can upload modules') then
    create policy "Anyone can upload modules" on coc_modules for insert with check ( true );
  end if;
end
$$;

-- 4. Create function
create or replace function increment_downloads(row_id bigint) returns void as $$
begin
  update coc_modules set downloads = downloads + 1 where id = row_id;
end;
$$ language plpgsql;`;
                                console.log('Database Setup Required');
                                sqlToRun.value = setupSql;
                                showSqlModal.value = true;
                                throw new Error('数据库表缺失，请运行初始化脚本');
                            }
                            throw error;
                        }
                        
                        showToast('贡献成功，感谢您的慷慨！', 'success');
                        libraryState.showUpload = false;
                        libraryState.uploadForm = { title: '', description: '', content: '', type: 'original' };
                        fetchLibraryModules();
                    } catch (err) {
                        console.error('Upload Error:', err);
                        showToast('上传失败: ' + err.message, 'error');
                    } finally {
                        libraryState.isUploading = false;
                    }
                };

                const generateModuleSummary = async (content) => {
                    if (!content || content.length < 50) return;
                    libraryState.isSummarizing = true;
                    
                    try {
                        const msgs = [
                            { role: 'system', content: '你是一个专业的跑团模组编辑。请根据用户提供的模组内容，生成一段简短、吸引人的简介（100字以内）。重点概括模组的背景、氛围和核心谜团，不要剧透关键结局。' },
                            { role: 'user', content: `请为以下模组生成简介：\n\n${content.slice(0, 5000)}` } // Limit context window
                        ];

                        const res = await fetch(`${settings.apiUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: msgs,
                                temperature: 0.7
                            })
                        });

                        const data = await res.json();
                        if (data.choices && data.choices[0]?.message?.content) {
                            libraryState.uploadForm.description = data.choices[0].message.content.trim();
                        }
                    } catch (e) {
                        console.error('Summary Generation Error:', e);
                    } finally {
                        libraryState.isSummarizing = false;
                    }
                };

                const handleLibraryFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    const processContent = (content) => {
                        libraryState.uploadForm.content = content;
                        if(!libraryState.uploadForm.title) libraryState.uploadForm.title = file.name.replace(/\.[^/.]+$/, "");
                        if(!libraryState.uploadForm.description) generateModuleSummary(content);
                    };

                    if (file.name.endsWith('.docx')) {
                        reader.onload = (ev) => {
                            mammoth.extractRawText({ arrayBuffer: ev.target.result })
                                .then((result) => processContent(result.value));
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        reader.onload = (ev) => processContent(ev.target.result);
                        reader.readAsText(file);
                    }
                };

                const useLibraryModule = async (mod, mode) => {
                    // Try to increment download count (RPC)
                    if (supabaseClient) {
                        // Optimistic update
                        mod.downloads = (mod.downloads || 0) + 1;
                        // RPC call if exists, otherwise just ignore
                        supabaseClient.rpc('increment_downloads', { row_id: mod.id }).then(({ error }) => {
                            if (error) console.warn('Failed to increment downloads', error);
                        });
                    }
                    
                    cocState.module = { name: mod.title, content: mod.content };
                    showToast(`已借阅《${mod.title}》`, 'success');
                    
                    if (mode === 'single') {
                        selectCocMode('single');
                    } else {
                        selectCocMode('multi');
                        // If host, sync immediately
                        if (multiplayerState.isHost) {
                             broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name });
                        }
                    }
                };

                // Expose to window for inline clicks
                window.triggerCocCommand = (cmd) => sendCocMessage(cmd);

                onMounted(() => {
                    loadData();
                    checkBroadcast();
                    if (settings.supabaseUrl) initSupabase();
                });

                return {
                    currentView, showMobileMenu, showMobileRightSidebar, user, settings, toasts, confirmState,
                    showBroadcast, dontShowBroadcast, closeBroadcast,
                    cocState, cocInput, cocInputRef, cocChatContainer, isGenerating,
                    multiplayerState, showJoinInput, joinRoomId, friends, friendRequests, friendInput,
                    showMentionList, mentionCandidates, handleInput, selectMention, savedGames,
                    selectCocMode, exitCocMode, exitCocGame, startCocGame, sendCocMessage, saveGame, deleteSave, loadSave,
                    importCocModule, saveManualModule, importInvestigator, deleteInvestigator,
                    initSupabase, createRoom, joinRoom, leaveRoom, addFriend, acceptFriend, inviteFriend,
                    handleUserAvatarUpload, saveData, renderMarkdown, copyToClipboard,
                    toggleReady, allPlayersReady, handleInvestigatorClick,
                    libraryState, fetchLibraryModules, uploadToLibrary, handleLibraryFileUpload, useLibraryModule,
                    showSqlModal, sqlToRun,
                    openCocCard,
                    hasCot, getCotContent, removeCot, toggleCot, regenerateLastResponse, lastAssistantIndex,
                    statDisplayMap,
                    getPageTitle: () => {
                        switch(currentView.value) {
                            case 'coc': return '命运选择';
                            case 'saves': return '记忆回廊';
                            case 'friends': return '同伴名录';
                            case 'settings': return '设置中心';
                            case 'multiplayer': return '多重宇宙';
                            case 'library': return '密大图书馆';
                            case 'preparing': return '跑团准备';
                            default: return 'The Call of Cthulhu';
                        }
                    }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
