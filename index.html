<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zarkto's Table - TRPG</title>
    <!-- å¼•å…¥è¡¬çº¿å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Noto Serif SC"', 'SimSun', 'Songti SC', 'serif'],
                        sans: ['"Noto Serif SC"', 'system-ui', 'sans-serif'], // å¼ºåˆ¶å…¨å±€ä½¿ç”¨è¡¬çº¿ä½“é£æ ¼
                    },
                    colors: {
                        dark: {
                            950: '#020617', // Slate 950
                            900: '#0a0f1e', // Deep Void
                            850: '#141b2d', // Lighter Void
                            800: '#1e293b', // Slate 800
                            700: '#334155', // Slate 700
                        },
                        mystic: {
                            gold: '#d4af37', // æ›´åŠ é²œäº®çš„æš—é‡‘
                            gold_dim: '#8a7120',
                            green: '#2d6a4f', // æ·±ç»¿
                            teal: '#115e59', // è“ç»¿
                            red: '#8a1c1c', // è¡€çº¢
                            purple: '#581c87', // æ·±ç´«
                        }
                    },
                    boxShadow: {
                        'glow-gold': '0 0 15px rgba(212, 175, 55, 0.15)',
                        'glow-green': '0 0 15px rgba(45, 106, 79, 0.2)',
                        'inner-glow': 'inset 0 0 20px rgba(0,0,0,0.5)',
                    },
                    backgroundImage: {
                        'void-noise': "url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22 opacity=%220.07%22/%3E%3C/svg%3E')",
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'message-in': 'messageIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        messageIn: { '0%': { transform: 'translateY(15px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } },
                    }
                }
            }
        }
    </script>
    <style>
        html, body {
            -webkit-text-size-adjust: 100%;
            height: 100%;
            height: 100dvh; /* ç§»åŠ¨ç«¯é«˜åº¦ä¿®å¤ */
            overflow: hidden;
            background-color: #020617;
            color: #cbd5e1;
            font-family: 'Noto Serif SC', serif;
        }
        /* Global Noise Overlay */
        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 50;
            opacity: 0.4;
        }

        [v-cloak] { display: none !important; }
        
        /* Custom Scrollbar - Antique Style */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; border-left: 1px solid #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border: 1px solid #0f172a; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; border-color: #d4af37; }
        
        /* Text Effects */
        .text-shadow-gold { text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
        .text-shadow-red { text-shadow: 0 0 10px rgba(138, 28, 28, 0.4); }
        
        /* Markdown Styles (Dark) */
        .markdown-body { font-size: 0.95rem; line-height: 1.7; color: #e2e8f0; font-family: 'Noto Serif SC', serif; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body strong { font-weight: 700; color: #c0a062; } /* Gold highlight */
        .markdown-body blockquote { border-left: 2px solid #2d6a4f; padding-left: 1em; color: #94a3b8; font-style: italic; background: rgba(0,0,0,0.2); padding: 0.5em 1em; }
        .markdown-body code { background-color: #1e293b; padding: 0.1em 0.3em; border-radius: 0.2em; font-family: monospace; font-size: 0.9em; color: #c0a062; border: 1px solid #334155; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin-bottom: 0.8em; }
        .markdown-body li { margin-bottom: 0.3em; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: #c0a062; font-family: 'Noto Serif SC', serif; margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; }
        .markdown-body h1 { font-size: 1.5em; border-bottom: 1px solid #334155; padding-bottom: 0.2em; }
        .markdown-body h2 { font-size: 1.3em; }
        
        /* Typing Indicator */
        .typing-indicator { display: flex; align-items: center; gap: 4px; }
        .typing-indicator span { display: block; width: 4px; height: 4px; background-color: #5eead4; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        /* Transitions */
        .list-enter-active, .list-leave-active { transition: all 0.4s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(-20px); }
        
        /* Utilities */
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .nav-active { background: linear-gradient(90deg, rgba(20, 184, 166, 0.15) 0%, transparent 100%); border-left: 3px solid #14b8a6; color: #ccfbf1; }

        /* Safe Area Support */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }

        /* CoT Styles */
        .cot-wrapper {
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
            background: rgba(2, 6, 23, 0.3);
            margin-bottom: 1rem;
        }
        .cot-header {
            padding: 0.5rem 0.75rem;
            background: rgba(30, 41, 59, 0.4);
            cursor: pointer;
            font-size: 0.75rem;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
        }
        .cot-header:hover {
            background: rgba(30, 41, 59, 0.6);
            color: #94a3b8;
        }
        .cot-header.active {
            border-bottom-color: rgba(148, 163, 184, 0.1);
        }
        .cot-content {
            padding: 1rem;
            background: rgba(15, 23, 42, 0.4);
            font-size: 0.85rem;
            color: #94a3b8;
            font-family: 'Noto Serif SC', serif;
            line-height: 1.6;
        }
        
        /* CoT Tree View Optimization */
        .cot-content ul {
            list-style: none;
            padding-left: 1rem;
            margin: 0;
            position: relative;
        }
        
        /* Medal Styles */
        .medal-icon {
            filter: drop-shadow(0 0 5px rgba(212, 175, 55, 0.3));
            transition: transform 0.3s;
        }
        .medal-icon:hover {
            transform: scale(1.1) rotate(5deg);
        }
        .cot-content ul li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .cot-content ul li::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0.7em;
            width: 1rem;
            height: 1px;
            background-color: #475569;
            opacity: 0.5;
        }
        .cot-content ul li::after {
            content: "";
            position: absolute;
            left: 0;
            top: -0.6em;
            bottom: 0;
            width: 1px;
            background-color: #475569;
            opacity: 0.5;
        }
        .cot-content ul li:last-child::after {
            height: 1.3em;
        }
        /* Root level ul shouldn't have line from top if it's the start */
        .cot-content > ul > li:first-child::after {
            top: 0.7em;
            height: calc(100% - 0.7em);
        }
        .cot-content code {
            background: rgba(0,0,0,0.3);
            color: #e2e8f0;
            padding: 0.1em 0.3em;
            border-radius: 0.2em;
            font-size: 0.9em;
        }
    </style>
</head>
<body class="selection:bg-teal-900 selection:text-teal-100">
    <div id="app" v-cloak class="h-full flex flex-col md:flex-row relative bg-dark-950 text-slate-300">
        
        <!-- Toast Notification -->
        <div class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[1000] flex flex-col gap-2 pointer-events-none items-center w-full max-w-sm px-4 safe-pt">
            <transition-group name="list" tag="div" class="flex flex-col items-center w-full">
                <div v-for="toast in toasts" :key="toast.id"
                     class="pointer-events-auto flex items-center px-4 py-3 rounded-xl shadow-2xl border bg-dark-900/95 backdrop-blur-md text-sm font-medium w-full"
                     :class="{
                        'border-mystic-green/50 text-mystic-green': toast.type === 'success',
                        'border-mystic-red/50 text-red-400': toast.type === 'error',
                        'border-blue-500/50 text-blue-400': toast.type === 'info',
                        'border-mystic-gold/50 text-mystic-gold': toast.type === 'warning'
                     }">
                    <span class="flex-1">{{ toast.message }}</span>
                </div>
            </transition-group>
        </div>

        <!-- Custom Confirm Modal -->
        <div v-if="confirmState.show" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in safe-pt safe-pb">
            <div class="bg-dark-900 border border-mystic-gold/50 rounded-lg shadow-[0_0_30px_rgba(212,175,55,0.15)] max-w-sm w-full flex flex-col relative overflow-hidden transform transition-all scale-100">
                <!-- Header Decoration -->
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-mystic-gold to-transparent opacity-50"></div>
                
                <div class="p-6">
                    <h3 class="text-xl font-bold text-mystic-gold font-serif mb-3 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        {{ confirmState.title || 'ç¡®è®¤æ“ä½œ' }}
                    </h3>
                    <p class="text-slate-300 text-sm leading-relaxed mb-6 font-serif">
                        {{ confirmState.message }}
                    </p>
                    <div class="flex justify-end gap-3">
                        <button @click="confirmState.resolve(false); confirmState.show = false" class="px-4 py-2 text-slate-400 hover:text-slate-200 text-sm font-bold transition-colors">
                            {{ confirmState.cancelText || 'å–æ¶ˆ' }}
                        </button>
                        <button @click="confirmState.resolve(true); confirmState.show = false" class="px-6 py-2 bg-mystic-gold text-dark-950 font-bold rounded shadow-lg hover:bg-yellow-600 transition-all text-sm uppercase tracking-wide">
                            {{ confirmState.confirmText || 'ç¡®å®š' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Confirm Modal -->
        <div v-if="confirmState.show" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in safe-pt safe-pb">
            <div class="bg-dark-900 border border-mystic-gold/50 rounded-lg shadow-[0_0_30px_rgba(212,175,55,0.15)] max-w-sm w-full flex flex-col relative overflow-hidden transform transition-all scale-100">
                <!-- Header Decoration -->
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-mystic-gold to-transparent opacity-50"></div>
                
                <div class="p-6">
                    <h3 class="text-xl font-bold text-mystic-gold font-serif mb-3 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        {{ confirmState.title || 'ç¡®è®¤æ“ä½œ' }}
                    </h3>
                    <p class="text-slate-300 text-sm leading-relaxed mb-6 font-serif">
                        {{ confirmState.message }}
                    </p>
                    <div class="flex justify-end gap-3">
                        <button @click="confirmState.resolve(false); confirmState.show = false" class="px-4 py-2 text-slate-400 hover:text-slate-200 text-sm font-bold transition-colors">
                            {{ confirmState.cancelText || 'å–æ¶ˆ' }}
                        </button>
                        <button @click="confirmState.resolve(true); confirmState.show = false" class="px-6 py-2 bg-mystic-gold text-dark-950 font-bold rounded shadow-lg hover:bg-yellow-600 transition-all text-sm uppercase tracking-wide">
                            {{ confirmState.confirmText || 'ç¡®å®š' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settlement Modal -->
        <div v-if="settlementState.show" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-fade-in safe-pt safe-pb">
            <div class="bg-dark-900 border border-mystic-gold/50 rounded-xl shadow-[0_0_50px_rgba(212,175,55,0.2)] max-w-2xl w-full flex flex-col relative overflow-hidden max-h-[90vh]">
                <!-- Header -->
                <div class="p-6 border-b border-dark-800 bg-gradient-to-r from-mystic-gold/10 to-transparent flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-mystic-gold font-serif flex items-center gap-3">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        ç»“å›¢å¥–åŠ±ç»“ç®—
                    </h3>
                    <button @click="settlementState.show = false" class="text-slate-500 hover:text-slate-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-8">
                    <!-- Step 1: Inputs -->
                    <div v-if="settlementState.step === 1" class="space-y-6 animate-slide-up">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">æ¨¡ç»„åç§°</label>
                            <input v-model="settlementState.moduleName" class="w-full bg-dark-950 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-mystic-gold outline-none">
                        </div>
                        
                        <div class="p-4 bg-dark-800/50 rounded border border-dark-700">
                            <h4 class="text-sm font-bold text-mystic-green mb-4 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                SAN å€¼å›å¤
                            </h4>
                            <div class="flex gap-4 items-center">
                                <input v-model="settlementState.sanRewardExpr" placeholder="1d6" class="w-24 bg-dark-950 border border-dark-700 rounded px-3 py-2 text-center font-mono text-slate-300 focus:border-mystic-green outline-none">
                                <button @click="rollSanReward" class="px-4 py-2 bg-mystic-green/20 text-mystic-green border border-mystic-green/30 rounded font-bold text-xs hover:bg-mystic-green/30 transition-all">ğŸ² æŠ•æ·</button>
                                <div class="flex-1 text-right">
                                    <span class="text-xs text-slate-500 mr-2">å›å¤é‡:</span>
                                    <span class="text-2xl font-bold text-mystic-green font-mono">{{ settlementState.sanRewardVal }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-dark-800/50 rounded border border-dark-700">
                            <h4 class="text-sm font-bold text-mystic-gold mb-4 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                æŠ€èƒ½æˆé•¿æ£€å®š
                            </h4>
                            <p class="text-xs text-slate-500 mb-3">è¯·å‹¾é€‰æœ¬æ¬¡æ¨¡ç»„ä¸­æˆåŠŸä½¿ç”¨è¿‡çš„æŠ€èƒ½ï¼š</p>
                            <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1">
                                <label v-for="skill in cocState.investigators[cocState.activeInvestigatorIndex].skills" :key="skill.name"
                                       class="cursor-pointer px-3 py-1.5 rounded border text-xs transition-all select-none flex items-center gap-2"
                                       :class="settlementState.selectedSkills.includes(skill.name) ? 'bg-mystic-gold text-dark-950 border-mystic-gold font-bold' : 'bg-dark-950 text-slate-400 border-dark-700 hover:border-slate-500'">
                                    <input type="checkbox" v-model="settlementState.selectedSkills" :value="skill.name" class="hidden">
                                    {{ skill.name }} ({{ skill.value }})
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">ç‰¹æ®Šå¥–åŠ± (ç‰©å“/äººè„‰)</label>
                                <textarea v-model="settlementState.specialReward" rows="3" class="w-full bg-dark-950 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-mystic-gold outline-none resize-none text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-widest">å±¥å†æ‘˜è¦</label>
                                <textarea v-model="settlementState.historyLog" rows="3" class="w-full bg-dark-950 border border-dark-700 rounded px-4 py-2 text-slate-200 focus:border-mystic-gold outline-none resize-none text-sm"></textarea>
                            </div>
                        </div>

                        <div class="p-4 bg-dark-800/50 rounded border border-dark-700 flex gap-4 items-center">
                            <div class="w-12 h-12 bg-dark-950 rounded-full border border-mystic-gold/30 flex items-center justify-center text-2xl cursor-pointer hover:bg-dark-900 relative">
                                <input v-model="settlementState.badge.icon" class="w-full h-full text-center bg-transparent outline-none cursor-pointer" title="è¾“å…¥Emoji">
                            </div>
                            <div class="flex-1 space-y-2">
                                <input v-model="settlementState.badge.name" placeholder="å‹‹ç« åç§° (å¦‚: å¹¸å­˜è€…)" class="w-full bg-dark-950 border-b border-dark-700 px-2 py-1 text-sm text-mystic-gold font-bold focus:border-mystic-gold outline-none">
                                <input v-model="settlementState.badge.desc" placeholder="å‹‹ç« æè¿°" class="w-full bg-transparent px-2 py-1 text-xs text-slate-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Rolling & Result -->
                    <div v-if="settlementState.step >= 2" class="space-y-4 animate-fade-in">
                        <div v-if="settlementState.isRolling" class="text-center py-10">
                            <div class="typing-indicator justify-center mb-4"><span></span><span></span><span></span></div>
                            <p class="text-mystic-gold font-serif">å‘½è¿ä¹‹è½®æ­£åœ¨è½¬åŠ¨...</p>
                        </div>
                        <div v-else class="space-y-2">
                            <div v-for="res in settlementState.skillGrowths" :key="res.name"
                                 class="flex items-center justify-between p-3 rounded border"
                                 :class="res.success ? 'bg-mystic-green/10 border-mystic-green/30' : 'bg-dark-950 border-dark-700 opacity-60'">
                                <div class="font-bold text-slate-200">{{ res.name }}</div>
                                <div class="flex items-center gap-4 text-sm font-mono">
                                    <span class="text-slate-500">1d100={{ res.checkVal }} / {{ res.oldVal }}</span>
                                    <span :class="res.success ? 'text-mystic-green font-bold' : 'text-slate-600'">{{ res.success ? 'æˆé•¿æˆåŠŸ' : 'æˆé•¿å¤±è´¥' }}</span>
                                    <div v-if="res.success" class="flex items-center gap-1 text-mystic-gold font-bold">
                                        <span>+{{ res.growth }}</span>
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                                        <span>{{ res.newVal }}</span>
                                    </div>
                                </div>
                            </div>
                            <div v-if="settlementState.skillGrowths.length === 0" class="text-center text-slate-500 italic py-4">
                                æ²¡æœ‰é€‰æ‹©éœ€è¦æˆé•¿çš„æŠ€èƒ½
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-6 border-t border-dark-800 bg-dark-900/80 flex justify-between items-center">
                    <div class="text-xs text-slate-500">
                        <span v-if="settlementState.step === 1">ç¬¬ä¸€æ­¥ï¼šè¾“å…¥å¥–åŠ±ä¸é€‰æ‹©æŠ€èƒ½</span>
                        <span v-if="settlementState.step === 2">ç¬¬äºŒæ­¥ï¼šæˆé•¿æ£€å®š</span>
                        <span v-if="settlementState.step === 3">ç¬¬ä¸‰æ­¥ï¼šç¡®è®¤ç»“æœ</span>
                    </div>
                    <div class="flex gap-3">
                        <button v-if="settlementState.step === 1" @click="processSkillGrowth" class="px-6 py-2 bg-mystic-gold text-dark-950 font-bold rounded shadow-lg hover:bg-yellow-600 transition-all text-sm">
                            å¼€å§‹æ£€å®š
                        </button>
                        <button v-if="settlementState.step === 3" @click="confirmSettlement" class="px-6 py-2 bg-mystic-green text-teal-100 font-bold rounded shadow-lg hover:bg-teal-700 transition-all text-sm">
                            ç¡®è®¤æ›´æ–°è§’è‰²å¡
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Sidebar Overlay -->
        <div v-if="showMobileMenu" @click="showMobileMenu = false" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-20 md:hidden transition-opacity"></div>

        <!-- Sidebar -->
        <div :class="['fixed inset-y-0 left-0 z-30 w-72 bg-dark-900 border-r border-dark-800 transform transition-transform duration-300 md:relative md:translate-x-0 flex flex-col shadow-2xl bg-void-noise', showMobileMenu ? 'translate-x-0' : '-translate-x-full']">
            <div class="h-24 flex items-center px-6 border-b border-dark-800 bg-dark-950/50 backdrop-blur-sm relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-b from-mystic-gold/5 to-transparent pointer-events-none"></div>
                <div class="font-bold text-xl text-mystic-gold flex items-center tracking-wider relative z-10 text-shadow-gold">
                    <!-- Cthulhu Icon -->
                    <svg class="w-8 h-8 mr-3 text-mystic-gold animate-pulse-slow" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8 c0-4.41,3.59-8,8-8s8,3.59,8,8C20,16.41,16.41,20,12,20z M12,6c-3.31,0-6,2.69-6,6c0,1.36,0.46,2.61,1.23,3.62l1.46-1.46 C8.26,13.61,8,12.84,8,12c0-2.21,1.79-4,4-4s4,1.79,4,4c0,0.84-0.26,1.61-0.69,2.16l1.46,1.46C17.54,14.61,18,13.36,18,12 C18,8.69,15.31,6,12,6z M12,10c-1.1,0-2,0.9-2,2c0,0.55,0.22,1.05,0.59,1.41l2.83-2.83C13.05,10.22,12.55,10,12,10z"/></svg>
                    <div class="flex flex-col">
                        <span class="leading-none">Call of</span>
                        <span class="text-2xl leading-none font-serif">Cthulhu</span>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto py-6 px-4 space-y-3">
                <button @click="currentView = 'chat'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'chat' ? 'bg-mystic-green/10 border-mystic-green/40 text-mystic-green shadow-glow-green' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-mystic-green/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    <span class="relative z-10">è†å¬ä½è¯­</span>
                </button>
                <button @click="if(cocState.gameState !== 'playing') { currentView = 'coc'; showMobileMenu = false; }" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'coc' ? 'bg-mystic-gold/10 border-mystic-gold/40 text-mystic-gold shadow-glow-gold' : (cocState.gameState === 'playing' ? 'opacity-50 cursor-not-allowed text-slate-600 border-transparent' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700')]">
                    <div class="absolute inset-0 bg-gradient-to-r from-mystic-gold/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="relative z-10">ä»ªå¼å‡†å¤‡</span>
                </button>
                <button @click="currentView = 'saves'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'saves' ? 'bg-indigo-900/20 border-indigo-500/30 text-indigo-400' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-indigo-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    <span class="relative z-10">è®°å¿†å›å»Š</span>
                <button @click="currentView = 'friends'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'friends' ? 'bg-blue-900/20 border-blue-500/30 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <span class="relative z-10">è°ƒæŸ¥å‘˜åå•</span>
                </button>
                <button @click="openCocCard" class="w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700">
                    <div class="absolute inset-0 bg-gradient-to-r from-mystic-purple/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span class="relative z-10">è°ƒæŸ¥å‘˜é›‡ä½£</span>
                </button>
                <button @click="currentView = 'library'; showMobileMenu = false" :class="['w-full flex items-center px-4 py-3.5 rounded-lg transition-all duration-300 font-bold tracking-wide border group relative overflow-hidden', currentView === 'library' ? 'bg-purple-900/20 border-purple-500/30 text-purple-400' : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-dark-800 hover:border-dark-700']">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <svg class="w-5 h-5 mr-3 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    <span class="relative z-10">å¯†å¤§å›¾ä¹¦é¦†</span>
                </button>
            </div>

            <div class="p-4 border-t border-dark-800 bg-dark-950/50 cursor-pointer hover:bg-dark-800 transition-colors group safe-pb" @click="currentView = 'settings'; showMobileMenu = false">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full overflow-hidden shadow-lg ring-2 ring-dark-700">
                        <img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover grayscale-[30%]">
                        <div v-else class="w-full h-full bg-dark-800 flex items-center justify-center text-mystic-gold font-bold border border-dark-700">
                            {{ user.name.charAt(0).toUpperCase() }}
                        </div>
                    </div>
                    <div class="ml-3 overflow-hidden">
                        <div class="text-sm font-bold text-slate-300 truncate">{{ user.name }}</div>
                        <div class="text-xs text-slate-500 truncate font-mono">{{ user.uuid ? 'ID: ' + user.uuid.slice(0,6) + '...' : 'æ¸¸å®¢' }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Broadcast Modal (Zarkto's Old Broadcast) -->
        <div v-if="showBroadcast" class="fixed inset-0 z-[300] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
            <div class="bg-dark-900 border border-mystic-gold/50 rounded-xl shadow-[0_0_50px_rgba(212,175,55,0.15)] max-w-lg w-full flex flex-col relative overflow-hidden">
                <!-- Decorative Header Background -->
                <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-mystic-gold/10 to-transparent pointer-events-none"></div>
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-mystic-gold/5 rounded-full blur-3xl pointer-events-none"></div>
                
                <div class="p-6 md:p-8 relative z-10">
                    <h3 class="text-2xl font-bold text-mystic-gold font-serif mb-2 flex items-center gap-3">
                        <svg class="w-8 h-8 animate-pulse-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                        æ‰å…‹æ‰˜çš„æ—§æ—¥å¹¿æ’­
                    </h3>
                    <div class="text-xs text-slate-500 font-mono mb-6 uppercase tracking-widest border-b border-dark-700 pb-2 flex justify-between">
                        <span>Frequency: 192.8 MHz</span>
                        <span>Ver 1.0</span>
                    </div>
                    
                    <div class="prose prose-invert prose-sm max-w-none text-slate-300 font-serif leading-relaxed mb-6 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                        <p>æ¬¢è¿æ¥åˆ° <strong>Zarkto's Table</strong> (Ver 1.0)ã€‚</p>
                        <p class="text-mystic-gold font-bold">ç›®å‰æœ¬ç½‘ç«™åªæœ‰cocè·‘å›¢åŠŸèƒ½ã€‚</p>
                        <p>è¿™é‡Œæ˜¯ä¸º TRPG çˆ±å¥½è€…æ‰“é€ çš„è·‘å›¢ä¸­å¿ƒã€‚ç›®å‰ï¼Œæ‚¨å¯ä»¥ä½“éªŒä»¥ä¸‹åŠŸèƒ½ï¼š</p>
                        <ul class="list-disc pl-4 space-y-1 marker:text-mystic-gold">
                            <li><strong>è†å¬ä½è¯­</strong>ï¼šä¸ AI Keeper è¿›è¡Œå•äººè·‘å›¢ï¼Œæˆ–ä½œä¸ºæˆ¿ä¸»ä¸»æŒæ¸¸æˆã€‚</li>
                            <li><strong>ä»ªå¼å‡†å¤‡</strong>ï¼šé€‰æ‹©æ¨¡ç»„ï¼Œåˆ›å»ºæˆ–å¯¼å…¥è°ƒæŸ¥å‘˜ã€‚</li>
                            <li><strong>è®°å¿†å›å»Š</strong>ï¼šä¿å­˜å’Œè¯»å–æ‚¨çš„è·‘å›¢è®°å½•ã€‚</li>
                            <li><strong>è°ƒæŸ¥å‘˜é›‡ä½£</strong>ï¼šä½¿ç”¨å…¨æ–°çš„è½¦å¡å™¨åˆ›å»ºæ‚¨çš„è§’è‰²ã€‚</li>
                            <li><strong>å¤šäººè”æœº</strong>ï¼šä¸æœ‹å‹ä»¬å»ºç«‹è¿æ¥ï¼Œå…±åŒæ¢ç´¢æœªçŸ¥ã€‚</li>
                        </ul>
                        <p class="mt-4 text-slate-400 italic">
                            æ›´å¤šåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼ŒåŒ…æ‹¬â€œå¯†å¤§å›¾ä¹¦é¦†â€æ¨¡ç»„åº“ç­‰ã€‚
                        </p>
                        <div class="mt-6 p-4 bg-mystic-gold/5 border border-mystic-gold/20 rounded-lg text-xs text-mystic-gold/80">
                            â€œæœ¬ç½‘ç«™å°šå¤„äºæµ‹è¯•é˜¶æ®µï¼Œè®¸å¤šåŠŸèƒ½å°šæœªå®Œå…¨ï¼Œæœ‰ä»»ä½•é—®é¢˜å¯ä»¥è”ç³»å¼€å‘è€…æœ¬äººï¼Œæ¬¢è¿å¤§å®¶ç§¯æåé¦ˆã€‚â€
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-4 border-t border-dark-700">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" v-model="dontShowBroadcast" class="checkbox checkbox-xs border-slate-600 checked:border-mystic-gold checked:bg-mystic-gold rounded-sm transition-all" />
                            <span class="text-xs text-slate-500 group-hover:text-slate-300 transition-colors select-none">ä¸å†æ”¶å¬æ­¤é¢‘æ®µ</span>
                        </label>
                        <button @click="closeBroadcast" class="px-6 py-2 bg-mystic-gold hover:bg-yellow-600 text-dark-900 font-bold rounded shadow-lg shadow-mystic-gold/20 transition-all text-sm font-serif">
                            å…³é—­é€šè®¯
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden relative bg-black/20">
            <!-- Background Decoration -->
            <div class="absolute inset-0 pointer-events-none overflow-hidden flex items-center justify-center opacity-5">
                <svg class="w-[800px] h-[800px] text-mystic-gold animate-pulse-slow" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8 c0-4.41,3.59-8,8-8s8,3.59,8,8C20,16.41,16.41,20,12,20z M12,6c-3.31,0-6,2.69-6,6c0,1.36,0.46,2.61,1.23,3.62l1.46-1.46 C8.26,13.61,8,12.84,8,12c0-2.21,1.79-4,4-4s4,1.79,4,4c0,0.84-0.26,1.61-0.69,2.16l1.46,1.46C17.54,14.61,18,13.36,18,12 C18,8.69,15.31,6,12,6z M12,10c-1.1,0-2,0.9-2,2c0,0.55,0.22,1.05,0.59,1.41l2.83-2.83C13.05,10.22,12.55,10,12,10z"/>
                </svg>
            </div>
            
            <!-- Mobile Header -->
            <div v-if="cocState.gameState !== 'playing'" class="md:hidden min-h-14 py-2 bg-dark-900 border-b border-dark-800 flex items-center justify-between px-4 z-10 flex-shrink-0 safe-pt">
                <button @click="showMobileMenu = !showMobileMenu" class="text-slate-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <div class="font-bold text-mystic-gold font-serif tracking-wider truncate mx-2">{{ getPageTitle() }}</div>
                <div class="w-6"></div> <!-- Spacer -->
            </div>

            <!-- Views -->
            
            <!-- 1. Chat View (New) -->
            <div v-if="currentView === 'chat'" class="flex-1 flex flex-col h-full bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                <div v-if="cocState.gameState !== 'playing'" class="flex-1 flex items-center justify-center text-slate-500 font-serif italic">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 text-dark-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        <p>æš‚æ— è¿›è¡Œä¸­çš„è·‘å›¢ä¼šè¯</p>
                        <button @click="currentView = 'coc'" class="mt-4 px-4 py-2 bg-dark-800 border border-dark-600 rounded hover:border-mystic-gold hover:text-mystic-gold transition-colors text-sm">å‰å¾€å¼€å§‹è·‘å›¢</button>
                    </div>
                </div>
                <div v-else class="flex-1 flex flex-col h-full overflow-hidden relative">
                        <!-- Game Header -->
                        <div class="min-h-16 py-2 bg-dark-950/80 backdrop-blur-md border-b border-dark-800 flex items-center justify-between px-4 md:px-6 z-10 shadow-2xl flex-shrink-0 relative safe-pt">
                            <div class="absolute inset-0 bg-gradient-to-r from-mystic-gold/5 via-transparent to-transparent pointer-events-none"></div>
                            <div class="flex items-center gap-4 overflow-hidden relative z-10">
                                <button @click="showMobileMenu = !showMobileMenu" class="md:hidden text-slate-400 flex-shrink-0 hover:text-mystic-gold transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                                </button>
                                <div class="flex flex-col">
                                    <div class="text-[10px] text-mystic-gold/60 uppercase tracking-[0.2em] font-bold">å½“å‰æ¨¡ç»„</div>
                                    <div class="font-bold text-mystic-gold truncate max-w-[200px] md:max-w-[400px] font-serif tracking-wide text-lg text-shadow-gold">{{ cocState.module?.name || 'æœªå‘½åæ¨¡ç»„' }}</div>
                                </div>
                                <!-- Player Preview (Top Bar) -->
                                <div v-if="cocState.mode === 'multi' && multiplayerState.members.length > 0" class="hidden md:flex items-center -space-x-2 ml-6 border-l border-dark-700 pl-6 py-1">
                                    <div v-for="member in multiplayerState.members" :key="member.id"
                                         class="w-8 h-8 rounded-full border-2 bg-dark-800 overflow-hidden relative group cursor-help transition-all z-0 hover:z-10 hover:scale-110"
                                         :class="member.isHost ? 'border-mystic-gold shadow-[0_0_8px_rgba(212,175,55,0.6)] z-10' : 'border-slate-400'"
                                         :title="member.name + (member.isHost ? ' (æˆ¿ä¸»)' : '')">
                                        <img v-if="member.avatar" :src="member.avatar" class="w-full h-full object-cover">
                                        <div v-else class="w-full h-full flex items-center justify-center text-xs font-bold text-slate-500">{{ member.name.charAt(0) }}</div>
                                        <!-- Status Dot -->
                                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full border-2 border-dark-950"
                                             :class="member.isReady || member.isHost ? 'bg-mystic-green' : 'bg-slate-500'"></div>
                                    </div>
                                    <div v-if="multiplayerState.members.length > 5" class="w-8 h-8 rounded-full border-2 border-slate-400 bg-dark-800 flex items-center justify-center text-[10px] text-slate-400 font-bold">
                                        +{{ multiplayerState.members.length - 5 }}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 relative z-10">
                                <!-- Room ID Display (Multiplayer Only) -->
                                <div v-if="cocState.mode === 'multi'" class="hidden md:flex items-center gap-2 mr-2 px-3 py-1.5 rounded border border-dark-700 bg-dark-900/50 cursor-pointer hover:bg-dark-800 hover:border-mystic-gold/30 transition-all group" @click="copyToClipboard(multiplayerState.roomId)" title="ç‚¹å‡»å¤åˆ¶æˆ¿é—´å·">
                                    <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">æˆ¿é—´å·</span>
                                    <span class="text-xs text-mystic-gold font-mono font-bold">{{ multiplayerState.roomId }}</span>
                                    <svg class="w-3 h-3 text-slate-600 group-hover:text-mystic-gold transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                </div>

                                <button @click="showMobileRightSidebar = !showMobileRightSidebar" class="md:hidden p-2 text-slate-400 hover:text-mystic-gold transition-colors rounded-lg border border-transparent hover:border-dark-700 hover:bg-dark-800">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                </button>
                                <button v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" @click="saveGame" class="group flex items-center gap-2 px-3 py-1.5 rounded border border-indigo-900/30 bg-indigo-900/10 hover:bg-indigo-900/20 hover:border-indigo-500/50 transition-all mr-2">
                                    <span class="text-[10px] text-indigo-400 group-hover:text-indigo-300 uppercase font-bold tracking-widest">ä¿å­˜</span>
                                    <svg class="w-3 h-3 text-indigo-500/70 group-hover:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                                </button>
                                <button @click="exitCocGame" class="group flex items-center gap-2 px-3 py-1.5 rounded border border-red-900/30 bg-red-900/10 hover:bg-red-900/20 hover:border-red-500/50 transition-all">
                                    <span class="text-[10px] text-red-400 group-hover:text-red-300 uppercase font-bold tracking-widest">é€€å‡º</span>
                                    <svg class="w-3 h-3 text-red-500/70 group-hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                </button>
                            </div>
                        </div>
    
                        <div class="flex-1 flex overflow-hidden relative">
                            <!-- Chat Log -->
                            <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-4 custom-scrollbar scroll-smooth" ref="cocChatContainer">
                                <div v-for="(msg, index) in cocState.log" :key="index" class="flex w-full animate-message-in group" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                                    
                                    <!-- User Message -->
                                    <!-- User Message -->
                                    <div v-if="msg.role === 'user' || msg.role === 'whisper'" class="flex flex-row-reverse max-w-[90%] md:max-w-[80%] gap-2 md:gap-4 ml-auto mb-2">
                                        <div class="flex-shrink-0 mt-1">
                                            <div class="w-8 h-8 md:w-10 md:h-10 rounded bg-dark-800 overflow-hidden border border-slate-600 shadow-lg group-hover:border-mystic-gold/50 transition-colors">
                                                <img v-if="msg.avatar" :src="msg.avatar" class="w-full h-full object-cover">
                                                <div v-else class="w-full h-full flex items-center justify-center text-slate-500 font-bold text-xs md:text-sm font-serif">{{ (msg.name || 'P').charAt(0) }}</div>
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-end min-w-0">
                                            <div class="text-[10px] text-slate-500 mb-1 mr-1 font-mono tracking-wider uppercase opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-2">
                                                {{ msg.name }}
                                                <span v-if="msg.role === 'whisper'" class="text-purple-400 bg-purple-900/20 px-1 rounded text-[9px] border border-purple-900/30">ç§è¯­</span>
                                            </div>
                                            <div class="px-3 py-2 md:px-4 md:py-3 rounded-2xl rounded-tr-none border shadow-xl relative overflow-hidden"
                                                 :class="msg.role === 'whisper' ? 'bg-purple-900/10 border-purple-500/20 text-purple-200' : 'bg-dark-800 border-dark-700 text-slate-200'">
                                                <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>
                                                <div class="markdown-body relative z-10" v-html="renderMarkdown(msg.content)"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Keeper Message -->
                                    <div v-else-if="msg.role === 'assistant'" class="flex max-w-[95%] md:max-w-[85%] gap-2 md:gap-4 mr-auto mb-2">
                                        <div class="flex-shrink-0 mt-1">
                                            <div class="w-8 h-8 md:w-10 md:h-10 rounded bg-dark-900 overflow-hidden border border-mystic-gold/30 shadow-[0_0_15px_rgba(204,164,59,0.15)]">
                                                <div class="w-full h-full flex items-center justify-center bg-dark-950 text-mystic-gold">
                                                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-start min-w-0">
                                            <div class="text-[10px] text-mystic-gold mb-1 ml-1 font-mono tracking-widest uppercase font-bold flex items-center gap-2">
                                                å®ˆå¯†äºº (Keeper)
                                                <span class="w-8 h-[1px] bg-mystic-gold/30"></span>
                                            </div>
                                            <div class="p-4 md:p-6 rounded-2xl rounded-tl-none bg-dark-900/80 border border-mystic-gold/20 text-slate-300 shadow-2xl relative overflow-hidden backdrop-blur-sm">
                                                <div class="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-mystic-gold/40 to-transparent"></div>
                                                
                                                <!-- CoT Rendering -->
                                                <div v-if="hasCot(msg.content)" class="cot-wrapper">
                                                    <div class="cot-header" @click="toggleCot(index)" :class="{ active: msg.showCot }">
                                                        <span class="flex items-center gap-2">
                                                            <svg class="w-3.5 h-3.5" :class="msg.showCot ? 'rotate-90' : ''" style="transition: transform 0.2s" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                                            é˜¿æ’’æ‰˜æ–¯çš„ä½è¯­ (Whispers of Azathoth)
                                                        </span>
                                                        <span class="text-[10px] opacity-50 font-mono">Forbidden Knowledge</span>
                                                    </div>
                                                    <div v-show="msg.showCot" class="cot-content markdown-body" v-html="renderMarkdown(getCotContent(msg.content))"></div>
                                                </div>

                                                <div class="markdown-body relative z-10 font-serif leading-loose" v-html="renderMarkdown(removeCot(msg.content))"></div>
                                                
                                                <!-- In-Bubble Loading Indicator -->
                                                <div v-if="isGenerating && index === cocState.log.length - 1 && !removeCot(msg.content)" class="typing-indicator py-1">
                                                    <span class="bg-mystic-gold/60"></span>
                                                    <span class="bg-mystic-gold/60"></span>
                                                    <span class="bg-mystic-gold/60"></span>
                                                </div>
                                            </div>
                                            
                                            <!-- Regenerate Button (Attached to Bubble) -->
                                            <div v-if="index === lastAssistantIndex && (cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)) && !isGenerating" class="mt-2 animate-fade-in">
                                                <button @click="regenerateLastResponse" class="flex items-center gap-1.5 px-3 py-1 bg-dark-800/80 border border-mystic-gold/30 rounded-full text-[10px] text-mystic-gold hover:bg-mystic-gold hover:text-dark-900 transition-all shadow-lg backdrop-blur-sm group opacity-80 hover:opacity-100">
                                                    <svg class="w-3 h-3 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                                    å›æº¯/é‡æ–°ç”Ÿæˆ
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- System Message -->
                                    <div v-else class="flex w-full justify-center my-2">
                                        <div class="bg-dark-950/80 border border-dark-800 px-4 py-2 rounded text-xs text-slate-500 font-mono flex items-center gap-3 shadow-inner max-w-[90%]">
                                            <span class="w-1.5 h-1.5 rounded-full bg-slate-600"></span>
                                            <div class="markdown-body !text-xs !text-slate-500" v-html="renderMarkdown(msg.content)"></div>
                                        </div>
                                    </div>

                                </div>
                                
                                <div v-if="isGenerating && cocState.log[cocState.log.length-1]?.role !== 'assistant'" class="flex w-full justify-start animate-message-in gap-2 md:gap-4 mr-auto mb-2">
                                    <!-- Keeper Avatar for Loading State -->
                                    <div class="flex-shrink-0 mt-1">
                                        <div class="w-8 h-8 md:w-10 md:h-10 rounded bg-dark-900 overflow-hidden border border-mystic-gold/30 shadow-[0_0_15px_rgba(204,164,59,0.15)]">
                                            <div class="w-full h-full flex items-center justify-center bg-dark-950 text-mystic-gold">
                                                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-start min-w-0">
                                        <div class="text-[10px] text-mystic-gold mb-1 ml-1 font-mono tracking-widest uppercase font-bold flex items-center gap-2">
                                            å®ˆå¯†äºº (Keeper)
                                            <span class="w-8 h-[1px] bg-mystic-gold/30"></span>
                                        </div>
                                        <div class="px-6 py-4 rounded-2xl rounded-tl-none bg-dark-900/50 border border-dark-700/50 shadow-inner flex items-center justify-center">
                                            <div class="typing-indicator">
                                                <span></span>
                                                <span></span>
                                                <span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
    
                            <!-- Mobile Right Sidebar Overlay -->
                            <div v-if="showMobileRightSidebar" @click="showMobileRightSidebar = false" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-20 md:hidden transition-opacity"></div>

                            <!-- Sidebar Info (Desktop & Mobile) -->
                            <div :class="['fixed inset-y-0 right-0 z-30 w-72 bg-dark-900 border-l border-dark-800 transform transition-transform duration-300 md:relative md:translate-x-0 flex flex-col shadow-2xl md:shadow-none overflow-y-auto safe-pb', showMobileRightSidebar ? 'translate-x-0' : 'translate-x-full']">
                                <div v-if="cocState.activeInvestigatorIndex !== -1 && cocState.investigators[cocState.activeInvestigatorIndex]" class="p-5">
                                    <div class="flex flex-col items-center mb-6 relative">
                                        <div class="w-20 h-20 rounded bg-dark-800 overflow-hidden mb-3 border-2 border-dark-700 shadow-xl">
                                            <img v-if="cocState.investigators[cocState.activeInvestigatorIndex].avatar" :src="cocState.investigators[cocState.activeInvestigatorIndex].avatar" class="w-full h-full object-cover">
                                            <div v-else class="w-full h-full flex items-center justify-center text-2xl font-bold text-dark-600 font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].name.charAt(0) }}</div>
                                        </div>
                                        <div class="font-bold text-lg font-serif text-mystic-gold">{{ cocState.investigators[cocState.activeInvestigatorIndex].name }}</div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 text-center mb-6">
                                        <div class="bg-red-900/10 p-2 rounded border border-red-900/20"><div class="text-[10px] text-red-500/70 tracking-widest mb-1">HP</div><div class="font-bold text-red-500 text-lg font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].hp }}</div></div>
                                        <div class="bg-blue-900/10 p-2 rounded border border-blue-900/20"><div class="text-[10px] text-blue-500/70 tracking-widest mb-1">MP</div><div class="font-bold text-blue-500 text-lg font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].mp }}</div></div>
                                        <div class="bg-purple-900/10 p-2 rounded border border-purple-900/20"><div class="text-[10px] text-purple-500/70 tracking-widest mb-1">SAN</div><div class="font-bold text-purple-500 text-lg font-serif">{{ cocState.investigators[cocState.activeInvestigatorIndex].san }}</div></div>
                                    </div>
    
                                    <!-- Stats -->
                                    <div class="mb-6" v-if="cocState.investigators[cocState.activeInvestigatorIndex].stats">
                                        <h4 class="font-bold text-slate-500 text-[10px] mb-3 border-b border-dark-800 pb-1 uppercase tracking-widest">åŸºç¡€å±æ€§</h4>
                                        <div class="grid grid-cols-4 gap-2">
                                            <div v-for="(val, key) in cocState.investigators[cocState.activeInvestigatorIndex].stats" :key="key"
                                                 class="bg-dark-800 p-1.5 rounded text-center cursor-pointer hover:bg-mystic-gold/10 hover:text-mystic-gold transition-colors border border-transparent hover:border-mystic-gold/30"
                                                 @click="cocInput = `.ra ${key}`" title="ç‚¹å‡»æ£€å®š">
                                                <div class="text-[10px] text-slate-500 uppercase font-bold mb-0.5">{{ statDisplayMap[key] || key }}</div>
                                                <div class="font-bold text-sm text-slate-300 font-mono">{{val}}</div>
                                            </div>
                                        </div>
                                    </div>
    
                                    <!-- Skills -->
                                    <div class="mb-6" v-if="cocState.investigators[cocState.activeInvestigatorIndex].skills">
                                        <h4 class="font-bold text-slate-500 text-[10px] mb-3 border-b border-dark-800 pb-1 uppercase tracking-widest">æŠ€èƒ½åˆ—è¡¨</h4>
                                        <div class="flex flex-wrap gap-1.5 max-h-60 overflow-y-auto custom-scrollbar pr-1">
                                            <span v-for="skill in cocState.investigators[cocState.activeInvestigatorIndex].skills.filter(s => s.value > 0)" :key="skill.name"
                                                  class="px-2 py-1 bg-dark-800 rounded text-xs text-slate-400 border border-dark-700 cursor-pointer hover:bg-mystic-green/10 hover:text-mystic-green hover:border-mystic-green/30 transition-colors select-none"
                                                  @click="cocInput = `.ra ${skill.name}`" title="ç‚¹å‡»æ£€å®š">
                                                {{ skill.name }} <span class="font-bold text-slate-300 ml-1">{{ skill.value }}</span>
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Badges & History -->
                                    <div class="mb-6" v-if="cocState.investigators[cocState.activeInvestigatorIndex].badges && cocState.investigators[cocState.activeInvestigatorIndex].badges.length > 0">
                                        <h4 class="font-bold text-slate-500 text-[10px] mb-3 border-b border-dark-800 pb-1 uppercase tracking-widest">å‹‹ç« å¢™</h4>
                                        <div class="flex flex-wrap gap-2">
                                            <div v-for="(badge, bIdx) in cocState.investigators[cocState.activeInvestigatorIndex].badges" :key="bIdx"
                                                 class="group relative w-8 h-8 flex items-center justify-center bg-dark-800 rounded-full border border-mystic-gold/30 cursor-help">
                                                <span class="text-lg medal-icon">{{ badge.icon || 'ğŸ…' }}</span>
                                                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-32 p-2 bg-dark-950 border border-mystic-gold/20 rounded text-[10px] text-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                                                    <div class="font-bold text-mystic-gold">{{ badge.name }}</div>
                                                    <div class="text-slate-400 mt-1">{{ badge.desc }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-4 pt-4 border-t border-dark-800">
                                        <button @click="openSettlement" class="w-full py-2 bg-gradient-to-r from-mystic-gold/10 to-transparent border border-mystic-gold/30 rounded text-mystic-gold text-xs font-bold uppercase tracking-widest hover:bg-mystic-gold/20 transition-all flex items-center justify-center gap-2 group">
                                            <svg class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            ç»“å›¢ / å¥–åŠ±ç»“ç®—
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Input -->
                        <div class="p-4 bg-dark-900 border-t border-dark-800 z-20 relative safe-pb">
                            <!-- Mention Auto-complete List -->
                            <div v-if="showMentionList && mentionCandidates.length > 0" class="absolute bottom-full left-4 mb-2 w-64 bg-dark-800 border border-dark-600 rounded-lg shadow-2xl overflow-hidden z-50 animate-fade-in">
                                <div class="text-[10px] bg-dark-900 px-3 py-1 text-slate-500 uppercase tracking-widest font-bold border-b border-dark-700">æåŠ (Mention)</div>
                                <div class="max-h-48 overflow-y-auto custom-scrollbar">
                                    <div v-for="(candidate, idx) in mentionCandidates" :key="idx"
                                         @click="selectMention(candidate)"
                                         class="px-3 py-2 flex items-center gap-3 hover:bg-mystic-gold/10 cursor-pointer transition-colors group border-b border-dark-700/50 last:border-0">
                                        <div class="w-6 h-6 rounded bg-dark-700 overflow-hidden flex-shrink-0 border border-dark-600 group-hover:border-mystic-gold/50">
                                            <img v-if="candidate.avatar" :src="candidate.avatar" class="w-full h-full object-cover">
                                            <div v-else class="w-full h-full flex items-center justify-center text-[10px] font-bold text-slate-500">{{ candidate.name.charAt(0) }}</div>
                                        </div>
                                        <div class="flex flex-col min-w-0">
                                            <span class="text-sm font-bold text-slate-300 group-hover:text-mystic-gold truncate">{{ candidate.name }}</span>
                                            <span class="text-[10px] text-slate-500 truncate">{{ candidate.type === 'character' ? 'è§’è‰²' : 'ç©å®¶' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="max-w-4xl mx-auto flex gap-3">
                                <textarea v-model="cocInput"
                                          ref="cocInputRef"
                                          @input="handleInput"
                                          @keydown.enter.prevent="sendCocMessage"
                                          @keydown.esc="showMentionList = false"
                                          :placeholder="cocState.mode === 'multi' && multiplayerState.roundActionIds.includes(user.uuid) ? 'æœ¬è½®å·²è¡ŒåŠ¨ï¼Œç­‰å¾…å…¶ä»–ç©å®¶...' : 'ä½ çš„è¡ŒåŠ¨...'"
                                          :disabled="cocState.mode === 'multi' && multiplayerState.roundActionIds.includes(user.uuid)"
                                          class="flex-1 bg-dark-800 rounded-lg px-4 py-3 resize-none border border-dark-700 focus:ring-1 focus:ring-mystic-gold focus:border-mystic-gold focus:bg-dark-900 text-slate-200 placeholder-slate-600 transition-all h-[56px] custom-scrollbar disabled:opacity-50 disabled:cursor-not-allowed"></textarea>
                                <button @click="sendCocMessage"
                                        :disabled="!cocInput.trim() || isGenerating || (cocState.mode === 'multi' && multiplayerState.roundActionIds.includes(user.uuid))"
                                        class="w-[56px] h-[56px] bg-dark-800 hover:bg-mystic-gold hover:text-dark-950 text-mystic-gold border border-mystic-gold/50 rounded-lg flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed transition-all shadow-lg group">
                                    <svg class="w-6 h-6 transform rotate-90 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- 2. COC Mode Selection View -->
            <div v-if="currentView === 'coc'" class="flex-1 flex flex-col overflow-hidden relative">
                <div class="flex-1 overflow-y-auto p-4 md:p-8 flex items-center justify-center animate-fade-in">
                    <div class="max-w-5xl w-full">
                        <h2 class="text-3xl md:text-4xl font-bold text-mystic-gold mb-10 text-center tracking-wider font-serif">é€‰æ‹©ä½ çš„å‘½è¿</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div @click="selectCocMode('single')" class="group glass-panel p-8 rounded border border-dark-700 hover:border-mystic-gold hover:bg-dark-800/50 transition-all cursor-pointer relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <svg class="w-32 h-32 text-mystic-gold" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
                                </div>
                                <div class="relative z-10">
                                    <div class="w-16 h-16 bg-dark-900 text-mystic-gold border border-dark-700 rounded flex items-center justify-center mb-6 shadow-lg group-hover:shadow-mystic-gold/20 transition-shadow">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    </div>
                                    <h3 class="text-2xl font-bold mb-3 text-slate-200 group-hover:text-mystic-gold transition-colors font-serif">å•äººæ¨¡å¼</h3>
                                    <p class="text-slate-500 text-sm leading-relaxed">ç‹¬è‡ªé¢å¯¹æœªçŸ¥çš„ææƒ§ã€‚ç”± AI æ‹…ä»» Keeper (å®ˆå¯†äºº)ï¼Œä¸ºä½ ç¼–ç»‡ä¸€åœºä¸“å±çš„å™©æ¢¦ã€‚</p>
                                </div>
                            </div>
                            <div @click="selectCocMode('multi')" class="group glass-panel p-8 rounded border border-dark-700 hover:border-mystic-green hover:bg-dark-800/50 transition-all cursor-pointer relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <svg class="w-32 h-32 text-mystic-green" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                                </div>
                                <div class="relative z-10">
                                    <div class="w-16 h-16 bg-dark-900 text-mystic-green border border-dark-700 rounded flex items-center justify-center mb-6 shadow-lg group-hover:shadow-mystic-green/20 transition-shadow">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    </div>
                                    <h3 class="text-2xl font-bold mb-3 text-slate-200 group-hover:text-mystic-green transition-colors font-serif">å¤šäººè”æœº</h3>
                                    <p class="text-slate-500 text-sm leading-relaxed">ä¸è°ƒæŸ¥å‘˜åŒä¼´ä»¬ç»„é˜Ÿã€‚éœ€å…ˆåœ¨â€œå¤šäººè”æœºâ€é¡µé¢å»ºç«‹è¿æ¥ã€‚</p>
                                    <div class="mt-4 inline-flex items-center text-xs font-bold px-3 py-1 rounded border" :class="multiplayerState.inRoom ? 'bg-mystic-green/10 text-mystic-green border-mystic-green/30' : 'bg-red-900/10 text-red-400 border-red-900/30'">
                                        {{ multiplayerState.inRoom ? `å·²è¿æ¥: ${multiplayerState.roomId}` : 'æœªè¿æ¥æˆ¿é—´' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Preparing View (Shared for Single/Multi) -->
            <div v-if="currentView === 'preparing'" class="flex-1 overflow-y-auto p-4 md:p-6 animate-fade-in">
                <div class="flex items-center mb-8 border-b border-dark-800 pb-4">
                    <button @click="exitCocMode" class="mr-4 p-2 bg-dark-800 border border-dark-700 rounded text-slate-400 hover:text-slate-200 hover:border-slate-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <h2 class="text-2xl font-bold text-mystic-gold font-serif">è·‘å›¢å‡†å¤‡</h2>
                </div>

                <div class="max-w-4xl mx-auto space-y-8">
                    <!-- Module (Host Only in Multi) -->
                    <div class="glass-panel p-6 rounded-lg">
                        <h3 class="font-bold text-slate-200 mb-6 flex items-center font-serif text-lg">
                            <span class="w-1 h-6 bg-mystic-gold mr-3"></span>
                            æ¨¡ç»„æ¡£æ¡ˆ
                        </h3>
                        
                        <!-- Host or Single Mode -->
                        <div v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)">
                            <div v-if="!cocState.module" class="flex flex-col gap-6">
                                <label class="w-full h-48 border border-dashed border-slate-600 hover:border-mystic-gold bg-dark-900/30 hover:bg-dark-800/50 rounded-lg cursor-pointer flex flex-col items-center justify-center text-slate-400 transition-all group relative overflow-hidden">
                                    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')] opacity-20"></div>
                                    <svg class="w-12 h-12 mb-4 text-slate-600 group-hover:text-mystic-gold transition-colors transform group-hover:scale-110 duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    <span class="font-serif text-lg tracking-widest group-hover:text-mystic-gold transition-colors">å¯¼å…¥æ¨¡ç»„æ¡£æ¡ˆ</span>
                                    <span class="text-xs text-slate-600 mt-2 font-mono">(.txt, .md, .docx, .json)</span>
                                    <input type="file" accept=".json,.txt,.md,.docx,.doc" @change="importCocModule" class="hidden">
                                </label>
                                
                                <div class="relative flex items-center py-2">
                                    <div class="flex-grow border-t border-dark-700"></div>
                                    <span class="flex-shrink-0 mx-4 text-slate-600 text-xs font-serif tracking-widest uppercase">æˆ–</span>
                                    <div class="flex-grow border-t border-dark-700"></div>
                                </div>
    
                                <div class="relative group">
                                    <textarea v-model="cocState.tempModuleText" placeholder="åœ¨æ­¤ç²˜è´´æ¨¡ç»„å†…å®¹..." class="w-full h-40 p-6 rounded-lg bg-dark-900/50 border border-dark-700 text-sm text-slate-300 focus:border-mystic-gold/50 focus:bg-dark-900 focus:ring-1 focus:ring-mystic-gold/50 outline-none resize-none font-serif leading-relaxed transition-all placeholder-slate-700"></textarea>
                                    <div class="absolute bottom-4 right-4">
                                        <button @click="saveManualModule" :disabled="!cocState.tempModuleText" class="px-6 py-2 bg-dark-800 text-mystic-gold border border-mystic-gold/30 hover:bg-mystic-gold hover:text-dark-900 rounded transition-all font-bold disabled:opacity-0 disabled:cursor-not-allowed text-sm tracking-widest uppercase shadow-lg hover:shadow-mystic-gold/20">
                                            ç¡®è®¤å½•å…¥
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="bg-dark-800/50 p-5 rounded border border-dark-700 flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-mystic-gold text-lg font-serif mb-1">{{ cocState.module.name }}</h4>
                                    <p class="text-xs text-slate-500 font-mono">{{ cocState.module.content.length }} chars</p>
                                </div>
                                <button @click="cocState.module = null" class="text-dark-400 hover:text-red-500 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Guest in Multi Mode -->
                        <div v-else class="text-center py-8 border border-dark-800 border-dashed rounded bg-dark-900/30">
                            <div v-if="cocState.module" class="text-mystic-gold font-bold font-serif text-xl">{{ cocState.module.name }}</div>
                            <div v-else class="text-slate-500 italic">ç­‰å¾…æˆ¿ä¸»é€‰æ‹©æ¨¡ç»„...</div>
                        </div>
                    </div>

                    <!-- Investigators -->
                    <div class="glass-panel p-6 rounded-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none">
                            <svg class="w-40 h-40 text-mystic-green" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                        </div>
                        <div class="flex justify-between items-center mb-6 relative z-10">
                            <h3 class="font-bold text-slate-200 flex items-center font-serif text-lg">
                                <span class="w-1 h-6 bg-mystic-green mr-3 shadow-[0_0_10px_rgba(45,106,79,0.5)]"></span>
                                è°ƒæŸ¥å‘˜åå†Œ
                            </h3>
                            
                            <div v-if="cocState.mode === 'multi' && multiplayerState.members.length > 0" class="flex-1 flex items-center justify-center gap-4 mx-4">
                                <div class="text-center text-xs font-bold uppercase tracking-wider">
                                    <span v-if="multiplayerState.members[multiplayerState.turnIndex]?.id === user.uuid" class="text-mystic-gold animate-pulse">
                                        å½“å‰è½®æ¬¡ï¼šè½®åˆ°ä½ äº†ï¼è¯·é€‰æ‹©è§’è‰²
                                    </span>
                                    <span v-else class="text-slate-500">
                                        å½“å‰è½®æ¬¡ï¼šç­‰å¾… {{ multiplayerState.members[multiplayerState.turnIndex]?.name || 'Unknown' }} é€‰æ‹©...
                                    </span>
                                </div>
                            </div>

                            <label v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" class="text-xs px-4 py-2 bg-dark-800 hover:bg-mystic-green hover:text-dark-900 border border-dark-600 hover:border-mystic-green rounded cursor-pointer transition-all text-slate-300 font-bold uppercase tracking-wide shadow-lg">
                                å¯¼å…¥ (.json/.png)
                                <input type="file" accept=".json,.png" @change="importInvestigator" class="hidden">
                            </label>
                        </div>
                        
                        <div v-if="cocState.investigators.length === 0" class="text-center py-12 text-slate-600 border border-dark-800 border-dashed rounded bg-dark-900/30 font-serif italic">
                            æš‚æ— è°ƒæŸ¥å‘˜è®°å½•... ä¹Ÿè®¸ä»–ä»¬éƒ½å·²è¿·å¤±åœ¨æ—¶ç©ºè£‚éš™ä¸­ã€‚
                        </div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-4 relative z-10">
                            <div v-for="(inv, index) in cocState.investigators" :key="index"
                                    class="relative p-4 rounded border transition-all cursor-pointer flex gap-4 group overflow-hidden"
                                    :class="[
                                        cocState.activeInvestigatorIndex === index ? 'border-mystic-green bg-mystic-green/10 shadow-glow-green' : 'border-dark-700 bg-dark-800/40 hover:border-slate-500 hover:bg-dark-800',
                                        multiplayerState.assignments[index] && multiplayerState.assignments[index] !== user.uuid ? 'opacity-50' : ''
                                    ]"
                                    @click="handleInvestigatorClick(index)">
                                <div class="absolute inset-0 bg-gradient-to-r from-mystic-green/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="w-16 h-16 rounded bg-dark-900 flex-shrink-0 overflow-hidden border border-dark-600 group-hover:border-slate-400 transition-colors shadow-lg relative">
                                    <img v-if="inv.avatar" :src="inv.avatar" class="w-full h-full object-cover grayscale-[20%] group-hover:grayscale-0 transition-all duration-500">
                                    <div v-else class="w-full h-full flex items-center justify-center text-slate-600 font-serif font-bold text-2xl">{{ inv.name.charAt(0) }}</div>
                                </div>
                                <div class="flex-1 min-w-0 flex flex-col justify-center relative z-10">
                                    <div class="font-bold truncate text-slate-200 font-serif text-lg group-hover:text-mystic-green transition-colors">{{ inv.name }}</div>
                                    <div class="text-xs text-slate-500 flex gap-2 mt-1.5 font-mono">
                                        <span class="text-red-400 bg-red-900/20 px-1.5 py-0.5 rounded border border-red-900/30">HP: {{inv.hp}}</span>
                                        <span class="text-blue-400 bg-blue-900/20 px-1.5 py-0.5 rounded border border-blue-900/30">SAN: {{inv.san}}</span>
                                    </div>
                                    <!-- Assignment Status -->
                                    <div v-if="cocState.mode === 'multi'" class="mt-2 text-[10px] font-bold uppercase tracking-widest flex items-center gap-1">
                                        <template v-if="multiplayerState.assignments[index]">
                                            <span class="w-1.5 h-1.5 rounded-full" :class="multiplayerState.assignments[index] === user.uuid ? 'bg-mystic-green' : 'bg-slate-500'"></span>
                                            <span :class="multiplayerState.assignments[index] === user.uuid ? 'text-mystic-green' : 'text-slate-500'">
                                                {{ multiplayerState.assignments[index] === user.uuid ? 'å·²é€‰æ‹© (ä½ )' : 'å·²è¢«å ç”¨' }}
                                            </span>
                                        </template>
                                        <template v-else-if="multiplayerState.assignmentDetails && multiplayerState.assignmentDetails[index]">
                                            <span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span>
                                            <span class="text-yellow-500">
                                                ç­‰å¾…å½’ä½: {{ multiplayerState.assignmentDetails[index].name }}
                                            </span>
                                        </template>
                                    </div>
                                </div>
                                <button v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)" @click.stop="deleteInvestigator(index)" class="text-dark-600 hover:text-red-500 transition-colors self-start relative z-10 p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Ready Status (Multiplayer) -->
                    <div v-if="cocState.mode === 'multi'" class="glass-panel p-6 rounded-lg">
                        <h3 class="font-bold text-slate-200 mb-4 flex items-center font-serif text-lg">
                            <span class="w-1 h-6 bg-blue-500 mr-3"></span>
                            å°é˜ŸçŠ¶æ€
                        </h3>
                        <div class="space-y-2">
                            <div v-for="member in multiplayerState.members" :key="member.id" class="flex items-center justify-between p-3 bg-dark-800/50 rounded border border-dark-700">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded bg-dark-700 flex items-center justify-center font-bold text-xs text-slate-500">{{ member.name.charAt(0) }}</div>
                                    <span class="font-serif text-slate-300">{{ member.name }}</span>
                                    <span v-if="member.isHost" class="text-[10px] bg-mystic-gold/10 text-mystic-gold border border-mystic-gold/20 px-2 py-0.5 rounded uppercase">æˆ¿ä¸»</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span v-if="member.isReady" class="text-xs text-mystic-green font-bold flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        å·²å‡†å¤‡
                                    </span>
                                    <span v-else class="text-xs text-slate-600 font-mono">å‡†å¤‡ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end pt-4 gap-4">
                        <button v-if="cocState.mode === 'multi' && !multiplayerState.isHost"
                                @click="toggleReady"
                                :class="['px-10 py-4 font-bold font-serif tracking-widest rounded shadow-lg transition-all border', multiplayerState.isReady ? 'bg-mystic-green/20 text-mystic-green border-mystic-green' : 'bg-dark-800 text-slate-400 border-dark-600 hover:bg-dark-700']">
                            {{ multiplayerState.isReady ? 'å·²å‡†å¤‡' : 'å‡†å¤‡å°±ç»ª' }}
                        </button>
                        <button v-if="cocState.mode === 'single' || (cocState.mode === 'multi' && multiplayerState.isHost)"
                                @click="startCocGame"
                                :disabled="cocState.mode === 'multi' && !allPlayersReady"
                                class="px-10 py-4 bg-gradient-to-r from-mystic-green to-teal-900 text-teal-100 font-bold font-serif tracking-widest rounded shadow-lg hover:shadow-mystic-green/30 transition-all border border-mystic-green/50 disabled:opacity-50 disabled:cursor-not-allowed">
                            å¼€å§‹è·‘å›¢
                        </button>
                    </div>
                </div>
            </div>
            <!-- 2. Settings View -->
            <div v-if="currentView === 'settings'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-2xl font-bold mb-8 text-mystic-gold font-serif">è®¾ç½®ä¸­å¿ƒ</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            
                            <!-- Left Column: User Profile -->
                            <div class="glass-panel p-8 rounded-lg shadow-xl h-fit">
                                <h3 class="font-bold text-lg mb-8 flex items-center text-slate-200 font-serif">
                                    <span class="w-1 h-5 bg-mystic-gold mr-3"></span>
                                    è°ƒæŸ¥å‘˜æ¡£æ¡ˆ
                                </h3>
                                
                                <div class="flex flex-col items-center mb-8">
                                    <div class="w-32 h-32 rounded-full overflow-hidden border-2 border-dark-600 shadow-2xl mb-4 relative group cursor-pointer ring-2 ring-transparent hover:ring-mystic-gold/50 transition-all" @click="$refs.avatarInput.click()">
                                        <img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 filter brightness-90 group-hover:brightness-100">
                                        <div v-else class="w-full h-full bg-dark-900 flex items-center justify-center text-5xl text-mystic-gold font-serif font-bold">
                                            {{ user.name.charAt(0).toUpperCase() }}
                                        </div>
                                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-[1px]">
                                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                        </div>
                                    </div>
                                    <input type="file" ref="avatarInput" @change="handleUserAvatarUpload" class="hidden" accept="image/*">
                                    <button @click="$refs.avatarInput.click()" class="text-xs tracking-widest text-mystic-gold font-bold hover:text-white bg-dark-800 border border-dark-600 hover:bg-dark-700 px-6 py-2 rounded transition-colors uppercase">æ›´æ¢å¤´åƒ</button>
                                </div>
                                
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-2 ml-1 uppercase tracking-widest">ä»£å· (Codename)</label>
                                        <input v-model="user.name" @change="saveData" class="w-full bg-dark-900 border-dark-700 border rounded px-4 py-3 focus:ring-1 focus:ring-mystic-gold focus:bg-dark-800 focus:border-mystic-gold transition-all font-serif text-slate-200 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-2 ml-1 uppercase tracking-widest">èº«ä»½æ ‡è¯† (UID)</label>
                                        <div class="relative group">
                                            <input :value="user.uuid" readonly class="w-full bg-dark-900 border-dark-700 border rounded px-4 py-3 text-sm font-mono text-slate-500 select-all outline-none">
                                            <button @click="copyToClipboard(user.uuid)" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-slate-600 hover:text-mystic-gold hover:bg-dark-800 rounded transition-all opacity-0 group-hover:opacity-100" title="å¤åˆ¶ ID">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Right Column: System Settings -->
                            <div class="space-y-6">
                                <div class="glass-panel p-8 rounded-lg shadow-xl">
                                    <h3 class="font-bold text-lg mb-6 flex items-center text-slate-200 font-serif">
                                        <span class="w-1 h-5 bg-mystic-green mr-3"></span>
                                        LLM é€šè®¯åè®®
                                    </h3>
                                    <div class="space-y-5">
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-2 ml-1 uppercase tracking-widest">API åœ°å€ (Endpoint)</label>
                                            <input v-model="settings.apiUrl" @change="saveData" placeholder="https://api.example.com" class="w-full bg-dark-900 border-dark-700 border rounded px-4 py-3 focus:ring-1 focus:ring-mystic-green focus:bg-dark-800 focus:border-mystic-green transition-all outline-none text-slate-300 font-mono text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-2 ml-1 uppercase tracking-widest">å¯†é’¥ (Key)</label>
                                            <input v-model="settings.apiKey" type="password" @change="saveData" placeholder="sk-..." class="w-full bg-dark-900 border-dark-700 border rounded px-4 py-3 focus:ring-1 focus:ring-mystic-green focus:bg-dark-800 focus:border-mystic-green transition-all outline-none font-mono text-sm text-slate-300">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-2 ml-1 uppercase tracking-widest">æ¨¡å‹ ID (Model)</label>
                                            <input v-model="settings.model" @change="saveData" placeholder="gpt-4-turbo" class="w-full bg-dark-900 border-dark-700 border rounded px-4 py-3 focus:ring-1 focus:ring-mystic-green focus:bg-dark-800 focus:border-mystic-green transition-all outline-none font-mono text-sm text-slate-300">
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                    </div>
                </div>
            </div>

            <!-- 3. Multiplayer View -->
                <div v-if="currentView === 'multiplayer'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                    <h2 class="text-2xl font-bold mb-8 text-mystic-gold font-serif">å¤šé‡å®‡å®™è¿æ¥</h2>
                    <div class="max-w-xl mx-auto glass-panel rounded-lg shadow-2xl p-8 border border-dark-700">
                        <div v-if="!multiplayerState.isConnected">
                            <h3 class="text-xl font-bold mb-6 text-center text-slate-200 font-serif">å»ºç«‹æ˜Ÿä¹‹çœ·æ—è¿æ¥</h3>
                            <div class="space-y-4">
                                <input v-model="settings.supabaseUrl" placeholder="Supabase åœ°å€ (URL)" class="w-full bg-dark-900 border-dark-700 text-slate-300 border rounded px-4 py-3 font-mono text-sm focus:border-mystic-green focus:ring-1 focus:ring-mystic-green outline-none">
                                <input v-model="settings.supabaseKey" placeholder="Anon å¯†é’¥ (Key)" type="password" class="w-full bg-dark-900 border-dark-700 text-slate-300 border rounded px-4 py-3 font-mono text-sm focus:border-mystic-green focus:ring-1 focus:ring-mystic-green outline-none">
                                <button @click="initSupabase" class="w-full py-3 bg-dark-800 text-mystic-green border border-mystic-green/30 font-bold rounded hover:bg-mystic-green hover:text-dark-900 transition-all uppercase tracking-widest">å¯åŠ¨åè®®</button>
                            </div>
                        </div>
                        <div v-else-if="!multiplayerState.inRoom">
                            <div class="text-center text-mystic-green font-bold mb-8 tracking-wide flex items-center justify-center gap-2">
                                <span class="w-2 h-2 bg-mystic-green rounded-full animate-pulse"></span>
                                è¿æ¥å·²å»ºç«‹
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <button @click="createRoom" class="p-6 bg-dark-800 rounded border border-dark-600 hover:border-mystic-gold hover:bg-dark-700 transition-colors text-mystic-gold font-bold font-serif">åˆ›å»ºä»ªå¼(æˆ¿é—´)</button>
                                <button @click="showJoinInput = !showJoinInput" class="p-6 bg-dark-800 rounded border border-dark-600 hover:border-slate-400 hover:bg-dark-700 transition-colors text-slate-300 font-bold font-serif">åŠ å…¥ä»ªå¼</button>
                            </div>
                            <div v-if="showJoinInput" class="flex gap-2 animate-fade-in">
                                <input v-model="joinRoomId" placeholder="ä»ªå¼ä»£ç " class="flex-1 bg-dark-900 border border-dark-600 text-slate-200 rounded px-4 py-2 uppercase text-center font-mono focus:border-mystic-gold outline-none">
                                <button @click="joinRoom()" class="px-6 bg-mystic-gold text-dark-900 rounded font-bold hover:bg-yellow-600 transition-colors">è¿›å…¥</button>
                            </div>
                        </div>
                        <div v-else class="text-center space-y-8">
                            <div class="p-6 bg-dark-900/50 rounded border border-mystic-gold/30 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-1 bg-mystic-gold/50"></div>
                                <div class="text-xs text-mystic-gold/70 mb-2 uppercase tracking-widest">å½“å‰ä»ªå¼ (æˆ¿é—´å·)</div>
                                <div @click="copyToClipboard(multiplayerState.roomId)" title="ç‚¹å‡»å¤åˆ¶" class="text-4xl font-mono font-bold text-mystic-gold tracking-wider cursor-pointer hover:text-white transition-colors">{{ multiplayerState.roomId }}</div>
                                <div class="mt-3 inline-block px-3 py-1 text-[10px] font-bold uppercase tracking-widest border rounded" :class="multiplayerState.isHost ? 'text-yellow-500 border-yellow-500/30 bg-yellow-900/10' : 'text-slate-500 border-slate-700 bg-slate-900/30'">{{ multiplayerState.isHost ? 'å®ˆå¯†äºº (æˆ¿ä¸»)' : 'è°ƒæŸ¥å‘˜' }}</div>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-500 text-xs mb-4 uppercase tracking-widest border-b border-dark-700 pb-2">å‚ä¸è€…åå•</h4>
                                <div class="space-y-2">
                                    <div v-for="member in multiplayerState.members" :key="member.id" class="flex items-center p-3 bg-dark-800/50 border border-dark-700 rounded hover:border-dark-600 transition-colors">
                                        <div class="w-8 h-8 rounded bg-dark-700 flex-shrink-0 overflow-hidden border border-dark-600">
                                            <img v-if="member.avatar" :src="member.avatar" class="w-full h-full object-cover">
                                            <div v-else class="w-full h-full flex items-center justify-center font-bold text-xs text-slate-500">{{ member.name.charAt(0) }}</div>
                                        </div>
                                        <span class="ml-3 font-medium text-slate-300 font-serif">{{ member.name }}</span>
                                        <div class="ml-auto flex items-center gap-2">
                                            <span v-if="member.isReady" class="text-[10px] text-mystic-green font-bold border border-mystic-green/30 px-2 py-0.5 rounded uppercase tracking-wider">å·²å‡†å¤‡</span>
                                            <span v-if="member.isHost" class="text-[10px] bg-mystic-gold/10 text-mystic-gold border border-mystic-gold/20 px-2 py-0.5 rounded uppercase tracking-wider">æˆ¿ä¸»</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-4">
                                <button @click="leaveRoom" class="flex-1 py-3 border border-red-900/50 text-red-500/80 rounded font-bold hover:bg-red-900/10 hover:text-red-400 hover:border-red-900 transition-all uppercase tracking-widest text-xs">æ”¾å¼ƒä»ªå¼ (ç¦»å¼€)</button>
                                <button v-if="!multiplayerState.isHost" @click="toggleReady" :class="['flex-1 py-3 border rounded font-bold transition-all uppercase tracking-widest text-xs', multiplayerState.isReady ? 'bg-mystic-green/20 text-mystic-green border-mystic-green' : 'bg-dark-800 text-slate-400 border-dark-600 hover:bg-dark-700']">
                                    {{ multiplayerState.isReady ? 'å·²å‡†å¤‡' : 'å‡†å¤‡å°±ç»ª' }}
                                </button>
                                <!-- Host Start Button -->
                                <button v-if="multiplayerState.isHost" @click="selectCocMode('multi')"
                                        :disabled="!allPlayersReady"
                                        class="flex-1 py-3 bg-mystic-gold/10 text-mystic-gold border border-mystic-gold/30 rounded font-bold hover:bg-mystic-gold/20 transition-all uppercase tracking-widest text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                    å¼€å§‹å‡†å¤‡
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
    
                <!-- 4. Saves View (Memory Corridor) -->
                <div v-if="currentView === 'saves'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                    <h2 class="text-2xl font-bold mb-8 text-indigo-400 font-serif flex items-center gap-3">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                        è®°å¿†å›å»Š
                    </h2>
                    <div class="max-w-4xl mx-auto">
                        <div v-if="savedGames.length === 0" class="text-center py-20 border border-dashed border-dark-700 rounded-lg bg-dark-900/30">
                            <div class="text-slate-500 font-serif italic mb-4">è¿™é‡Œç©ºæ— ä¸€ç‰©ï¼Œåªæœ‰æ—¶é—´çš„å°˜åŸƒ...</div>
                            <button @click="currentView = 'coc'" class="px-6 py-2 bg-dark-800 text-mystic-gold border border-mystic-gold/30 rounded hover:bg-mystic-gold hover:text-dark-900 transition-all font-bold text-sm">å¼€å§‹æ–°çš„æ—…ç¨‹</button>
                        </div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div v-for="(save, index) in savedGames" :key="save.id" class="group relative bg-dark-900/80 border border-dark-700 rounded-lg overflow-hidden hover:border-indigo-500/50 transition-all shadow-lg">
                                <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500/30 group-hover:bg-indigo-500 transition-colors"></div>
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <div class="text-xs text-indigo-400 font-bold uppercase tracking-widest mb-1">{{ save.mode === 'multi' ? 'å¤šäººè”æœº' : 'å•äººæ¨¡å¼' }}</div>
                                            <h3 class="text-xl font-bold text-slate-200 font-serif truncate pr-4">{{ save.moduleName || 'æœªå‘½åç¯‡ç« ' }}</h3>
                                        </div>
                                        <button @click="deleteSave(index)" class="text-slate-600 hover:text-red-500 transition-colors p-1">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                    <div class="text-sm text-slate-500 font-mono mb-6 line-clamp-2 h-10">
                                        {{ save.lastMessage || 'æ— è®°å½•...' }}
                                    </div>
                                    <div class="flex items-center justify-between mt-auto pt-4 border-t border-dark-800">
                                        <div class="text-xs text-slate-600 font-mono">{{ new Date(save.timestamp).toLocaleString() }}</div>
                                        <button @click="loadSave(index)" class="px-4 py-1.5 bg-indigo-900/20 text-indigo-400 border border-indigo-500/30 rounded hover:bg-indigo-500 hover:text-white transition-all text-xs font-bold uppercase tracking-wider">
                                            è¯»å–è®°å¿†
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    
                <!-- 5. Library View -->
                <div v-if="currentView === 'library'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                    <div class="max-w-6xl mx-auto">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h2 class="text-3xl font-bold text-purple-400 font-serif flex items-center gap-3">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
                                å¯†æ–¯å¡æ‰˜å°¼å…‹å¤§å­¦å›¾ä¹¦é¦†
                            </h2>
                            <div class="flex gap-3 w-full md:w-auto">
                                <div class="relative flex-1 md:w-64">
                                    <input v-model="libraryState.searchQuery" @keyup.enter="fetchLibraryModules" placeholder="æœç´¢å…¸ç±..." class="w-full bg-dark-900 border border-dark-700 rounded px-4 py-2 text-sm text-slate-300 focus:border-purple-500 outline-none">
                                    <button @click="fetchLibraryModules" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-purple-400">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    </button>
                                </div>
                                <button @click="libraryState.showUpload = true" class="px-4 py-2 bg-purple-900/20 text-purple-400 border border-purple-500/30 rounded hover:bg-purple-900/40 font-bold text-sm flex items-center gap-2 whitespace-nowrap">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    è´¡çŒ®è—ä¹¦
                                </button>
                            </div>
                        </div>

                        <!-- Upload Modal -->
                        <!-- Upload Modal -->
                        <div v-if="libraryState.showUpload" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm safe-pt safe-pb">
                            <div class="bg-dark-900 border border-purple-500/30 rounded-lg shadow-2xl max-w-2xl w-full flex flex-col max-h-[90vh] md:max-h-[80vh]">
                                <div class="p-6 border-b border-dark-800 flex justify-between items-center flex-shrink-0">
                                    <h3 class="text-xl font-bold text-purple-400 font-serif flex items-center gap-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        è´¡çŒ®æ–°æ¨¡ç»„
                                    </h3>
                                    <button @click="libraryState.showUpload = false" class="text-slate-500 hover:text-slate-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                </div>
                                <div class="p-6 overflow-y-auto space-y-5 custom-scrollbar">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">æ¨¡ç»„æ ‡é¢˜</label>
                                            <input v-model="libraryState.uploadForm.title" class="w-full bg-dark-950 border border-dark-700 rounded px-3 py-2 text-slate-300 focus:border-purple-500 outline-none transition-colors focus:ring-1 focus:ring-purple-500/50">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">æ¥æºç±»å‹</label>
                                            <div class="flex bg-dark-950 p-1 rounded border border-dark-700">
                                                <button @click="libraryState.uploadForm.type = 'original'" :class="['flex-1 py-1 text-xs rounded transition-all font-bold', libraryState.uploadForm.type === 'original' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300']">åŸåˆ›</button>
                                                <button @click="libraryState.uploadForm.type = 'reprint'" :class="['flex-1 py-1 text-xs rounded transition-all font-bold', libraryState.uploadForm.type === 'reprint' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300']">æ¬è¿</button>
                                                <button @click="libraryState.uploadForm.type = 'ai_adapt'" :class="['flex-1 py-1 text-xs rounded transition-all font-bold', libraryState.uploadForm.type === 'ai_adapt' ? 'bg-teal-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300']">AIæ”¹ç¼–</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider flex justify-between">
                                            ç®€ä»‹
                                            <span v-if="libraryState.isSummarizing" class="text-purple-400 animate-pulse flex items-center gap-1 normal-case">
                                                <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                æ­£åœ¨è¯»å–ç¦å¿ŒçŸ¥è¯†...
                                            </span>
                                        </label>
                                        <textarea v-model="libraryState.uploadForm.description" rows="3" :placeholder="libraryState.isSummarizing ? 'æ­£åœ¨ç”Ÿæˆæ‘˜è¦...' : 'è¯·è¾“å…¥ç®€ä»‹æˆ–ç­‰å¾…è‡ªåŠ¨ç”Ÿæˆ...'" class="w-full bg-dark-950 border border-dark-700 rounded px-3 py-2 text-slate-300 focus:border-purple-500 outline-none resize-none transition-colors focus:ring-1 focus:ring-purple-500/50" :disabled="libraryState.isSummarizing"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">
                                            {{ libraryState.uploadForm.type === 'ai_adapt' ? 'å°è¯´åŸæ–‡ / æ•…äº‹å¤§çº²' : 'æ¨¡ç»„å†…å®¹' }}
                                        </label>
                                        <div class="flex gap-4 mb-2">
                                            <button @click="libraryState.uploadType = 'text'" :class="['px-3 py-1 rounded text-xs border', libraryState.uploadType === 'text' ? 'bg-purple-900/30 border-purple-500 text-purple-300' : 'border-dark-700 text-slate-500']">ç›´æ¥ç²˜è´´</button>
                                            <button @click="libraryState.uploadType = 'file'" :class="['px-3 py-1 rounded text-xs border', libraryState.uploadType === 'file' ? 'bg-purple-900/30 border-purple-500 text-purple-300' : 'border-dark-700 text-slate-500']">æ–‡ä»¶ä¸Šä¼ </button>
                                        </div>
                                        <textarea v-if="libraryState.uploadType === 'text'" v-model="libraryState.uploadForm.content" rows="10" :placeholder="libraryState.uploadForm.type === 'ai_adapt' ? 'åœ¨æ­¤ç²˜è´´å°è¯´åŸæ–‡...' : 'åœ¨æ­¤ç²˜è´´æ¨¡ç»„æ­£æ–‡...'" class="w-full bg-dark-950 border border-dark-700 rounded px-3 py-2 text-slate-300 focus:border-purple-500 outline-none font-mono text-sm"></textarea>
                                        <div v-else class="h-40 border-2 border-dashed border-dark-700 rounded flex flex-col items-center justify-center text-slate-500 hover:border-purple-500 hover:text-purple-400 transition-colors cursor-pointer relative">
                                            <input type="file" accept=".txt,.md,.json,.docx" @change="handleLibraryFileUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                                            <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                            <span>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤</span>
                                            <span class="text-xs mt-1" v-if="libraryState.uploadForm.content">å·²åŠ è½½: {{ libraryState.uploadForm.content.length }} å­—ç¬¦</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6 border-t border-dark-800 flex justify-end gap-3">
                                    <button @click="libraryState.showUpload = false" class="px-4 py-2 text-slate-400 hover:text-slate-200">å–æ¶ˆ</button>
                                    
                                    <button v-if="libraryState.uploadForm.type === 'ai_adapt'" @click="adaptNovelToModule" :disabled="!libraryState.uploadForm.content || libraryState.isAdapting" class="px-6 py-2 bg-teal-600 hover:bg-teal-500 text-white rounded font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                        <svg v-if="libraryState.isAdapting" class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                        {{ libraryState.isAdapting ? 'æ­£åœ¨æ”¹ç¼–...' : 'å¼€å§‹AIæ”¹ç¼–' }}
                                    </button>

                                    <button v-else @click="uploadToLibrary" :disabled="!libraryState.uploadForm.title || !libraryState.uploadForm.content || libraryState.isUploading" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                        <svg v-if="libraryState.isUploading" class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                        {{ libraryState.isUploading ? 'æ­£åœ¨å…¥åº“...' : 'ç¡®è®¤å…¥åº“' }}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- SQL Setup Modal -->
                        <div v-if="showSqlModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm safe-pt safe-pb">
                            <div class="bg-dark-900 border border-red-500/50 rounded-lg shadow-2xl max-w-2xl w-full flex flex-col max-h-[90vh] md:max-h-[80vh] animate-fade-in">
                                <div class="p-6 border-b border-dark-800 flex justify-between items-center bg-red-900/10 flex-shrink-0">
                                    <h3 class="text-xl font-bold text-red-400 font-serif flex items-center gap-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                        æ•°æ®åº“æœªåˆå§‹åŒ–
                                    </h3>
                                    <button @click="showSqlModal = false" class="text-slate-500 hover:text-slate-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                </div>
                                <div class="p-6 overflow-y-auto custom-scrollbar">
                                    <p class="text-slate-300 mb-4 text-sm leading-relaxed">
                                        æ£€æµ‹åˆ° Supabase æ•°æ®åº“ç¼ºå°‘å¿…è¦çš„è¡¨ç»“æ„ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨é¦–æ¬¡è¿æ¥æ–°é¡¹ç›®æ—¶ã€‚<br>
                                        è¯·å¤åˆ¶ä»¥ä¸‹ SQL è¯­å¥ï¼Œå¹¶åœ¨ Supabase çš„ <a href="https://supabase.com/dashboard/project/_/sql" target="_blank" class="text-mystic-gold hover:underline">SQL Editor</a> ä¸­è¿è¡Œä»¥ä¿®å¤æ­¤é—®é¢˜ï¼š
                                    </p>
                                    <div class="relative group">
                                        <pre class="bg-dark-950 p-4 rounded border border-dark-700 text-xs font-mono text-slate-400 overflow-x-auto whitespace-pre-wrap select-all">{{ sqlToRun }}</pre>
                                        <button @click="copyToClipboard(sqlToRun)" class="absolute top-2 right-2 p-2 bg-dark-800 text-slate-400 hover:text-white rounded border border-dark-600 hover:border-mystic-gold transition-all" title="å¤åˆ¶ SQL">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-6 border-t border-dark-800 flex justify-end">
                                    <button @click="showSqlModal = false" class="px-6 py-2 bg-dark-800 text-slate-300 hover:text-white border border-dark-600 rounded transition-colors">å…³é—­</button>
                                </div>
                            </div>
                        </div>
                        <!-- Module List -->
                        <div v-if="libraryState.loading" class="text-center py-20 text-purple-400 animate-pulse">
                            æ­£åœ¨ä»ä¹¦æ¶ä¸Šå–ä¹¦...
                        </div>
                        <div v-else-if="libraryState.modules.length === 0" class="text-center py-20 border border-dashed border-dark-700 rounded bg-dark-900/30">
                            <div class="text-slate-500 font-serif italic mb-4">å›¾ä¹¦é¦†ç©ºç©ºå¦‚ä¹Ÿï¼Œä¹Ÿè®¸ä½ è¯¥è´¡çŒ®ç¬¬ä¸€æœ¬è—ä¹¦ï¼Ÿ</div>
                        </div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div v-for="mod in libraryState.modules" :key="mod.id" class="group relative bg-dark-900 border border-dark-700 rounded-lg overflow-hidden hover:border-purple-500/50 hover:shadow-[0_0_20px_rgba(168,85,247,0.15)] transition-all duration-300 flex flex-col transform hover:-translate-y-1">
                                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-600 to-blue-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="p-5 flex-1 relative">
                                    <!-- Background Pattern -->
                                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity pointer-events-none">
                                        <svg class="w-24 h-24 text-purple-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/></svg>
                                    </div>

                                    <div class="flex justify-between items-start mb-2 relative z-10">
                                        <div class="flex-1 mr-2">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span v-if="mod.type === 'reprint'" class="text-[10px] px-1.5 py-0.5 rounded bg-blue-900/30 text-blue-400 border border-blue-500/30 font-bold uppercase tracking-wider">æ¬è¿</span>
                                                <span v-else class="text-[10px] px-1.5 py-0.5 rounded bg-purple-900/30 text-purple-400 border border-purple-500/30 font-bold uppercase tracking-wider">åŸåˆ›</span>
                                                <span class="text-[10px] text-slate-600">{{ new Date(mod.created_at).toLocaleDateString() }}</span>
                                            </div>
                                            <h3 class="text-lg font-bold text-slate-200 font-serif line-clamp-1 group-hover:text-purple-400 transition-colors" :title="mod.title">{{ mod.title }}</h3>
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-500 mb-3 font-mono flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                        {{ mod.author_name || 'ä½šå' }}
                                    </div>
                                    <p class="text-sm text-slate-400 line-clamp-3 mb-4 h-[4.5em] leading-relaxed relative z-10">{{ mod.description || 'æš‚æ— ç®€ä»‹...' }}</p>
                                    <div class="flex gap-4 text-xs text-slate-600 border-t border-dark-800 pt-3 justify-between">
                                        <div class="flex gap-4">
                                            <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg> {{ Math.ceil(mod.content.length / 1000) }}k å­—</span>
                                            <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> {{ mod.downloads || 0 }}</span>
                                        </div>
                                        <button @click="exportModuleToWord(mod)" class="text-slate-500 hover:text-blue-400 transition-colors" title="å¯¼å‡º Word">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-4 border-t border-dark-800 bg-dark-950/30 flex gap-2">
                                    <button @click="useLibraryModule(mod, 'single')" class="flex-1 py-2 bg-dark-800 hover:bg-mystic-gold hover:text-dark-900 text-mystic-gold border border-mystic-gold/30 rounded text-xs font-bold transition-colors">
                                        å•äººè·‘å›¢
                                    </button>
                                    <button @click="useLibraryModule(mod, 'multi')" class="flex-1 py-2 bg-dark-800 hover:bg-mystic-green hover:text-dark-900 text-mystic-green border border-mystic-green/30 rounded text-xs font-bold transition-colors">
                                        å¤šäººè”æœº
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 6. Friends View -->
                <div v-if="currentView === 'friends'" class="h-full overflow-y-auto p-4 md:p-8 animate-fade-in bg-dark-950 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                    <h2 class="text-2xl font-bold mb-8 text-mystic-gold font-serif">åŒä¼´åå½•</h2>
                    <div class="max-w-2xl mx-auto space-y-6">
                        <!-- My ID -->
                        <div class="glass-panel p-6 rounded-lg shadow-sm flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-slate-200 font-serif">{{ user.name }}</h3>
                                <p class="text-sm text-slate-500 font-mono select-all">UID: {{ user.uuid }}</p>
                            </div>
                            <div class="flex gap-2">
                                <input v-model="friendInput" placeholder="è¾“å…¥åŒä¼´ ID" class="bg-dark-900 border border-dark-600 text-slate-300 rounded px-3 py-1.5 text-sm focus:border-mystic-gold outline-none">
                                <button @click="addFriend" class="bg-dark-800 text-mystic-gold border border-mystic-gold/30 px-4 py-1.5 rounded text-sm font-bold hover:bg-mystic-gold hover:text-dark-900 transition-colors">æ·»åŠ </button>
                            </div>
                        </div>
                        <!-- Friend Requests -->
                        <div v-if="friendRequests.length > 0" class="space-y-2">
                            <h4 class="font-bold text-xs text-slate-500 uppercase tracking-widest mb-2">æ”¶åˆ°çš„ä¿¡å·</h4>
                            <div v-for="req in friendRequests" :key="req.id" class="bg-dark-800 p-4 rounded border border-mystic-gold/30 flex justify-between items-center">
                                <span class="font-bold text-slate-200 font-serif">{{ req.name }}</span>
                                <div class="flex gap-2">
                                    <button @click="acceptFriend(req)" class="px-3 py-1 text-xs bg-mystic-gold text-dark-900 rounded font-bold hover:bg-yellow-600">æ¥å—</button>
                                    <button @click="rejectFriend(req)" class="px-3 py-1 text-xs bg-dark-700 text-slate-400 rounded hover:bg-dark-600">æ‹’ç»</button>
                                </div>
                            </div>
                        </div>
                        <!-- List -->
                        <div class="space-y-3">
                            <div v-for="friend in friends" :key="friend.uuid" class="glass-panel p-4 rounded border border-dark-700 flex justify-between items-center hover:border-slate-600 transition-colors">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded bg-dark-800 overflow-hidden relative border border-dark-600">
                                        <img v-if="friend.avatar" :src="friend.avatar" class="w-full h-full object-cover">
                                        <div v-if="friend.isOnline" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-mystic-green border border-dark-900 rounded-full shadow-[0_0_8px_rgba(45,212,191,0.8)]"></div>
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-200 font-serif">{{ friend.name }}</div>
                                        <div class="text-xs font-mono" :class="friend.isOnline ? 'text-mystic-green' : 'text-slate-600'">{{ friend.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿' }}</div>
                                    </div>
                                </div>
                                <button v-if="friend.isOnline" @click="inviteFriend(friend)" class="px-3 py-1.5 bg-dark-800 text-slate-300 border border-dark-600 rounded text-xs font-bold hover:text-mystic-gold hover:border-mystic-gold transition-colors uppercase tracking-wider">é‚€è¯·</button>
                            </div>
                            <div v-if="friends.length === 0" class="text-center py-12 text-slate-600 border border-dashed border-dark-800 rounded bg-dark-900/20 font-serif italic">å­¤ç‹¬æ˜¯ç†æ™ºçš„æœ€åé˜²çº¿...</div>
                        </div>
                    </div>
                </div>

        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, watch, nextTick } = Vue;

        // Marked Config
        marked.use({ breaks: true });

        createApp({
            setup() {
                // --- Constants & Utilities ---
                const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });

                // PNG Parsing Utility to extract embedded text chunks (tEXt)
                const extractPngData = async (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const buffer = e.target.result;
                                const view = new DataView(buffer);
                                let offset = 8; // Skip PNG Signature
                                
                                while (offset < view.byteLength) {
                                    const length = view.getUint32(offset);
                                    const type = String.fromCharCode(view.getUint8(offset+4), view.getUint8(offset+5), view.getUint8(offset+6), view.getUint8(offset+7));
                                    
                                    if (type === 'tEXt') {
                                        const dataStart = offset + 8;
                                        const chunkData = new Uint8Array(buffer, dataStart, length);
                                        
                                        // Find null separator
                                        let nullIdx = -1;
                                        for(let i=0; i<chunkData.length; i++) {
                                            if(chunkData[i] === 0) { nullIdx = i; break; }
                                        }
                                        
                                        if (nullIdx > -1) {
                                            const keywordDecoder = new TextDecoder('iso-8859-1');
                                            const keyword = keywordDecoder.decode(chunkData.slice(0, nullIdx));
                                            
                                            const textBytes = chunkData.slice(nullIdx + 1);
                                            const textDecoder = new TextDecoder('utf-8');
                                            const text = textDecoder.decode(textBytes);

                                            console.log('[PNG Parser] Found chunk:', keyword);

                                            let jsonStr = text;

                                            // Special handling for 'coc_data' which uses Base64
                                            if (keyword === 'coc_data') {
                                                try {
                                                    // decodeURIComponent(escape(window.atob(str))) handles UTF-8 in Base64
                                                    jsonStr = decodeURIComponent(escape(window.atob(text)));
                                                    console.log('[PNG Parser] Decoded Base64 coc_data');
                                                } catch (e) {
                                                    console.warn('[PNG Parser] Base64 decode failed, using raw text:', e);
                                                }
                                            }

                                            // Try to find JSON content
                                            try {
                                                // Handle potential URL encoding
                                                if (jsonStr.includes('%7B')) {
                                                    try { jsonStr = decodeURIComponent(jsonStr); } catch(e){}
                                                }
                                                
                                                const firstBrace = jsonStr.indexOf('{');
                                                const lastBrace = jsonStr.lastIndexOf('}');
                                                if (firstBrace !== -1 && lastBrace !== -1) {
                                                    const cleanJson = jsonStr.substring(firstBrace, lastBrace + 1);
                                                    const obj = JSON.parse(cleanJson);
                                                    // Basic validation for COC card
                                                    if (obj.name || obj.stats || obj.skills) {
                                                        console.log('[PNG Parser] Successfully extracted data for:', obj.name);
                                                        resolve(obj);
                                                        return;
                                                    }
                                                }
                                            } catch(e) {
                                                // console.debug('[PNG Parser] JSON parse failed for chunk content');
                                            }
                                        }
                                    }
                                    offset += 12 + length; // Length + Type(4) + Data + CRC(4)
                                }
                                console.log('[PNG Parser] No valid COC data found in PNG chunks');
                                resolve(null);
                            } catch (err) {
                                console.error('PNG Parse Error:', err);
                                resolve(null);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    });
                };

                const compressImage = (source, maxWidth = 300, quality = 0.7) => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.src = source;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width, height = img.height;
                            if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, width, height); ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = () => resolve(source);
                    });
                };

                // --- State ---
                const currentView = ref('coc');
                const showMobileMenu = ref(false);
                const showMobileRightSidebar = ref(false);
                const toasts = ref([]);
                // Confirm Modal State
                const confirmState = reactive({
                    show: false,
                    title: '',
                    message: '',
                    confirmText: 'ç¡®å®š',
                    cancelText: 'å–æ¶ˆ',
                    resolve: null
                });

                // Settlement Modal State
                const settlementState = reactive({
                    show: false,
                    moduleName: '',
                    sanRewardExpr: '1d6',
                    sanRewardVal: 0,
                    skillGrowths: [], // { name: 'æŠ€èƒ½å', oldVal: 50, checkVal: 85, success: true, growth: 5, newVal: 55 }
                    specialReward: '',
                    badge: { name: '', desc: '', icon: 'ğŸ…' },
                    historyLog: '',
                    step: 1, // 1: Input Reward, 2: Skill Check, 3: Confirm
                    selectedSkills: [], // Skills marked for growth check
                    skillSearch: '', // Search query for skills
                    customSkillName: '', // For manually adding a skill
                    isRolling: false
                });

                const showConfirm = (message, title = 'ç¡®è®¤æ“ä½œ') => {
                    return new Promise((resolve) => {
                        confirmState.message = message;
                        confirmState.title = title;
                        confirmState.show = true;
                        confirmState.resolve = resolve;
                    });
                };

                const user = reactive({ name: 'æ¸¸å®¢', avatar: '', uuid: generateUUID() });
                const settings = reactive({
                    apiUrl: 'https://opis.zeabur.app',
                    apiKey: 'sk-8PZs39TSK9Jde8dpD2IIrJxyAnJQUot7pskCbA4WlyFAwVJd',
                    model: 'gemini-3-pro-preview-maxthinking',
                    supabaseUrl: 'https://ghswjgxrblpdklukxjnq.supabase.co',
                    supabaseKey: 'sb_publishable_rIc2MYg6kaGIQcddDgVKYw_uLkWaY4E',
                    temperature: 1.0
                });

                // COC State
                const statDisplayMap = {
                    STR: 'åŠ›é‡', CON: 'ä½“è´¨', SIZ: 'ä½“å‹', DEX: 'æ•æ·',
                    APP: 'å¤–è²Œ', INT: 'æ™ºåŠ›', POW: 'æ„å¿—', EDU: 'æ•™è‚²',
                    LUCK: 'å¹¸è¿'
                };

                const cocState = reactive({
                    mode: null,
                    module: null,
                    tempModuleText: '',
                    investigators: [],
                    activeInvestigatorIndex: -1,
                    gameState: 'idle',
                    log: [],
                    systemPrompt: '',
                    pendingRolls: [] // å¾…å¤„ç†çš„æ£€å®šåˆ—è¡¨ [{ target: 'Name', command: 'ra', args: 'ä¾¦æŸ¥' }]
                });

                const lastAssistantIndex = Vue.computed(() => {
                    let idx = -1;
                    for (let i = 0; i < cocState.log.length; i++) {
                        if (cocState.log[i].role === 'assistant') idx = i;
                    }
                    return idx;
                });

                // CoT Helpers
                // Helper to clear assignments for a specific user
                const clearUserAssignments = (userId) => {
                    Object.keys(multiplayerState.assignments).forEach(key => {
                        if (multiplayerState.assignments[key] === userId) {
                            delete multiplayerState.assignments[key];
                        }
                    });
                };

                const hasCot = (text) => text && (text.includes('<cot>') || text.includes('<cot'));
                const getCotContent = (text) => {
                    if (!text) return '';
                    // åŒ¹é…å®Œæ•´é—­åˆçš„ <cot>...</cot> æˆ– <cot>...<cot>
                    const match = text.match(/<cot>([\s\S]*?)(?:<\/cot>|<cot>|$)/);
                    if (match) return match[1];
                    // å¤„ç†æµå¼è¾“å‡ºä¸­æœªé—­åˆçš„æƒ…å†µ
                    if (text.includes('<cot>')) {
                        return text.split('<cot>')[1];
                    }
                    return '';
                };
                const removeCot = (text) => {
                    if (!text) return '';
                    // ç§»é™¤å®Œæ•´é—­åˆçš„æ ‡ç­¾
                    let clean = text.replace(/<cot>[\s\S]*?(?:<\/cot>|<cot>)/g, '').trim();
                    // å¦‚æœè¿˜æœ‰æœªé—­åˆçš„ <cot> (æµå¼è¾“å‡ºä¸­)ï¼Œåˆ™ç§»é™¤ <cot> ä¹‹åçš„æ‰€æœ‰å†…å®¹
                    if (clean.includes('<cot>')) {
                        clean = clean.split('<cot>')[0].trim();
                    }
                    return clean;
                };
                const toggleCot = async (index) => {
                    // Multiplayer Permission Check
                    if (cocState.mode === 'multi' && !multiplayerState.isHost) {
                        if (!multiplayerState.cotAuthorizedUsers.includes(user.uuid)) {
                            if (await showConfirm('æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹æ€ç»´é“¾ (CoT)ã€‚æ˜¯å¦å‘æˆ¿ä¸»ç”³è¯·æƒé™ï¼Ÿ', 'ç”³è¯·æƒé™')) {
                                requestCotAccess();
                            }
                            return;
                        }
                    }
                    const msg = cocState.log[index];
                    if (msg) {
                        msg.showCot = !msg.showCot;
                    }
                };

                const requestCotAccess = () => {
                    if (!multiplayerState.inRoom) return;
                    broadcastMessage({ type: 'request_cot_access', userId: user.uuid, userName: user.name });
                    showToast('å·²å‘é€æƒé™ç”³è¯·', 'info');
                };

                const grantCotAccess = (targetUserId) => {
                    if (!multiplayerState.cotAuthorizedUsers.includes(targetUserId)) {
                        multiplayerState.cotAuthorizedUsers.push(targetUserId);
                        broadcastMessage({ type: 'grant_cot_access', userId: targetUserId, authorizedUsers: multiplayerState.cotAuthorizedUsers });
                        showToast('å·²æˆæƒæŸ¥çœ‹ CoT', 'success');
                    }
                };

                const regenerateLastResponse = async () => {
                    // Check permissions
                    if (cocState.mode === 'multi' && !multiplayerState.isHost) {
                        return showToast('ä»…æˆ¿ä¸»å¯ä»¥é‡æ–°ç”Ÿæˆ', 'warning');
                    }
                    
                    const lastAiIdx = lastAssistantIndex.value;
                    if (lastAiIdx === -1) return;

                    if (!await showConfirm('ç¡®å®šè¦å›æº¯åˆ°æ­¤å¤„å¹¶é‡æ–°ç”Ÿæˆå—ï¼Ÿè¯¥æ¶ˆæ¯åŠä¹‹åçš„æ‰€æœ‰å¯¹è¯å°†è¢«æ¸…é™¤ã€‚', 'å›æº¯é‡ç”Ÿæˆ')) return;

                    // Remove from lastAiIdx
                    // è¿™é‡Œçš„ splice ä¼šç§»é™¤ä» lastAiIdx å¼€å§‹çš„æ‰€æœ‰å…ƒç´ ï¼ŒåŒ…æ‹¬è¯¥ AI æ¶ˆæ¯å’Œä¹‹åçš„æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯
                    cocState.log.splice(lastAiIdx);

                    // Multiplayer Sync
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        // åŒæ­¥æ•´ä¸ªçŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½åˆ é™¤äº†å¤šæ¡æ¶ˆæ¯
                        broadcastMessage({
                            type: 'sync_state',
                            log: cocState.log,
                            gameState: cocState.gameState,
                            investigators: cocState.investigators,
                            assignments: multiplayerState.assignments,
                            assignmentDetails: multiplayerState.assignmentDetails,
                            turnIndex: multiplayerState.turnIndex,
                            roundActionIds: multiplayerState.roundActionIds,
                            cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers
                        });
                        broadcastMessage({ type: 'regenerate_start' });
                    }

                    // Trigger generation
                    generateResponse();
                };

                const cocInput = ref('');
                const cocInputRef = ref(null); // Ref for textarea
                const cocChatContainer = ref(null);
                const isGenerating = ref(false);

                // Mention System
                const showMentionList = ref(false);
                const mentionQuery = ref('');
                
                const mentionCandidates = Vue.computed(() => {
                    if (!mentionQuery.value && mentionQuery.value !== '') return [];
                    const q = mentionQuery.value.toLowerCase();
                    
                    let candidates = [];
                    
                    // 2. Add Characters (if assigned)
                    if (cocState.mode === 'multi') {
                        cocState.investigators.forEach((inv, idx) => {
                            // Only add if assigned to someone else
                            if (multiplayerState.assignments[idx] && multiplayerState.assignments[idx] !== user.uuid) {
                                candidates.push({ type: 'character', name: inv.name, id: `char_${idx}`, avatar: inv.avatar });
                            }
                        });
                    }

                    // Filter
                    return candidates.filter(c => c.name.toLowerCase().includes(q));
                });

                const handleInput = (e) => {
                    const val = e.target.value;
                    const cursor = e.target.selectionStart;
                    const lastAt = val.lastIndexOf('@', cursor - 1);
                    
                    if (lastAt !== -1) {
                        // Check if there's a space before @ or it's the start
                        if (lastAt === 0 || val[lastAt - 1] === ' ' || val[lastAt - 1] === '\n') {
                            const query = val.substring(lastAt + 1, cursor);
                            // Stop if query contains space (end of mention)
                            if (!query.includes(' ')) {
                                mentionQuery.value = query;
                                showMentionList.value = true;
                                return;
                            }
                        }
                    }
                    showMentionList.value = false;
                };

                const selectMention = (candidate) => {
                    const val = cocInput.value;
                    const cursor = cocInputRef.value.selectionStart;
                    const lastAt = val.lastIndexOf('@', cursor - 1);
                    
                    if (lastAt !== -1) {
                        const before = val.substring(0, lastAt);
                        const after = val.substring(cursor);
                        cocInput.value = `${before}@${candidate.name} ${after}`;
                        showMentionList.value = false;
                        
                        // Restore focus
                        nextTick(() => {
                            cocInputRef.value.focus();
                            // Move cursor to end of inserted name + space
                            const newCursorPos = lastAt + 1 + candidate.name.length + 1;
                            cocInputRef.value.setSelectionRange(newCursorPos, newCursorPos);
                        });
                    }
                };

                // Multiplayer & Friends
                const multiplayerState = reactive({
                    isConnected: false, inRoom: false, roomId: null, myId: null,
                    isHost: false, members: [], turnStatus: {}, skipStatus: {},
                    isReady: false, // Local player ready status
                    assignments: {}, // { investigatorIndex: userId }
                    turnIndex: 0, // Who is picking now? 0 = Host, 1 = First Guest...
                    roundActionIds: [], // Track who has acted in the current round
                    cotAuthorizedUsers: [] // List of user IDs authorized to view CoT
                });
                const friends = ref([]);
                const friendRequests = ref([]);
                const friendInput = ref('');
                const showJoinInput = ref(false);
                const joinRoomId = ref('');
                const savedGames = ref([]); // Archive list

                // SQL Modal State
                const showSqlModal = ref(false);
                const sqlToRun = ref('');

                // Library State
                const libraryState = reactive({
                    modules: [],
                    loading: false,
                    isSummarizing: false,
                    isUploading: false,
                    isAdapting: false,
                    searchQuery: '',
                    showUpload: false,
                    uploadType: 'text', // 'text' or 'file'
                    uploadForm: { title: '', description: '', content: '', type: 'original' }
                });

                // Broadcast State
                const showBroadcast = ref(false);
                const dontShowBroadcast = ref(false);
                const currentVersion = '1.0';

                // Check Broadcast on Mount
                const checkBroadcast = () => {
                    const lastReadVersion = localStorage.getItem('coc_broadcast_read_version');
                    if (lastReadVersion !== currentVersion) {
                        showBroadcast.value = true;
                    }
                };

                const closeBroadcast = () => {
                    showBroadcast.value = false;
                    if (dontShowBroadcast.value) {
                        localStorage.setItem('coc_broadcast_read_version', currentVersion);
                    }
                };

                const openCocCard = () => {
                    window.open('Workshop/index.html', '_blank');
                    showMobileMenu.value = false;
                };
                
                let supabaseClient = null;
                let roomChannel = null;
                let personalChannel = null;
                let globalChannel = null;

                // --- Persistence ---
                const saveData = () => {
                    localStorage.setItem('coc_user', JSON.stringify(user));
                    localStorage.setItem('coc_settings', JSON.stringify(settings));
                    localStorage.setItem('coc_investigators', JSON.stringify(cocState.investigators));
                    localStorage.setItem('coc_friends', JSON.stringify(friends.value));
                };

                const loadData = () => {
                    const lUser = localStorage.getItem('coc_user');
                    if (lUser) Object.assign(user, JSON.parse(lUser));
                    
                    const lSettings = localStorage.getItem('coc_settings');
                    if (lSettings) Object.assign(settings, JSON.parse(lSettings));
                    
                    const lInv = localStorage.getItem('coc_investigators');
                    if (lInv) cocState.investigators = JSON.parse(lInv);

                    const lFriends = localStorage.getItem('coc_friends');
                    if (lFriends) friends.value = JSON.parse(lFriends);

                    const lSaves = localStorage.getItem('coc_saves');
                    if (lSaves) savedGames.value = JSON.parse(lSaves);
                };

                // --- Core Logic ---
                const showToast = (msg, type = 'info') => {
                    const id = Date.now();
                    toasts.value.push({ id, message: msg, type });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
                };

                const copyToClipboard = (text) => {
                    if (!text) return;
                    navigator.clipboard.writeText(text).then(() => showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')).catch(() => showToast('å¤åˆ¶å¤±è´¥', 'error'));
                };

                // Helper: Execute ST command (Modify Stats)
                const executeStCommand = (inv, prop, valExpr) => {
                    if (!inv || !prop || !valExpr) return null;
                    
                    const lowerProp = prop.toLowerCase();
                    let targetKey = '';
                    let isStat = false;

                    // Map prop to inv key
                    if (['hp', 'mp', 'san'].includes(lowerProp)) {
                        targetKey = lowerProp;
                    } else {
                        // Check stats
                        const statMap = {
                            'åŠ›é‡': 'STR', 'STR': 'STR',
                            'ä½“è´¨': 'CON', 'CON': 'CON',
                            'ä½“å‹': 'SIZ', 'SIZ': 'SIZ',
                            'æ•æ·': 'DEX', 'DEX': 'DEX',
                            'å¤–è²Œ': 'APP', 'APP': 'APP',
                            'æ™ºåŠ›': 'INT', 'INT': 'INT', 'çµæ„Ÿ': 'INT',
                            'æ„å¿—': 'POW', 'POW': 'POW',
                            'æ•™è‚²': 'EDU', 'EDU': 'EDU', 'çŸ¥è¯†': 'EDU',
                            'å¹¸è¿': 'LUCK', 'LUCK': 'LUCK'
                        };
                        const key = statMap[prop] || statMap[prop.toUpperCase()];
                        if (key) {
                            targetKey = key;
                            isStat = true;
                        }
                    }

                    if (!targetKey) return { success: false, msg: `æœªæ‰¾åˆ°å±æ€§: ${prop}` };

                    let currentVal = isStat ? inv.stats[targetKey] : inv[targetKey];
                    let newVal = currentVal;
                    let change = 0;

                    // Parse expression (+10, -5, 50, 1d6)
                    // Simple regex for + / -
                    const match = valExpr.match(/^([+-]?)(\d+|d\d+|\d+d\d+)(.*)$/);
                    let op = '';
                    
                    if (match) {
                        op = match[1]; // + or - or empty
                        const valPart = match[2]; // number or dice
                        
                        let valNum = 0;
                        if (valPart.includes('d')) {
                            const [n, d] = valPart.split('d').map(v => parseInt(v) || 1);
                            for(let i=0; i<n; i++) valNum += Math.floor(Math.random() * d) + 1;
                        } else {
                            valNum = parseInt(valPart);
                        }

                        if (op === '+') {
                            newVal += valNum;
                            change = valNum;
                        } else if (op === '-') {
                            newVal -= valNum;
                            change = -valNum;
                        } else {
                            newVal = valNum; // Set directly
                            change = newVal - currentVal;
                        }
                    } else {
                         return { success: false, msg: `æ•°å€¼æ ¼å¼é”™è¯¯: ${valExpr}` };
                    }

                    // Apply
                    if (isStat) inv.stats[targetKey] = newVal;
                    else inv[targetKey] = newVal;

                    // Bounds check (optional, but good for SAN/HP)
                    if (targetKey === 'san') inv[targetKey] = Math.max(0, Math.min(99, inv[targetKey]));
                    if (targetKey === 'hp') inv[targetKey] = Math.max(0, Math.min(inv.maxHp || 99, inv[targetKey]));
                    if (targetKey === 'mp') inv[targetKey] = Math.max(0, Math.min(inv.maxMp || 99, inv[targetKey]));

                    saveData();
                    return {
                        success: true,
                        msg: `${prop.toUpperCase()} ${op==='+'?'+':''}${change} => ${inv[targetKey]}`,
                        log: `ğŸ”§ **å±æ€§å˜æ›´** ${inv.name} çš„ ${prop.toUpperCase()}: ${currentVal} â” ${inv[targetKey]}`
                    };
                };

                const renderMarkdown = (text) => {
                    if (!text) return '';
                    // Simple regex for dice command linking (simplified from main app)
                    let processed = text.replace(/(^|[\s\n>])(\.(?:ra|rc|sc|san|r|roll|st|set)(?:\s+[^\s\n<ã€‚ï¼Œï¼\?]+)?)(?=$|[\s\n<ã€‚ï¼Œï¼\?])/gi,
                        '$1<span class="cursor-pointer text-mystic-gold font-bold hover:underline decoration-mystic-gold/30" onclick="event.stopPropagation(); window.triggerCocCommand(\'$2\')">$2</span>');
                    return DOMPurify.sanitize(marked.parse(processed));
                };

                // Computed
                const allPlayersReady = Vue.computed(() => {
                    // å¿…é¡»è‡³å°‘æœ‰2äººï¼ˆæˆ¿ä¸»+è‡³å°‘1åç©å®¶ï¼‰æ‰èƒ½å¼€å§‹å¤šäººæ¸¸æˆ
                    if (multiplayerState.members.length < 2) return false;
                    // æ£€æŸ¥æˆ¿ä¸»æ˜¯å¦åœ¨åœºï¼ˆè™½ç„¶é€šå¸¸æˆ¿ä¸»å°±æ˜¯å½“å‰ç”¨æˆ·ï¼Œä½†ä¸ºäº†é€»è¾‘ä¸¥è°¨ï¼‰
                    const hostPresent = multiplayerState.members.some(m => m.isHost);
                    if (!hostPresent) return false;
                    // æ‰€æœ‰éæˆ¿ä¸»æˆå‘˜å¿…é¡»å‡†å¤‡å°±ç»ª
                    return multiplayerState.members.every(m => m.isReady || m.isHost);
                });

                // COC Logic
                // Moved checkAndTriggerRound definition up to ensure scope availability
                const checkAndTriggerRound = () => {
                    if (!multiplayerState.isHost || isGenerating.value) return;
                    
                    // è·å–æ‰€æœ‰å·²åˆ†é…è§’è‰²çš„å”¯ä¸€ç©å®¶ ID
                    const participants = [...new Set(Object.values(multiplayerState.assignments))];
                    if (participants.length === 0) return;

                    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç©å®¶éƒ½å·²è¡ŒåŠ¨
                    const allActed = participants.every(uid => multiplayerState.roundActionIds.includes(uid));
                    
                    if (allActed) {
                        console.log('æ‰€æœ‰ç©å®¶å·²è¡ŒåŠ¨ï¼Œè§¦å‘ Keeper å›å¤...');
                        generateResponse();
                    }
                };

                const selectCocMode = (mode) => {
                    if (mode === 'multi') {
                        if (!multiplayerState.inRoom) {
                            currentView.value = 'multiplayer';
                            return showToast('è¯·å…ˆåŠ å…¥æˆ¿é—´', 'warning');
                        }
                        // Host broadcasts mode change to entering preparation phase
                        if (multiplayerState.isHost) {
                            broadcastMessage({ type: 'change_mode', mode: 'multi', view: 'preparing', gameState: 'preparing' });
                        }
                        
                        cocState.mode = mode;
                        currentView.value = 'preparing';
                        cocState.gameState = 'preparing';
                    } else {
                        cocState.mode = mode;
                        currentView.value = 'preparing';
                        cocState.gameState = 'preparing';
                    }
                };

                const exitCocMode = () => {
                    if (cocState.mode === 'multi') {
                        // å¤šäººæ¨¡å¼ä¸‹ï¼Œå‡†å¤‡é˜¶æ®µçš„è¿”å›åº”å½“è§†ä¸ºé€€å‡ºæ¸¸æˆ/æˆ¿é—´
                        // é¿å…ç”¨æˆ·è¿”å›åˆ° multiplayer ç•Œé¢å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
                        exitCocGame();
                    } else {
                        cocState.mode = null;
                        cocState.gameState = 'idle';
                        currentView.value = 'coc';
                    }
                };
                
                const exitCocGame = async () => {
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        if (await showConfirm('æ‚¨æ˜¯æˆ¿ä¸»ï¼Œé€€å‡ºå°†è§£æ•£æˆ¿é—´ã€‚æ˜¯å¦å…ˆä¿å­˜å½“å‰æ¸¸æˆè¿›åº¦ï¼Ÿ', 'ä¿å­˜è¿›åº¦')) {
                            saveGame();
                        } else {
                            return; // å¦‚æœå–æ¶ˆä¿å­˜ï¼Œåˆ™è§†ä¸ºå–æ¶ˆé€€å‡ºæ“ä½œï¼Œä¸å†å¼¹å‡ºè§£æ•£æç¤º
                        }
                        
                        if (!await showConfirm('ç¡®å®šè¦è§£æ•£æˆ¿é—´å¹¶é€€å‡ºå—ï¼Ÿæ‰€æœ‰ç©å®¶å°†è¢«å¼ºåˆ¶é€€å‡ºã€‚', 'è§£æ•£æˆ¿é—´')) return;

                        // Broadcast room closed signal
                        await broadcastMessage({ type: 'room_closed' });
                    } else {
                        if(!await showConfirm('ç¡®å®šé€€å‡ºå—ï¼Ÿæœªä¿å­˜çš„è¿›åº¦å°†ä¸¢å¤±ã€‚', 'é€€å‡ºç¡®è®¤')) return;
                    }

                    cocState.gameState = 'idle';
                    cocState.log = [];
                    currentView.value = 'coc';
                    // Leave room if in multi
                    if (multiplayerState.inRoom) leaveRoom();
                };

                const saveGame = () => {
                    const save = {
                        id: Date.now(),
                        timestamp: Date.now(),
                        mode: cocState.mode,
                        moduleName: cocState.module?.name,
                        moduleContent: cocState.module?.content,
                        investigators: cocState.investigators,
                        log: cocState.log,
                        systemPrompt: cocState.systemPrompt,
                        pendingRolls: cocState.pendingRolls, // Save roll state
                        // Multi specific
                        multiplayer: cocState.mode === 'multi' ? {
                            assignments: multiplayerState.assignments,
                            // Save player names for assignments to allow re-binding
                            assignmentDetails: Object.entries(multiplayerState.assignments).reduce((acc, [idx, uid]) => {
                                const member = multiplayerState.members.find(m => m.id === uid);
                                if (member) acc[idx] = { id: uid, name: member.name };
                                return acc;
                            }, {}),
                            turnIndex: multiplayerState.turnIndex,
                            roundActionIds: multiplayerState.roundActionIds
                        } : null,
                        lastMessage: cocState.log.length > 0 ? cocState.log[cocState.log.length - 1].content : ''
                    };

                    // Update existing if same session? For now just new save
                    savedGames.value.unshift(save);
                    localStorage.setItem('coc_saves', JSON.stringify(savedGames.value));
                    showToast('æ¸¸æˆè¿›åº¦å·²ä¿å­˜è‡³è®°å¿†å›å»Š', 'success');
                };

                const deleteSave = async (index) => {
                    if(await showConfirm('ç¡®å®šè¦é—å¿˜è¿™æ®µè®°å¿†å—ï¼Ÿ', 'åˆ é™¤å­˜æ¡£')) {
                        savedGames.value.splice(index, 1);
                        localStorage.setItem('coc_saves', JSON.stringify(savedGames.value));
                    }
                };

                const loadSave = async (index) => {
                    const save = savedGames.value[index];
                    if (!save) return;

                    // --- In-Game Rollback Logic ---
                    if (cocState.gameState === 'playing' && cocState.mode === 'multi') {
                        if (save.mode !== 'multi') return showToast('æ— æ³•åœ¨å¤šäººæ¸¸æˆä¸­è¯»å–å•äººå­˜æ¡£', 'error');
                        
                        // Check Module
                        if (save.moduleName !== cocState.module?.name) {
                            return showToast('æ— æ³•è¯»å–ï¼šå­˜æ¡£å±äºä¸åŒçš„æ¨¡ç»„ (' + save.moduleName + ')', 'error');
                        }

                        // Check Members (Assignments)
                        const savedAssignments = save.multiplayer?.assignments || {};
                        const currentMemberIds = multiplayerState.members.map(m => m.id);
                        const missingPlayers = Object.values(savedAssignments).filter(uid => !currentMemberIds.includes(uid));
                        
                        if (missingPlayers.length > 0) {
                             return showToast('æ— æ³•è¯»å–ï¼šå­˜æ¡£ä¸­çš„å…³é”®ç©å®¶ä¸åœ¨å½“å‰æˆ¿é—´', 'error');
                        }

                        if (!await showConfirm('æ£€æµ‹åˆ°å½“å‰æ­£åœ¨æ¸¸æˆä¸­ã€‚æ˜¯å¦è¿›è¡Œå›æ¡£ï¼ˆè¦†ç›–å½“å‰è¿›åº¦ï¼‰ï¼Ÿ', 'è¦†ç›–ç¡®è®¤')) return;

                        // Execute Rollback
                        cocState.log = save.log;
                        cocState.investigators = save.investigators;
                        cocState.systemPrompt = save.systemPrompt;
                        if (save.pendingRolls !== undefined) cocState.pendingRolls = save.pendingRolls; // Restore roll state
                        else if (save.canRoll !== undefined) cocState.pendingRolls = []; // Migration: clear old boolean
                        
                        multiplayerState.assignments = savedAssignments;
                        multiplayerState.assignmentDetails = save.multiplayer.assignmentDetails || {};
                        multiplayerState.turnIndex = save.multiplayer.turnIndex || 0;
                        multiplayerState.roundActionIds = save.multiplayer.roundActionIds || [];
                        
                        // Update host's own assignment index
                        updateMyAssignment();

                        broadcastMessage({
                            type: 'sync_state',
                            log: cocState.log,
                            investigators: cocState.investigators,
                            assignments: multiplayerState.assignments,
                            assignmentDetails: multiplayerState.assignmentDetails,
                            turnIndex: multiplayerState.turnIndex,
                            roundActionIds: multiplayerState.roundActionIds,
                            gameState: 'playing'
                        });

                        showToast('å·²æˆåŠŸå›æ¡£', 'success');
                        currentView.value = 'chat';
                        return;
                    }

                    if (save.mode === 'multi') {
                        // Multi load logic (New Session)
                        // 1. Must be connected to Supabase
                        if (!multiplayerState.isConnected) {
                            currentView.value = 'multiplayer';
                            showToast('è¯·å…ˆè¿æ¥æœåŠ¡å™¨', 'warning');
                            return;
                        }
                        
                        // 2. Create a room automatically (isLoadGame = true)
                        createRoom(true).then(() => {
                            // 3. Restore State (But keep in preparing mode first)
                            cocState.mode = 'multi';
                            cocState.module = { name: save.moduleName, content: save.moduleContent };
                            cocState.investigators = save.investigators;
                            cocState.log = save.log;
                            cocState.systemPrompt = save.systemPrompt;
                            if (save.pendingRolls !== undefined) cocState.pendingRolls = save.pendingRolls;
                            else if (save.canRoll !== undefined) cocState.pendingRolls = [];
                            
                            // Restore assignments logic:
                            // We keep the assignments but mark them as "pending re-connection"
                            // We use a special state to track "expected players"
                            multiplayerState.assignments = save.multiplayer.assignments;
                            multiplayerState.assignmentDetails = save.multiplayer.assignmentDetails || {}; // Load saved details
                            
                            cocState.gameState = 'preparing'; // Force preparing state
                            multiplayerState.turnIndex = 0;
                            multiplayerState.roundActionIds = save.multiplayer.roundActionIds;
                            
                            // Sync to room
                            broadcastMessage({
                                type: 'sync_state',
                                log: cocState.log,
                                moduleName: cocState.module.name,
                                gameState: cocState.gameState,
                                investigators: cocState.investigators,
                                assignments: multiplayerState.assignments,
                                assignmentDetails: multiplayerState.assignmentDetails, // Sync details too
                                turnIndex: multiplayerState.turnIndex,
                                roundActionIds: multiplayerState.roundActionIds
                            });
                            
                            currentView.value = 'multiplayer';
                            showToast('å­˜æ¡£å·²åŠ è½½ã€‚è¯·ç­‰å¾…åŸç­äººé©¬å½’ä½ã€‚', 'success');
                        });
                    } else {
                        // Single load logic
                        cocState.mode = 'single';
                        cocState.module = { name: save.moduleName, content: save.moduleContent };
                        cocState.investigators = save.investigators;
                        cocState.log = save.log;
                        cocState.systemPrompt = save.systemPrompt;
                        if (save.pendingRolls !== undefined) cocState.pendingRolls = save.pendingRolls;
                        else if (save.canRoll !== undefined) cocState.pendingRolls = [];
                        cocState.gameState = 'playing';
                        // Restore active investigator (default to first if not tracked, or maybe track it in save?)
                        // For now default to 0 or last active
                        cocState.activeInvestigatorIndex = 0;
                        
                        currentView.value = 'chat';
                        showToast('è®°å¿†å·²å”¤é†’', 'success');
                    }
                };

                const importCocModule = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    
                    // Handle .docx with Mammoth
                    if (file.name.endsWith('.docx')) {
                        reader.onload = (ev) => {
                            const arrayBuffer = ev.target.result;
                            mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                                .then((result) => {
                                    cocState.module = { name: file.name.replace(/\.[^/.]+$/, ""), content: result.value };
                                    showToast('æ¨¡ç»„å¯¼å…¥æˆåŠŸ', 'success');
                                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                                        broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name });
                                    }
                                })
                                .catch((err) => {
                                    console.error(err);
                                    showToast('Docx è§£æå¤±è´¥', 'error');
                                });
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        // Handle text/json/md
                        reader.onload = (ev) => {
                            cocState.module = { name: file.name.replace(/\.[^/.]+$/, ""), content: ev.target.result };
                            showToast('æ¨¡ç»„å¯¼å…¥æˆåŠŸ', 'success');
                            if (cocState.mode === 'multi' && multiplayerState.isHost) {
                                broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name });
                            }
                        };
                        reader.readAsText(file);
                    }
                };

                const saveManualModule = () => {
                    if (!cocState.tempModuleText) return;
                    cocState.module = { name: 'æ‰‹åŠ¨æ¨¡ç»„', content: cocState.tempModuleText };
                    showToast('æ¨¡ç»„ä¿å­˜æˆåŠŸ', 'success');
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name });
                    }
                };

                const importInvestigator = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        let data = null;
                        
                        // Handle JSON
                        if (file.type === 'application/json' || file.name.endsWith('.json')) {
                            const text = await file.text();
                            data = JSON.parse(text);
                        }
                        // Handle PNG
                        // Handle PNG
                        else if (file.type === 'image/png' || file.name.endsWith('.png')) {
                            data = await extractPngData(file);
                            if (!data) throw new Error('æœªåœ¨ PNG ä¸­æ‰¾åˆ°åµŒå…¥çš„è§’è‰²æ•°æ®');
                            
                            // PNG å¯¼å…¥æ—¶ï¼Œå›¾ç‰‡æœ¬èº«å°±æ˜¯å¤´åƒï¼Œå³ä½¿æ•°æ®é‡Œæ²¡å­˜ avatar å­—æ®µï¼ˆé€šå¸¸ exportPNG ä¼šåˆ é™¤ï¼‰
                            // æ€»æ˜¯ä½¿ç”¨å½“å‰ PNG æ–‡ä»¶ä½œä¸ºå¤´åƒï¼Œç¡®ä¿æœ€æ–°
                            data.avatar = await compressImage(URL.createObjectURL(file), 300, 0.8);
                        }

                        if (!data) throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');

                        // Ensure basic stats & structure
                        if (!data.stats) data.stats = { STR:50, CON:50, SIZ:65, DEX:50, APP:50, INT:60, POW:50, EDU:60 };
                        
                        // ç¡®ä¿æ•°å€¼ç±»å‹æ­£ç¡®
                        for (let k in data.stats) data.stats[k] = Number(data.stats[k]);
                        
                        // è¡ç”Ÿå±æ€§è¡¥å…¨ (å¦‚æœç¼ºå¤±)
                        if (data.hp === undefined) data.hp = Math.floor((data.stats.CON + data.stats.SIZ)/10);
                        if (data.mp === undefined) data.mp = Math.floor(data.stats.POW/5);
                        if (data.san === undefined) data.san = data.stats.POW;
                        if (data.maxSan === undefined) data.maxSan = 99;
                        if (data.maxHp === undefined) data.maxHp = Math.floor((data.stats.CON + data.stats.SIZ)/10);
                        if (data.maxMp === undefined) data.maxMp = Math.floor(data.stats.POW/5);
                        
                        // Ensure history and badges exist
                        if (!data.history) data.history = [];
                        if (!data.badges) data.badges = [];
                        
                        // ç¡®ä¿ skills ç»“æ„å®Œæ•´
                        if (!data.skills) data.skills = [];
                        
                        // Store full data structure
                        cocState.investigators.push(data);
                        // Multiplayer Sync
                        if (cocState.mode === 'multi' && multiplayerState.isHost) {
                            broadcastMessage({ type: 'sync_investigators', investigators: cocState.investigators });
                        }

                        // Auto select if none selected (Single mode or Host)
                        if (cocState.activeInvestigatorIndex === -1) {
                            cocState.activeInvestigatorIndex = cocState.investigators.length - 1;
                        }
                        saveData();
                        showToast('è°ƒæŸ¥å‘˜å¯¼å…¥æˆåŠŸ: ' + data.name, 'success');
                    } catch(err) {
                        console.error(err);
                        showToast('å¯¼å…¥å¤±è´¥: ' + err.message, 'error');
                    }
                    
                    // Reset input
                    e.target.value = '';
                };

                const deleteInvestigator = async (index) => {
                    if(await showConfirm('åˆ é™¤æ­¤è°ƒæŸ¥å‘˜ï¼Ÿ', 'åˆ é™¤è§’è‰²')) {
                        cocState.investigators.splice(index, 1);
                        if(cocState.activeInvestigatorIndex >= index) cocState.activeInvestigatorIndex = -1;
                        
                        // Multiplayer Sync
                        if (cocState.mode === 'multi' && multiplayerState.isHost) {
                            broadcastMessage({ type: 'sync_investigators', investigators: cocState.investigators });
                            // Reset assignments for deleted index
                            multiplayerState.assignments = {};
                            broadcastMessage({ type: 'sync_assignments', assignments: {} });
                        }
                        
                        saveData();
                    }
                };

                const toggleReady = () => {
                    // Check assignment only if we are in preparation phase and trying to get ready
                    if (!multiplayerState.isReady && cocState.gameState === 'preparing') {
                        if (cocState.activeInvestigatorIndex === -1) {
                            return showToast('è¯·å…ˆé€‰æ‹©ä¸€åè°ƒæŸ¥å‘˜', 'warning');
                        }
                    }

                    multiplayerState.isReady = !multiplayerState.isReady;
                    if (roomChannel) {
                        // Find my existing presence to keep original online_at
                        const myPresence = multiplayerState.members.find(m => m.id === user.uuid);
                        const onlineAt = myPresence ? myPresence.online_at : new Date();

                        const status = {
                            user_id: user.uuid,
                            name: user.name,
                            avatar: user.avatar,
                            is_host: multiplayerState.isHost,
                            isReady: multiplayerState.isReady,
                            online_at: onlineAt
                        };
                        roomChannel.track(status);
                        
                        // Explicit broadcast for redundancy
                        broadcastMessage({ type: 'member_status', status });
                    }
                };

                const buildInvestigatorProfile = (inv) => {
                    let profile = `å§“åï¼š${inv.name}\nèŒä¸šï¼š${inv.job} | å¹´é¾„ï¼š${inv.age} | æ€§åˆ«ï¼š${inv.gender} | ä½åœ°ï¼š${inv.residence}\n`;
                    profile += `å±æ€§ï¼šSTR:${inv.stats.STR} CON:${inv.stats.CON} SIZ:${inv.stats.SIZ} DEX:${inv.stats.DEX} APP:${inv.stats.APP} INT:${inv.stats.INT} POW:${inv.stats.POW} EDU:${inv.stats.EDU}\n`;
                    profile += `çŠ¶æ€ï¼šHP ${inv.hp}/${inv.maxHp} | MP ${inv.mp}/${inv.maxMp} | SAN ${inv.san}/${inv.maxSan}\n`;
                    
                    if (inv.skills && inv.skills.length) {
                        const skillsStr = inv.skills
                            .filter(s => s.value > 0) // Only show learned skills
                            .map(s => `${s.name}(${s.value})`).join(', ');
                        profile += `æŠ€èƒ½ï¼š${skillsStr}\n`;
                    }
                    
                    if (inv.backstory) {
                        profile += `èƒŒæ™¯ï¼š\n`;
                        const map = {
                            personalDescription: "å¤–è²Œä¸æ°”è´¨", ideology: "æ ¸å¿ƒä¿¡å¿µ", significantPeople: "é‡è¦ä¹‹äºº",
                            meaningfulLocations: "é‡è¦ä¹‹åœ°", treasuredPossessions: "å®è´µä¹‹ç‰©", traits: "æ€§æ ¼ç‰¹è´¨",
                            injuries: "ä¼¤ç–¤ä¸æ®‹ç–¾", phobias: "ææƒ§ç—‡"
                        };
                        for (const [k, v] of Object.entries(inv.backstory)) {
                            if (v) profile += `- ${map[k]||k}: ${v}\n`;
                        }
                    }
                    
                    if (inv.inventory) profile += `éšèº«ç‰©å“ï¼š${inv.inventory}\n`;
                    return profile;
                };

                const openSettlement = () => {
                    const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                    if (!inv) return showToast('è¯·é€‰æ‹©ä¸€åè°ƒæŸ¥å‘˜', 'warning');
                    
                    // Initialize settlement state
                    settlementState.moduleName = cocState.module?.name || 'æœªçŸ¥æ¨¡ç»„';
                    settlementState.sanRewardExpr = '1d6';
                    settlementState.sanRewardVal = 0;
                    settlementState.specialReward = '';
                    settlementState.badge = { name: 'å¹¸å­˜è€…', desc: `åœ¨ã€Š${settlementState.moduleName}ã€‹ä¸­å­˜æ´»`, icon: 'ğŸ…' };
                    settlementState.historyLog = `å®Œæˆæ¨¡ç»„ã€Š${settlementState.moduleName}ã€‹`;
                    settlementState.step = 1;
                    settlementState.selectedSkills = [];
                    settlementState.skillGrowths = [];
                    
                    // Pre-select skills that have been successfully used (value > base? No, we don't track success count yet. Let user pick.)
                    // Just list all skills > 0 for now
                    
                    settlementState.show = true;
                };

                const rollSanReward = () => {
                    const expr = settlementState.sanRewardExpr;
                    let val = 0;
                    if (expr.includes('d')) {
                        const [n, d] = expr.split('d').map(Number);
                        for(let i=0; i<(n||1); i++) val += Math.floor(Math.random()*(d||6))+1;
                    } else {
                        val = parseInt(expr) || 0;
                    }
                    settlementState.sanRewardVal = val;
                };

                const processSkillGrowth = async () => {
                    const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                    settlementState.isRolling = true;
                    settlementState.skillGrowths = [];

                    for (const skillName of settlementState.selectedSkills) {
                        const skill = inv.skills.find(s => s.name === skillName);
                        if (!skill) continue;

                        // Growth Check: Roll 1d100 > current value
                        const checkVal = Math.floor(Math.random() * 100) + 1;
                        const success = checkVal > skill.value || checkVal > 95; // > skill or > 95 is growth success
                        
                        let growth = 0;
                        if (success) {
                            growth = Math.floor(Math.random() * 10) + 1; // 1d10 growth
                        }

                        settlementState.skillGrowths.push({
                            name: skill.name,
                            oldVal: skill.value,
                            checkVal,
                            success,
                            growth,
                            newVal: skill.value + growth
                        });
                        
                        // Small delay for effect
                        await new Promise(r => setTimeout(r, 300));
                    }
                    settlementState.isRolling = false;
                    settlementState.step = 3;
                };

                const confirmSettlement = () => {
                    const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                    
                    // Apply SAN Reward
                    const oldSan = inv.san;
                    inv.san = Math.min(inv.maxSan || 99, inv.san + settlementState.sanRewardVal);
                    
                    // Apply Skill Growth
                    settlementState.skillGrowths.forEach(g => {
                        if (g.success) {
                            const skill = inv.skills.find(s => s.name === g.name);
                            if (skill) skill.value = g.newVal;
                        }
                    });

                    // Add History
                    if (!inv.history) inv.history = [];
                    const date = new Date().toLocaleDateString();
                    let log = `[${date}] ${settlementState.historyLog}\n`;
                    log += `- SANå›å¤: ${settlementState.sanRewardVal} (${oldSan} -> ${inv.san})\n`;
                    if (settlementState.skillGrowths.length > 0) {
                        log += `- æŠ€èƒ½æˆé•¿: ${settlementState.skillGrowths.filter(g=>g.success).map(g => `${g.name}+${g.growth}`).join(', ') || 'æ— '}\n`;
                    }
                    if (settlementState.specialReward) {
                        log += `- ç‰¹æ®Šå¥–åŠ±: ${settlementState.specialReward}`;
                    }
                    inv.history.unshift(log);

                    // Add Badge
                    if (settlementState.badge.name) {
                        if (!inv.badges) inv.badges = [];
                        inv.badges.push({ ...settlementState.badge, date });
                    }

                    saveData();
                    showToast('ç»“ç®—å®Œæˆï¼Œè§’è‰²å·²æ›´æ–°', 'success');
                    settlementState.show = false;
                };

                const startCocGame = () => {
                    if (!cocState.module || cocState.investigators.length === 0) return showToast('è¯·å…ˆå¯¼å…¥æ¨¡ç»„å’Œè°ƒæŸ¥å‘˜', 'warning');
                    
                    // Multi-mode validation
                    if (cocState.mode === 'multi') {
                        // Check if all ready players have assignments
                        const readyMembers = multiplayerState.members.filter(m => m.isReady && !m.isHost);
                        if (readyMembers.length === 0) return showToast('æ²¡æœ‰ç©å®¶å‡†å¤‡å°±ç»ª', 'warning');
                        
                        // Check if assignments cover all ready players
                        const assignedUserIds = Object.values(multiplayerState.assignments);
                        const allReadyAssigned = readyMembers.every(m => assignedUserIds.includes(m.id));
                        
                        if (!allReadyAssigned) return showToast('æœ‰å‡†å¤‡å°±ç»ªçš„ç©å®¶æœªåˆ†é…è§’è‰²', 'warning');

                        // Fix: Host needs a default view if not assigned
                        if (multiplayerState.isHost && cocState.activeInvestigatorIndex === -1 && cocState.investigators.length > 0) {
                            cocState.activeInvestigatorIndex = 0;
                        }
                    } else {
                        if (cocState.activeInvestigatorIndex === -1) cocState.activeInvestigatorIndex = 0;
                    }
                    
                    let invProfile = '';
                    
                    if (cocState.mode === 'multi') {
                        invProfile = `ã€è°ƒæŸ¥å‘˜é˜Ÿä¼ã€‘\n`;
                        for (const [idx, uid] of Object.entries(multiplayerState.assignments)) {
                            const inv = cocState.investigators[idx];
                            const player = multiplayerState.members.find(m => m.id === uid);
                            invProfile += `\n--- ç©å®¶: ${player?.name || 'Unknown'} æ‰®æ¼”: ${inv.name} ---\n`;
                            invProfile += buildInvestigatorProfile(inv);
                        }
                    } else {
                        const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                        invProfile = `ã€å½“å‰è°ƒæŸ¥å‘˜èµ„æ–™ã€‘\n` + buildInvestigatorProfile(inv);
                    }
                    
                    // If resuming from save, use existing prompt but update profiles?
                    // Actually, if we just loaded a save, we might want to keep the old prompt OR update it with new assignments.
                    // Let's regenerate it to be safe with new assignments.
                    
                    let systemPrompt = `ä½ ç°åœ¨æ˜¯COCè·‘å›¢ (Call of Cthulhu 7th Edition) çš„ Keeper (å®ˆå¯†äºº)ã€‚
ä½ çš„èŒè´£æ˜¯ä¸»æŒæ¸¸æˆï¼Œæè¿°ç¯å¢ƒï¼Œæ‰®æ¼” NPCï¼Œå¹¶æ ¹æ®è§„åˆ™è£å®šç©å®¶çš„è¡ŒåŠ¨ç»“æœï¼Œåªæœ‰ä½ èƒ½é˜…è¯»æ¨¡ç»„å‰§æœ¬ï¼Œè¯·ä¸è¦åœ¨æ­£æ–‡ä¸­æˆ–å¼•å¯¼ä¸­å‰§é€ã€‚

ã€æ ¸å¿ƒæŒ‡ä»¤ä¸æ£€å®šç³»ç»Ÿ (å¿…é¡»ä¸¥æ ¼éµå®ˆ)ã€‘
ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æŒ‡ä»¤æ ¼å¼ï¼Œ**ä¸è¦ä¿®æ”¹æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ä»£ç å—åŒ…è£¹**ï¼Œå¿…é¡»ä½œä¸ºç‹¬ç«‹è¡Œè¾“å‡ºï¼Œéšåä¼šå°†æ£€å®šç»“æœå‘é€ç»™ä½ ï¼Œä¸éœ€è¦ä½ è‡ªå·±è¿›è¡Œæ£€å®šã€‚å¦‚æœä¸æŒ‰è§„å®šæ ¼å¼è¾“å‡ºï¼Œåˆ™æ— æ³•è§¦å‘æ£€å®šé€»è¾‘ï¼Œä½ å°†æ”¶ä¸åˆ°æ£€å®šç»“æœã€‚
1. **æŠ€èƒ½/å±æ€§æ£€å®š**ï¼š
   - æ ¼å¼ï¼š\`@è§’è‰²å .ra æŠ€èƒ½å\`
   - ç¤ºä¾‹ï¼š\`@å¼ ä¸‰ .ra ä¾¦æŸ¥\`
   - åé¢ç¤ºä¾‹ï¼š(æ­¤æ—¶ï¼Œè°¢å¤©é€¸è‹¥æƒ³åˆ†ææ­¤åœ°é£æ°´ï¼Œå¯è¿›è¡Œç›¸å…³æ£€å®šï¼›é™ˆé“œå¯è¿›è¡Œä¾¦æŸ¥)
   - è¯´æ˜ï¼šå½“ä½ è®¤ä¸ºç©å®¶éœ€è¦è¿›è¡Œæ£€å®šæ—¶ä½¿ç”¨ï¼Œåªæœ‰ä½ è¾“å‡ºäº†æ ‡å‡†æŒ‡ä»¤ï¼Œç©å®¶æ‰èƒ½è¿›è¡Œç¬¦åˆä½ è¦æ±‚çš„æ£€å®šï¼Œè‹¥æ²¡æœ‰éµå¾ªæ ‡å‡†æ ¼å¼ï¼Œåˆ™æ— æ³•è§¦å‘ç³»ç»Ÿçš„æ£€å®šè§„åˆ™ã€‚
   - **é‡è¦æ£€æŸ¥**ï¼šè¯·å…ˆæ£€æŸ¥å„ä¸ªç©å®¶çš„æŠ€èƒ½åˆ—è¡¨ï¼Œç¡®ä¿ä½ è¦æ±‚æ£€å®šçš„æŒ‡å®šç©å®¶æ‹¥æœ‰ä½ è¦æ±‚æ£€å®šçš„æŠ€èƒ½ã€‚å¦‚æœå®åœ¨éœ€è¦è¿›è¡Œæ£€å®šæŒ‡å®šç©å®¶æ²¡æœ‰çš„æŠ€èƒ½ï¼Œä¸€å®šè¦æ›¿æ¢ä¸ºè¦æ±‚æ£€å®šæŸé¡¹ç›¸å…³çš„åŸºç¡€å±æ€§ï¼Œå¦‚DEX,POWç­‰ã€‚

2. **San Check (ç†æ™ºæ£€å®š)**ï¼š
   - æ ¼å¼ï¼š\`@è§’è‰²å .sc æˆåŠŸæ‰£é™¤/å¤±è´¥æ‰£é™¤\`
   - ç¤ºä¾‹ï¼š\`@æå›› .sc 1/1d3\`
   - è¯´æ˜ï¼šå½“ç©å®¶é­é‡ææ€–äº‹ç‰©æ—¶ä½¿ç”¨ã€‚

3. **æš—éª°/ç›´æ¥è°ƒæ•´æ•°å€¼ (æ¨è)**ï¼š
   - æ ¼å¼ï¼š\`@è§’è‰²å .st å±æ€§ å˜æ›´è¡¨è¾¾å¼\`
   - ç¤ºä¾‹ï¼š\`@ç‹äº” .st san -1d6\` (ç›´æ¥æ‰£é™¤ 1d6 ç‚¹ SAN)
   - ç¤ºä¾‹ï¼š\`@èµµå…­ .st hp -2\` (æ‰£é™¤ 2 ç‚¹ HP)
   - è¯´æ˜ï¼šç”¨äºç›´æ¥ç»“ç®—ä¼¤å®³ã€ææƒ§æƒ©ç½šï¼Œæˆ–ä¸å¸Œæœ›ç©å®¶çŸ¥é“ç»“æœçš„æš—éª°ï¼Œsan checkéƒ½æ˜¯æš—éª°ã€‚


**é‡è¦è§„åˆ™**ï¼š
- **ä¸¥æ ¼æ ¼å¼**ï¼šæŒ‡ä»¤å¿…é¡»ä¸¥æ ¼åŒ¹é…ä¸Šè¿°æ ¼å¼ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œç¬¦å·ã€‚
- **ç‹¬ç«‹è¡Œ**ï¼šæŒ‡ä»¤å¿…é¡»å†™åœ¨å›å¤çš„æœ€åï¼Œå•ç‹¬å ä¸€è¡Œæˆ–å¤šè¡Œã€‚
- **å¤šäººæ¸¸æˆ**ï¼šå¿…é¡»æŒ‡å®š \`@è§’è‰²å\`ã€‚

ã€Keeper è¡Œä¸ºå‡†åˆ™ã€‘
1. **æåº¦æ²‰æµ¸**ï¼šæ­£æ–‡ä¸­ä¸è¦å‡ºç°"è¯·è¿›è¡Œä¾¦æŸ¥æ£€å®š""å› ä¸ºä½ æŸé¡¹å±æ€§é‰´å®šæˆåŠŸæˆ–å¤±è´¥ï¼Œæ‰€ä»¥â€¦â€¦"è¿™ç§å‡ºæˆçš„æç¤ºè¯­ã€‚ç›´æ¥é€šè¿‡ç¯å¢ƒæè¿°æš—ç¤ºï¼Œç„¶ååœ¨æ–‡æœ«é™„ä¸ŠæŒ‡ä»¤å³å¯ã€‚
2. **ææ€–æ°›å›´**ï¼šä½¿ç”¨å¯Œæœ‰ç”»é¢æ„Ÿã€æ–‡å­¦æ€§ã€å…‹è‹é²é£æ ¼ï¼ˆææ€–ã€æ‚¬ç–‘ã€ä¸å¯åçŠ¶ï¼‰çš„è¯­è¨€ã€‚
3. **ä¸­ç«‹è£å®š**ï¼šä¸è¦åè¢’ç©å®¶ï¼Œä¹Ÿä¸è¦åˆ»æ„åˆéš¾ã€‚
4. **ç¦æ­¢ä»£å…¥ç©å®¶**ï¼šä½ æ°¸è¿œæ˜¯ Keeperï¼Œåªæè¿°å¤–ç•Œåé¦ˆï¼Œä¸æ‰®æ¼”ç©å®¶è§’è‰²ã€‚
5. **å¤±è´¥å‘å‰**ï¼šæ£€å®šå¤±è´¥ä¸åº”å¯¼è‡´å‰§æƒ…å¡æ­»ï¼Œè€Œåº”å¸¦æ¥æœ‰è¶£çš„éº»çƒ¦æˆ–ä»£ä»·ã€‚
6. **é˜²å‰§é€**ï¼šç¦æ­¢åœ¨æ­£æ–‡ä¸­è¾“å‡ºæˆ–é€éœ²ä¸€åˆ‡ä¸åˆç†çš„ç©å®¶å½“å‰ä¸åº”è¯¥çŸ¥é“çš„å‰§æƒ…å’Œä¿¡æ¯ï¼ˆå°¤å…¶æ˜¯å‰§æƒ…é€‰æ‹©æç¤ºä¸­ï¼‰ï¼Œé™¤éç©å®¶ä½¿ç”¨äº†ç›¸åº”çš„æ£€å®šæˆ–ç”¨åˆç†æ–¹å¼è·å¾—äº†æƒ…æŠ¥ã€‚ç¦æ­¢ä½¿ç”¨è¿‡äºæ˜æ˜¾çš„æç¤ºæ€§è¯è¯­å‘ŠçŸ¥ç©å®¶å‰§æƒ…èµ°å‘å’Œç›´æ¥ä¿¡æ¯ï¼Œä¿æŒæ‚¬ç–‘æ„Ÿå’Œæ¨ç†æ„Ÿ

ã€çŠ¶æ€æ„ŸçŸ¥å™äº‹ã€‘
è¯·æ—¶åˆ»å…³æ³¨è°ƒæŸ¥å‘˜çš„å½“å‰çŠ¶æ€ï¼ˆHP, SANï¼‰ï¼Œå¹¶å°†å…¶åæ˜ åœ¨å™äº‹é£æ ¼ä¸­ï¼š
*   **HP ä½ä¸‹**ï¼šæè¿°ç–¼ç—›ã€è™šå¼±ã€è§†çº¿æ¨¡ç³Šã€è¡ŒåŠ¨è¿Ÿç¼“ã€æ¿’æ­»çš„ææƒ§ã€‚
*   **SAN ä½ä¸‹**ï¼šæè¿°å¹»è§‰ã€è€³é¸£ã€åæ‰§ã€ç†æ™ºå´©åçš„ç–¯ç‹‚æ„Ÿã€ä¸å¯åçŠ¶çš„ææƒ§ã€‚
*   **MP ä½ä¸‹**ï¼šæè¿°ç²¾ç¥èé¡ã€æ³¨æ„åŠ›æ¶£æ•£ã€æ–½æ³•åçš„è™šè„±ã€‚
è¯·æ ¹æ®è¿™äº›æ•°å€¼çš„å˜åŒ–ï¼ŒåŠ¨æ€è°ƒæ•´ä½ çš„æå†™è‰²è°ƒã€‚`;

                    if (cocState.mode === 'multi') {
                        systemPrompt += `\n\nã€å¤šäººæ¸¸æˆåˆ†é•œå™äº‹ã€‘
å½“å‰ä¸ºå¤šäººè”æœºæ¨¡å¼ã€‚ä½ å¿…é¡»ç­‰å¾…æ‰€æœ‰ç©å®¶è¡ŒåŠ¨å®Œæ¯•åæ‰ä¼šæ”¶åˆ°æ±‡æ€»ä¿¡æ¯ã€‚
ä¸ºäº†ä¿è¯æ¯ä½ç©å®¶çš„ä½“éªŒï¼Œè¯·é‡‡ç”¨**ç”µå½±åˆ†é•œ**å¼çš„å™äº‹æ‰‹æ³•ï¼Œæ¸…æ™°åœ°åˆ‡æ¢ä¸åŒè§’è‰²çš„è§†è§’ã€‚
è¯·ä½¿ç”¨ **Markdown äºŒçº§æˆ–ä¸‰çº§æ ‡é¢˜** (å¦‚ \`## è§’è‰²å\`) æ¥ä½œä¸ºåˆ†é•œçš„å¼€å§‹ï¼Œåˆ†åˆ«æè¿°ä»–ä»¬çš„é­é‡ã€‚

æ ¼å¼ç¤ºä¾‹ï¼š
## å¼ ä¸‰
ä½ æ¨å¼€é—¨ï¼Œå‘ç°å±‹å†…æ¼†é»‘ä¸€ç‰‡...

## æå››
ä½ åœ¨é—¨å¤–è´Ÿè´£æŠŠé£ï¼Œçªç„¶å¬åˆ°æ¥¼é“é‡Œä¼ æ¥äº†è„šæ­¥å£°...

ç¡®ä¿æ¯ä½å‚ä¸æœ¬è½®è¡ŒåŠ¨çš„è°ƒæŸ¥å‘˜éƒ½èƒ½å¾—åˆ°ç‹¬ç«‹ä¸”ä¸°æ»¡çš„å›åº”ã€‚`;
                    }

                    // CoT Instruction
                    systemPrompt += `\n\nã€æ€ç»´é“¾ (CoT) è¦æ±‚ã€‘
è¯·åœ¨æ­£æ–‡è¾“å‡ºå‰ï¼Œä½¿ç”¨markdownæ ¼å¼ï¼Œä»¥ <cot>...æ€è€ƒå†…å®¹...<cot> çš„æ–¹å¼ä¸¥å¯†ï¼Œè¯¦ç»†åœ°åˆ†æcocè·‘å›¢æ¸¸æˆçš„ç³»ç»Ÿè§„åˆ™ï¼Œè°ƒæŸ¥å‘˜å’Œæ¨¡ç»„è®¾å®šï¼Œå†å²å¯¹è¯ï¼Œç”¨æˆ·è¾“å…¥ç­‰ä¿¡æ¯ï¼Œç¡®ä¿ç¬¦åˆè®¾å®šä¸”ç¬¦åˆé€»è¾‘åå†è¿›è¡Œæ­£æ–‡çš„è¾“å‡ºã€‚
è§„èŒƒæ ¼å¼ä¸º <cot>... <cot>ï¼Œç¡®ä¿å¼€å¤´ç»“å°¾éƒ½æœ‰<cot>æ ‡ç­¾ã€‚
åœ¨æ€è€ƒä¸­ï¼Œä½ éœ€è¦ï¼š
1. åˆ†æå½“å‰åœºæ™¯å’Œç©å®¶è¡ŒåŠ¨ã€‚
2. æ£€æŸ¥è§„åˆ™ä¹¦ï¼Œåˆ¤å®šæ˜¯å¦éœ€è¦æ£€å®šï¼Œæ£€å®šæ ¼å¼æ˜¯å¦æ ‡å‡†ï¼Œæ£€å®šçš„æŠ€èƒ½/å±æ€§æ˜¯å¦ä¸ºè¯¥ç©å®¶æ‹¥æœ‰çš„ï¼Œè‹¥ç©å®¶æ²¡æœ‰è¯¥æŠ€èƒ½ï¼Œæ˜¯å¦è¿›è¡Œäº†åŸºç¡€å±æ€§æ›¿æ¢ã€‚
3. å¦‚æœéœ€è¦æ£€å®šï¼Œæ„æ€å¼•å¯¼è¯­ã€‚
4. è§„åˆ’å‰§æƒ…èµ°å‘ï¼Œç¡®ä¿é€»è¾‘è‡ªæ´½ã€‚ç¡®ä¿æ­£æ–‡çš„è¾“å‡ºå’Œè¡ŒåŠ¨é€‰æ‹©å¼•å¯¼ä¸åŒ…å«å…·ä½“çš„ï¼Œç©å®¶å½“å‰ä¸çŸ¥é“çš„ä¿¡æ¯å’Œå‰§æƒ…ã€‚`;

                    // æ’å…¥è°ƒæŸ¥å‘˜èµ„æ–™
                    systemPrompt += `\n\n${invProfile}`;

                    // æœ€åæ’å…¥æ¨¡ç»„å†…å®¹
                    systemPrompt += `\n\nã€æ¨¡ç»„èƒŒæ™¯ (ä»… Keeper å¯è§)ã€‘
${cocState.module.content.slice(0, 15000)}`;

                    // Check if we are resuming a game (log already has content)
                    if (cocState.log.length > 0) {
                        systemPrompt += `\n\nã€æ¸¸æˆç»§ç»­ã€‘
ç©å®¶å·²é‡æ–°è¿æ¥å¹¶åˆ†é…äº†è§’è‰²ã€‚è¯·ç»§ç»­ä¹‹å‰çš„å‰§æƒ…ã€‚
ç®€è¦å›é¡¾ä¸€ä¸‹å½“å‰æƒ…å†µï¼Œç„¶åç­‰å¾…ç©å®¶è¡ŒåŠ¨ã€‚`;
                        // Don't reset log
                    } else {
                        systemPrompt += `\n\nç°åœ¨ï¼Œæ¸¸æˆå¼€å§‹ã€‚è¯·æ ¹æ®æ¨¡ç»„å¼€ç¯‡ï¼Œå¼•å¯¼è°ƒæŸ¥å‘˜è¿›å…¥åœºæ™¯ã€‚`;
                        cocState.log = [{ role: 'assistant', name: 'å®ˆå¯†äºº', content: `æ¬¢è¿æ¥åˆ°ã€Š${cocState.module.name}ã€‹ã€‚\n\n(çœ‹ç€æ‰‹ä¸­çš„è°ƒæŸ¥å‘˜æ¡£æ¡ˆ)\nâ€œå„ä½è°ƒæŸ¥å‘˜...â€\n\nè¯·ç¡®è®¤ä½ çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å³å°†å¼€å§‹ã€‚` }];
                    }
                    
                    cocState.systemPrompt = systemPrompt;
                    cocState.gameState = 'playing';
                    currentView.value = 'chat'; // Switch to chat view
                    
                    if (cocState.mode === 'multi' && multiplayerState.isHost) {
                        broadcastMessage({ type: 'game_start', log: cocState.log });
                    }

                    console.log('=== Game Started ===');
                    console.log('System Prompt Constructed:', systemPrompt);
                };

                const handleInvestigatorClick = (index) => {
                    if (cocState.mode === 'single') {
                        cocState.activeInvestigatorIndex = index;
                    } else {
                        // Multi mode
                        if (cocState.gameState !== 'preparing') return;

                        // Check if this slot is reserved (from save load)
                        if (multiplayerState.assignmentDetails && multiplayerState.assignmentDetails[index]) {
                            const reserved = multiplayerState.assignmentDetails[index];
                            // Allow if ID matches OR Name matches (fuzzy fallback)
                            // Note: ID might change if user cleared cache, so Name is a good fallback
                            const isMe = reserved.id === user.uuid || reserved.name === user.name;
                            
                            if (!isMe && !multiplayerState.isHost) {
                                showToast(`è¯¥è§’è‰²å·²ç»‘å®šç»™ç©å®¶: ${reserved.name}`, 'warning');
                                return;
                            }
                            
                            // If it is me, I can "claim" it
                            if (isMe) {
                                if (multiplayerState.isHost) {
                                    // Host claims directly
                                    clearUserAssignments(user.uuid); // Ensure unique assignment
                                    multiplayerState.assignments[index] = user.uuid;
                                    // Remove from pending details once claimed? No, keep for reference or remove?
                                    // Better to update assignments.
                                    broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments });
                                    showToast('æ¬¢è¿å›æ¥ï¼Œè°ƒæŸ¥å‘˜', 'success');
                                } else {
                                    // Client claims
                                    broadcastMessage({ type: 'claim_role', index, userId: user.uuid });
                                }
                                cocState.activeInvestigatorIndex = index;
                                return;
                            }
                        }

                        // Normal Selection Logic (New Game)
                        // 1. Check if occupied by others
                        if (multiplayerState.assignments[index] && multiplayerState.assignments[index] !== user.uuid) {
                            showToast('è¯¥è§’è‰²å·²è¢«å ç”¨', 'warning');
                            return;
                        }

                        if (multiplayerState.isHost) {
                            // Host Logic
                            // Only allow picking if NOT loading a save with bindings (or if bindings are cleared)
                            if (!multiplayerState.assignmentDetails || Object.keys(multiplayerState.assignmentDetails).length === 0) {
                                // Check turn
                                if (multiplayerState.members[multiplayerState.turnIndex]?.id !== user.uuid) {
                                    // If host tries to click during others' turn
                                    // Allow clicking own assigned character to potentially unassign?
                                    // Or if clicking an unassigned character, warn "Not your turn"
                                    if (multiplayerState.assignments[index] === user.uuid) {
                                         // Allowed to click own (maybe to view details), but re-assign logic below handles toggle
                                    } else {
                                        showToast(`è¿˜æ²¡è½®åˆ°ä½ ï¼è¯·ç­‰å¾… ${multiplayerState.members[multiplayerState.turnIndex]?.name} é€‰æ‹©`, 'warning');
                                        return;
                                    }
                                }

                                cocState.activeInvestigatorIndex = index;

                                if (multiplayerState.members[multiplayerState.turnIndex]?.id === user.uuid) {
                                    // If clicking already assigned (self), do nothing (prevent unassign)
                                    if (multiplayerState.assignments[index] === user.uuid) {
                                        // Still update active view just in case
                                        cocState.activeInvestigatorIndex = index;
                                        return;
                                    } else {
                                        // Clear previous assignment for this user
                                        clearUserAssignments(user.uuid);
                                        multiplayerState.assignments[index] = user.uuid;
                                        // Advance turn
                                        if (multiplayerState.turnIndex < multiplayerState.members.length - 1) {
                                            multiplayerState.turnIndex++;
                                        }
                                        broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments, turnIndex: multiplayerState.turnIndex });
                                    }
                                }
                            }
                        } else {
                            // Client
                            if (!multiplayerState.assignmentDetails || Object.keys(multiplayerState.assignmentDetails).length === 0) {
                                const currentTurnPlayer = multiplayerState.members[multiplayerState.turnIndex];
                                if (!currentTurnPlayer || currentTurnPlayer.id !== user.uuid) {
                                    showToast(`è¿˜æ²¡è½®åˆ°ä½ ï¼è¯·ç­‰å¾… ${currentTurnPlayer?.name} é€‰æ‹©`, 'warning');
                                    return;
                                }
                                const currentOwner = multiplayerState.assignments[index];
                                if (currentOwner === user.uuid) return;
                                if (currentOwner) {
                                    showToast('è¯¥è§’è‰²å·²è¢«å…¶ä»–ç©å®¶é€‰æ‹©', 'warning');
                                    return;
                                }
                                broadcastMessage({ type: 'request_assignment', index, userId: user.uuid });
                            }
                        }
                    }
                };

                const updateMyAssignment = () => {
                    // Find if I have an assignment
                    const myIndex = Object.keys(multiplayerState.assignments).find(key => multiplayerState.assignments[key] === user.uuid);
                    if (myIndex !== undefined) {
                        cocState.activeInvestigatorIndex = parseInt(myIndex);
                    } else {
                        // Fix: In playing mode, host needs a view (default to first investigator)
                        // æˆ¿ä¸»åœ¨æ¸¸æˆè¿›è¡Œä¸­å¦‚æœæ²¡æœ‰è§’è‰²ï¼Œé»˜è®¤æŸ¥çœ‹ç¬¬ä¸€ä¸ªï¼Œä»¥ç¡®ä¿ä¾§è¾¹æ æ˜¾ç¤º
                        if (multiplayerState.isHost && cocState.gameState === 'playing' && cocState.investigators.length > 0) {
                            cocState.activeInvestigatorIndex = 0;
                        } else {
                            cocState.activeInvestigatorIndex = -1;
                        }
                    }
                };

                const scrollToBottom = () => {
                    nextTick(() => { if (cocChatContainer.value) cocChatContainer.value.scrollTop = cocChatContainer.value.scrollHeight; });
                };

                const sendCocMessage = async (manualContent = null) => {
                    const isDirect = typeof manualContent === 'string';
                    const content = isDirect ? manualContent : cocInput.value.trim();
                    if (!content || isGenerating.value) return;
                    if (!isDirect) cocInput.value = '';

                    const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                    // Fix: å¦‚æœæ˜¯æˆ¿ä¸»ä¸”æœªé€‰æ‹©è°ƒæŸ¥å‘˜ï¼ˆå¯èƒ½æ˜¯è‡ªåŠ¨é‡ç½®å¯¼è‡´çš„ï¼‰ï¼Œå°è¯•è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª
                    if (!inv && multiplayerState.isHost && cocState.investigators.length > 0) {
                        cocState.activeInvestigatorIndex = 0;
                        inv = cocState.investigators[0];
                    }

                    if (!inv) return showToast('è¯·é€‰æ‹©è°ƒæŸ¥å‘˜', 'warning');

                    // --- ç§èŠå¤„ç† ---
                    if (content.startsWith('@')) {
                        const spaceIndex = content.indexOf(' ');
                        if (spaceIndex === -1) {
                            showToast('ç§èŠæ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨ "@åå­— æ¶ˆæ¯å†…å®¹"', 'warning');
                            if (!isDirect) cocInput.value = content;
                            return;
                        }

                        const targetName = content.substring(1, spaceIndex);
                        const msgContent = content.substring(spaceIndex + 1);
                        
                        if (!msgContent.trim()) {
                            showToast('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'warning');
                            if (!isDirect) cocInput.value = content;
                            return;
                        }

                        // æŸ¥æ‰¾ç›®æ ‡ç”¨æˆ·ï¼ˆä¼˜å…ˆåŒ¹é…è§’è‰²åï¼Œå…¶æ¬¡åŒ¹é…ç©å®¶åï¼‰
                        let targetMember = null;
                        let targetCharName = null;

                        // 1. å°è¯•é€šè¿‡è§’è‰²åæŸ¥æ‰¾
                        if (cocState.mode === 'multi') {
                            for (const [idx, uid] of Object.entries(multiplayerState.assignments)) {
                                const char = cocState.investigators[idx];
                                if (char && char.name.includes(targetName)) {
                                    targetMember = multiplayerState.members.find(m => m.id === uid);
                                    targetCharName = char.name;
                                    break;
                                }
                            }
                        }

                        // 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•é€šè¿‡ç©å®¶åæŸ¥æ‰¾
                        if (!targetMember) {
                            targetMember = multiplayerState.members.find(m => m.name.includes(targetName));
                        }
                        
                        if (targetMember) {
                            const displayName = targetCharName || targetMember.name;
                            // æœ¬åœ°æ˜¾ç¤º
                            const whisperMsg = {
                                role: 'whisper',
                                name: inv.name,
                                avatar: inv.avatar,
                                content: `[å¯¹ ${displayName} è¯´] ${msgContent}`
                            };
                            cocState.log.push(whisperMsg);
                            scrollToBottom();

                            // å¹¿æ’­ï¼ˆåªç»™ç›®æ ‡å’Œè‡ªå·±ï¼Œæˆ–è€…å…¨å‘˜å¯è§ä½†æ ‡è®°ä¸ºç§èŠï¼‰
                            if (multiplayerState.inRoom) {
                                broadcastMessage({
                                    type: 'coc_chat',
                                    role: 'whisper',
                                    name: inv.name,
                                    avatar: inv.avatar,
                                    content: `[å¯¹ ${displayName} è¯´] ${msgContent}`,
                                    senderId: multiplayerState.myId,
                                    targetId: targetMember.id // ç”¨äºæ¥æ”¶ç«¯è¿‡æ»¤
                                });
                            }
                            cocInput.value = '';
                            return; // ç§èŠä¸è§¦å‘æ¸¸æˆå›åˆ
                        } else {
                            showToast(`æ‰¾ä¸åˆ°åä¸º "${targetName}" çš„ç©å®¶æˆ–è§’è‰²`, 'warning');
                            if (!isDirect) cocInput.value = content;
                            return;
                        }
                    }

                    // --- æŒ‡ä»¤ç³»ç»Ÿå¤„ç† ---
                    if (content.startsWith('.')) {
                        const cmdParts = content.trim().split(/\s+/);
                        const cmdType = cmdParts[0].toLowerCase(); // .ra, .sc, etc.
                        const cmdArgs = cmdParts.slice(1).join(' '); // ä¾¦æŸ¥, 1/1d3, etc.

                        // 1. éªŒè¯æƒé™
                        // å¿…é¡»åœ¨ pendingRolls ä¸­æ‰¾åˆ°åŒ¹é…çš„ (targetName === inv.name)
                        // ä¸” command ç±»å‹åŒ¹é… (.ra/.rc or .sc/.san)
                        // ä¸”å¦‚æœæ˜¯ .raï¼ŒæŠ€èƒ½åæœ€å¥½ä¹Ÿè¦åŒ¹é…ï¼ˆæˆ–è€…å…è®¸æ¨¡ç³ŠåŒ¹é…ï¼‰
                        
                        const myPendingRollIndex = cocState.pendingRolls.findIndex(p => {
                            if (p.targetName !== inv.name) return false;
                            
                            // å®½æ¾åŒ¹é…é€»è¾‘ (å“åº”ç”¨æˆ·éœ€æ±‚ï¼šå½“ KP è¦æ±‚ .ra æ—¶ï¼Œæ”¾å¼€æ‰€æœ‰æ£€å®š)
                            
                            // 1. ç©å®¶è¾“å…¥ .ra / .rc
                            if (cmdType === '.ra' || cmdType === '.rc') {
                                // åªè¦ pending æ˜¯ .ra/.rc å³å¯ï¼Œä¸å†å¼ºåˆ¶æ£€æŸ¥æŠ€èƒ½ååŒ¹é…
                                if (p.command === '.ra' || p.command === '.rc') return true;
                            }
                            
                            // 2. ç©å®¶è¾“å…¥ .sc / .san
                            if (cmdType === '.sc' || cmdType === '.san') {
                                // åŒ¹é… .sc çš„ pending
                                if (p.command === '.sc' || p.command === '.san') return true;
                                // æ ¹æ®éœ€æ±‚ï¼šå¦‚æœ pending æ˜¯ .raï¼Œä¹Ÿå…è®¸ç©å®¶è¿›è¡Œ .sc
                                if (p.command === '.ra' || p.command === '.rc') return true;
                            }
                            
                            return false;
                        });

                        if (myPendingRollIndex === -1) {
                            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•é’ˆå¯¹æˆ‘çš„æ£€å®š
                            const hasAnyRoll = cocState.pendingRolls.some(p => p.targetName === inv.name);
                            if (hasAnyRoll) {
                                const req = cocState.pendingRolls.find(p => p.targetName === inv.name);
                                showToast(`æŒ‡ä»¤ä¸åŒ¹é…ã€‚Keeper è¦æ±‚: ${req.command} ${req.args}`, 'warning');
                            } else {
                                showToast('Keeper æœªè¦æ±‚ä½ è¿›è¡Œæ­¤æ£€å®š', 'warning');
                            }
                            return;
                        }

                        let systemMsg = '';
                        let logContent = '';
                        
                        // .r / .roll ç®€å•æ·éª° (æš‚æ—¶ç¦ç”¨ï¼Œå› ä¸º pendingRolls æœºåˆ¶ä¸æ”¯æŒæ— ç›®æ ‡æ·éª°ï¼Œé™¤é Keeper æ˜¾å¼å…è®¸)
                        if (content.match(/^\.(r|roll)(\s|$)/i)) {
                            // åªæœ‰å½“ Keeper æ˜ç¡®å‘é€ @Name .r æ—¶æ‰å…è®¸ï¼ˆå½“å‰æ­£åˆ™æœªæ•è· .rï¼Œéœ€æ‰©å±•æ­£åˆ™æˆ–ä¿æŒç¦ç”¨ï¼‰
                             showToast('å½“å‰è§„åˆ™ä¸‹ä»…å…è®¸å“åº” Keeper çš„ç‰¹å®šæ£€å®šè¦æ±‚', 'warning');
                             return;
                        }
                        // .st / .set å±æ€§ä¿®æ”¹ (.st hp -1 / .st san +5 / .st str 60)
                        else if (content.match(/^\.(st|set)(\s|$)/i)) {
                            // .st æŒ‡ä»¤é€šå¸¸ç”± KP (AI) è§¦å‘ï¼Œæˆ–è€…ç©å®¶åœ¨è¢«å…è®¸æ—¶è§¦å‘
                            // è§£æ: .st å±æ€§ å€¼
                            const parts = content.split(/\s+/);
                            if (parts.length < 3) {
                                showToast('æ ¼å¼é”™è¯¯: .st å±æ€§ å€¼', 'warning');
                                return;
                            }
                            const prop = parts[1];
                            const valExpr = parts[2];
                            
                            const res = executeStCommand(inv, prop, valExpr);
                            if (res && res.success) {
                                systemMsg = `[ç³»ç»Ÿ] ${res.msg}`;
                                logContent = res.log;
                            } else {
                                showToast(res ? res.msg : 'æ‰§è¡Œå¤±è´¥', 'error');
                                return;
                            }
                        }
                        // .sc / .san SAN Check (.sc 1/1d6)
                        else if (content.match(/^\.(sc|san)(\s|$)/i)) {
                            const pendingReq = cocState.pendingRolls[myPendingRollIndex];
                            // å¦‚æœ pendingReq æ˜¯ sc ç±»å‹ï¼Œä¼˜å…ˆç”¨å®ƒçš„å‚æ•°ï¼›å¦‚æœæ˜¯ ra ç±»å‹ï¼ˆè·¨ç±»å‹å…è®¸ï¼‰ï¼Œåˆ™å¿½ç•¥ pending å‚æ•°ï¼Œä½¿ç”¨ç©å®¶è¾“å…¥çš„
                            let args = '';
                            if (pendingReq && (pendingReq.command === '.sc' || pendingReq.command === '.san')) {
                                args = pendingReq.args;
                            }
                            if (!args) args = content.split(/\s+/)[1] || '';
                            
                            const [successLoss, failLoss] = args.split('/').map(s => s || '0');
                            
                            const val = Math.floor(Math.random() * 100) + 1;
                            const isSuccess = val <= inv.san;
                            let lossExpr = isSuccess ? successLoss : failLoss;
                            
                            // è§£ææ‰£é™¤è¡¨è¾¾å¼ (å¦‚ 1d6)
                            let loss = 0;
                            if (lossExpr.includes('d')) {
                                const [n, d] = lossExpr.split('d').map(Number);
                                for(let i=0; i<(n||1); i++) loss += Math.floor(Math.random()*(d||6))+1;
                            } else {
                                loss = parseInt(lossExpr) || 0;
                            }

                            const oldSan = inv.san;
                            inv.san = Math.max(0, inv.san - loss);
                            saveData(); // ä¿å­˜çŠ¶æ€å˜æ›´

                            const resultStr = isSuccess ? 'æˆåŠŸ' : 'å¤±è´¥';
                            systemMsg = `[ç³»ç»Ÿ] ${inv.name} è¿›è¡Œ SAN Check: 1d100=${val}/${oldSan} [${resultStr}]ã€‚æ‰£é™¤ SAN å€¼: ${loss} (å½“å‰: ${inv.san})ã€‚`;
                            logContent = `ğŸ‘» **SAN Check ${resultStr}** (1d100=${val}/${oldSan})\næŸå¤± ${loss} ç‚¹ SAN (å½“å‰: ${inv.san})`;
                        }
                        // .ra / .rc æŠ€èƒ½æ£€å®š (.ra ä¾¦æŸ¥) ä»¥åŠ .rb (å¥–åŠ±éª°) / .rp (æƒ©ç½šéª°)
                        else if (content.match(/^\.(ra|rc|rb|rp)(\s|$)/i)) {
                            const pendingReq = cocState.pendingRolls[myPendingRollIndex];
                            const cmdParts = content.split(/\s+/);
                            const cmdType = cmdParts[0].toLowerCase();
                            
                            // ä¼˜å…ˆä½¿ç”¨ç©å®¶è¾“å…¥çš„æŠ€èƒ½åï¼Œå¦‚æœç©å®¶æœªè¾“å…¥ï¼Œåˆ™ä½¿ç”¨ Keeper æŒ‡å®šçš„
                            // å¯¹äº .rb/.rpï¼Œå‚æ•°æ ¼å¼é€šå¸¸æ˜¯ .rb [æ•°é‡] [æŠ€èƒ½å] æˆ– .rb [æŠ€èƒ½å] (é»˜è®¤1ä¸ª)
                            // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å‡è®¾ .rb/.rp åé¢çš„ç¬¬ä¸€ä¸ªéæ•°å­—å‚æ•°æ˜¯æŠ€èƒ½åï¼Œæ•°å­—æ˜¯éª°å­æ•°é‡
                            
                            let skillName = '';
                            let bonusDice = 0; // æ­£æ•°å¥–åŠ±ï¼Œè´Ÿæ•°æƒ©ç½š
                            
                            if (cmdType === '.rb' || cmdType === '.rp') {
                                const args = cmdParts.slice(1);
                                let count = 1;
                                
                                // è§£æå‚æ•°
                                for (const arg of args) {
                                    if (/^\d+$/.test(arg)) {
                                        count = parseInt(arg);
                                    } else {
                                        skillName = arg;
                                    }
                                }
                                if (cmdType === '.rp') count = -count;
                                bonusDice = count;
                            } else {
                                skillName = cmdParts[1];
                            }
                            
                            if (!skillName && pendingReq) skillName = pendingReq.args;
                            
                            let skillVal = 0;
                            let skillLabel = skillName || 'å±æ€§/æŠ€èƒ½';

                            // å±æ€§æ˜ å°„è¡¨ (æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ç¼©å†™)
                            const statMap = {
                                'åŠ›é‡': 'STR', 'STR': 'STR',
                                'ä½“è´¨': 'CON', 'CON': 'CON',
                                'ä½“å‹': 'SIZ', 'SIZ': 'SIZ',
                                'æ•æ·': 'DEX', 'DEX': 'DEX',
                                'å¤–è²Œ': 'APP', 'APP': 'APP',
                                'æ™ºåŠ›': 'INT', 'INT': 'INT', 'çµæ„Ÿ': 'INT',
                                'æ„å¿—': 'POW', 'POW': 'POW',
                                'æ•™è‚²': 'EDU', 'EDU': 'EDU', 'çŸ¥è¯†': 'EDU',
                                'å¹¸è¿': 'LUCK', 'LUCK': 'LUCK'
                            };

                            // æŸ¥æ‰¾æŠ€èƒ½æˆ–å±æ€§
                            if (skillName) {
                                // æ¨¡ç³ŠåŒ¹é…æŠ€èƒ½: ç²¾ç¡®åŒ¹é… -> åŒ…å«åŒ¹é…
                                const s = inv.skills.find(k => k.name === skillName) ||
                                          inv.skills.find(k => k.name.includes(skillName) || skillName.includes(k.name));
                                          
                                if (s) {
                                    skillVal = s.value;
                                    skillLabel = s.name; // ä½¿ç”¨æ‰¾åˆ°çš„å®é™…æŠ€èƒ½å
                                } else {
                                    // å°è¯•æŸ¥æ‰¾åŸºç¡€å±æ€§
                                    const statKey = statMap[skillName] || statMap[skillName.toUpperCase()];
                                    if (statKey && inv.stats[statKey]) {
                                        skillVal = inv.stats[statKey];
                                        skillLabel = `${skillName}(${statKey})`;
                                    } else if (inv.stats[skillName.toUpperCase()]) {
                                        // Fallback
                                        skillVal = inv.stats[skillName.toUpperCase()];
                                        skillLabel = skillName.toUpperCase();
                                    }
                                }
                            }
                            
                            // éª°ç‚¹é€»è¾‘ (å«å¥–åŠ±/æƒ©ç½šéª°)
                            // è§„åˆ™ï¼šä¸ªä½ä¸å˜ï¼Œåä½å¤šæŠ• N ä¸ªï¼Œå¥–åŠ±éª°å–æœ€å°åä½ï¼Œæƒ©ç½šéª°å–æœ€å¤§åä½
                            const units = Math.floor(Math.random() * 10); // 0-9
                            const tens = [Math.floor(Math.random() * 10)]; // åˆå§‹åä½ 0-9
                            
                            const extraDiceCount = Math.abs(bonusDice);
                            for(let i=0; i<extraDiceCount; i++) {
                                tens.push(Math.floor(Math.random() * 10));
                            }
                            
                            let finalTen = tens[0];
                            if (bonusDice > 0) {
                                // å¥–åŠ±éª°ï¼šå–æœ€å°
                                // æ³¨æ„ï¼š0 åœ¨ COC ä¸­ä»£è¡¨ 0 æˆ– 100ã€‚å¦‚æœæ˜¯ 00 (100)ï¼Œåä½æ˜¯ 0ã€‚
                                // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šç›´æ¥æ¯”è¾ƒæ•°å­—å¤§å°ï¼Œæœ€åç»„åˆæˆ 1-100
                                // å®é™…ä¸Š COC è§„åˆ™æ˜¯æ¯”è¾ƒæœ€ç»ˆç»“æœã€‚
                                // ä¾‹å¦‚ï¼šä¸ªä½ 5ã€‚åä½æŠ•å‡º 1 å’Œ 2ã€‚ç»„åˆæˆ 15 å’Œ 25ã€‚å– 15ã€‚
                                // å¦‚æœä¸ªä½ 0ã€‚åä½æŠ•å‡º 0 å’Œ 1ã€‚ç»„åˆæˆ 100 (00) å’Œ 10ã€‚å– 10ã€‚
                                // è®©æˆ‘ä»¬æ„å»ºæ‰€æœ‰å¯èƒ½çš„æœ€ç»ˆå€¼ï¼Œç„¶åæ¯”è¾ƒ
                                const candidates = tens.map(t => {
                                    let val = t * 10 + units;
                                    if (val === 0) val = 100;
                                    return val;
                                });
                                finalTen = -1; // unused
                                var finalVal = Math.min(...candidates);
                            } else if (bonusDice < 0) {
                                // æƒ©ç½šéª°ï¼šå–æœ€å¤§
                                const candidates = tens.map(t => {
                                    let val = t * 10 + units;
                                    if (val === 0) val = 100;
                                    return val;
                                });
                                finalTen = -1;
                                var finalVal = Math.max(...candidates);
                            } else {
                                finalVal = tens[0] * 10 + units;
                                if (finalVal === 0) finalVal = 100;
                            }

                            let level = '';
                            if (skillVal > 0) {
                                if (finalVal === 1) level = 'å¤§æˆåŠŸ';
                                else if (finalVal === 100) level = 'å¤§å¤±è´¥';
                                else if (finalVal <= skillVal / 5) level = 'æéš¾æˆåŠŸ';
                                else if (finalVal <= skillVal / 2) level = 'å›°éš¾æˆåŠŸ';
                                else if (finalVal <= skillVal) level = 'æˆåŠŸ';
                                else level = 'å¤±è´¥';
                            }

                            const resultStr = skillVal > 0 ? `${level}` : '';
                            
                            // æ˜¾ç¤ºé€»è¾‘ï¼šå¦‚æœæ˜¯å¥–åŠ±/æƒ©ç½šéª°ï¼Œè§†ä¸ºæš—éª°ï¼Œä¸æ˜¾ç¤ºå…·ä½“ç‚¹æ•°ï¼Œåªæ˜¾ç¤ºç»“æœçŠ¶æ€
                            const isSecret = bonusDice !== 0;
                            
                            if (isSecret) {
                                systemMsg = `[ç³»ç»Ÿ] ${inv.name} è¿›è¡Œ ${skillLabel} æ£€å®š (${bonusDice > 0 ? 'å¥–åŠ±' : 'æƒ©ç½š'} ${Math.abs(bonusDice)}): [${resultStr}]`;
                                logContent = `ğŸ² **${skillLabel} ${resultStr}** (???/${skillVal || '?'}) ${bonusDice > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'}`;
                            } else {
                                systemMsg = `[ç³»ç»Ÿ] ${inv.name} è¿›è¡Œ ${skillLabel} æ£€å®š: 1d100=${finalVal}/${skillVal || '?'} [${resultStr}]`;
                                logContent = `ğŸ² **${skillLabel} ${resultStr}** (1d100=${finalVal}/${skillVal || '?'})`;
                            }
                        }

                        if (logContent) {
                            // æ£€å®šå®Œæˆåï¼Œä» pendingRolls ä¸­ç§»é™¤è¯¥è¯·æ±‚
                            cocState.pendingRolls.splice(myPendingRollIndex, 1);

                            cocState.log.push({ role: 'user', name: inv.name, avatar: inv.avatar, content });
                            cocState.log.push({ role: 'system', content: logContent });
                            scrollToBottom();

                            if (multiplayerState.inRoom) {
                                broadcastMessage({ type: 'coc_chat', role: 'user', name: inv.name, avatar: inv.avatar, content, senderId: multiplayerState.myId });
                                broadcastMessage({ type: 'coc_chat', role: 'system', content: logContent });
                                
                                // Mark self as acted (prevent duplicates)
                                if (!multiplayerState.roundActionIds.includes(user.uuid)) {
                                    multiplayerState.roundActionIds.push(user.uuid);
                                }
                                broadcastMessage({ type: 'action_taken', userId: user.uuid });
                                
                                if (multiplayerState.isHost) {
                                    checkAndTriggerRound();
                                }
                            } else {
                                generateResponse();
                            }
                            return;
                        }
                    }

                    // æ™®é€šå¯¹è¯
                    cocState.log.push({ role: 'user', name: inv.name, avatar: inv.avatar, content });
                    scrollToBottom();

                    if (multiplayerState.inRoom) {
                        broadcastMessage({ type: 'coc_chat', role: 'user', name: inv.name, avatar: inv.avatar, content, senderId: multiplayerState.myId });
                        
                        // åªæœ‰åœ¨ã€ä¸éœ€è¦æ£€å®šã€‘æˆ–è€…ã€å½“å‰å·²ç»æ˜¯æ£€å®šç»“æœ(ä½†è¿™éƒ¨åˆ†é€»è¾‘åœ¨ä¸Šé¢ifå—)ã€‘æ—¶ï¼Œæ‰ç®—è¡ŒåŠ¨ç»“æŸ
                        // å¦‚æœå½“å‰ Keeper è¦æ±‚æˆ‘æ£€å®š (pendingRolls has me)ï¼Œåˆ™æ™®é€šå¯¹è¯ä¸ç®—ä½œâ€œå®Œæˆè¡ŒåŠ¨â€ï¼Œä¸è§¦å‘ä¸‹ä¸€è½®
                        const hasPending = cocState.pendingRolls.some(p => p.targetName === inv.name);
                        
                        if (!hasPending) {
                            if (!multiplayerState.roundActionIds.includes(user.uuid)) {
                                multiplayerState.roundActionIds.push(user.uuid);
                            }
                            broadcastMessage({ type: 'action_taken', userId: user.uuid });

                            if (multiplayerState.isHost) {
                                checkAndTriggerRound();
                            }
                        }
                    } else {
                        // å•äººæ¨¡å¼ä¸‹ï¼Œæ— è®ºæ˜¯å¦éœ€è¦æ£€å®šï¼Œæ™®é€šå¯¹è¯éƒ½åº”è§¦å‘ AI å›å¤ï¼Œé¿å…æ­»é”
                        generateResponse();
                    }
                };

                const generateResponse = async () => {
                    isGenerating.value = true;
                    if (multiplayerState.inRoom && multiplayerState.isHost) {
                        broadcastMessage({ type: 'keeper_typing', status: true });
                    }
                    // å¦‚æœæ˜¯æµå¼ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„ assistant æ¶ˆæ¯
                    const assistantMsg = {
                        role: 'assistant',
                        name: 'å®ˆå¯†äºº',
                        content: '',
                        showCot: false // é»˜è®¤æŠ˜å  CoT
                    };
                    cocState.log.push(assistantMsg);
                    
                    try {
                        // æ„å»ºå½“å‰çŠ¶æ€å¿«ç…§
                        let statusSnapshot = "ã€å½“å‰è°ƒæŸ¥å‘˜å®æ—¶çŠ¶æ€ç›‘æ§ã€‘\n";
                        if (cocState.mode === 'multi') {
                            for (const [idx, uid] of Object.entries(multiplayerState.assignments)) {
                                const inv = cocState.investigators[idx];
                                if (inv) {
                                    statusSnapshot += `- ${inv.name}: HP ${inv.hp}/${inv.maxHp} | MP ${inv.mp}/${inv.maxMp} | SAN ${inv.san}/${inv.maxSan}`;
                                    if (inv.hp < inv.maxHp * 0.3) statusSnapshot += " [é‡ä¼¤/æ¿’æ­»]";
                                    if (inv.san < 30) statusSnapshot += " [ç²¾ç¥ææƒš/ç–¯ç‹‚]";
                                    statusSnapshot += "\n";
                                }
                            }
                        } else {
                            const inv = cocState.investigators[cocState.activeInvestigatorIndex];
                            if (inv) {
                                statusSnapshot += `- ${inv.name}: HP ${inv.hp}/${inv.maxHp} | MP ${inv.mp}/${inv.maxMp} | SAN ${inv.san}/${inv.maxSan}`;
                                if (inv.hp < inv.maxHp * 0.3) statusSnapshot += " [é‡ä¼¤/æ¿’æ­»]";
                                if (inv.san < 30) statusSnapshot += " [ç²¾ç¥ææƒš/ç–¯ç‹‚]";
                                statusSnapshot += "\n";
                            }
                        }
                        statusSnapshot += "è¯·æ ¹æ®ä»¥ä¸ŠçŠ¶æ€è°ƒæ•´ä½ çš„å™äº‹è¯­æ°”å’Œæè¿°ç»†èŠ‚ã€‚";

                        const msgs = [
                            { role: 'system', content: cocState.systemPrompt },
                            ...cocState.log.slice(0, -1).map(m => { // Exclude the empty assistant msg we just added
                                if (m.role === 'user') return { role: 'user', content: `${m.name}: ${m.content}` };
                                if (m.role === 'assistant') return { role: 'assistant', content: m.content };
                                if (m.role === 'system') return { role: 'system', content: `[ç³»ç»Ÿæç¤º] ${m.content}` };
                                return null;
                            }).filter(Boolean),
                            // å°†çŠ¶æ€å¿«ç…§ä½œä¸ºæœ€æ–°çš„ System Hint æ’å…¥ï¼Œç¡®ä¿ LLM èƒ½çœ‹åˆ°æœ€æ–°çš„æ•°å€¼
                            { role: 'system', content: statusSnapshot }
                        ];

                        const res = await fetch(`${settings.apiUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: msgs,
                                temperature: settings.temperature,
                                stream: true // Enable streaming
                            })
                        });

                        if (!res.ok) {
                            if (res.status === 401) {
                                throw new Error('API Key æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·åœ¨è®¾ç½®ä¸­æ›´æ–° Key');
                            }
                            throw new Error(res.statusText);
                        }

                        const reader = res.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop(); // Keep incomplete line in buffer

                            for (const line of lines) {
                                if (line.trim() === '') continue;
                                if (line.trim() === 'data: [DONE]') break;
                                if (line.startsWith('data: ')) {
                                    try {
                                        const json = JSON.parse(line.slice(6));
                                        const content = json.choices[0]?.delta?.content || '';
                                        if (content) {
                                            assistantMsg.content += content;
                                            scrollToBottom();
                                        }
                                    } catch (e) { console.error('Parse Error', e); }
                                }
                            }
                        }
                        
                        // ç”Ÿæˆå®Œæˆåï¼Œè§£ææŒ‡ä»¤ (.ra/.sc/.st)
                        const pending = [];
                        const lines = assistantMsg.content.split('\n');
                        
                        for (const line of lines) {
                            // 1. æå–è¯¥è¡Œæ‰€æœ‰ @Name
                            const nameRegex = /@([^\s@,ï¼Œ.ã€‚!ï¼?ï¼Ÿ;ï¼›:ï¼š]+)/g;
                            const names = [];
                            let nameMatch;
                            while ((nameMatch = nameRegex.exec(line)) !== null) {
                                names.push(nameMatch[1]);
                            }

                            if (names.length === 0) continue;

                            // 2. æå–è¯¥è¡Œæ‰€æœ‰æŒ‡ä»¤
                            const cmdRegex = /(\.(?:ra|rc|sc|san|st|set))\s+([^\s\n,ï¼Œ.ã€‚!ï¼?ï¼Ÿ;ï¼›:ï¼š\(\)ï¼ˆï¼‰]+)(?:\s+([^\s\n,ï¼Œ.ã€‚!ï¼?ï¼Ÿ;ï¼›:ï¼š\(\)ï¼ˆï¼‰]+))?/gi;
                            const cmds = [];
                            let cmdMatch;
                            while ((cmdMatch = cmdRegex.exec(line)) !== null) {
                                cmds.push({
                                    command: cmdMatch[1].toLowerCase(),
                                    args: cmdMatch[2],
                                    args2: cmdMatch[3] // For .st prop val
                                });
                            }

                            // 3. å¤„ç†æŒ‡ä»¤
                            if (cmds.length > 0) {
                                for (const name of names) {
                                    // Find investigator by name (fuzzy match)
                                    let targetInv = null;
                                    
                                    // Try to match name in cocState.investigators
                                    cocState.investigators.forEach((inv) => {
                                        if (inv.name.includes(name) || name.includes(inv.name)) {
                                            targetInv = inv;
                                        }
                                    });

                                    for (const cmd of cmds) {
                                        // Auto-execute .st (Secret Roll / Stat Mod)
                                        if (cmd.command === '.st' || cmd.command === '.set') {
                                            if (targetInv && cmd.args && cmd.args2) {
                                                const res = executeStCommand(targetInv, cmd.args, cmd.args2);
                                                if (res && res.success) {
                                                    // Add system log for the change
                                                    cocState.log.push({ role: 'system', content: res.log });
                                                    if (multiplayerState.inRoom && multiplayerState.isHost) {
                                                        broadcastMessage({ type: 'coc_chat', role: 'system', content: res.log });
                                                    }
                                                }
                                            }
                                        } else {
                                            // .ra / .sc go to pending
                                            pending.push({
                                                targetName: name, // Keep original name from text for display
                                                command: cmd.command,
                                                args: cmd.args
                                            });
                                        }
                                    }
                                }
                            }
                        }
                        
                        cocState.pendingRolls = pending;
                        if (pending.length > 0) {
                            const myInv = cocState.investigators[cocState.activeInvestigatorIndex];
                            // Check fuzzy match for my name
                            const isMyRoll = myInv && pending.some(p => p.targetName.includes(myInv.name) || myInv.name.includes(p.targetName));
                            
                            if (isMyRoll) showToast('Keeper è¦æ±‚ä½ è¿›è¡Œæ£€å®š', 'info');
                            else showToast(`Keeper è¦æ±‚ ${[...new Set(pending.map(p=>p.targetName))].join(', ')} è¿›è¡Œæ£€å®š`, 'info');
                        }

                        if (multiplayerState.inRoom && multiplayerState.isHost) {
                            broadcastMessage({
                                type: 'coc_chat',
                                role: 'assistant',
                                name: 'å®ˆå¯†äºº',
                                content: assistantMsg.content,
                                senderId: multiplayerState.myId,
                                pendingRolls: cocState.pendingRolls
                            });
                            
                            // Reset Round
                            multiplayerState.roundActionIds = [];
                            broadcastMessage({ type: 'round_reset' });
                        }

                    } catch(e) {
                        // cocState.log.pop(); // Remove failed message -> æ”¹ä¸ºæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                        console.error('Generation Error:', e);
                        showToast('ç”Ÿæˆå¤±è´¥: '+e.message, 'error');
                        
                        // Update the last message to show error state
                        if (cocState.log.length > 0 && cocState.log[cocState.log.length - 1].role === 'assistant') {
                            const errorMsg = cocState.log[cocState.log.length - 1];
                            if (!errorMsg.content) {
                                errorMsg.content = `**[é€šè®¯ä¸­æ–­]**\n\n*å®ˆå¯†äººçš„å£°éŸ³è¢«ä¸€é˜µåˆºè€³çš„é™ç”µå™ªéŸ³æ·¹æ²¡...*\n\n(é”™è¯¯ä¿¡æ¯: ${e.message})`;
                            } else {
                                errorMsg.content += `\n\n**[ä¿¡å·ä¸¢å¤±]**\n(é”™è¯¯ä¿¡æ¯: ${e.message})`;
                            }
                            
                            // Broadcast error state to clients
                            if (multiplayerState.inRoom && multiplayerState.isHost) {
                                broadcastMessage({
                                    type: 'coc_chat',
                                    role: 'assistant',
                                    name: 'å®ˆå¯†äºº',
                                    content: errorMsg.content,
                                    senderId: multiplayerState.myId,
                                    isError: true
                                });
                            }
                        }
                    } finally {
                        isGenerating.value = false;
                        if (multiplayerState.inRoom && multiplayerState.isHost) {
                            broadcastMessage({ type: 'keeper_typing', status: false });
                        }
                    }
                };

                // Multiplayer
                const initSupabase = () => {
                    if (!settings.supabaseUrl || !settings.supabaseKey) return showToast('è¯·é…ç½® Supabase', 'error');
                    try {
                        supabaseClient = window.supabase.createClient(settings.supabaseUrl, settings.supabaseKey);
                        multiplayerState.isConnected = true;
                        showToast('å·²è¿æ¥æœåŠ¡å™¨', 'success');
                        saveData();
                        fetchLibraryModules(); // Fetch modules on connect
                        
                        // Setup Global Presence & Personal Channel
                        const globalChannel = supabaseClient.channel('global_presence', { config: { presence: { key: user.uuid } } });
                        globalChannel.on('presence', { event: 'sync' }, () => {
                            const state = globalChannel.presenceState();
                            const onlineIds = new Set();
                            Object.values(state).flat().forEach(p => onlineIds.add(p.user_id));
                            friends.value.forEach(f => f.isOnline = onlineIds.has(f.uuid));
                        }).subscribe(async (status) => {
                            if (status === 'SUBSCRIBED') await globalChannel.track({ user_id: user.uuid, online_at: new Date() });
                        });

                        supabaseClient.channel(`personal:${user.uuid}`).on('broadcast', { event: 'message' }, async ({ payload }) => {
                            if (payload.type === 'invite_room') {
                                if(await showConfirm(`${payload.sender.name} é‚€è¯·ä½ åŠ å…¥æˆ¿é—´ ${payload.roomId}`, 'æ”¶åˆ°é‚€è¯·')) {
                                    joinRoomId.value = payload.roomId;
                                    currentView.value = 'multiplayer';
                                    joinRoom();
                                }
                            } else if (payload.type === 'friend_request') {
                                if (!friends.value.some(f=>f.uuid===payload.sender.uuid)) friendRequests.value.push(payload.sender);
                            }
                        }).subscribe();

                    } catch(e) { showToast('è¿æ¥å¤±è´¥', 'error'); }
                };

                const createRoom = async (isLoadGame = false) => {
                    const id = Math.random().toString(36).substring(2, 8).toUpperCase();
                    
                    // Reset game state for new game
                    if (!isLoadGame) {
                        cocState.module = null;
                        cocState.investigators = [];
                        cocState.log = [];
                        cocState.systemPrompt = '';
                        cocState.pendingRolls = [];
                        cocState.activeInvestigatorIndex = -1;
                        
                        multiplayerState.assignments = {};
                        multiplayerState.assignmentDetails = {};
                        multiplayerState.turnIndex = 0;
                        multiplayerState.roundActionIds = [];
                    }

                    await joinRoom(id, true);
                };

                const joinRoom = async (id = null, asHost = false) => {
                    const roomId = id || joinRoomId.value.toUpperCase();
                    if (!roomId || !supabaseClient) return;
                    
                    if (roomChannel) await roomChannel.unsubscribe();
                    
                    // Reset local ready state when joining/re-joining
                    multiplayerState.isReady = false;
                    
                    multiplayerState.roomId = roomId;
                    multiplayerState.isHost = asHost;
                    multiplayerState.myId = user.uuid;

                    // Ensure presence key is unique (UUID) not Name
                    roomChannel = supabaseClient.channel(`room:${roomId}`, { config: { broadcast: { self: false }, presence: { key: user.uuid } } });
                    roomChannel.on('broadcast', { event: 'message' }, async ({ payload }) => {
                        if (payload.type === 'member_status') {
                            // Update local member list immediately from broadcast
                            const idx = multiplayerState.members.findIndex(m => m.id === payload.status.user_id);
                            if (idx !== -1) {
                                Object.assign(multiplayerState.members[idx], {
                                    isReady: payload.status.isReady,
                                    isHost: payload.status.is_host,
                                    name: payload.status.name,
                                    avatar: payload.status.avatar
                                });
                            }
                        } else if (payload.type === 'coc_chat') {
                            // Whisper filtering
                            if (payload.role === 'whisper') {
                                // Only show if I am the target or the sender
                                if (payload.targetId === user.uuid || payload.senderId === user.uuid) {
                                    cocState.log.push({ role: payload.role, name: payload.name, content: payload.content, avatar: payload.avatar });
                                    scrollToBottom();
                                }
                            } else {
                                cocState.log.push({ role: payload.role, name: payload.name, content: payload.content, avatar: payload.avatar });
                                // Client update pendingRolls status from Host
                                if (payload.role === 'assistant' && payload.pendingRolls !== undefined) {
                                    cocState.pendingRolls = payload.pendingRolls;
                                    // Check if I am targeted
                                    const myInv = cocState.investigators[cocState.activeInvestigatorIndex];
                                    if (myInv && cocState.pendingRolls.some(p => p.targetName === myInv.name)) {
                                        showToast('Keeper è¦æ±‚ä½ è¿›è¡Œæ£€å®š', 'info');
                                    }
                                }
                                scrollToBottom();
                            }
                        } else if (payload.type === 'action_taken') {
                            if (!multiplayerState.roundActionIds.includes(payload.userId)) {
                                multiplayerState.roundActionIds.push(payload.userId);
                            }
                            if (multiplayerState.isHost) checkAndTriggerRound();
                        } else if (payload.type === 'round_reset') {
                            multiplayerState.roundActionIds = [];
                            showToast('æ–°çš„ä¸€è½®å¼€å§‹äº†', 'info');
                        } else if (payload.type === 'request_cot_access' && multiplayerState.isHost) {
                            if (await showConfirm(`${payload.userName} ç”³è¯·æŸ¥çœ‹æ€ç»´é“¾ (CoT) æƒé™`, 'æƒé™ç”³è¯·')) {
                                grantCotAccess(payload.userId);
                            }
                        } else if (payload.type === 'grant_cot_access') {
                            multiplayerState.cotAuthorizedUsers = payload.authorizedUsers;
                            if (payload.userId === user.uuid) {
                                showToast('æˆ¿ä¸»å·²æ‰¹å‡†æ‚¨çš„ CoT æŸ¥çœ‹æƒé™', 'success');
                            }
                        } else if (payload.type === 'regenerate_start' && !multiplayerState.isHost) {
                            cocState.log.pop(); // Remove last message
                            showToast('æˆ¿ä¸»æ­£åœ¨é‡æ–°ç”Ÿæˆå›å¤...', 'info');
                        } else if (payload.type === 'sync_state' && !multiplayerState.isHost) {
                            cocState.log = payload.log;
                            if (payload.moduleName) cocState.module = { name: payload.moduleName, content: 'Synced' };
                            if (payload.investigators) cocState.investigators = payload.investigators;
                            if (payload.assignments) {
                                multiplayerState.assignments = payload.assignments;
                                updateMyAssignment();
                            }
                            if (payload.assignmentDetails) multiplayerState.assignmentDetails = payload.assignmentDetails;
                            if (payload.turnIndex !== undefined) multiplayerState.turnIndex = payload.turnIndex;
                            if (payload.roundActionIds) multiplayerState.roundActionIds = payload.roundActionIds;
                            if (payload.cotAuthorizedUsers) multiplayerState.cotAuthorizedUsers = payload.cotAuthorizedUsers;
                            // If game is playing, ensure we are in chat view
                            if (payload.gameState === 'playing') {
                                cocState.gameState = 'playing';
                                currentView.value = 'chat';
                            }
                        } else if (payload.type === 'sync_module' && !multiplayerState.isHost) {
                            cocState.module = { name: payload.moduleName, content: 'Synced' };
                            showToast('æˆ¿ä¸»å·²é€‰æ‹©æ¨¡ç»„: ' + payload.moduleName, 'info');
                        } else if (payload.type === 'sync_investigators' && !multiplayerState.isHost) {
                            cocState.investigators = payload.investigators;
                            showToast('è§’è‰²åˆ—è¡¨å·²æ›´æ–°', 'info');
                        } else if (payload.type === 'sync_assignments') {
                            multiplayerState.assignments = payload.assignments;
                            if (payload.turnIndex !== undefined) multiplayerState.turnIndex = payload.turnIndex;
                            updateMyAssignment();
                        } else if (payload.type === 'request_sync' && multiplayerState.isHost) {
                            // å“åº”æ–°åŠ å…¥/é‡è¿ç©å®¶çš„åŒæ­¥è¯·æ±‚
                            console.log('Received sync request from:', payload.userId);
                            broadcastMessage({
                                type: 'sync_state',
                                log: cocState.log,
                                moduleName: cocState.module?.name,
                                gameState: cocState.gameState,
                                investigators: cocState.investigators,
                                assignments: multiplayerState.assignments,
                                assignmentDetails: multiplayerState.assignmentDetails,
                                turnIndex: multiplayerState.turnIndex,
                                roundActionIds: multiplayerState.roundActionIds,
                                cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers
                            });
                        } else if (payload.type === 'claim_role' && multiplayerState.isHost) {
                            // Handle claim request from client (Resume Mode)
                            const { index, userId } = payload;
                            const reserved = multiplayerState.assignmentDetails[index];
                            // Verify again
                            // We need to find the member to check name
                            const member = multiplayerState.members.find(m => m.id === userId);
                            if (reserved && (reserved.id === userId || (member && reserved.name === member.name))) {
                                clearUserAssignments(userId); // Ensure unique assignment
                                multiplayerState.assignments[index] = userId;
                                broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments });
                            }
                        } else if (payload.type === 'request_assignment' && multiplayerState.isHost) {
                            // Host handles assignment request
                            const { index, userId } = payload;
                            
                            // Validate Turn
                            const currentTurnPlayer = multiplayerState.members[multiplayerState.turnIndex];
                            if (!currentTurnPlayer || currentTurnPlayer.id !== userId) {
                                // Not their turn
                                return;
                            }

                            // If index is -1, it's a skip turn request
                            if (index === -1) {
                                if (multiplayerState.turnIndex < multiplayerState.members.length - 1) {
                                    multiplayerState.turnIndex++;
                                }
                                broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments, turnIndex: multiplayerState.turnIndex });
                                return;
                            }

                            // Check if taken by someone else
                            const currentOwner = multiplayerState.assignments[index];
                            
                            // If already owned by requestor, do nothing (prevent re-assignment logic)
                            if (currentOwner === userId) {
                                // Just sync back to confirm (or do nothing)
                                broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments, turnIndex: multiplayerState.turnIndex });
                                return;
                            }

                            // Ensure one character per player:
                            if (!currentOwner) {
                                // Clear previous assignment for this user
                                clearUserAssignments(userId);
                                multiplayerState.assignments[index] = userId;
                                
                                // Advance turn
                                if (multiplayerState.turnIndex < multiplayerState.members.length - 1) {
                                    multiplayerState.turnIndex++;
                                }
                                
                                broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments, turnIndex: multiplayerState.turnIndex });
                            } else {
                                broadcastMessage({ type: 'sync_assignments', assignments: multiplayerState.assignments, turnIndex: multiplayerState.turnIndex });
                            }
                        } else if (payload.type === 'game_start' && !multiplayerState.isHost) {
                            cocState.log = payload.log;
                            cocState.gameState = 'playing';
                            currentView.value = 'chat';
                            showToast('æ¸¸æˆå¼€å§‹ï¼', 'success');
                        } else if (payload.type === 'change_mode' && !multiplayerState.isHost) {
                            cocState.mode = payload.mode;
                            currentView.value = payload.view;
                            cocState.gameState = payload.gameState;
                            showToast('æˆ¿ä¸»å·²å¼€å§‹å‡†å¤‡é˜¶æ®µ', 'info');
                        } else if (payload.type === 'room_closed') {
                            showToast('æˆ¿ä¸»å·²è§£æ•£æˆ¿é—´ï¼Œæ¸¸æˆç»“æŸ', 'warning');
                            leaveRoom();
                            cocState.gameState = 'idle';
                            cocState.log = [];
                            currentView.value = 'multiplayer';
                        } else if (payload.type === 'keeper_typing') {
                            isGenerating.value = payload.status;
                            scrollToBottom();
                        }
                    }).on('presence', { event: 'sync' }, () => {
                        const state = roomChannel.presenceState();
                        const flatMembers = Object.values(state).flat();
                        // Sort by online_at to ensure consistent order across clients
                        flatMembers.sort((a, b) => new Date(a.online_at) - new Date(b.online_at));
                        
                        // Check if host is missing
                        const oldHost = multiplayerState.members.find(m => m.isHost);
                        const currentHost = flatMembers.find(m => m.is_host);
                        
                        multiplayerState.members = flatMembers.map(p => ({
                            name: p.name, id: p.user_id, avatar: p.avatar, isHost: p.is_host, isReady: p.isReady, online_at: p.online_at
                        }));

                        // Host Migration Logic
                        if (oldHost && !currentHost && multiplayerState.members.length > 0) {
                            // Host left, the oldest member becomes the new host
                            const newHostCandidate = multiplayerState.members[0];
                            if (newHostCandidate.id === user.uuid) {
                                // I am the new host
                                multiplayerState.isHost = true;
                                showToast('åŸæˆ¿ä¸»å·²æ–­å¼€è¿æ¥ï¼Œä½ å·²è‡ªåŠ¨ç»§ä»»ä¸ºæˆ¿ä¸»', 'info');
                                
                                // Update my status in presence
                                roomChannel.track({
                                    user_id: user.uuid,
                                    name: user.name,
                                    avatar: user.avatar,
                                    is_host: true,
                                    isReady: multiplayerState.isReady,
                                    online_at: newHostCandidate.online_at // Keep original time
                                });
                                
                                // Broadcast self as new host (redundant with track but safe)
                                // Note: We don't need to explicitly broadcast 'I am host', presence update handles it for others.
                                // But we should sync state immediately to ensure consistency
                                broadcastMessage({
                                    type: 'sync_state',
                                    log: cocState.log,
                                    moduleName: cocState.module?.name,
                                    gameState: cocState.gameState,
                                    investigators: cocState.investigators,
                                    assignments: multiplayerState.assignments,
                                    assignmentDetails: multiplayerState.assignmentDetails,
                                    turnIndex: multiplayerState.turnIndex,
                                    roundActionIds: multiplayerState.roundActionIds,
                                    cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers
                                });
                            }
                        }
                        
                        // Host syncs state to new members
                        if (multiplayerState.isHost && multiplayerState.members.length > 1) {
                            broadcastMessage({
                                type: 'sync_state',
                                log: cocState.log,
                                moduleName: cocState.module?.name,
                                gameState: cocState.gameState,
                                investigators: cocState.investigators,
                                assignments: multiplayerState.assignments,
                                turnIndex: multiplayerState.turnIndex,
                                roundActionIds: multiplayerState.roundActionIds,
                                cotAuthorizedUsers: multiplayerState.cotAuthorizedUsers
                            });
                        }
                    }).subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            multiplayerState.inRoom = true;
                            await roomChannel.track({
                                user_id: user.uuid,
                                name: user.name,
                                avatar: user.avatar,
                                is_host: asHost,
                                isReady: false,
                                online_at: new Date() // For sorting
                            });
                            showToast(`å·²è¿›å…¥æˆ¿é—´ ${roomId}`, 'success');
                            
                            // ä¸»åŠ¨è¯·æ±‚åŒæ­¥çŠ¶æ€ (ç”¨äºæ–­çº¿é‡è¿)
                            if (!asHost) {
                                await roomChannel.send({
                                    type: 'broadcast',
                                    event: 'message',
                                    payload: { type: 'request_sync', userId: user.uuid }
                                });
                            }
                        }
                    });
                };

                const leaveRoom = async () => {
                    if (roomChannel) await roomChannel.unsubscribe();
                    multiplayerState.inRoom = false;
                    multiplayerState.roomId = null;
                    multiplayerState.isReady = false; // Reset ready state
                    cocState.mode = null; // Exit multi mode
                };

                const broadcastMessage = async (payload) => {
                    if (roomChannel) await roomChannel.send({ type: 'broadcast', event: 'message', payload });
                };

                // Friends
                const sendSignal = async (targetUuid, type, payload) => {
                    if (!supabaseClient) return;
                    const ch = supabaseClient.channel(`personal:${targetUuid}`);
                    ch.subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            await ch.send({ type: 'broadcast', event: 'message', payload: { type, sender: { uuid: user.uuid, name: user.name }, ...payload } });
                            supabaseClient.removeChannel(ch);
                        }
                    });
                };

                const addFriend = () => {
                    if (!friendInput.value) return;
                    sendSignal(friendInput.value, 'friend_request', {});
                    showToast('å·²å‘é€è¯·æ±‚', 'info');
                    friendInput.value = '';
                };

                const acceptFriend = (req) => {
                    friends.value.push(req);
                    friendRequests.value = friendRequests.value.filter(r => r.uuid !== req.uuid);
                    saveData();
                };

                const inviteFriend = (f) => {
                    if (multiplayerState.inRoom) sendSignal(f.uuid, 'invite_room', { roomId: multiplayerState.roomId });
                    else showToast('è¯·å…ˆåˆ›å»ºæˆ¿é—´', 'warning');
                };

                // Image Utils
                const handleUserAvatarUpload = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = async (ev) => {
                            user.avatar = await compressImage(ev.target.result, 200, 0.6);
                            saveData();
                        };
                        reader.readAsDataURL(file);
                    }
                };

                // Library Functions
                const fetchLibraryModules = async () => {
                    if (!supabaseClient) return;
                    libraryState.loading = true;
                    try {
                        let query = supabaseClient.from('coc_modules').select('*').order('created_at', { ascending: false });
                        if (libraryState.searchQuery) {
                            query = query.ilike('title', `%${libraryState.searchQuery}%`);
                        }
                        const { data, error } = await query;
                        if (error) throw error;
                        libraryState.modules = data;
                    } catch (err) {
                        console.error('Library Fetch Error:', err);
                        // showToast('æ— æ³•è·å–å›¾ä¹¦é¦†è—ä¹¦', 'error');
                    } finally {
                        libraryState.loading = false;
                    }
                };

                const uploadToLibrary = async () => {
                    if (!supabaseClient) return showToast('è¯·å…ˆè¿æ¥æœåŠ¡å™¨', 'error');
                    if (!libraryState.uploadForm.title || !libraryState.uploadForm.content) return showToast('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º', 'warning');
                    
                    libraryState.isUploading = true;
                    try {
                        const { error } = await supabaseClient.from('coc_modules').insert({
                            title: libraryState.uploadForm.title,
                            description: libraryState.uploadForm.description,
                            content: libraryState.uploadForm.content,
                            author_name: user.name,
                            author_id: user.uuid,
                            type: libraryState.uploadForm.type || 'original'
                        });
                        
                        if (error) {
                            // Check for missing table error (Postgres code 42P01 or generic 404 from REST)
                            if (error.code === '42P01' || (error.message && error.message.includes('404')) || (error.message && error.message.includes('Could not find the table'))) {
                                const setupSql = `-- 1. Create the table
create table if not exists coc_modules (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  title text not null,
  description text,
  content text not null,
  author_name text,
  author_id text,
  type text default 'original',
  downloads bigint default 0
);

-- 2. Enable RLS
alter table coc_modules enable row level security;

-- 3. Create policies (Check if they exist first to avoid errors if re-running)
do $$
begin
  if not exists (select 1 from pg_policies where tablename = 'coc_modules' and policyname = 'Public modules are viewable by everyone') then
    create policy "Public modules are viewable by everyone" on coc_modules for select using ( true );
  end if;
  
  if not exists (select 1 from pg_policies where tablename = 'coc_modules' and policyname = 'Anyone can upload modules') then
    create policy "Anyone can upload modules" on coc_modules for insert with check ( true );
  end if;
end
$$;

-- 4. Create function
create or replace function increment_downloads(row_id bigint) returns void as $$
begin
  update coc_modules set downloads = downloads + 1 where id = row_id;
end;
$$ language plpgsql;`;
                                console.log('Database Setup Required');
                                sqlToRun.value = setupSql;
                                showSqlModal.value = true;
                                throw new Error('æ•°æ®åº“è¡¨ç¼ºå¤±ï¼Œè¯·è¿è¡Œåˆå§‹åŒ–è„šæœ¬');
                            }
                            throw error;
                        }
                        
                        showToast('è´¡çŒ®æˆåŠŸï¼Œæ„Ÿè°¢æ‚¨çš„æ…·æ…¨ï¼', 'success');
                        libraryState.showUpload = false;
                        libraryState.uploadForm = { title: '', description: '', content: '', type: 'original' };
                        fetchLibraryModules();
                    } catch (err) {
                        console.error('Upload Error:', err);
                        showToast('ä¸Šä¼ å¤±è´¥: ' + err.message, 'error');
                    } finally {
                        libraryState.isUploading = false;
                    }
                };

                const generateModuleSummary = async (content) => {
                    if (!content || content.length < 50) return;
                    libraryState.isSummarizing = true;
                    
                    try {
                        const msgs = [
                            { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è·‘å›¢æ¨¡ç»„ç¼–è¾‘ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„æ¨¡ç»„å†…å®¹ï¼Œç”Ÿæˆä¸€æ®µç®€çŸ­ã€å¸å¼•äººçš„ç®€ä»‹ï¼ˆ100å­—ä»¥å†…ï¼‰ã€‚é‡ç‚¹æ¦‚æ‹¬æ¨¡ç»„çš„èƒŒæ™¯ã€æ°›å›´å’Œæ ¸å¿ƒè°œå›¢ï¼Œä¸è¦å‰§é€å…³é”®ç»“å±€ã€‚' },
                            { role: 'user', content: `è¯·ä¸ºä»¥ä¸‹æ¨¡ç»„ç”Ÿæˆç®€ä»‹ï¼š\n\n${content.slice(0, 5000)}` } // Limit context window
                        ];

                        const res = await fetch(`${settings.apiUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: msgs,
                                temperature: 0.7
                            })
                        });

                        const data = await res.json();
                        if (data.choices && data.choices[0]?.message?.content) {
                            libraryState.uploadForm.description = data.choices[0].message.content.trim();
                        }
                    } catch (e) {
                        console.error('Summary Generation Error:', e);
                    } finally {
                        libraryState.isSummarizing = false;
                    }
                };

                const handleLibraryFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    const processContent = (content) => {
                        libraryState.uploadForm.content = content;
                        if(!libraryState.uploadForm.title) libraryState.uploadForm.title = file.name.replace(/\.[^/.]+$/, "");
                        if(!libraryState.uploadForm.description) generateModuleSummary(content);
                    };

                    if (file.name.endsWith('.docx')) {
                        reader.onload = (ev) => {
                            mammoth.extractRawText({ arrayBuffer: ev.target.result })
                                .then((result) => processContent(result.value));
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        reader.onload = (ev) => processContent(ev.target.result);
                        reader.readAsText(file);
                    }
                };

                const useLibraryModule = async (mod, mode) => {
                    // Try to increment download count (RPC)
                    if (supabaseClient) {
                        // Optimistic update
                        mod.downloads = (mod.downloads || 0) + 1;
                        // RPC call if exists, otherwise just ignore
                        supabaseClient.rpc('increment_downloads', { row_id: mod.id }).then(({ error }) => {
                            if (error) console.warn('Failed to increment downloads', error);
                        });
                    }
                    
                    cocState.module = { name: mod.title, content: mod.content };
                    showToast(`å·²å€Ÿé˜…ã€Š${mod.title}ã€‹`, 'success');
                    
                    if (mode === 'single') {
                        selectCocMode('single');
                    } else {
                        selectCocMode('multi');
                        // If host, sync immediately
                        if (multiplayerState.isHost) {
                             broadcastMessage({ type: 'sync_module', moduleName: cocState.module.name });
                        }
                    }
                };

                const adaptNovelToModule = async () => {
                    const novelContent = libraryState.uploadForm.content;
                    if (!novelContent || novelContent.length < 50) return showToast('å†…å®¹å¤ªçŸ­ï¼Œæ— æ³•æ”¹ç¼–', 'warning');
                    
                    libraryState.isAdapting = true;
                    showToast('æ­£åœ¨å¬å”¤çµæ„Ÿä¹‹æºï¼Œè¯·è€å¿ƒç­‰å¾…...', 'info');

                    try {
                        const msgs = [
                            { role: 'system', content: `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ COC (Call of Cthulhu 7th Edition) è·‘å›¢æ¨¡ç»„ä½œè€…ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ç”¨æˆ·æä¾›çš„å°è¯´å†…å®¹æˆ–æ•…äº‹å¤§çº²ï¼Œæ”¹ç¼–æˆä¸€ä¸ªæ ‡å‡†çš„ COC æ¨¡ç»„ã€‚
                            
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown æ ¼å¼è¾“å‡ºï¼š

# [æ¨¡ç»„æ ‡é¢˜]

## ç®€ä»‹
[æ¨¡ç»„ç®€ä»‹ï¼ŒåŒ…å«èƒŒæ™¯æ•…äº‹æ‘˜è¦å’Œæ ¸å¿ƒè°œå›¢]

## å®ˆå¯†äººä¿¡æ¯ (Keeper Information)
[åªæœ‰ KP éœ€è¦çŸ¥é“çš„çœŸç›¸ã€å¹•åé»‘æ‰‹ã€æ—¶é—´çº¿]

## å¼•å…¥ (The Hook)
[è°ƒæŸ¥å‘˜å¦‚ä½•å·å…¥äº‹ä»¶]

## åœºæ™¯ä¸€ï¼š[åœºæ™¯å]
[æè¿°ã€NPCã€çº¿ç´¢ã€å¯èƒ½å‘ç”Ÿçš„äº‹ä»¶]

## åœºæ™¯äºŒï¼š[åœºæ™¯å]
...

## ç»“å±€ (Ending)
[å‡ ç§å¯èƒ½çš„ç»“å±€]

## NPC æ¡£æ¡ˆ
[ä¸»è¦ NPC çš„ç®€è¦è®¾å®š]

## ç‰©å“ä¸æ³•æœ¯
[ç›¸å…³ç‰©å“æˆ–ä¹¦ç±çš„è®¾å®š]

è¯·ç¡®ä¿å†…å®¹é€»è¾‘é€šé¡ºï¼Œæ°›å›´å…·æœ‰å…‹è‹é²é£æ ¼ï¼Œå¹¶åŒ…å«å¿…è¦çš„æ£€å®šå»ºè®®ï¼ˆå¦‚ï¼šä¾¦æŸ¥ã€è†å¬ã€å¿ƒç†å­¦ç­‰ï¼‰ã€‚` },
                            { role: 'user', content: `è¯·å°†ä»¥ä¸‹å°è¯´/å¤§çº²æ”¹ç¼–ä¸º COC æ¨¡ç»„ï¼š\n\n${novelContent.slice(0, 15000)}` }
                        ];

                        const res = await fetch(`${settings.apiUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: msgs,
                                temperature: 0.8
                            })
                        });

                        const data = await res.json();
                        if (data.choices && data.choices[0]?.message?.content) {
                            const adaptedContent = data.choices[0].message.content;
                            
                            // Update Form
                            libraryState.uploadForm.content = adaptedContent;
                            libraryState.uploadForm.type = 'original'; // Reset to original so user can edit and submit
                            
                            // Try to extract title
                            const titleMatch = adaptedContent.match(/^#\s+(.+)$/m);
                            if (titleMatch) libraryState.uploadForm.title = titleMatch[1].replace(/[\[\]]/g, '');
                            
                            // Generate description if missing
                            if (!libraryState.uploadForm.description) {
                                generateModuleSummary(adaptedContent);
                            }
                            
                            showToast('æ”¹ç¼–å®Œæˆï¼è¯·æ ¡å¯¹åå…¥åº“ã€‚', 'success');
                        } else {
                            throw new Error('API è¿”å›æ•°æ®ä¸ºç©º');
                        }
                    } catch (e) {
                        console.error('Adaptation Error:', e);
                        showToast('æ”¹ç¼–å¤±è´¥: ' + e.message, 'error');
                    } finally {
                        libraryState.isAdapting = false;
                    }
                };

                const exportModuleToWord = (mod) => {
                    try {
                        // 1. Convert Markdown to HTML
                        const htmlContent = marked.parse(mod.content);
                        
                        // 2. Wrap in Word-friendly HTML structure with styles
                        const docHtml = `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="UTF-8">
                                <style>
                                    body { font-family: 'SimSun', 'Times New Roman', serif; line-height: 1.5; }
                                    h1 { font-size: 24pt; color: #2e74b5; text-align: center; margin-bottom: 20px; }
                                    h2 { font-size: 18pt; color: #1f4d78; border-bottom: 1px solid #1f4d78; padding-bottom: 5px; margin-top: 20px; }
                                    h3 { font-size: 14pt; color: #1f4d78; margin-top: 15px; }
                                    p { font-size: 12pt; margin-bottom: 10px; text-align: justify; }
                                    ul, ol { margin-bottom: 10px; }
                                    li { margin-bottom: 5px; }
                                    strong { color: #b7950b; }
                                    blockquote { border-left: 4px solid #5e8d83; padding-left: 10px; color: #555; font-style: italic; background-color: #f9f9f9; }
                                    table { border-collapse: collapse; width: 100%; margin-bottom: 15px; }
                                    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                                    th { background-color: #e9ecef; }
                                </style>
                            </head>
                            <body>
                                <h1>${mod.title}</h1>
                                <p style="text-align: center; color: #666; font-size: 10pt;">ä½œè€…ï¼š${mod.author_name || 'ä½šå'} | æ¥æºï¼šZarkto's Table</p>
                                <hr/>
                                ${htmlContent}
                            </body>
                            </html>
                        `;

                        // 3. Convert to Blob using html-docx-js
                        const converted = htmlDocx.asBlob(docHtml);
                        
                        // 4. Save
                        saveAs(converted, `${mod.title}.docx`);
                        showToast('å¯¼å‡ºæˆåŠŸ', 'success');
                    } catch (e) {
                        console.error('Export Error:', e);
                        showToast('å¯¼å‡ºå¤±è´¥: ' + e.message, 'error');
                    }
                };

                // Expose to window for inline clicks
                window.triggerCocCommand = (cmd) => sendCocMessage(cmd);

                onMounted(() => {
                    loadData();
                    checkBroadcast();
                    if (settings.supabaseUrl) initSupabase();
                });

                return {
                    currentView, showMobileMenu, showMobileRightSidebar, user, settings, toasts, confirmState,
                    showBroadcast, dontShowBroadcast, closeBroadcast,
                    cocState, cocInput, cocInputRef, cocChatContainer, isGenerating,
                    multiplayerState, showJoinInput, joinRoomId, friends, friendRequests, friendInput,
                    showMentionList, mentionCandidates, handleInput, selectMention, savedGames,
                    selectCocMode, exitCocMode, exitCocGame, startCocGame, sendCocMessage, saveGame, deleteSave, loadSave,
                    importCocModule, saveManualModule, importInvestigator, deleteInvestigator,
                    initSupabase, createRoom, joinRoom, leaveRoom, addFriend, acceptFriend, inviteFriend,
                    handleUserAvatarUpload, saveData, renderMarkdown, copyToClipboard,
                    toggleReady, allPlayersReady, handleInvestigatorClick,
                    libraryState, fetchLibraryModules, uploadToLibrary, handleLibraryFileUpload, useLibraryModule,
                    showSqlModal, sqlToRun,
                    openCocCard,
                    hasCot, getCotContent, removeCot, toggleCot, regenerateLastResponse, lastAssistantIndex,
                    statDisplayMap,
                    settlementState, openSettlement, rollSanReward, processSkillGrowth, confirmSettlement,
                    getPageTitle: () => {
                        switch(currentView.value) {
                            case 'coc': return 'å‘½è¿é€‰æ‹©';
                            case 'saves': return 'è®°å¿†å›å»Š';
                            case 'friends': return 'åŒä¼´åå½•';
                            case 'settings': return 'è®¾ç½®ä¸­å¿ƒ';
                            case 'multiplayer': return 'å¤šé‡å®‡å®™';
                            case 'library': return 'å¯†å¤§å›¾ä¹¦é¦†';
                            case 'preparing': return 'è·‘å›¢å‡†å¤‡';
                            default: return 'The Call of Cthulhu';
                        }
                    }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
